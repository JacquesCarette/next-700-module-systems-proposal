<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-08-20 Tue 16:06 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Making Modules with Meta-Programmed Meta-Primitives</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Musa Al-hassy" />
<meta name="description" content="Generalising ADTS, records, typeclasses to “package formers”."
 />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Making Modules with Meta-Programmed Meta-Primitives
<br />
<span class="subtitle">Liberating Package Formation from the Backend</span>
</h1>

<style>

/* wrap lengthy lines for code blocks */
pre{white-space:pre-wrap}

/* inline code; see here for other colours: https://www.w3schools.com/colors/colors_names.asp */
code { background: Cyan;
       border-radius: 5px; /* How curvy the borders should be. */
}

table {
    background: pink;
    border-radius: 10px; /* How curvy the borders should be. */
    /* width:90% */

    border-bottom: hidden;
    border-top: hidden;

    /* Put table in the center of the page, horizontally. */
    margin-left:auto;margin-right:auto;

    font-family:"Courier New";
    font-size:90%;
}

/* table ‘d’ata elements */
td {
    border: 1px solid red; padding: 1em;
    /* border: none;
    border-left: 1px solid transparent;
    border-right: 1px solid transparent; */


}


/* Alter visible labels of source blocks */
pre.src-agda:before { content: 'Agda'; }
pre.src-haskell:before { content: 'Agda'; }
pre.src-org:before { content: 'Text'; }

/* Using source blocks “agda-results” as pink-background coloured blocks in HTML. */
/* pre.src-results-agda:before { content: 'Results: Agda'; } */
pre.src-results-agda { background: pink;}
/* Execute this for alias: (add-to-list 'org-src-lang-modes '("results-agda" . org-agda)) */

</style>


<div class="org-center">
<p>
<b>Abstract</b>
</p>
</div>
<blockquote>
<p>
This article is about implementing a prototype supporting <a href="https://alhassy.github.io/next-700-module-systems-proposal/">“the next 700 module systems” proposal</a>
as an editor extension. In particular, we show how intimately related presentations of a type
can be <i>derived automatically</i> from a single generic declaration which we call a <code>PackageFormer</code>.
</p>

<p>
Think of a language that does not support currying and you need to have a function of
10 arguments that needs to support accepting any number of arguments less than 10, say
for partial application. In such languages, one must utilise the builder design pattern,
or quickly copy-paste the function 10 times, altering it slightly each time.
In general, if such a function definition requires <i>N</i> lines and <i>M</i> forms of the function
are needed, then nearly <i>N × M</i> lines of code are written manually.
</p>

<p>
Our prototype deals with this problem, among others, for functions on <i>types</i>
&#x2014;i.e., type constructors&#x2014; and reduces this quadratic count to a linear
count <i>N + M</i>: One declaration of <i>N</i> lines, then <i>M</i> lines, each being an instantiation
of the desired form. These ideas are discussed in the pre-print
<a href="https://github.com/alhassy/next-700-module-systems-proposal/blob/master/Paper0.pdf">A Language Feature to Unbundle Data at Will</a>.
</p>

<p>
<b>Design patterns for theories become library methods!</b>
An interesting side-effect of having meta-primitives for packages
is that traditional patterns for theories
&#x2014;e.g., homomorphisms, syntax, interpretation functions&#x2014;
can now be codified as general re-usable methods.
</p>

<p>
The ideas are targeted to the dependently-typed language Agda.
However, with little alterations they could easily be made to target
other languages, such as Haskell and Coq. The ideas transcend the presentation
language, Agda. Ideally, variational definitions would also be in the host
language rather than in Lisp but that would require alteration to the host
language itself, and Lisp with Emacs hooks is much easier to do; for now.
<i>This is an Emacs centric language extension.</i>
</p>

<p>
The <a href="#orgcff7866">first section</a> below quickly elaborates on our goal,
after that is a ‘<a href="#user-manual">user manual</a>’, then the remainder of
the article serves as literate documentation of the prototype;
as well as an opportunity for me to explore emojis.
To follow along, it may be useful to look at an <a href="https://alhassy.github.io/ElispCheatSheet/">Elisp Cheat Sheet</a>.
</p>
</blockquote>

<div class="org-center">
<p>
<i>Everything here works with Agda version 2.6.0.</i>
</p>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Results of tests will be in pink, like this.</td>
</tr>
</tbody>
</table>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgcff7866">1. Aim: <i>Scrap the Repetition</i></a></li>
<li><a href="#user-manual">2. User Manual</a>
<ul>
<li><a href="#orgbd21942">2.1. Installation</a></li>
<li><a href="#orgc464f2d">2.2. Syntax</a></li>
<li><a href="#orgd5c1ed0">2.3. Records and Meta-Primitives <code>:kind</code> &amp; <code>:waist-strings</code></a></li>
<li><a href="#org6316e60">2.4. Typeclasses &#x2014;Parameterised Records&#x2014; and Meta-Primitives <code>:waist</code> &amp; <code>:level</code></a></li>
<li><a href="#orgff1d072">2.5. Primed Decoration and the Meta-Primitive <code>alter-elements</code></a></li>
<li><a href="#org83aeb77">2.6. Composition <code>⟴</code> and First-class PackageFormers</a></li>
<li><a href="#orgbf6cc26">2.7. Forming Syntax and the Special <code>$𝑛𝑎𝑚𝑒</code> Variable</a></li>
<li><a href="#orgf493afb">2.8. Variationals with Arguments ---<code>map, rename, [co]decorated, renaming</code></a></li>
<li><a href="#orgdc3d98d">2.9. Shallow Renaming with Agda's <code>open ⋯ public ⋯ renaming ⋯</code></a></li>
<li><a href="#orga7d5b78">2.10. Subpacakges with <code>generated, sorts, signature</code></a></li>
<li><a href="#org860f09b">2.11. Automatically deriving homomorphism definitions ♥‿♥</a></li>
</ul>
</li>
<li><a href="#org0486626">3. Strings and Things</a>
<ul>
<li><a href="#org8b5deba">3.1. Finding Children in the Wild</a></li>
<li><a href="#org739b954">3.2. Substrings Delimited by Tokens</a></li>
<li><a href="#org3a51221">3.3. Agda Mixfix Renaming and Imports</a></li>
</ul>
</li>
<li><a href="#org9105fd9">4. The <code>package-former</code> Datatype</a>
<ul>
<li><a href="#org076966c">4.1. Locally Opening a PackageFormer</a></li>
<li><a href="#org63ce2ce">4.2. Typed Names</a></li>
<li><a href="#org9a8491f">4.3. Package Former Parsing and Pretty Printing</a></li>
</ul>
</li>
<li><a href="#orgdeb0c69">5. Variational Language</a>
<ul>
<li><a href="#org3a54f99">5.1. 𝒱𝒸,  𝒱-, and 𝒱</a></li>
<li><a href="#org6d47006">5.2. Well-formed checks &#x2014;Error reporting</a></li>
<li><a href="#orgcf2f002">5.3. Loading Variationals: Super Simple Conversion From String to Lisp</a></li>
</ul>
</li>
<li><a href="#org3d18d04">6. Loading an Agda Buffer</a>
<ul>
<li><a href="#org42ac504">6.1. Loading an Instance &#x2014;The Core Utility</a></li>
<li><a href="#org501e372">6.2. <code>load-700-comments</code> and <code>lisp</code> blocks</a></li>
</ul>
</li>
<li><a href="#org411aaff">7. Emacs Interface</a>
<ul>
<li><a href="#orgbc038d0">7.1. Advising our Beloved <code>C-c C-l</code></a></li>
<li><a href="#org27e1267">7.2. Menu matter</a></li>
</ul>
</li>
<li><a href="#org2d2db67">8. <span class="done Future">Future</span> Work</a></li>
</ul>
</div>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><a href="Testing.agda">Testing.agda</a> has up-to-date working examples.</td>
</tr>
</tbody>
</table>

<div id="outline-container-orgcff7866" class="outline-2">
<h2 id="orgcff7866"><span class="section-number-2">1</span> Aim: <i>Scrap the Repetition</i></h2>
<div class="outline-text-2" id="text-1">
<p>
We're going to write a code generator in Lisp that is going to interpret
fictitious Agda code &#x2014;henceforth referred to as “700 code”&#x2014;
into currently legitimate Agda code.
</p>

<p>
For example, something like the following, henceforth referred to as <code>test</code>:
</p>
<div class="org-src-container">
<pre class="src src-agda" id="org949a397"><span style="color: #ba2f59; font-weight: bold;">PackageFormer M-Set</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
  <span style="color: #ba2f59; font-weight: bold;"> Scalar</span>  : <span style="color: #cd6600;">Set</span>
  <span style="color: #ba2f59; font-weight: bold;"> Vector</span>  : <span style="color: #cd6600;">Set</span>
   _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
   &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)

S<span style="color: #0000cd;">emantics</span>     <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #cd6600;">record</span>
S<span style="color: #0000cd;">yntax</span>        <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #cd6600;">data</span> <span style="color: #cd6600;">with</span> <span style="color: #0000cd;">tags</span><span style="color: #ba2f59; font-weight: bold;"> (Scalar</span>;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>)
U<span style="color: #0000cd;">ntypedSyntax</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #cd6600;">data</span> <span style="color: #cd6600;">with</span> <span style="color: #0000cd;">identified</span> <span style="color: #0000cd;">carrier</span><span style="color: #ba2f59; font-weight: bold;"> (Scalar</span>;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>)
S<span style="color: #0000cd;">calarSyntax</span>  <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #cd6600;">data</span> <span style="color: #cd6600;">with</span> <span style="color: #0000cd;">identified</span> <span style="color: #0000cd;">carrier</span><span style="color: #ba2f59; font-weight: bold;"> (Scalar</span>)
S<span style="color: #0000cd;">tream</span>        <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #0000cd;">parameterised</span> <span style="color: #cd6600;">codata</span> <span style="color: #cd6600;">with</span> <span style="color: #0000cd;">identified</span> <span style="color: #0000cd;">carrier</span><span style="color: #ba2f59; font-weight: bold;"> (Vector</span>) <span style="color: #cd6600;">renaming</span> (_&#183;_&#8321; <span style="color: #0000cd;">to</span> <span style="color: #0000cd;">head</span>; _&#183;_&#8322; <span style="color: #0000cd;">to</span> <span style="color: #0000cd;">tail</span>)
V<span style="color: #0000cd;">ectorSyntax</span>  <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #cd6600;">data</span> <span style="color: #cd6600;">with</span> <span style="color: #0000cd;">identified</span> <span style="color: #0000cd;">carrier</span><span style="color: #ba2f59; font-weight: bold;"> (Vector</span>) <span style="color: #0000cd;">and</span> <span style="color: #0000cd;">variables</span> (<span style="color: #0000cd;">embed</span>) <span style="color: #0000cd;">from</span><span style="color: #ba2f59; font-weight: bold;"> (Scalar</span>)
N<span style="color: #0000cd;">earMonoid</span>    <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #cd6600;">record</span> <span style="color: #cd6600;">renaming</span><span style="color: #ba2f59; font-weight: bold;"> (Scalar</span> <span style="color: #0000cd;">to</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> <span style="color: #0000cd;">to</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>; _&#183;_ <span style="color: #0000cd;">to</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span>; _&#215;_ <span style="color: #0000cd;">to</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span>)
</pre>
</div>

<p>
Will behave as if it were written:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> Semantics</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
  <span style="color: #cd6600;">field</span>
   <span style="color: #ba2f59; font-weight: bold;"> Scalar</span>  : <span style="color: #cd6600;">Set</span>
   <span style="color: #ba2f59; font-weight: bold;"> Vector</span>  : <span style="color: #cd6600;">Set</span>
    _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
    &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
    _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
    <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
    <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)

<span style="color: #cd6600;">data</span><span style="color: #ba2f59; font-weight: bold;"> SyntaxTag</span> : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span><span style="color: #ba2f59; font-weight: bold;"> Scalar Vector</span> :<span style="color: #ba2f59; font-weight: bold;"> SyntaxTag</span>
<span style="color: #cd6600;">data</span><span style="color: #ba2f59; font-weight: bold;"> Syntax</span> :<span style="color: #ba2f59; font-weight: bold;"> SyntaxTag</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
    _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> Syntax Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Syntax Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Syntax Vector</span>
    &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Syntax Scalar</span>
    _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Syntax Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Syntax Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Syntax Scalar</span>

<span style="color: #cd6600;">data</span><span style="color: #ba2f59; font-weight: bold;"> UntypedSyntax</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
    _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> UntypedSyntax</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> UntypedSyntax</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> UntypedSyntax</span>
    &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> UntypedSyntax</span>
    _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> UntypedSyntax</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> UntypedSyntax</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> UntypedSyntax</span>

<span style="color: #cd6600;">data</span><span style="color: #ba2f59; font-weight: bold;"> ScalarSyntax</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
    &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> ScalarSyntax</span>
    _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> ScalarSyntax</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> ScalarSyntax</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> ScalarSyntax</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Nutshell: Keep items ending in &#8220;Stream Carrier&#8221;, then discard that ending,</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">         then form a subscripted version for each argument.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> Stream (Carrier</span> : <span style="color: #cd6600;">Set</span>) :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
  <span style="color: #cd6600;">coinductive</span>
  <span style="color: #cd6600;">field</span>
    <span style="color: #0000cd;">head</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #0000cd;">tail</span> :<span style="color: #ba2f59; font-weight: bold;"> Stream Carrier</span>

<span style="color: #cd6600;">data</span><span style="color: #ba2f59; font-weight: bold;"> VectorSyntax (Scalar</span> : <span style="color: #cd6600;">Set</span>) :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
    <span style="color: #0000cd;">embed</span>   :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> VectorSyntax</span>
    _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> VectorSyntax</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> VectorSyntax</span>

<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> NearMonoid</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
  <span style="color: #cd6600;">field</span>
   <span style="color: #ba2f59; font-weight: bold;"> Carrier</span> : <span style="color: #cd6600;">Set</span>
    <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span>     :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>}  &#8594;  &#120793; &#10814; &#120011;  &#8801;  &#120011;
    <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594; (<span style="color: #0000cd;">a</span> &#10814; <span style="color: #0000cd;">b</span>) &#10814; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#10814; (<span style="color: #0000cd;">b</span> &#10814; &#120011;)
</pre>
</div>
<p>
This is a more than a <a id="orgede69a7">200% increase</a> in size; that is, our fictitious code will
save us a lot of repetition.
</p>

<p>
The above is ideal syntax: In Lisp fashion, we are not limiting our vision to what
we can currently be done. The actual syntax that is currently supported by this
program is surprisingly close to the above, with an occasional <code>-</code> or <code>:</code> inserted.
Just look at the following source file and resulting generated code!
</p>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Testing.agda </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(load-file "PackageFormer.el")</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">Strip away the 700 annotations with:</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(progn (700-bare-bones) (find-file "Testing_Bare.agda"))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">0. There are a number of common use-cases.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">1. We can handle all of them &amp; more, since we're extensible.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  - Mention the Lean &amp; Coq, as well as the Agda, repeated fragments.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">2. The resulting setup is pragmatic: It is unobtrusive in the</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   traditional Agda coding style in that it happens in the background.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">3. It fills a particular need; the desire to avoid repetitious code.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

-----------------------------------------------------------------------------------------

--<span style="color: #ba2f59; font-weight: bold;"> The</span> <span style="color: #0000cd;">space</span> <span style="color: #0000cd;">causes</span> <span style="color: #0000cd;">this</span> <span style="color: #0000cd;">block</span> <span style="color: #0000cd;">to</span> <span style="color: #0000cd;">be</span> <span style="color: #0000cd;">treated</span><span style="color: #404040;"> as</span> <span style="color: #0000cd;">a</span> <span style="color: #0000cd;">normal</span> <span style="color: #0000cd;">comment</span> <span style="color: #0000cd;">block</span>.
--<span style="color: #ba2f59; font-weight: bold;"> Having</span> <span style="color: #0000cd;">no</span> <span style="color: #0000cd;">space</span> <span style="color: #0000cd;">between</span> &#8220;<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8221; and &#8220;lisp&#8221; would cause the block to be executed</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-- as a single Lisp form.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">{-  lisp</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(progn (message-box "Hello")</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(message-box "World"))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">lisp</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(message-box "Friend")</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #cd6600;">module</span> <span style="color: #a020f0;">Testing</span> <span style="color: #cd6600;">where</span>
<span style="color: #cd6600;">open</span> <span style="color: #cd6600;">import</span> <span style="color: #a020f0;">Testing_Generated</span>

<span style="color: #cd6600;">open</span> <span style="color: #cd6600;">import</span> <span style="color: #a020f0;">Level</span>
<span style="color: #cd6600;">open</span> <span style="color: #cd6600;">import</span> <span style="color: #a020f0;">Data.Bool</span>
<span style="color: #cd6600;">open</span> <span style="color: #cd6600;">import</span> <span style="color: #a020f0;">Relation.Binary.PropositionalEquality</span> <span style="color: #cd6600;">using</span> (_&#8801;_)
<span style="color: #cd6600;">open</span> <span style="color: #cd6600;">import</span> <span style="color: #a020f0;">Data.String</span> <span style="color: #cd6600;">hiding</span> (_++_)

------------------------------------------------------------------------------------------
--- &#167;<span style="color: #a020f0;">0</span>.<span style="color: #ba2f59; font-weight: bold;"> Basic</span> <span style="color: #ba2f59; font-weight: bold;">PackageFormer</span> <span style="color: #0000cd;">declarations</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">PackageFormer MonoidP : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    Carrier : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    _&#10814;_     : Carrier &#8594; Carrier &#8594; Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    Id      : Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    assoc   : &#8704; {x y z} &#8594; (x &#10814; y) &#10814; z &#8801; x &#10814; (y &#10814; z)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    leftId  : &#8704; {x : Carrier} &#8594; Id &#10814; x &#8801; x</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    rightId : &#8704; {x : Carrier} &#8594; x &#10814; Id &#8801; x</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">PackageFormer M-Set : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   Scalar  : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   Vector  : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   _&#183;_     : Scalar &#8594; Vector &#8594; Vector</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   &#120793;       : Scalar</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   _&#215;_     : Scalar &#8594; Scalar &#8594; Scalar</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   leftId  : {&#120011; : Vector}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   assoc   : {a b : Scalar} {&#120011; : Vector} &#8594; (a &#215; b) &#183; &#120011;  &#8801;  a &#183; (b &#183; &#120011;)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">-- Gives error that &#119985;-doit is not defined (&#3591;&#3232;_&#3232;)&#3591;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-- Whoops   =  MonoidP doit</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

-----------------------------------------------------------------------------------------
---- &#167;<span style="color: #a020f0;">1</span>.<span style="color: #ba2f59; font-weight: bold;"> Empty Variationals</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Find definition with M-. on the &#8220;_ = &#8943;&#8221; lines to see the generated code </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-- Variational with empty right hand side.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-identity =</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidP&#8305;&#7496; = MonoidP identity</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">-- No variational clauses needed!</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidP&#8304;  = MonoidP</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">-- Identity of composition &#10228;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidP&#7580; = MonoidP &#10228;</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">-- Operationally: Pf &#10228; v  &#8776;  Pf v &#10228;  &#8776;  Pf v</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">-- &#8220;&#10228;&#8221; is just forwards composition: We &#8216;thread&#8217; the Pf through the compositions v&#7522; in order.</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

-----------------------------------------------------------------------------------------
----- &#167;<span style="color: #a020f0;">2</span>.<span style="color: #ba2f59; font-weight: bold;"> Record-based Variationals</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-- &#119985;-whoops              = :kind recorder :waist-strings ("field")</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-record                 = :kind record :waist-strings ("field")</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-typeclass-attempt      = :kind record :waist-strings ("field") :waist 2</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-typeclass&#8322;             = :kind record :waist-strings ("field") :waist 2 :level dec</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-typeclass height level = record &#10228; :waist height :level level</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidT&#8323;   =  MonoidP record &#10228; :waist 3 :level dec</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidT&#8322;   =  MonoidP typeclass&#8322; &#10228; :waist-strings ("private" "extra : Set&#8321;" "extra = Set" "field")</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidT&#8324;   =  MonoidP typeclass :height 4 :level 'dec</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-Record = M-Set record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-Typeclass&#8322; = M-Set typeclass&#8322;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-Typeclass&#8323; = M-Set-Record typeclass :height 3 :level 'dec</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

_ <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">MonoidT&#8323;</span>
_ <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">MonoidT&#8322;</span>
_ <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">MonoidT&#8324;</span>
_ <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">M-Set-Record</span>
_ <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">M-Set-Typeclass&#8322;</span>
_ <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">M-Set-Typeclass&#8323;</span>

-----------------------------------------------------------------------------------------
----- &#167;<span style="color: #a020f0;">3</span>.<span style="color: #ba2f59; font-weight: bold;"> Variationals</span> <span style="color: #0000cd;">via</span><span style="color: #ba2f59; font-weight: bold;"> Lisp</span>:<span style="color: #ba2f59; font-weight: bold;"> Primed</span>, <span style="color: #0000cd;">map-elements</span>, <span style="color: #cd6600;">renaming</span>
-----     (<span style="color: #ba2f59; font-weight: bold;"> Feel</span> <span style="color: #0000cd;">free</span> <span style="color: #0000cd;">to</span> <span style="color: #0000cd;">skip</span> <span style="color: #0000cd;">this</span> <span style="color: #0000cd;">and</span> <span style="color: #0000cd;">look</span> <span style="color: #0000cd;">at</span> &#167;<span style="color: #a020f0;">4</span> <span style="color: #0000cd;">for</span> <span style="color: #0000cd;">a</span> <span style="color: #0000cd;">better</span> <span style="color: #0000cd;">way</span> <span style="color: #0000cd;">to</span> <span style="color: #cd6600;">do</span> <span style="color: #0000cd;">things</span>. )

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">-- First one is intensionally erroenous attempt.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-primed-attempt = :alter-elements (lambda (fs) (mapcar (lambda (f) (map-name (concat name "&#8242;") f)) fs))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-primed&#8343;&#8337;&#8348; = :alter-elements (lambda (fs) (-as-&gt; (-unzip (--zip-with `(,other  ,(format "let %s = %s in " (get-name it) (get-name other))) fs (--map (map-name (concat name "&#8242;") it) fs))) yup (--zip-with (map-type (concat (s-join "" it) type) other) (-inits (cadr yup)) (car yup))))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set&#8242; = M-Set primed-attempt</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidR    =  MonoidP record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidR&#8242;   =  MonoidP record &#10228; primed&#8343;&#8337;&#8348;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidR&#8243;   =  MonoidR primed&#8343;&#8337;&#8348;</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">-- Operationally: Pf v&#8320; &#10228; &#8943; &#10228; v&#8345; &#8776; ((Pf v&#8320;) v&#8321;) &#8943;) v&#8345;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-- Note: In the concrete syntax, such parenthisation is not permitted.</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

_ <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">MonoidR</span>
_ <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">MonoidR&#8242;</span>
_ <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">MonoidR&#8243;</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-map&#8320; elements = :alter-elements (lambda (fs) (-as-&gt; (-unzip (--zip-with `(,other  ,(format "let %s = %s in " (get-name it) (get-name other))) fs (mapcar elements fs))) yup (--zip-with (map-type (concat (s-join "" it) type) other) (-inits (cadr yup)) (car yup))))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">Monoid&#8344; = MonoidR map&#8320; :elements (lambda (f) (make-tn (concat (get-name f) "&#8344;") (get-type f)))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">-- Note the prime on the rhs. MA: Maybe avoid this?</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-rename&#8320; elements = map&#8320; :elements 'elements</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-rename&#8321; elements = map&#8320; :elements (lambda (f) (make-tn (rename-mixfix elements (get-name f)) (get-type f)))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">Monoid&#8345; = MonoidR rename&#8321; :elements (lambda (name) (concat name "&#8345;"))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

_ <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">Monoid&#8344;   -- Notice the name is &#8220;_&#10814;_&#8344;&#8221;</span>
_ <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">Monoid&#8345;   -- Notice the name is &#8220;_&#10814;&#8345;_&#8221;</span>
              --<span style="color: #ba2f59; font-weight: bold;"> The</span> <span style="color: #0000cd;">differences</span> <span style="color: #0000cd;">are</span> <span style="color: #0000cd;">due</span> <span style="color: #0000cd;">to</span> <span style="color: #0000cd;">the</span> <span style="color: #0000cd;">choice</span> <span style="color: #0000cd;">of</span> <span style="color: #cd6600;">renaming</span> <span style="color: #0000cd;">scheme</span> <span style="color: #0000cd;">above</span>.

-----------------------------------------------------------------------------------------
--- &#167;<span style="color: #a020f0;">4</span>.<span style="color: #ba2f59; font-weight: bold;"> Variationals</span> <span style="color: #0000cd;">via</span><span style="color: #ba2f59; font-weight: bold;"> Lisp</span>,<span style="color: #ba2f59; font-weight: bold;"> Continue</span>:<span style="color: #ba2f59; font-weight: bold;"> Primed</span>, <span style="color: #0000cd;">map-elements</span>, <span style="color: #cd6600;">renaming</span>
--     <span style="color: #ba2f59; font-weight: bold;"> Using</span> <span style="color: #0000cd;">lisp-blocks</span> <span style="color: #0000cd;">and</span> <span style="color: #0000cd;">without</span> <span style="color: #0000cd;">let-in</span> <span style="color: #0000cd;">clauses</span>.

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">lisp</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; primer = :alter-elements (lambda (fs)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   (let ((fsnew fs)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">         (names (--map (s-replace "_" "" (get-name it)) fs)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     (loop for old in names</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           for new in (--map (concat it "&#8242;") names)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           do</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           ;; (message-box "old %s; new %s" old new)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           (setq fsnew (--map (s-replace old new it) fsnew)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     ;; return value</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     fsnew</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     )))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MR&#8242; = M-Set record &#10228; primer</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
_ <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">MR&#8242;</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">lisp</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; Underscores are not given any special consideration.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; map_ elements = :alter-elements (lambda (fs)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   (let* ((fsnew (mapcar elements fs))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (names  (--map (get-name it) fs))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (names&#8242; (--map (get-name it) fsnew)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     (loop for old in names</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           for new in names&#8242;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           do</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           (setq fsnew (--map (map-type (s-replace old new type) it) fsnew)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     ;; return value</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     fsnew</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     )))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; map elements = :alter-elements (lambda (fs)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   (let* ((fsnew (mapcar elements fs))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (names  (--map (s-replace "_" "" (get-name it)) fs))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (names&#8242; (--map (s-replace "_" "" (get-name it)) fsnew)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     (loop for old in names</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           for new in names&#8242;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           do</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           (setq fsnew (--map (map-type (s-replace old new type) it) fsnew)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     ;; return value</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     fsnew</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     )))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
--
--<span style="color: #ba2f59; font-weight: bold;"> Note</span> <span style="color: #0000cd;">that</span> <span style="color: #0000cd;">we</span> <span style="color: #0000cd;">cannot</span> <span style="color: #0000cd;">form</span> <span style="color: #0000cd;">a</span> &#8220;<span style="color: #0000cd;">map_</span>&#8221; <span style="color: #0000cd;">that</span> <span style="color: #0000cd;">does</span> <span style="color: #0000cd;">not</span> <span style="color: #cd6600;">rewrite</span> &#8220;_&#8221; <span style="color: #cd6600;">with</span> &#8220;&#8221;
-- <span style="color: #0000cd;">and</span> <span style="color: #0000cd;">expect</span> <span style="color: #0000cd;">it</span> <span style="color: #0000cd;">to</span> <span style="color: #0000cd;">work</span><span style="color: #404040;"> as</span> <span style="color: #0000cd;">desired</span>.<span style="color: #ba2f59; font-weight: bold;"> Indeed</span>, <span style="color: #0000cd;">if</span> <span style="color: #0000cd;">we</span> <span style="color: #0000cd;">have</span> <span style="color: #0000cd;">a</span> <span style="color: #0000cd;">name</span>, <span style="color: #0000cd;">say</span>, &#8220;_&#8853;_&#8221;
-- <span style="color: #0000cd;">but</span> <span style="color: #0000cd;">one</span> <span style="color: #0000cd;">of</span> <span style="color: #0000cd;">its</span> <span style="color: #0000cd;">uses</span> <span style="color: #0000cd;">is</span> &#8220;<span style="color: #0000cd;">x</span> &#8853; <span style="color: #0000cd;">y</span>&#8221; <span style="color: #0000cd;">then</span> <span style="color: #0000cd;">any</span> <span style="color: #0000cd;">alteration</span> <span style="color: #0000cd;">would</span> <span style="color: #0000cd;">not</span> <span style="color: #0000cd;">transpire</span>
-- <span style="color: #0000cd;">since</span> &#8220;<span style="color: #0000cd;">x</span> &#8853; <span style="color: #0000cd;">y</span>&#8221; <span style="color: #0000cd;">clearly</span> <span style="color: #0000cd;">does</span> <span style="color: #0000cd;">not</span> <span style="color: #0000cd;">mention</span> <span style="color: #0000cd;">the</span> <span style="color: #0000cd;">literal</span> &#8220;_&#8853;_&#8221;.
--<span style="color: #ba2f59; font-weight: bold;"> Agda</span> <span style="color: #cd6600;">let</span>'<span style="color: #0000cd;">s</span> <span style="color: #0000cd;">use</span> <span style="color: #0000cd;">use</span> <span style="color: #0000cd;">opertor</span> <span style="color: #0000cd;">names</span> <span style="color: #cd6600;">in</span> <span style="color: #0000cd;">prefix</span> <span style="color: #0000cd;">and</span> <span style="color: #0000cd;">mixfix</span>,<span style="color: #404040;"> as</span> <span style="color: #0000cd;">such</span> <span style="color: #0000cd;">our</span> <span style="color: #0000cd;">schemes</span>
-- <span style="color: #0000cd;">need</span> <span style="color: #0000cd;">to</span> <span style="color: #0000cd;">be</span> <span style="color: #0000cd;">more</span> <span style="color: #0000cd;">robust</span> ---<span style="color: #0000cd;">which</span> <span style="color: #0000cd;">the</span> <span style="color: #0000cd;">reader</span> <span style="color: #0000cd;">may</span> <span style="color: #0000cd;">pursue</span> <span style="color: #cd6600;">with</span> <span style="color: #0000cd;">sufficint</span><span style="color: #ba2f59; font-weight: bold;"> Lisp</span>.
--
--<span style="color: #ba2f59; font-weight: bold;"> We</span> <span style="color: #0000cd;">only</span> <span style="color: #0000cd;">show</span> <span style="color: #0000cd;">this</span> <span style="color: #0000cd;">briefly</span> <span style="color: #cd6600;">with</span> <span style="color: #0000cd;">rename_</span> <span style="color: #0000cd;">and</span> <span style="color: #0000cd;">renaming_</span> <span style="color: #0000cd;">below</span>.

--<span style="color: #ba2f59; font-weight: bold;"> Now</span> <span style="color: #0000cd;">for</span> <span style="color: #0000cd;">some</span> <span style="color: #0000cd;">useful</span> <span style="color: #0000cd;">corollaries</span>.

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">lisp</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; &#8220;elements&#8221; is a string-to-string function acting on names.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; rename elements</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  = map :elements</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     (lambda (f) (make-tn (rename-mixfix elements (get-name f)) (get-type f))))</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">;; &#8220;elements&#8221; is a string-to-string function acting on names.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; Underscores are not given any special consideration.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; rename_ elements</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  = map :elements</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     (lambda (f) (make-tn (funcall elements (get-name f)) (get-type f))))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; decorated    by  =  rename :elements (lambda (name) (concat name by)))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; co-decorated by  =  rename :elements (lambda (name) (concat by name)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MR&#8321;&#8331;&#8322;    = M-Set record &#10228; decorated :by "&#8321;" &#10228; decorated :by "&#8322;"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">the-MR   = M-Set record &#10228; co-decorated :by "the-"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
_ <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">MR&#8321;&#8331;&#8322;</span>
_ <span style="color: #cd6600;">=</span> the-<span style="color: #ba2f59; font-weight: bold;">MR</span>

-----------------------------------------------------------------------------------------
--- &#167;<span style="color: #a020f0;">5</span>.<span style="color: #ba2f59; font-weight: bold;"> Renaming</span> <span style="color: #cd6600;">with</span> &#8220;<span style="color: #0000cd;">to</span>&#8221; <span style="color: #0000cd;">lists</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MR-oh  = M-Set record &#10228; rename :elements (lambda (name) (pcase name ("Scalar" "S") (x x)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
_ <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">MR-oh</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">lisp</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; &#8220;by&#8221; should be a &#8220;;&#8221;-seperated string of &#8220;to&#8221;-seperated pairs.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; renaming by</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  = rename :elements '(lambda (name)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      (let (clauses)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">        (thread-last by</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (s-split ";")</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (--map (s-split " to " it))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (--map (list (s-trim (car it)) (s-trim (cadr it))))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (-cons* 'pcase 'name)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (setq clauses)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">        )</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      (eval (append clauses '((otherwise otherwise))))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      )</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; &#8220;by&#8221; should be a &#8220;;&#8221;-seperated string of &#8220;to&#8221;-seperated pairs.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; renaming_ by</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  = rename_ :elements '(lambda (name)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      (let (clauses)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">        (thread-last by</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (s-split ";")</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (--map (s-split " to " it))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (--map (list (s-trim (car it)) (s-trim (cadr it))))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (-cons* 'pcase 'name)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (setq clauses)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">        )</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      (eval (append clauses '((otherwise otherwise))))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      )</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MR&#8348;&#8338; = M-Set record &#10228; renaming :by "Scalar to S; Vector to V; &#183; to nice"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MR&#8348;&#8338;_ = M-Set record &#10228; renaming_ :by "Scalar to S; Vector to V; _&#183;_ to _nice_"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">NearMonoid = M-Set record &#10228; renaming :by "Scalar to Carrier; Vector to Carrier; &#183; to &#215;"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

_ <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">MR&#8348;&#8338;</span>
_ <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">MR&#8348;&#8338;_</span>

--<span style="color: #ba2f59; font-weight: bold;"> As</span> <span style="color: #0000cd;">the</span> <span style="color: #0000cd;">underscore</span> <span style="color: #0000cd;">variant</span> <span style="color: #0000cd;">shows</span>, <span style="color: #0000cd;">one</span> <span style="color: #0000cd;">must</span> <span style="color: #0000cd;">ensure</span> <span style="color: #0000cd;">that</span> <span style="color: #0000cd;">the</span> <span style="color: #0000cd;">new</span> <span style="color: #0000cd;">names</span> <span style="color: #0000cd;">either</span> <span style="color: #0000cd;">are</span> <span style="color: #0000cd;">the</span> <span style="color: #0000cd;">same</span>
-- <span style="color: #0000cd;">fixity</span> <span style="color: #0000cd;">or</span> <span style="color: #0000cd;">are</span> <span style="color: #cd6600;">in</span> <span style="color: #0000cd;">prefix</span> <span style="color: #0000cd;">form</span> <span style="color: #cd6600;">in</span> <span style="color: #0000cd;">the</span> <span style="color: #ba2f59; font-weight: bold;">PackageFormer</span> <span style="color: #0000cd;">being</span> <span style="color: #0000cd;">instantiated</span>.

_ <span style="color: #cd6600;">=</span> Near<span style="color: #ba2f59; font-weight: bold;">Monoid</span>

--<span style="color: #ba2f59; font-weight: bold;"> Notice</span> <span style="color: #0000cd;">that</span> <span style="color: #0000cd;">this</span> <span style="color: #0000cd;">example</span> <span style="color: #0000cd;">demonstrates</span> <span style="color: #0000cd;">multiplicity</span> <span style="color: #0000cd;">of</span> <span style="color: #ba2f59; font-weight: bold;">PackageFormer</span> <span style="color: #0000cd;">elements</span> <span style="color: #0000cd;">is</span> <span style="color: #0000cd;">irrelevant</span>.
--<span style="color: #ba2f59; font-weight: bold;"> That</span> <span style="color: #0000cd;">is</span>, <span style="color: #0000cd;">elements</span> <span style="color: #0000cd;">are</span> <span style="color: #0000cd;">algebraically</span> <span style="color: #0000cd;">a</span> <span style="color: #0000cd;">list</span> <span style="color: #cd6600;">with</span> <span style="color: #0000cd;">the</span> <span style="color: #0000cd;">axiom</span> <span style="color: #0000cd;">xs</span> ++ <span style="color: #0000cd;">ys</span> ++ <span style="color: #0000cd;">xs</span>  &#8776;  <span style="color: #0000cd;">xs</span> ++ <span style="color: #0000cd;">ys</span>.

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">lisp</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">(defun is-sort (element) (s-contains? "Set" (target element)))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; single-sorted with-sort</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  = map :elements (lambda (e)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      (if (is-sort e) (map-name with-sort e) e)))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">NearMonoid&#185; = M-Set record &#10228; single-sorted :with-sort "Carrier"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

_ <span style="color: #cd6600;">=</span> Near<span style="color: #ba2f59; font-weight: bold;">Monoid&#185;</span>

-----------------------------------------------------------------------------------------
--- &#167;<span style="color: #a020f0;">6</span>. <span style="color: #ba2f59; font-weight: bold;">Modules: Opening</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-empty-module = :kind module :level none :waist 999</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Neato = M-Set empty-module</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #cd6600;">open</span><span style="color: #ba2f59; font-weight: bold;"> Neato</span> <span style="color: #cd6600;">using</span> () --<span style="color: #ba2f59; font-weight: bold;"> A</span> <span style="color: #cd6600;">module</span> <span style="color: #cd6600;">where</span> <span style="color: #0000cd;">the</span> <span style="color: #0000cd;">elements</span> <span style="color: #0000cd;">are</span> <span style="color: #0000cd;">all</span> <span style="color: #0000cd;">params</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">lisp</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; &#8220;with&#8221; is a renaming string-to-string function.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; open with</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  = :kind module</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    :level none</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    :waist 1</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    :waist-strings ("")</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    :alter-elements  (lambda (fs)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      (let ((kind "{! !}"))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">        (thread-last</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           (--map (format "%s to %s" (get-name it) (rename-mixfix with (get-name it))) fs)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           ;; Resulting elements must be a list, so we make a singleton list.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           (s-join "\n       ; ")</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           (format "    ( %s\n       )")</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           list</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">           ;; Stick on the renaming, which in turn requires an opening clause;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           ;; which in turn requires a module parameter.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           (cons "  renaming")</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           (cons (format "open %s &#8475; public" $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905;))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           (cons (format "&#8475; : %s" $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905;)))))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; &#8220;with&#8221; should be a &#8220;;&#8221;-seperated string of &#8220;to&#8221;-seperated pairs; c.g. &#8216;&#119985;-renaming&#8217;.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; opening with</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  = open :with '(lambda (name)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      (let (clauses)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">        (thread-last with</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (s-split ";")</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (--map (s-split " to " it))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (--map (list (s-trim (car it)) (s-trim (cadr it))))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (-cons* 'pcase 'name)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (setq clauses)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">        )</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      (eval (append clauses '((otherwise otherwise))))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      )</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; open-with decoration</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  = open :with (lambda (x) (concat x decoration)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-R = M-Set record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-R&#8321; = M-Set-R open :with (lambda (x) (concat x "&#8321;"))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-R&#8242; = M-Set-R open-with :decoration "&#8242;"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #cd6600;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>&#8321; <span style="color: #cd6600;">using</span> ()
<span style="color: #cd6600;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>&#8242; <span style="color: #cd6600;">using</span> ()

--<span style="color: #ba2f59; font-weight: bold;"> It</span> <span style="color: #0000cd;">is</span> <span style="color: #0000cd;">important</span> <span style="color: #0000cd;">to</span> <span style="color: #0000cd;">observe</span> <span style="color: #0000cd;">that</span> &#8216;<span style="color: #0000cd;">openings</span>&#8217; <span style="color: #0000cd;">are</span> <span style="color: #0000cd;">lossy</span>:
--<span style="color: #ba2f59; font-weight: bold;"> They</span> <span style="color: #0000cd;">lose</span> <span style="color: #0000cd;">the</span> <span style="color: #0000cd;">types</span> <span style="color: #0000cd;">of</span> <span style="color: #0000cd;">the</span> <span style="color: #0000cd;">declarations</span> <span style="color: #0000cd;">and</span> <span style="color: #0000cd;">so</span> <span style="color: #0000cd;">cannot</span> <span style="color: #0000cd;">be</span> <span style="color: #0000cd;">used</span> <span style="color: #0000cd;">further</span> <span style="color: #0000cd;">to</span> <span style="color: #0000cd;">construct</span>
-- <span style="color: #0000cd;">new</span> <span style="color: #0000cd;">pacaking</span> <span style="color: #0000cd;">mechanisms</span>.<span style="color: #ba2f59; font-weight: bold;"> They</span> <span style="color: #0000cd;">are</span> <span style="color: #0000cd;">a</span> <span style="color: #0000cd;">terminal</span> <span style="color: #0000cd;">construction</span>.

-----------------------------------------------------------------------------------------
--- &#167;<span style="color: #a020f0;">7</span>. Sub-<span style="color: #ba2f59; font-weight: bold;">PackageFormer</span>s:<span style="color: #ba2f59; font-weight: bold;"> Generated-by</span> <span style="color: #0000cd;">and</span><span style="color: #ba2f59; font-weight: bold;"> Keeping</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">lisp</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; &#8220;by&#8221; is a predicate on elements.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; generated by</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  = :alter-elements  (lambda (fs)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      (let* ( (yeses (--map (funcall by it) fs))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">              (get-yeses (lambda () (--filter it (--zip-with (if it other) yeses fs))))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">              (in-yeses (lambda (e)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">                          (--any</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">                           (s-contains? (s-replace "_" " " (get-name e)) (get-type it))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">                           (funcall get-yeses)))))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">        (loop for _ in fs do</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">              (loop for f in fs</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">                    for i from 0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">                    do ;; when f in yess, set f to be yes.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">                    (when (funcall in-yeses f) (setf (nth i yeses) t))))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">        (funcall get-yeses))))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

--<span style="color: #ba2f59; font-weight: bold;"> Here</span>'<span style="color: #0000cd;">s</span> <span style="color: #0000cd;">some</span> <span style="color: #0000cd;">nifty</span> <span style="color: #0000cd;">applications</span>!

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-sorts = generated :by (lambda (f) (s-contains? "Set" (target (get-type f))))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-Sorts = M-Set record &#10228; sorts</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
_ <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">M-Set-Sorts</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidSignature = M-Set record &#10228; generated :by (lambda (f) (and (s-contains? "Scalar" f) (not (s-contains? "Vector" f))))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
_ <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">MonoidSignature</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">lisp</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(defun targets-a-sort (element)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  (--any (s-contains? it (target element)) (-map #'get-name (-filter #'is-sort $&#119890;&#119897;&#119890;&#119898;&#119890;&#119899;&#119905;&#119904;))))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; signature = generated :by (lambda (f) (targets-a-sort f)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonSig = M-Set record &#10228; signature</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

_ <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">MonSig</span>

-----------------------------------------------------------------------------------------
--- &#167;<span style="color: #a020f0;">8</span>. <span style="color: #ba2f59; font-weight: bold;">Mechanising Homomorphism Formulations</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">lisp</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(defun to-subscript (n)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  (nth n '("&#8320;" "&#8321;" "&#8322;" "&#8323;" "&#8324;" "&#8325;" "&#8326;" "&#8327;" "&#8328;" "&#8329;")))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">(defun homify (typed-name sort)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  "Given a typed name, produce the associating &#8220;preservation&#8221; formula.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   E.g.,</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">            _&#183;_    : Scalar &#8594; Vector &#8594; Vector</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">            pres-&#183; : {x&#8321; : Scalar} &#8594; {x&#8322; : Vector} &#8594; map&#8322; (x&#8321; &#183; x&#8322;) = map&#8321; x&#8321; &#183;&#8242; map&#8322; x&#8322;</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">  Type &#964; gets variable x&#7522; provided (i, &#964;) &#8712; sorts; likewise we think of map&#7522; : &#964; &#8594; &#964;&#8242;.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  Note that we must have i &#8712; 0..9, otherwise there'll be unexpected subscripting errors.</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">  The target name is primed, &#8220;&#183;&#8242;&#8221;.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> "</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> (letf* ((sorts     (mapcar #'car sort))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">         ((symbol-function 'index) (lambda (s) (to-subscript (cdr (assoc it sort)))))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">         (tn&#8594;       (s-split " &#8594; " (get-type typed-name)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">         (arg-count (1- (length tn&#8594;)))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">         (all-indicies  (--map (index it) (--filter (member (s-trim it) sorts) tn&#8594;)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">         (indicies  (-drop-last 1 all-indicies))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">         (tgt-idx   (car (-take-last 1 all-indicies)))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">         (op        (get-name typed-name))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">         (args      (--map (concat "x" it) indicies))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">         (lhs       (format "map%s (%s %s)" tgt-idx op (s-join " " args)))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">         (op&#8242;       (rename-mixfix (lambda (n) (concat n "&#8242;")) op))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">         (map-args  (--map (format "(map%s x%s)" it it) indicies))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">         (rhs       (format "%s %s" op&#8242; (s-join " " map-args)))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">         (target    (format "  %s   &#8801;   %s" lhs rhs))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> )</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"> ;; Change the target type.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> (setq tn&#8594; (--map (when (assoc it sort) (format "{x%s : %s}" (index it) it)) tn&#8594;))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> (setf (nth arg-count tn&#8594;) target)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"> ;; Stick it all together, with an updated name.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> (make-tn</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   (format "pres-%s" (s-replace "_" "" (get-name typed-name)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   (s-join " &#8594; " tn&#8594;))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> )</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(homify "_&#183;_    : Scalar &#8594; Vector &#8594; Vector" '( ("Scalar" . 4) ("Vector" . 1)))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; hom</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  = record &#10228;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    :remark "The $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905; should be defined as a record."</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    :waist 2</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    :waist-strings ((format "open %s  Src" $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905;)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">                    (format "open %s&#8242; Tgt" $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905;)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">                    "field")</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    :alter-elements (lambda (es)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">    (let (maps eqns sorts)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">      ;; Construct the map&#7522; : sort&#7522; &#8594; sort&#7522;&#8242;; keeping track of (sort . i) pairs.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      (loop for e in es</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">            for i from 1</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">       do</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">         (when (is-sort e)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           (push (cons (get-name e) i) sorts)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           (push (format "map%s : %s &#8594; %s&#8242;" (to-subscript i) (get-name e) (get-name e))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">                 maps))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">          (when (and (targets-a-sort e) (not (is-sort e)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">            (push (homify e sorts) eqns)))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">    ;; Ensure we have a source and target space as elements.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    (-cons* "Src : M-Set-R"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">            "Tgt : M-Set-R"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    (reverse (-concat eqns maps)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Hom  = M-Set-R hom</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Hom&#178; = M-Set-R hom &#10228; renaming :by "map&#8321; to scalar; pres-&#120793; to unity"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
_ <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Hom</span>
_ <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Hom</span>&#178;
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Testing_Generated.agda </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This file is generated ;; do not alter. </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #cd6600;">open</span> <span style="color: #cd6600;">import</span> <span style="color: #a020f0;">Level</span>
<span style="color: #cd6600;">open</span> <span style="color: #cd6600;">import</span> <span style="color: #a020f0;">Data.Bool</span>
<span style="color: #cd6600;">open</span> <span style="color: #cd6600;">import</span> <span style="color: #a020f0;">Relation.Binary.PropositionalEquality</span> <span style="color: #cd6600;">using</span> (_&#8801;_)
<span style="color: #cd6600;">open</span> <span style="color: #cd6600;">import</span> <span style="color: #a020f0;">Data.String</span> <span style="color: #cd6600;">hiding</span> (_++_)
<span style="color: #cd6600;">open</span> <span style="color: #cd6600;">import</span> <span style="color: #a020f0;">Level</span><span style="color: #404040;"> as</span><span style="color: #ba2f59; font-weight: bold;"> Level</span>
<span style="color: #cd6600;">module</span> <span style="color: #a020f0;">Testing_Generated</span> <span style="color: #cd6600;">where</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Kind &#8220;PackageFormer&#8221; does not correspond  to a concrete Agda type. </span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">PackageFormer MonoidP : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    Carrier : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    _&#10814;_     : Carrier &#8594; Carrier &#8594; Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    Id      : Carrier</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    assoc   : &#8704; {x y z} &#8594; (x &#10814; y) &#10814; z &#8801; x &#10814; (y &#10814; z)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    leftId  : &#8704; {x : Carrier} &#8594; Id &#10814; x &#8801; x</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    rightId : &#8704; {x : Carrier} &#8594; x &#10814; Id &#8801; x </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>





<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Kind &#8220;PackageFormer&#8221; does not correspond  to a concrete Agda type. </span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">PackageFormer M-Set : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   Scalar  : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   Vector  : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   _&#183;_     : Scalar &#8594; Vector &#8594; Vector</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   &#120793;       : Scalar</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   _&#215;_     : Scalar &#8594; Scalar &#8594; Scalar</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   leftId  : {&#120011; : Vector}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   assoc   : {a b : Scalar} {&#120011; : Vector} &#8594; (a &#215; b) &#183; &#120011;  &#8801;  a &#183; (b &#183; &#120011;) </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Kind &#8220;PackageFormer&#8221; does not correspond  to a concrete Agda type. </span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">{- MonoidP&#8305;&#7496; = MonoidP identity </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #ba2f59; font-weight: bold;">PackageFormer MonoidP</span>&#8305;&#7496; :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
   <span style="color: #ba2f59; font-weight: bold;"> Carrier</span> : <span style="color: #cd6600;">Set</span>
    <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span>     :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>      :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #ba2f59; font-weight: bold;">rightId</span> : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594; <span style="color: #0000cd;">x</span> &#10814;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#8801; <span style="color: #0000cd;">x</span> -}


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Kind &#8220;PackageFormer&#8221; does not correspond  to a concrete Agda type. </span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">{- MonoidP&#8304;  = MonoidP </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #ba2f59; font-weight: bold;">PackageFormer MonoidP</span>&#8304; :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
   <span style="color: #ba2f59; font-weight: bold;"> Carrier</span> : <span style="color: #cd6600;">Set</span>
    <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span>     :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>      :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #ba2f59; font-weight: bold;">rightId</span> : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594; <span style="color: #0000cd;">x</span> &#10814;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#8801; <span style="color: #0000cd;">x</span> -}


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Kind &#8220;PackageFormer&#8221; does not correspond  to a concrete Agda type. </span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">{- MonoidP&#7580; = MonoidP &#10228; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #ba2f59; font-weight: bold;">PackageFormer MonoidP</span>&#7580; :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
   <span style="color: #ba2f59; font-weight: bold;"> Carrier</span> : <span style="color: #cd6600;">Set</span>
    <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span>     :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>      :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #ba2f59; font-weight: bold;">rightId</span> : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594; <span style="color: #0000cd;">x</span> &#10814;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#8801; <span style="color: #0000cd;">x</span> -}


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidT&#8323;   =  MonoidP record &#10228; :waist 3 :level dec </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> MonoidT</span>&#8323;<span style="color: #ba2f59; font-weight: bold;"> (Carrier</span> : <span style="color: #cd6600;">Set</span>) (<span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>)<span style="color: #ba2f59; font-weight: bold;"> (Id</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>) : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
  <span style="color: #cd6600;">field</span>
    <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #ba2f59; font-weight: bold;">rightId</span> : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594; <span style="color: #0000cd;">x</span> &#10814;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#8801; <span style="color: #0000cd;">x</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidT&#8322;   =  MonoidP typeclass&#8322; &#10228; :waist-strings ("private" "extra : Set&#8321;" "extra = Set" "field") </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> MonoidT</span>&#8322;<span style="color: #ba2f59; font-weight: bold;"> (Carrier</span> : <span style="color: #cd6600;">Set</span>) (<span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>) : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
  <span style="color: #cd6600;">private</span>
    <span style="color: #0000cd;">extra</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321;
    <span style="color: #0000cd;">extra</span> <span style="color: #cd6600;">=</span> <span style="color: #cd6600;">Set</span>
  <span style="color: #cd6600;">field</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>      :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #ba2f59; font-weight: bold;">rightId</span> : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594; <span style="color: #0000cd;">x</span> &#10814;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#8801; <span style="color: #0000cd;">x</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidT&#8324;   =  MonoidP typeclass :height 4 :level 'dec </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> MonoidT</span>&#8324;<span style="color: #ba2f59; font-weight: bold;"> (Carrier</span> : <span style="color: #cd6600;">Set</span>) (<span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>)<span style="color: #ba2f59; font-weight: bold;"> (Id</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>) (<span style="color: #ba2f59; font-weight: bold;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)) : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
  <span style="color: #cd6600;">field</span>
    <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #ba2f59; font-weight: bold;">rightId</span> : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594; <span style="color: #0000cd;">x</span> &#10814;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#8801; <span style="color: #0000cd;">x</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-Record = M-Set record </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-Record</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
  <span style="color: #ba2f59; font-weight: bold;"> Scalar</span>  : <span style="color: #cd6600;">Set</span>
  <span style="color: #ba2f59; font-weight: bold;"> Vector</span>  : <span style="color: #cd6600;">Set</span>
   _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
   &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-Typeclass&#8322; = M-Set typeclass&#8322; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-Typeclass</span>&#8322;<span style="color: #ba2f59; font-weight: bold;"> (Scalar</span> : <span style="color: #cd6600;">Set</span>)<span style="color: #ba2f59; font-weight: bold;"> (Vector</span> : <span style="color: #cd6600;">Set</span>) : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
   _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
   &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-Typeclass&#8323; = M-Set-Record typeclass :height 3 :level 'dec </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-Typeclass</span>&#8323;<span style="color: #ba2f59; font-weight: bold;"> (Scalar</span> : <span style="color: #cd6600;">Set</span>)<span style="color: #ba2f59; font-weight: bold;"> (Vector</span> : <span style="color: #cd6600;">Set</span>) (_&#183;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>) : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
   &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Kind &#8220;PackageFormer&#8221; does not correspond  to a concrete Agda type. </span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">{- M-Set&#8242; = M-Set primed-attempt </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #ba2f59; font-weight: bold;">PackageFormer M-Set</span>&#8242; :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
  <span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242; : <span style="color: #cd6600;">Set</span>
  <span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8242; : <span style="color: #cd6600;">Set</span>
   _&#183;&#8242;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
   &#120793;&#8242; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   _&#215;&#8242;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8242; : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8242; : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;) -}


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidR    =  MonoidP record </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> MonoidR</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
  <span style="color: #cd6600;">field</span>
   <span style="color: #ba2f59; font-weight: bold;"> Carrier</span> : <span style="color: #cd6600;">Set</span>
    <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span>     :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>      :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #ba2f59; font-weight: bold;">rightId</span> : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594; <span style="color: #0000cd;">x</span> &#10814;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#8801; <span style="color: #0000cd;">x</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidR&#8242;   =  MonoidP record &#10228; primed&#8343;&#8337;&#8348; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> MonoidR</span>&#8242; :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
  <span style="color: #cd6600;">field</span>
   <span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242; : <span style="color: #cd6600;">Set</span>
    _&#10814;&#8242;_ : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242; <span style="color: #cd6600;">in</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>&#8242; : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> <span style="color: #cd6600;">=</span> _&#10814;&#8242;_ <span style="color: #cd6600;">in</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8242; : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> <span style="color: #cd6600;">=</span> _&#10814;&#8242;_ <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Id</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>&#8242; <span style="color: #cd6600;">in</span> &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8242; : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> <span style="color: #cd6600;">=</span> _&#10814;&#8242;_ <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Id</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>&#8242; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span> <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8242; <span style="color: #cd6600;">in</span> &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #ba2f59; font-weight: bold;">rightId</span>&#8242; : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> <span style="color: #cd6600;">=</span> _&#10814;&#8242;_ <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Id</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>&#8242; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span> <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8242; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span> <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8242; <span style="color: #cd6600;">in</span> &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594; <span style="color: #0000cd;">x</span> &#10814;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#8801; <span style="color: #0000cd;">x</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidR&#8243;   =  MonoidR primed&#8343;&#8337;&#8348; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> MonoidR</span>&#8243; :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
  <span style="color: #cd6600;">field</span>
   <span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242; : <span style="color: #cd6600;">Set</span>
    _&#10814;&#8242;_ : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242; <span style="color: #cd6600;">in</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>&#8242; : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> <span style="color: #cd6600;">=</span> _&#10814;&#8242;_ <span style="color: #cd6600;">in</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8242; : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> <span style="color: #cd6600;">=</span> _&#10814;&#8242;_ <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Id</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>&#8242; <span style="color: #cd6600;">in</span> &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8242; : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> <span style="color: #cd6600;">=</span> _&#10814;&#8242;_ <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Id</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>&#8242; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span> <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8242; <span style="color: #cd6600;">in</span> &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #ba2f59; font-weight: bold;">rightId</span>&#8242; : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> <span style="color: #cd6600;">=</span> _&#10814;&#8242;_ <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Id</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>&#8242; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span> <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8242; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span> <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8242; <span style="color: #cd6600;">in</span> &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594; <span style="color: #0000cd;">x</span> &#10814;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#8801; <span style="color: #0000cd;">x</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Monoid&#8344; = MonoidR map&#8320; :elements (lambda (f) (make-tn (concat (get-name f) "&#8344;") (get-type f))) </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> Monoid</span>&#8344; :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
  <span style="color: #cd6600;">field</span>
   <span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8344; : <span style="color: #cd6600;">Set</span>
    <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span>&#8344; : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8344; <span style="color: #cd6600;">in</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>&#8344; : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8344; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span>&#8344; <span style="color: #cd6600;">in</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8344; : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8344; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span>&#8344; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Id</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>&#8344; <span style="color: #cd6600;">in</span> &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8344; : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8344; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span>&#8344; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Id</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>&#8344; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span> <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8344; <span style="color: #cd6600;">in</span> &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #ba2f59; font-weight: bold;">rightId</span>&#8344; : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8344; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span>&#8344; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Id</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>&#8344; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span> <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8344; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span> <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8344; <span style="color: #cd6600;">in</span> &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594; <span style="color: #0000cd;">x</span> &#10814;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#8801; <span style="color: #0000cd;">x</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Monoid&#8345; = MonoidR rename&#8321; :elements (lambda (name) (concat name "&#8345;")) </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> Monoid</span>&#8345; :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
  <span style="color: #cd6600;">field</span>
   <span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8345; : <span style="color: #cd6600;">Set</span>
    _&#10814;&#8345;_ : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8345; <span style="color: #cd6600;">in</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>&#8345; : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8345; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> <span style="color: #cd6600;">=</span> _&#10814;&#8345;_ <span style="color: #cd6600;">in</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8345; : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8345; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> <span style="color: #cd6600;">=</span> _&#10814;&#8345;_ <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Id</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>&#8345; <span style="color: #cd6600;">in</span> &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8345; : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8345; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> <span style="color: #cd6600;">=</span> _&#10814;&#8345;_ <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Id</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>&#8345; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span> <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8345; <span style="color: #cd6600;">in</span> &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #ba2f59; font-weight: bold;">rightId</span>&#8345; : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8345; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> <span style="color: #cd6600;">=</span> _&#10814;&#8345;_ <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Id</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>&#8345; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span> <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8345; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span> <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8345; <span style="color: #cd6600;">in</span> &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594; <span style="color: #0000cd;">x</span> &#10814;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#8801; <span style="color: #0000cd;">x</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">MR&#8242; = M-Set record &#10228; primer </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> MR</span>&#8242; :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
  <span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242;  : <span style="color: #cd6600;">Set</span>
  <span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8242;  : <span style="color: #cd6600;">Set</span>
   _&#183;&#8242;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8242; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8242;
   &#120793;&#8242;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242;
   _&#215;&#8242;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242;
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8242;  : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8242;}  &#8594;  &#120793;&#8242; &#183;&#8242; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8242;   : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242;} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8242;} &#8594; (<span style="color: #0000cd;">a</span> &#215;&#8242; <span style="color: #0000cd;">b</span>) &#183;&#8242; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183;&#8242; (<span style="color: #0000cd;">b</span> &#183;&#8242; &#120011;)


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">MR&#8321;&#8331;&#8322;    = M-Set record &#10228; decorated :by "&#8321;" &#10228; decorated :by "&#8322;" </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> MR</span>&#8321;&#8331;&#8322; :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
  <span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8321;&#8322; : <span style="color: #cd6600;">Set</span>
  <span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8321;&#8322; : <span style="color: #cd6600;">Set</span>
   _&#183;&#8321;&#8322;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8321;&#8322; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8321;&#8322; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8321;&#8322;
   &#120793;&#8321;&#8322; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8321;&#8322;
   _&#215;&#8321;&#8322;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8321;&#8322; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8321;&#8322; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8321;&#8322;
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8321;&#8322; : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8321;&#8322;}  &#8594;  &#120793;&#8321;&#8322; &#183;&#8321;&#8322; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8321;&#8322; : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8321;&#8322;} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8321;&#8322;} &#8594; (<span style="color: #0000cd;">a</span> &#215;&#8321;&#8322; <span style="color: #0000cd;">b</span>) &#183;&#8321;&#8322; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183;&#8321;&#8322; (<span style="color: #0000cd;">b</span> &#183;&#8321;&#8322; &#120011;)


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">the-MR   = M-Set record &#10228; co-decorated :by "the-" </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span> <span style="color: #0000cd;">the-MR</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
   <span style="color: #0000cd;">the-Scalar</span> : <span style="color: #cd6600;">Set</span>
   <span style="color: #0000cd;">the-Vector</span> : <span style="color: #cd6600;">Set</span>
   _<span style="color: #0000cd;">the-</span>&#183;_ : <span style="color: #0000cd;">the-Scalar</span> &#8594; <span style="color: #0000cd;">the-Vector</span> &#8594; <span style="color: #0000cd;">the-Vector</span>
   <span style="color: #0000cd;">the-</span>&#120793; : <span style="color: #0000cd;">the-Scalar</span>
   _<span style="color: #0000cd;">the-</span>&#215;_ : <span style="color: #0000cd;">the-Scalar</span> &#8594; <span style="color: #0000cd;">the-Scalar</span> &#8594; <span style="color: #0000cd;">the-Scalar</span>
   the-<span style="color: #ba2f59; font-weight: bold;">leftId</span> : {&#120011; : <span style="color: #0000cd;">the-Vector</span>}  &#8594;  <span style="color: #0000cd;">the-</span>&#120793; <span style="color: #0000cd;">the-</span>&#183; &#120011;  &#8801;  &#120011;
   the-<span style="color: #ba2f59; font-weight: bold;">assoc</span> : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> : <span style="color: #0000cd;">the-Scalar</span>} {&#120011; : <span style="color: #0000cd;">the-Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">the-</span>&#215; <span style="color: #0000cd;">b</span>) <span style="color: #0000cd;">the-</span>&#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> <span style="color: #0000cd;">the-</span>&#183; (<span style="color: #0000cd;">b</span> <span style="color: #0000cd;">the-</span>&#183; &#120011;)


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">MR-oh  = M-Set record &#10228; rename :elements (lambda (name) (pcase name ("Scalar" "S") (x x))) </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> MR-oh</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
  <span style="color: #ba2f59; font-weight: bold;"> S</span> : <span style="color: #cd6600;">Set</span>
  <span style="color: #ba2f59; font-weight: bold;"> Vector</span> : <span style="color: #cd6600;">Set</span>
   _&#183;_ :<span style="color: #ba2f59; font-weight: bold;"> S</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
   &#120793; :<span style="color: #ba2f59; font-weight: bold;"> S</span>
   _&#215;_ :<span style="color: #ba2f59; font-weight: bold;"> S</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> S</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> S</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span> : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span> : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> S</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">MR&#8348;&#8338; = M-Set record &#10228; renaming :by "Scalar to S; Vector to V; &#183; to nice" </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> MR</span>&#8348;&#8338; :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
  <span style="color: #ba2f59; font-weight: bold;"> S</span> : <span style="color: #cd6600;">Set</span>
  <span style="color: #ba2f59; font-weight: bold;"> V</span> : <span style="color: #cd6600;">Set</span>
   _<span style="color: #0000cd;">nice_</span> :<span style="color: #ba2f59; font-weight: bold;"> S</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> V</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> V</span>
   &#120793; :<span style="color: #ba2f59; font-weight: bold;"> S</span>
   _&#215;_ :<span style="color: #ba2f59; font-weight: bold;"> S</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> S</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> S</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span> : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> V</span>}  &#8594;  &#120793; <span style="color: #0000cd;">nice</span> &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span> : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> S</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> V</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) <span style="color: #0000cd;">nice</span> &#120011;  &#8801;  <span style="color: #0000cd;">a</span> <span style="color: #0000cd;">nice</span> (<span style="color: #0000cd;">b</span> <span style="color: #0000cd;">nice</span> &#120011;)


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">MR&#8348;&#8338;_ = M-Set record &#10228; renaming_ :by "Scalar to S; Vector to V; _&#183;_ to _nice_" </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> MR</span>&#8348;&#8338;_ :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
  <span style="color: #ba2f59; font-weight: bold;"> S</span> : <span style="color: #cd6600;">Set</span>
  <span style="color: #ba2f59; font-weight: bold;"> V</span> : <span style="color: #cd6600;">Set</span>
   _<span style="color: #0000cd;">nice_</span> :<span style="color: #ba2f59; font-weight: bold;"> S</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> V</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> V</span>
   &#120793; :<span style="color: #ba2f59; font-weight: bold;"> S</span>
   _&#215;_ :<span style="color: #ba2f59; font-weight: bold;"> S</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> S</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> S</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span> : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> V</span>}  &#8594;  &#120793; <span style="color: #0000cd;">nice</span> &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span> : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> S</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> V</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) <span style="color: #0000cd;">nice</span> &#120011;  &#8801;  <span style="color: #0000cd;">a</span> <span style="color: #0000cd;">nice</span> (<span style="color: #0000cd;">b</span> <span style="color: #0000cd;">nice</span> &#120011;)


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">NearMonoid = M-Set record &#10228; renaming :by "Scalar to Carrier; Vector to Carrier; &#183; to &#215;" </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> NearMonoid</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
  <span style="color: #ba2f59; font-weight: bold;"> Carrier</span> : <span style="color: #cd6600;">Set</span>
   _&#215;_ :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   &#120793; :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span> : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>}  &#8594;  &#120793; &#215; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span> : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#215; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#215; (<span style="color: #0000cd;">b</span> &#215; &#120011;)


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">NearMonoid&#185; = M-Set record &#10228; single-sorted :with-sort "Carrier" </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> NearMonoid</span>&#185; :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
  <span style="color: #ba2f59; font-weight: bold;"> Carrier</span> : <span style="color: #cd6600;">Set</span>
   _&#183;_ :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   &#120793; :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   _&#215;_ :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span> : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span> : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Neato = M-Set empty-module </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">module</span> <span style="color: #a020f0;">Neato</span><span style="color: #ba2f59; font-weight: bold;"> (Scalar</span> : <span style="color: #cd6600;">Set</span>)<span style="color: #ba2f59; font-weight: bold;"> (Vector</span> : <span style="color: #cd6600;">Set</span>) (_&#183;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>) (&#120793; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>) (_&#215;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>) (<span style="color: #ba2f59; font-weight: bold;">leftId</span> : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; &#120793; &#183; &#120011; &#8801; &#120011;) (<span style="color: #ba2f59; font-weight: bold;">assoc</span> : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011; &#8801; <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)) <span style="color: #cd6600;">where</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-R = M-Set record </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
  <span style="color: #ba2f59; font-weight: bold;"> Scalar</span>  : <span style="color: #cd6600;">Set</span>
  <span style="color: #ba2f59; font-weight: bold;"> Vector</span>  : <span style="color: #cd6600;">Set</span>
   _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
   &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-R&#8321; = M-Set-R open :with (lambda (x) (concat x "&#8321;")) </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">module</span> <span style="color: #a020f0;">M-Set-R</span>&#8321; (&#8475; :<span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>) <span style="color: #cd6600;">where</span>

 <span style="color: #cd6600;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span> &#8475; <span style="color: #cd6600;">public</span>
     <span style="color: #cd6600;">renaming</span>
       (<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> <span style="color: #0000cd;">to</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8321;
       ;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> <span style="color: #0000cd;">to</span><span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8321;
       ; _&#183;_ <span style="color: #0000cd;">to</span> _&#183;&#8321;_
       ; &#120793; <span style="color: #0000cd;">to</span> &#120793;&#8321;
       ; _&#215;_ <span style="color: #0000cd;">to</span> _&#215;&#8321;_
       ; <span style="color: #ba2f59; font-weight: bold;">leftId</span> <span style="color: #0000cd;">to</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8321;
       ; <span style="color: #ba2f59; font-weight: bold;">assoc</span> <span style="color: #0000cd;">to</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8321;
       )


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-R&#8242; = M-Set-R open-with :decoration "&#8242;" </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">module</span> <span style="color: #a020f0;">M-Set-R</span>&#8242; (&#8475; :<span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>) <span style="color: #cd6600;">where</span>

 <span style="color: #cd6600;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span> &#8475; <span style="color: #cd6600;">public</span>
     <span style="color: #cd6600;">renaming</span>
       (<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> <span style="color: #0000cd;">to</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242;
       ;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> <span style="color: #0000cd;">to</span><span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8242;
       ; _&#183;_ <span style="color: #0000cd;">to</span> _&#183;&#8242;_
       ; &#120793; <span style="color: #0000cd;">to</span> &#120793;&#8242;
       ; _&#215;_ <span style="color: #0000cd;">to</span> _&#215;&#8242;_
       ; <span style="color: #ba2f59; font-weight: bold;">leftId</span> <span style="color: #0000cd;">to</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8242;
       ; <span style="color: #ba2f59; font-weight: bold;">assoc</span> <span style="color: #0000cd;">to</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8242;
       )


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-Sorts = M-Set record &#10228; sorts </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-Sorts</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
  <span style="color: #ba2f59; font-weight: bold;"> Scalar</span>  : <span style="color: #cd6600;">Set</span>
  <span style="color: #ba2f59; font-weight: bold;"> Vector</span>  : <span style="color: #cd6600;">Set</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidSignature = M-Set record &#10228; generated :by (lambda (f) (and (s-contains? "Scalar" f) (not (s-contains? "Vector" f)))) </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> MonoidSignature</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
  <span style="color: #ba2f59; font-weight: bold;"> Scalar</span>  : <span style="color: #cd6600;">Set</span>
   &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">MonSig = M-Set record &#10228; signature </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> MonSig</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
  <span style="color: #ba2f59; font-weight: bold;"> Scalar</span>  : <span style="color: #cd6600;">Set</span>
  <span style="color: #ba2f59; font-weight: bold;"> Vector</span>  : <span style="color: #cd6600;">Set</span>
   _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
   &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Hom  = M-Set-R hom </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> Hom (Src</span> :<span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>)<span style="color: #ba2f59; font-weight: bold;"> (Tgt</span> :<span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>) :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">open</span> <span style="color: #ba2f59; font-weight: bold;">M-Set-R  Src</span>
 <span style="color: #cd6600;">open</span> <span style="color: #ba2f59; font-weight: bold;">M-Set-R&#8242; Tgt</span>
 <span style="color: #cd6600;">field</span>
   <span style="color: #0000cd;">map</span>&#8321; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242;
   <span style="color: #0000cd;">map</span>&#8322; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8242;
   <span style="color: #0000cd;">pres-</span>&#183; : {<span style="color: #0000cd;">x</span>&#8321; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} &#8594; {<span style="color: #0000cd;">x</span>&#8322; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594;   <span style="color: #0000cd;">map</span>&#8322; (_&#183;_ <span style="color: #0000cd;">x</span>&#8321; <span style="color: #0000cd;">x</span>&#8322;)   &#8801;   _&#183;&#8242;_ (<span style="color: #0000cd;">map</span>&#8321; <span style="color: #0000cd;">x</span>&#8321;) (<span style="color: #0000cd;">map</span>&#8322; <span style="color: #0000cd;">x</span>&#8322;)
   <span style="color: #0000cd;">pres-</span>&#120793; : <span style="color: #0000cd;">map</span>&#8321; (&#120793; )   &#8801;   &#120793;&#8242;
   <span style="color: #0000cd;">pres-</span>&#215; : {<span style="color: #0000cd;">x</span>&#8321; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} &#8594; {<span style="color: #0000cd;">x</span>&#8321; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} &#8594;   <span style="color: #0000cd;">map</span>&#8321; (_&#215;_ <span style="color: #0000cd;">x</span>&#8321; <span style="color: #0000cd;">x</span>&#8321;)   &#8801;   _&#215;&#8242;_ (<span style="color: #0000cd;">map</span>&#8321; <span style="color: #0000cd;">x</span>&#8321;) (<span style="color: #0000cd;">map</span>&#8321; <span style="color: #0000cd;">x</span>&#8321;)


<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Hom&#178; = M-Set-R hom &#10228; renaming :by "map&#8321; to scalar; pres-&#120793; to unity" </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> Hom</span>&#178;<span style="color: #ba2f59; font-weight: bold;"> (Src</span> :<span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>)<span style="color: #ba2f59; font-weight: bold;"> (Tgt</span> :<span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>) :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">open</span> <span style="color: #ba2f59; font-weight: bold;">M-Set-R  Src</span>
 <span style="color: #cd6600;">open</span> <span style="color: #ba2f59; font-weight: bold;">M-Set-R&#8242; Tgt</span>
 <span style="color: #cd6600;">field</span>
   <span style="color: #0000cd;">scalar</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242;
   <span style="color: #0000cd;">map</span>&#8322; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8242;
   <span style="color: #0000cd;">pres-</span>&#183; : {<span style="color: #0000cd;">x</span>&#8321; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} &#8594; {<span style="color: #0000cd;">x</span>&#8322; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594;   <span style="color: #0000cd;">map</span>&#8322; (_&#183;_ <span style="color: #0000cd;">x</span>&#8321; <span style="color: #0000cd;">x</span>&#8322;)   &#8801;   _&#183;&#8242;_ (<span style="color: #0000cd;">scalar</span> <span style="color: #0000cd;">x</span>&#8321;) (<span style="color: #0000cd;">map</span>&#8322; <span style="color: #0000cd;">x</span>&#8322;)
   <span style="color: #0000cd;">unity</span> : <span style="color: #0000cd;">scalar</span> (&#120793; )   &#8801;   &#120793;&#8242;
   <span style="color: #0000cd;">pres-</span>&#215; : {<span style="color: #0000cd;">x</span>&#8321; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} &#8594; {<span style="color: #0000cd;">x</span>&#8321; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} &#8594;   <span style="color: #0000cd;">scalar</span> (_&#215;_ <span style="color: #0000cd;">x</span>&#8321; <span style="color: #0000cd;">x</span>&#8321;)   &#8801;   _&#215;&#8242;_ (<span style="color: #0000cd;">scalar</span> <span style="color: #0000cd;">x</span>&#8321;) (<span style="color: #0000cd;">scalar</span> <span style="color: #0000cd;">x</span>&#8321;)
</pre>
</div>
</details>

<p>
Above is a sample source file which contains special comments that are picked up
by the prototype which then copy-paste-cuts to produce a generated file.
</p>

<p>
For this prototype, we have the following <a id="org49fea97">constraints</a>:
</p>

<ol class="org-ol">
<li>The type of a PackageFormer is <code>Set ℓ</code> where <code>ℓ</code> is the empty string
or a parenthesised expression of type <code>Level</code>.
<ul class="org-ul">
<li>In-particular, subscript types are not yet supported.</li>
</ul></li>

<li>The <code>where</code> keyword appears on the same line as the <code>PackageFormer</code> key-phrase.</li>

<li>The name of the PackageFormer should not contain <code>PackageFormer</code> as a sub-identifier.
<ul class="org-ul">
<li>Likewise, no element should be named <code>to</code>.</li>
</ul></li>

<li><p>
We are only considering single-sorted structures, for now.
</p>

<p>
The research <a href="https://alhassy.github.io/next-700-module-systems-proposal/">proposal</a> addresses how to move beyond this issue.
</p></li>
</ol>

<p>
There are many useful features outlined in the proposal, such as default implementations, that we
hope to include in the future. For now, we just want something that works, is decently documented, and
can be useful.
</p>
</div>
</div>
<div id="outline-container-org4234b5b" class="outline-2">
<h2 id="user-manual"><span class="section-number-2">2</span> User Manual</h2>
<div class="outline-text-2" id="text-user-manual">
<p>
If the previous section is unclear regarding the aims and uses of this prototype,
please consult the pre-print <a href="https://github.com/alhassy/next-700-module-systems-proposal/blob/master/Paper0.pdf">A Language Feature to Unbundle Data at Will</a>
or <a href="https://alhassy.github.io/next-700-module-systems-proposal/">the next 700 module systems proposal</a>.
</p>
</div>

<div id="outline-container-orgbd21942" class="outline-3">
<h3 id="orgbd21942"><span class="section-number-3">2.1</span> Installation</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Click here to obtain <a href="https://raw.githubusercontent.com/alhassy/next-700-module-systems-proposal/master/prototype/PackageFormer.el">PackageFormer.el</a>, place it somewhere, open an Agda file, execute
<code>M-x your/location/PackageFormer.el</code>, then enable the mode by executing <code>M-x 700-mode</code>.
</p>

<p>
<b>Alternatively</b>, add the following to your Emacs configuration file:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Ensure you have the pre-requsite libraries ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;;                                                                                       </span><span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">String and list manipulation libraries                                                ;;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">https://github.com/magnars/dash.el                                                    ;;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">https://github.com/magnars/s.el                                                       ;;</span>
<span style="color: #3a81c3;">(</span>package-install 's<span style="color: #3a81c3;">)</span>                <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8220;The long lost Emacs string manipulation library&#8221; ;;</span>
<span style="color: #3a81c3;">(</span>package-install 'dash<span style="color: #3a81c3;">)</span>             <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8220;A modern list library for Emacs&#8221;                 ;;</span>
<span style="color: #3a81c3;">(</span>package-install 'fold-this<span style="color: #3a81c3;">)</span>        <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Folding away regions of text                      ;;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Next, obtain the Elisp file, load it, and attach it to Agda.</span>

<span style="color: #3a81c3;">(</span>shell-command <span style="color: #6c3163;">(</span>concat <span style="color: #2d9574;">"curl "</span>
  <span style="color: #2d9574;">"https://raw.githubusercontent.com/alhassy/next-700-module-systems-proposal/master/PackageFormer.el "</span>
  <span style="color: #2d9574;">"&gt;&gt; ~/.emacs.d/PackageFormer.el"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span>load-file <span style="color: #2d9574;">"~/.emacs.d/PackageFormer.el"</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span>add-hook 'agda2-mode-hook #'700-mode<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
When you enable <code>700-mode</code>:
</p>

<ol class="org-ol">
<li>A menu-bar <code>700PackageFormers</code> will be added.</li>

<li>It will allow you to temporarily disable and enable this new feature,
as well as providing a help menu. Invoke <code>M-x 700-mode</code> to toggle turning off this feature
completely.</li>

<li>The string icon <code>700 (•̀ᴗ•́)و</code> is displayed in the mode line &#x2014;near the bottom of Emacs.</li>

<li>You may use <code>C-c c-l</code> as usual, but it will now recognise <a href="#orgfeb9199">700-comments</a> and generate
legitimate Agda code from them &#x2014;more on this later.

<ul class="org-ul">
<li>PackageFormer syntactical items are coloured green, PackageFormer names are
coloured yellow, and their instantiation are simply bolded.</li>
</ul></li>
</ol>

<p>
If you need any assistance, please contact me!
</p>
</div>
</div>

<div id="outline-container-orgc464f2d" class="outline-3">
<h3 id="orgc464f2d"><span class="section-number-3">2.2</span> Syntax</h3>
<div class="outline-text-3" id="text-2-2">
<p>
The prototype works by translating fictitious <a href="#org0f40ab6">700-syntax</a> into legitimate Agda;
as follows:
</p>
<div class="org-src-container">
<pre class="src src-agda">...<span style="color: #0000cd;">agda</span> <span style="color: #0000cd;">code</span> <span style="color: #0000cd;">here</span>...
<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">       ...700-syntactical items here...</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
...<span style="color: #0000cd;">more</span> <span style="color: #0000cd;">agda</span> <span style="color: #0000cd;">code</span>...
</pre>
</div>
<p>
Since the first section provides an example source fragment with both <a href="#orgfeb9199">700-comments</a> as well
as instantiations, we shall only enclose <a href="#org0f40ab6">700-syntax</a> in <a href="#orgfeb9199">700-comments</a> when it is surrounded
by other Agda code, and otherwise leave it free standing.
</p>

<p>
<i>We will provide full source listings at the end of discussions that only display fragments!</i>
</p>

<p>
<a id="org0f40ab6">700-syntax</a> is defined informally as follows:
</p>
<pre class="example">
⟪700-syntax⟫    ::=  ⟪PackageFormer⟫ | ⟪Instantiation⟫ | ⟪Agda⟫

⟪PackageFormer⟫ ::= PackageFormer ⟪Identifier⟫ : Set (⟪level⟫) where
               ⟪newline-with-indentation⟫ ⟪Element⟫*

⟪Element⟫       ::=  ⟪Identifier⟫ : ⟪Any-Agda-Type⟫

⟪Instantiation⟫ ::= ⟪Identifier⟫ = ⟪Identifier⟫ ⟪VariationalClause⟫

⟪VariationalClause⟫ ::= [⟪Identifier⟫] (:key (value))* (⟴ ⟪VariationalClause⟫)*
</pre>

<ul class="org-ul">
<li>One derives many presentations of a grouping mechanism by what we call ‘variational clauses’.
<ul class="org-ul">
<li><p>
In a 700-comment, one declares ‘variational’ such as
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>𝒱-typeclass height = :kind record :level dec :waist-strings ("field") :waist height</code></td>
</tr>
</tbody>
</table>

<p>
These are functions whose names begin with <code>𝒱-</code>, they may have arguments on the left-hand-side,
and their right hand side may invoke any of the 5 meta-primitives
<code>kind, waist, waist-strings, level, alter-elements</code> with any mixture of
arguments and concrete values.
</p>

<ul class="org-ul">
<li>To invoke a variational in an instantiation clause, arguments are not positional
but instead are passed by name &#x2014;e.g., <code>:key value</code>.</li>
</ul></li>
</ul></li>
</ul>

<ul class="org-ul">
<li>Example uses of the variational clauses could be seen in the <code>Testing.agda</code> listing in the first section above.</li>
</ul>
</div>
</div>

<div id="outline-container-orgd5c1ed0" class="outline-3">
<h3 id="orgd5c1ed0"><span class="section-number-3">2.3</span> Records and Meta-Primitives <code>:kind</code> &amp; <code>:waist-strings</code></h3>
<div class="outline-text-3" id="text-2-3">
<p>
Let's begin with the simplest thing: Realising these fictitious ‘PackageFormers’ as records.
</p>

<p>
An Agda ‘record’ is just a PackageFormer where the qualifier <code>PackageFormer</code> has been
replaced with <code>record</code> and the line separating <a href="#orgbfc27a3">parameters</a> and <a href="#org3a76688">fields</a> &#x2014;the ‘waist’&#x2014; has the special
Agda keyword <code>field</code>. We may declare this particular configuration using the meta-primitives
<code>:kind</code> and <code>:waist-strings</code>, as follows.
</p>
<div class="org-src-container">
<pre class="src src-agda">    <span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    &#119985;-record                 = :kind record :waist-strings ("field")</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
Unsurprisingly, we have elected to name this grouping mechanism configuration as <code>𝒱-record</code>.
The prefix <code>𝒱-</code> signals to the Elisp meta-program that this particular equation is intended
to be a variational and should be loaded into the database as such.
</p>

<p>
Remember: The prefix only occurs at the definition site, the call site omits it.
Indeed, we may now perform the following invocation &#x2014;within <a href="#orgfeb9199">700-comments</a>.
</p>

<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    M-Set-Record = M-Set record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
The system picks this up, looks up <code>M-Set</code> which was defined in the first section earlier,
looks up the variational <code>record</code>, then runs that configuration to generate:
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-Record</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
  <span style="color: #ba2f59; font-weight: bold;"> Scalar</span>  : <span style="color: #cd6600;">Set</span>
  <span style="color: #ba2f59; font-weight: bold;"> Vector</span>  : <span style="color: #cd6600;">Set</span>
   _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
   &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)
</pre>
</div>

<p>
Nothing too remarkable; the keyword <code>field</code> has been inserted and the rewrite <code>PackageFormer ↦ record</code>
has been performed.
</p>

<p>
Even though this is a prototype, we wish it to be useful to ourselves and to others
&#x2014;especially those who take a quick glance, think they got it, and try things out only to not have them work
immediately. As such, we have implemented a cute little error-reporting system.
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">If you try to load, <code>C-c C-l</code>, but your <a href="#org0f40ab6">700-syntax</a> is wrong, you get an immediate error explaining why ♥‿♥</td>
</tr>
</tbody>
</table>

<p>
For example, suppose we accidentally wrote <code>recorder</code> instead of <code>record</code> for the <code>:kind</code> as in the following.
</p>
<div class="org-src-container">
<pre class="src src-agda">    <span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    &#119985;-whoops  = :kind recorder :waist-strings ("field")</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">    </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<p>
Even thought we have the correct invocation, say <code>M-Set-Record = M-Set whoops</code>,
when we try to load our Agda file the Agda process is interrupted and we are warned:
</p>
<div class="org-src-container">
<pre class="src src-text"> 700: This kind &#8220;recorder&#8221; is not supported by Agda!
      Valid kinds: record, data, module, PackageFormer.

    &#8680;   M-Set-Record = M-Set whoops
    &#8680;   whoops  = :kind recorder :waist-strings ("field")
</pre>
</div>
<p>
The 700 system informs us of our fault in “quotes”, suggests a solution,
and points to the offending declaration hierarchy. Neato (•̀ᴗ•́)و
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Caution</td>
</tr>
</tbody>
</table>
<p>
We have taken care, in this subsection, to present the variation-invocation-generation stages separately
as they should be &#x2014;including the <b>important</b> new lines.
However, in the subsequent examples, we shall tersely present the three in one
in code fragment, as below. This is for exposition only; the three stages do not coexist in such close proximity.
</p>
<div class="org-src-container">
<pre class="src src-results-agda">    <span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">0. &#119985;ariation declaration</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">       1. Invocation declaration </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
       <span style="color: #a020f0;">2</span>.<span style="color: #ba2f59; font-weight: bold;"> Resulting Generation</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6316e60" class="outline-3">
<h3 id="org6316e60"><span class="section-number-3">2.4</span> Typeclasses &#x2014;Parameterised Records&#x2014; and Meta-Primitives <code>:waist</code> &amp; <code>:level</code></h3>
<div class="outline-text-3" id="text-2-4">
<p>
We mentioned the <a id="org919c143">“waist”</a> before, but what is it exactly?
I propose that the difference between ‘field’ and ‘parameter’
is an illusion &#x2014;as is that of ‘input’ and ‘output’ when one
considers relations rather than deterministic functions.
</p>

<p>
For example, let's alter the previous variation declaration to
lift the waist up 2 positions.
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-typeclass-attempt      = :kind record :waist-strings ("field") :waist 2</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   M-Set-TypeClass = M-Set typeclass-attempt</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-TypeClass (Scalar</span> : <span style="color: #cd6600;">Set</span>)<span style="color: #ba2f59; font-weight: bold;"> (Vector</span> : <span style="color: #cd6600;">Set</span>) :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
   _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
   &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)
</pre>
</div>

<p>
Notice that the first two elements of the PackageFormer have been lifted
into being <a href="#orgbfc27a3">parameters</a>, while the rest have been construed as <a href="#org3a76688">fields</a>.
</p>

<p>
While this typechecks according to Agda standards, it is not ideal to human
standards since the level of the resulting package is larger than necessary.
The meta-primitive <code>:level</code> allows us to <code>inc</code>-rement or <code>dec</code>-crement the
current level of a PackageFormer, so we may instead define:
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-typeclass&#8322;    = :kind record :waist-strings ("field") :waist 2 :level dec</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   M-Set-Typeclass&#8322; = M-Set-Record typeclass&#8322; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-Typeclass</span>&#8322;<span style="color: #ba2f59; font-weight: bold;"> (Scalar</span> : <span style="color: #cd6600;">Set</span>)<span style="color: #ba2f59; font-weight: bold;"> (Vector</span> : <span style="color: #cd6600;">Set</span>) : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
   _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
   &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)
</pre>
</div>

<p>
Unlike records, typeclasses scream to have an argument: The height of the waist.
Variationals may have arguments and we will cover this issue in a later subsection
in preference to continuing our purview of the meta-primitives.
</p>
</div>
</div>

<div id="outline-container-orgff1d072" class="outline-3">
<h3 id="orgff1d072"><span class="section-number-3">2.5</span> Primed Decoration and the Meta-Primitive <code>alter-elements</code></h3>
<div class="outline-text-3" id="text-2-5">
<p>
When we have two occurrences of a structure, we may want one of them to be decorated
say with a prime so as to disambiguate them easily rather than have to qualify all
of their components.
</p>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-primed-attempt  = :kind record :waist-strings ("field") :alter-elements (lambda(f) (map-name (concat name \"&#8242;\") f))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">   M-Set&#8242;-attempt = M-Set primed-attempt </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> M-Set</span>&#8242;-<span style="color: #0000cd;">attempt</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
  <span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242; : <span style="color: #cd6600;">Set</span>
  <span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8242; : <span style="color: #cd6600;">Set</span>
   _&#183;&#8242;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
   &#120793;&#8242; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   _&#215;&#8242;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8242; : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8242; : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)

<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This is crashing Agda code; as expected. Working improvements below. </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
There are number of issues to address.
</p>

<ol class="org-ol">
<li><p>
The system comes with a Lisp methods <code>map-name</code> and <code>map-type</code> that yield the name and type part,
respectively, of a typed-name such as <code>"the-name : the-type"</code>.
</p>

<p>
Upon invocation, their second argument may mention <i>symbols</i> <code>name</code>, or <code>type</code> respectively, to refer to
that part of their third argument &#x2014;the typed-name <code>f</code> above in the definition of <code>𝒱-primed-attempt</code>.
</p></li>

<li><p>
The <code>:key value</code> pairs have legitimate Lisp for the <code>value</code> positions.
</p>

<p>
The basics of list processing, such as maps/filters/folds, with Lisp suffice for a rich
inventory of possible configurations. Moreover, the functional nature of such higher-order
functions ought to be familiar to any Agda coder <a href="https://www.phrases.org.uk/meanings/worth-ones-salt.html">worth their salt</a>.
</p>

<p>
Here's a terse tutorial rendered as an <a href="https://alhassy.github.io/ElispCheatSheet/">Elisp Cheat Sheet</a>.
</p></li>

<li><p>
One would expect catenating a prime to the mixfix name <code>_×_</code> would yield <code>_×_′</code> but above
it yielded <code>_×′_</code>. Indeed, the former would yield confusing expressions of the form
<code>1 × 2 ′</code> whereas the latter permits <code>1 ×′ 2</code>. It is with this pragmatic usage that
<code>map-name</code> performs a rewrite to a name by jumping over the Agda mixfix marker, <code>_</code>,
if it occurs at the start or end of a name.
</p>

<p>
As an additional example, the name
<code>_≈_∶_</code>, under the above scheme, would have rewritten to <code>_≈_∶′_</code> thereby
allowing terms such as <code>x ≈ y ∶ A  →  f x ≈ f y ∶′ B</code> &#x2014;a elegant way to
express that, say, <code>f</code> is a setoid homomorphism.
If the prime scheme were instead a prepend, we would have obtained the name
<code>_′≈_∶_</code>.
</p></li>
</ol>

<p>
Notice that
we have <a href="#org3a76688">fields</a> such as <code>𝟙′ : Scalar</code>
whose type is a free variable: <code>Scalar</code> no longer refers to any field.
As such, the above code is ill-typed.
The solution then is to <i>propagate</i> any changes a name has down to its siblings.
</p>
</div>
</div>

<div id="outline-container-org83aeb77" class="outline-3">
<h3 id="org83aeb77"><span class="section-number-3">2.6</span> Composition <code>⟴</code> and First-class PackageFormers</h3>
<div class="outline-text-3" id="text-2-6">
<p>
Before we show how to fix the flawed <code>primed-attempt</code> definition,
it is important to note that the previous variational duplicated
the <code>record</code>'s definition in full.
</p>

<p>
Just because we can be silly, does not mean we must.
</p>

<p>
Let us drop that repeated portion.
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  &#119985;-primed-attempt = :alter-elements (lambda (fs) (mapcar (lambda (f) (map-name (concat name "&#8242;") f)) fs))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  M-Set&#8242; = M-Set primed-attempt</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Kind &#8220;PackageFormer&#8221; does not correspond  to a concrete Agda type.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">PackageFormer M-Set&#8242; : Set&#8321; where</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   Scalar&#8242; : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   Vector&#8242; : Set</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   _&#183;&#8242;_ : Scalar &#8594; Vector &#8594; Vector</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   &#120793;&#8242; : Scalar</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   _&#215;&#8242;_ : Scalar &#8594; Scalar &#8594; Scalar</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   leftId&#8242; : {&#120011; : Vector}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   assoc&#8242; : {a b : Scalar} {&#120011; : Vector} &#8594; (a &#215; b) &#183; &#120011;  &#8801;  a &#183; (b &#183; &#120011;)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
This is interesting: We have not generated a concrete &#x2014;legitimate Agda construct&#x2014;
but instead yielded a new abstract grouping mechanism which may be instantiated later on,
whenever desired.
</p>

<p>
Likewise, we have already declared <code>M-Set-Record = M-Set record</code> and now we may apply
our <code>primed</code> variational.
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-Record&#8242; = M-Set-Record primed </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-Record</span>&#8242;<span style="color: #ba2f59; font-weight: bold;"> (Scalar</span>&#8242; : <span style="color: #cd6600;">Set</span>)<span style="color: #ba2f59; font-weight: bold;"> (Vector</span>&#8242; : <span style="color: #cd6600;">Set</span>) :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
   _&#183;&#8242;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
   &#120793;&#8242; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   _&#215;&#8242;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8242; : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8242; : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><i>We may apply  variationals even to concrete Agda packaging constructs!</i></td>
</tr>
</tbody>
</table>

<p>
Of-course, we may simply want to obtain <code>M-Set-Record′</code> without having first
to define <code>M-Set-Record</code>, and so we may use the variational composition operator <code>⟴</code>.
</p>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-Record&#8242; = M-Set-Record record &#10228; primed </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-Record</span>&#8242;<span style="color: #ba2f59; font-weight: bold;"> (Scalar</span>&#8242; : <span style="color: #cd6600;">Set</span>)<span style="color: #ba2f59; font-weight: bold;"> (Vector</span>&#8242; : <span style="color: #cd6600;">Set</span>) :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
   _&#183;&#8242;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
   &#120793;&#8242; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   _&#215;&#8242;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8242; : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8242; : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)
</pre>
</div>

<p>
Since the <code>record</code> and <code>primed</code> configurations are ‘disjoint’, they commute
with respect to composition. The reader may want to confirm the following identifications:
</p>
<div class="org-src-container">
<pre class="src src-agda">      <span style="color: #ba2f59; font-weight: bold;">M-Set-Record&#8242;</span>
   &#8776; <span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #cd6600;">record</span> &#10228; <span style="color: #0000cd;">primed</span>
   &#8776; <span style="color: #ba2f59; font-weight: bold;"> M-Set</span> <span style="color: #0000cd;">primed</span> &#10228; <span style="color: #cd6600;">record</span>
   &#8776; <span style="color: #ba2f59; font-weight: bold;"> M-Set</span>&#8242; <span style="color: #cd6600;">record</span>
   &#8776;  <span style="color: #ba2f59; font-weight: bold;">M-Set-Record primed</span>
</pre>
</div>

<p>
It is important to remember that these primed perspectives do <i>not</i> typecheck in Agda due to the free-variable
issue mentioned earlier. We are only demonstrating composition, <code>⟴</code>, in this section; in a later section we
fix-up <code>primed</code>.
</p>
</div>
</div>

<div id="outline-container-orgbf6cc26" class="outline-3">
<h3 id="orgbf6cc26"><span class="section-number-3">2.7</span> Forming Syntax and the Special <code>$𝑛𝑎𝑚𝑒</code> Variable</h3>
<div class="outline-text-3" id="text-2-7">
<p>
Records provide a semantics, what if we want the syntax?
</p>

<p>
Since <code>data</code> declarations consist of constructors, whose target type necessarily
begins with the name of the <code>data</code>-type being defined, let's only keep those <a href="#org3a76688">fields</a> and drop the rest.
To do so, we use the helper function <code>target</code> which takes a declaration <code>name : type0 → ⋯ → typeN</code> and yields <code>typeN</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">target</span> <span style="color: #6c3163;">(</span>thing<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">" Given a declaration &#8220;name : type0 &#8594; &#8943; &#8594; typeN&#8221;, yield &#8220;typeN&#8221;. "</span>
  <span style="color: #6c3163;">(</span>car <span style="color: #2d9574;">(</span>-take-last 1 <span style="color: #67b11d;">(</span>s-split <span style="color: #2d9574;">"&#8594;"</span> thing<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
With this in hand, a <code>data</code> presentation requires a designated <code>carrier</code> which is used to
keep only those elements that target it. Finally, as data constructor must target the
type being defined, we alter the filtered elements by changing every instance of the
carrier name with the name of the newly defined PackageFormer &#x2014;which we may access
using the special identifier <code>$𝑛𝑎𝑚𝑒</code>. In a <code>lisp</code> comment, we formalise this algorithm as follows.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">&#119985;</span> data carrier
  = <span style="color: #3a81c3;">:kind</span> data
    <span style="color: #3a81c3;">:level</span> dec
    <span style="color: #3a81c3;">:alter-elements</span> <span style="color: #6c3163;">(</span><span style="color: #cd6600;">lambda</span> <span style="color: #2d9574;">(</span>fs<span style="color: #2d9574;">)</span>
      <span style="color: #2d9574;">(</span><span style="color: #cd6600;">thread-last</span> fs
        <span style="color: #67b11d;">(</span><span style="color: #cd6600;">--filter</span> <span style="color: #b1951d;">(</span>s-contains? carrier <span style="color: #3a81c3;">(</span>target <span style="color: #6c3163;">(</span>get-type it<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
        <span style="color: #67b11d;">(</span><span style="color: #cd6600;">--map</span> <span style="color: #b1951d;">(</span><span style="color: #cd6600;">map-type</span> <span style="color: #3a81c3;">(</span>s-replace carrier $&#119899;&#119886;&#119898;&#119890; type<span style="color: #3a81c3;">)</span> it<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
For example:
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">ScalarTerm    = M-Set data :carrier "Scalar" &#10228; primer </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">data</span><span style="color: #ba2f59; font-weight: bold;"> ScalarTerm</span> : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
   &#120793;&#8242; :<span style="color: #ba2f59; font-weight: bold;"> ScalarTerm</span>
   _&#215;&#8242;_ :<span style="color: #ba2f59; font-weight: bold;"> ScalarTerm</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> ScalarTerm</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> ScalarTerm</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">ScalarSyntax = M-Set primer &#10228; data :carrier "Scalar&#8242;" </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">data</span><span style="color: #ba2f59; font-weight: bold;"> ScalarSyntax</span> : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
   &#120793;&#8242; :<span style="color: #ba2f59; font-weight: bold;"> ScalarSyntax</span>
   _&#215;&#8242;_ :<span style="color: #ba2f59; font-weight: bold;"> ScalarSyntax</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> ScalarSyntax</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> ScalarSyntax</span>
</pre>
</div>

<p>
Again:
The meta-primitive <code>:alter-elements</code> is instructed to map over those
<a href="#org3a76688">fields</a> <code>f</code> that contain the <code>carrier</code> in their <code>target</code> type
by replacing the given <code>carrier</code> with the newly-minted <code>$𝑛𝑎𝑚𝑒</code> of
the grouping mechanism being constructed. Those that do not
contain the given <code>carrier</code> in their target type are filtered out.
</p>

<p>
Notice that $𝑛𝑎𝑚𝑒 is a special variable that refers to the newly defined PackageFormer's name.
</p>
<ul class="org-ul">
<li>It is written using <code>\Mi</code> with Agda input; e.g., <code>\Min</code> gives <code>𝑛</code>.</li>
<li>The ‘$’ is intended to further mark the special nature of this variable.</li>
</ul>

<p>
<b>Important</b>: Notice that, in the second example above,
the name of the carrier is <code>Scalar′</code> since we changed the
PackageFormer to prime all elements, including the <code>Scalar</code>, element.
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">No = M-Set primer &#10228; data :carrier "Scalar" </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">data</span><span style="color: #ba2f59; font-weight: bold;"> No</span> : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
   &#120793;&#8242; :<span style="color: #ba2f59; font-weight: bold;"> No</span>&#8242;
   _&#215;&#8242;_ :<span style="color: #ba2f59; font-weight: bold;"> No</span>&#8242; &#8594;<span style="color: #ba2f59; font-weight: bold;"> No</span>&#8242; &#8594;<span style="color: #ba2f59; font-weight: bold;"> No</span>&#8242;

<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Crashes since type No&#8242; is not defined! </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf493afb" class="outline-3">
<h3 id="orgf493afb"><span class="section-number-3">2.8</span> Variationals with Arguments ---<code>map, rename, [co]decorated, renaming</code></h3>
<div class="outline-text-3" id="text-2-8">
<p>
Thus far our variationals have been nullary, let's consider otherwise.
</p>

<p>
For example, let's add arguments to the typeclass variational from earlier.
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-typeclass height level = :kind record :waist-strings ("field") :waist height :level level</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-Typeclass&#8323; = M-Set-Record typeclass :height 3 :level 'dec </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-Typeclass</span>&#8323;<span style="color: #ba2f59; font-weight: bold;"> (Scalar</span> : <span style="color: #cd6600;">Set</span>)<span style="color: #ba2f59; font-weight: bold;"> (Vector</span> : <span style="color: #cd6600;">Set</span>) (_&#183;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>) : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
   &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)
</pre>
</div>

<ul class="org-ul">
<li>Argument come before the <code>=</code> in a variational's definition and
the may be used as if they were constants on the right-hand side.
<ul class="org-ul">
<li>Above we introduced the named arguments <code>height</code> and <code>level</code>.</li>
<li>We then passed the <i>argument</i> <code>level</code> to the <i>meta-primitive</i> <code>:level</code>.</li>
</ul></li>

<li><p>
Invocation of variationals with arguments uses named invocation, rather than
positional application. One supplies an argument in the form <code>:argument-name the-value</code>.
</p>

<p>
Consequently, position is irrelevant in such invocations.
</p>

<ul class="org-ul">
<li>Supplying <code>:key value</code> pairs where the <code>key</code> is not a named argument of
the variational yields a error message indicating the allowable keys.
<ul class="org-ul">
<li>There is an implementation key, <code>*parent-context*</code>, which is used to
capture the current context for error-reporting purposes and should
not be altered by the user &#x2014;otherwise they may obtain less than helpful
error messages.</li>
</ul></li>
</ul></li>
</ul>

<p>
<i>Anyhow, like <code>record</code> and <code>primed</code>, this <code>typeclass</code> variational is actually useful in practice.</i>
</p>

<p>
Let's turn to a slightly more complicated example: Generalising <code>primed</code> to take arguments. Whenever a name <code>x</code> is primed, all subsequent elements' type should be
preprended with <code>let x = x′ in</code> to propagate this change.
</p>

<p>
Since 700-declarations must be single lines, we are forced to have something like
the following &#x2014;which you are not expected to understand, but it serves as a nice
comparison and motivation for the alternative approach below.
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-primed&#8343;&#8337;&#8348; = :alter-elements (lambda (fs) (-as-&gt; (-unzip (--zip-with `(,other  ,(format "let %s = %s in " (get-name it) (get-name other))) fs (--map (map-name (concat name "&#8242;") it) fs))) yup (--zip-with (map-type (concat (s-join "" it) type) other) (-inits (cadr yup)) (car yup))))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidR&#8242;   =  MonoidP record &#10228; primed&#8343;&#8337;&#8348;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> MonoidR</span>&#8242; :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
  <span style="color: #cd6600;">field</span>
   <span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242; : <span style="color: #cd6600;">Set</span>
    _&#10814;&#8242;_ : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242; <span style="color: #cd6600;">in</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #ba2f59; font-weight: bold;"> Id</span>&#8242; : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> <span style="color: #cd6600;">=</span> _&#10814;&#8242;_ <span style="color: #cd6600;">in</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
    <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8242; : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> <span style="color: #cd6600;">=</span> _&#10814;&#8242;_ <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Id</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>&#8242; <span style="color: #cd6600;">in</span> &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8242; : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> <span style="color: #cd6600;">=</span> _&#10814;&#8242;_ <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Id</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>&#8242; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span> <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8242; <span style="color: #cd6600;">in</span> &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #ba2f59; font-weight: bold;">rightId</span>&#8242; : <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Carrier</span>&#8242; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">_&#10814;_</span> <span style="color: #cd6600;">=</span> _&#10814;&#8242;_ <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span><span style="color: #ba2f59; font-weight: bold;"> Id</span> <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> Id</span>&#8242; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span> <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8242; <span style="color: #cd6600;">in</span> <span style="color: #cd6600;">let</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span> <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8242; <span style="color: #cd6600;">in</span> &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594; <span style="color: #0000cd;">x</span> &#10814;<span style="color: #ba2f59; font-weight: bold;"> Id</span> &#8801; <span style="color: #0000cd;">x</span>

</pre>
</div>

<p>
This is a prototype; ideally the variational definition would be rendered in
Agda code. Notice that the above incantation is composed of functional combinators
<code>unzip, map, zip-with</code>. Anyhow, here is a better approach to doing essentially the
same thing; for diversity, the following scheme will not produce <code>let…in…</code> clauses
but instead perform a substitution everywhere and will utilise imperative constructs.
</p>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">lisp</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; primer = :alter-elements (lambda (fs)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   (let ((fsnew fs)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">         (names (--map (s-replace "_" "" (get-name it)) fs)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     (loop for old in names</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           for new in (--map (concat it "&#8242;") names)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           do</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           ;; (message-box "old %s; new %s" old new)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           (setq fsnew (--map (s-replace old new it) fsnew)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     ;; return value</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     fsnew</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     )))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MR&#8242; = M-Set record &#10228; primer</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> MR</span>&#8242; :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
  <span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242;  : <span style="color: #cd6600;">Set</span>
  <span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8242;  : <span style="color: #cd6600;">Set</span>
   _&#183;&#8242;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8242; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8242;
   &#120793;&#8242;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242;
   _&#215;&#8242;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242;
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8242;  : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8242;}  &#8594;  &#120793;&#8242; &#183;&#8242; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8242;   : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242;} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8242;} &#8594; (<span style="color: #0000cd;">a</span> &#215;&#8242; <span style="color: #0000cd;">b</span>) &#183;&#8242; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183;&#8242; (<span style="color: #0000cd;">b</span> &#183;&#8242; &#120011;)
</pre>
</div>

<p>
Important distinctions include:
</p>

<ol class="org-ol">
<li>The Lisp code now lives in a <code>{-lisp ⋯ -}</code> block.</li>

<li><a href="#orgfeb9199">700-comments</a> have single-line <code>𝒱-name args = rhs</code>, whereas lisp-blocks
have multi-line <code>(𝒱 name args = rhs)</code> &#x2014;the dash after the 𝒱 is gone and outer-most
parenthesis are added.</li>

<li><p>
To provide minimal accommodation for mixfix names, we simply remove the
Agda argument indicator ‘_’ when performing rewrites.
</p>

<p>
Let's code this up as a reusable pattern &#x2014;call it <code>map</code>.
</p></li>
</ol>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">lisp</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; map elements = :alter-elements (lambda (fs)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   (let* ((fsnew (mapcar elements fs))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (names  (--map (s-replace "_" "" (get-name it)) fs))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (names&#8242; (--map (s-replace "_" "" (get-name it)) fsnew)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     (loop for old in names</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           for new in names&#8242;</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           do</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">           (setq fsnew (--map (map-type (s-replace old new type) it) fsnew)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     ;; return value</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     fsnew</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     )))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
Now for some useful corollaries. For diversity, we render these in lisp-blocks.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">lisp</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; rename elements</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  = map :elements</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     (lambda (f) (make-tn (rename-mixfix elements (get-name f)) (get-type f))))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; decorated    by  =  rename :elements (lambda (name) (concat name by)))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; co-decorated by  =  rename :elements (lambda (name) (concat by name)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
Here are sample uses.
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">MR&#8321;&#8331;&#8322;    = M-Set record &#10228; decorated :by "&#8321;" &#10228; decorated :by "&#8322;" </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> MR</span>&#8321;&#8331;&#8322; :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
  <span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8321;&#8322; : <span style="color: #cd6600;">Set</span>
  <span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8321;&#8322; : <span style="color: #cd6600;">Set</span>
   _&#183;&#8321;&#8322;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8321;&#8322; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8321;&#8322; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8321;&#8322;
   &#120793;&#8321;&#8322; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8321;&#8322;
   _&#215;&#8321;&#8322;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8321;&#8322; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8321;&#8322; &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8321;&#8322;
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8321;&#8322; : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8321;&#8322;}  &#8594;  &#120793;&#8321;&#8322; &#183;&#8321;&#8322; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8321;&#8322; : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8321;&#8322;} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8321;&#8322;} &#8594; (<span style="color: #0000cd;">a</span> &#215;&#8321;&#8322; <span style="color: #0000cd;">b</span>) &#183;&#8321;&#8322; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183;&#8321;&#8322; (<span style="color: #0000cd;">b</span> &#183;&#8321;&#8322; &#120011;)

<span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">the-MR = M-Set record &#10228; co-decorated :by "the-" </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span> <span style="color: #0000cd;">the-MR</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
   <span style="color: #0000cd;">the-Scalar</span> : <span style="color: #cd6600;">Set</span>
   <span style="color: #0000cd;">the-Vector</span> : <span style="color: #cd6600;">Set</span>
   _<span style="color: #0000cd;">the-</span>&#183;_ : <span style="color: #0000cd;">the-Scalar</span> &#8594; <span style="color: #0000cd;">the-Vector</span> &#8594; <span style="color: #0000cd;">the-Vector</span>
   <span style="color: #0000cd;">the-</span>&#120793; : <span style="color: #0000cd;">the-Scalar</span>
   _<span style="color: #0000cd;">the-</span>&#215;_ : <span style="color: #0000cd;">the-Scalar</span> &#8594; <span style="color: #0000cd;">the-Scalar</span> &#8594; <span style="color: #0000cd;">the-Scalar</span>
   the-<span style="color: #ba2f59; font-weight: bold;">leftId</span> : {&#120011; : <span style="color: #0000cd;">the-Vector</span>}  &#8594;  <span style="color: #0000cd;">the-</span>&#120793; <span style="color: #0000cd;">the-</span>&#183; &#120011;  &#8801;  &#120011;
   the-<span style="color: #ba2f59; font-weight: bold;">assoc</span> : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> : <span style="color: #0000cd;">the-Scalar</span>} {&#120011; : <span style="color: #0000cd;">the-Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">the-</span>&#215; <span style="color: #0000cd;">b</span>) <span style="color: #0000cd;">the-</span>&#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> <span style="color: #0000cd;">the-</span>&#183; (<span style="color: #0000cd;">b</span> <span style="color: #0000cd;">the-</span>&#183; &#120011;)
</pre>
</div>

<p>
Example <code>M₁₋₂</code> demonstrates that composition, ⟴, is sequential from left to right.
That is, “⟴” is just forwards composition: We thread the given PackageFormer
through the variationals <code>vᵢ</code> in order. Operationally:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Pf v₀ ⟴ ⋯ ⟴ vₙ ≈ ((Pf v₀) v₁) ⋯) vₙ</td>
</tr>

<tr>
<td class="org-left">Pf ⟴ v  ≈  Pf v ⟴  ≈  Pf v</td>
</tr>
</tbody>
</table>

<p>
Note: In the concrete syntax, parenthesisation is not permitted.
</p>

<p>
What if we want Agda-style renaming via <code>to</code>-lists?
We can simply code that up!
</p>

<p>
Directly, for a one-time use:
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">MR-oh  = M-Set record &#10228; rename :elements (lambda (name) (pcase name ("Scalar" "S") (x x))) </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> MR-oh</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
  <span style="color: #ba2f59; font-weight: bold;"> S</span> : <span style="color: #cd6600;">Set</span>
  <span style="color: #ba2f59; font-weight: bold;"> Vector</span> : <span style="color: #cd6600;">Set</span>
   _&#183;_ :<span style="color: #ba2f59; font-weight: bold;"> S</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
   &#120793; :<span style="color: #ba2f59; font-weight: bold;"> S</span>
   _&#215;_ :<span style="color: #ba2f59; font-weight: bold;"> S</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> S</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> S</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span> : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span> : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> S</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)
</pre>
</div>

<p>
More generally, as a variational pattern:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">lisp</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; &#8220;by&#8221; should be a &#8220;;&#8221;-seperated string of &#8220;to&#8221;-seperated pairs.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; renaming by</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  = rename :elements '(lambda (name)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      (let (clauses)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">        (thread-last by</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (s-split ";")</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (--map (s-split " to " it))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (--map (list (s-trim (car it)) (s-trim (cadr it))))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (-cons* 'pcase 'name)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">          (setq clauses)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">        )</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      (eval (append clauses '((otherwise otherwise))))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      )</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
<p>
With sample use:
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">NearMonoid = M-Set record &#10228; renaming :by "Scalar to Carrier; Vector to Carrier; &#183; to &#215;" </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> NearMonoid</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
  <span style="color: #ba2f59; font-weight: bold;"> Carrier</span> : <span style="color: #cd6600;">Set</span>
   _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>}  &#8594;  &#120793; &#215; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#215; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#215; (<span style="color: #0000cd;">b</span> &#215; &#120011;)
</pre>
</div>

<p>
This is so cool: We can just extend the system with whatever pattern we prefer!
No more bending to the will of language designers! More power to the user!
</p>

<p>
For example, we can codify the previous scheme into a top-level pattern.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">lisp</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">(defun is-sort (element) (s-contains? "Set" (target element)))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; single-sorted with-sort</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  = map :elements (lambda (e)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">      (if (is-sort e) (map-name with-sort e) e)))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>

<p>
Then the previous PackageFormer can be obtained with:
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">NearMonoid = M-Set record &#10228; single-sorted :with-sort "Carrier"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdc3d98d" class="outline-3">
<h3 id="orgdc3d98d"><span class="section-number-3">2.9</span> Shallow Renaming with Agda's <code>open ⋯ public ⋯ renaming ⋯</code></h3>
<div class="outline-text-3" id="text-2-9">
<p>
The previous approach to renaming altered field names literally which is not
desirable when one only wants to refer to field names of multiple instances
of the same record &#x2014;e.g., when forming homomorphisms.
</p>

<p>
A common pattern in Agda is then to open the record and perform the desired
shallow renames. This pattern is so common that the standard library is littered
with instances of it. We can codify the pattern as a method rather than as a
manual technique.
</p>

<p>
Let's go from zero to one-hundred &#x2014;again: There's a Lisp Cheat Sheet that should
have been consulted at one point.
</p>

<p>
Zero: A module where the elements are all <a href="#orgbfc27a3">parameters</a>.
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-empty-module = :kind module :level none :waist 999</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Neato = M-Set empty-module</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #cd6600;">module</span> <span style="color: #a020f0;">Neato</span><span style="color: #ba2f59; font-weight: bold;"> (Scalar</span> : <span style="color: #cd6600;">Set</span>)<span style="color: #ba2f59; font-weight: bold;"> (Vector</span> : <span style="color: #cd6600;">Set</span>) (_&#183;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>) (&#120793; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>) (_&#215;_ :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>) (<span style="color: #ba2f59; font-weight: bold;">leftId</span> : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; &#120793; &#183; &#120011; &#8801; &#120011;) (<span style="color: #ba2f59; font-weight: bold;">assoc</span> : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011; &#8801; <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)) <span style="color: #cd6600;">where</span>
</pre>
</div>

<p>
One-hundred: A one-parameter module where elements may be renamed.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8220;with&#8221; is a renaming string-to-string function.</span>
<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">&#119985;</span> open with
  = <span style="color: #3a81c3;">:kind</span> module
    <span style="color: #3a81c3;">:level</span> none
    <span style="color: #3a81c3;">:waist</span> 1
    <span style="color: #3a81c3;">:waist-strings</span> '<span style="color: #6c3163;">(</span><span style="color: #2d9574;">""</span><span style="color: #6c3163;">)</span>
    <span style="color: #3a81c3;">:alter-elements</span>  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">lambda</span> <span style="color: #2d9574;">(</span>fs<span style="color: #2d9574;">)</span>
      <span style="color: #2d9574;">(</span><span style="color: #cd6600;">let</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>kind <span style="color: #2d9574;">"{! !}"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
        <span style="color: #67b11d;">(</span><span style="color: #cd6600;">thread-last</span>
           <span style="color: #b1951d;">(</span><span style="color: #cd6600;">--map</span> <span style="color: #3a81c3;">(</span>format <span style="color: #2d9574;">"%s to %s"</span> <span style="color: #6c3163;">(</span>get-name it<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>rename-mixfix with <span style="color: #2d9574;">(</span>get-name it<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> fs<span style="color: #b1951d;">)</span>
           <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Resulting elements must be a list, so we make a singleton list.</span>
           <span style="color: #b1951d;">(</span>s-join <span style="color: #2d9574;">"\n       ; "</span><span style="color: #b1951d;">)</span>
           <span style="color: #b1951d;">(</span>format <span style="color: #2d9574;">"    ( %s\n       )"</span><span style="color: #b1951d;">)</span>
           list

           <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Stick on the renaming, which in turn requires an opening clause;</span>
           <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">which in turn requires a module parameter.</span>
           <span style="color: #b1951d;">(</span>cons <span style="color: #2d9574;">"  renaming"</span><span style="color: #b1951d;">)</span>
           <span style="color: #b1951d;">(</span>cons <span style="color: #3a81c3;">(</span>format <span style="color: #2d9574;">"open %s &#8475; public"</span> $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905;<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
           <span style="color: #b1951d;">(</span>cons <span style="color: #3a81c3;">(</span>format <span style="color: #2d9574;">"&#8475; : %s"</span> $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905;<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">&#119985;</span> open-with decoration
  = open <span style="color: #3a81c3;">:with</span> <span style="color: #6c3163;">(</span><span style="color: #cd6600;">lambda</span> <span style="color: #2d9574;">(</span>x<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span>concat x decoration<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Here is an example use &#x2014;where we first declare a <code>record</code> perspective of <code>M-Set</code>'s then
use that to produce two decorated variants.
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-R = M-Set record</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-R&#8321; = M-Set-R open :with (lambda (x) (concat x "&#8321;"))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-R&#8322; = M-Set-R open-with :decoration "&#8322;"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #cd6600;">module</span> <span style="color: #a020f0;">M-Set-R</span>&#8321; (&#8475; :<span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>) <span style="color: #cd6600;">where</span>
   <span style="color: #cd6600;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span> &#8475; <span style="color: #cd6600;">public</span>
     <span style="color: #cd6600;">renaming</span>
       (<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> <span style="color: #0000cd;">to</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8321;
       ;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> <span style="color: #0000cd;">to</span><span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8321;
       ; _&#183;_ <span style="color: #0000cd;">to</span> _&#183;&#8321;_
       ; &#120793; <span style="color: #0000cd;">to</span> &#120793;&#8321;
       ; _&#215;_ <span style="color: #0000cd;">to</span> _&#215;&#8321;_
       ; <span style="color: #ba2f59; font-weight: bold;">leftId</span> <span style="color: #0000cd;">to</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8321;
       ; <span style="color: #ba2f59; font-weight: bold;">assoc</span> <span style="color: #0000cd;">to</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8321;
       )

<span style="color: #cd6600;">module</span> <span style="color: #a020f0;">M-Set-R</span>&#8322; (&#8475; :<span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>) <span style="color: #cd6600;">where</span>
   <span style="color: #cd6600;">open</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span> &#8475; <span style="color: #cd6600;">public</span>
     <span style="color: #cd6600;">renaming</span>
       (<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> <span style="color: #0000cd;">to</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8322;
       ;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> <span style="color: #0000cd;">to</span><span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8322;
       ; _&#183;_ <span style="color: #0000cd;">to</span> _&#183;&#8322;_
       ; &#120793; <span style="color: #0000cd;">to</span> &#120793;&#8322;
       ; _&#215;_ <span style="color: #0000cd;">to</span> _&#215;&#8322;_
       ; <span style="color: #ba2f59; font-weight: bold;">leftId</span> <span style="color: #0000cd;">to</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>&#8322;
       ; <span style="color: #ba2f59; font-weight: bold;">assoc</span> <span style="color: #0000cd;">to</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>&#8322;
       )
</pre>
</div>

<p>
These kind of open-renamings are so common that the tedium
is actually acceptable by most users &#x2014;it shouldn't be
and now it no longer has to be that way.
</p>
</div>
</div>

<div id="outline-container-orga7d5b78" class="outline-3">
<h3 id="orga7d5b78"><span class="section-number-3">2.10</span> Subpacakges with <code>generated, sorts, signature</code></h3>
<div class="outline-text-3" id="text-2-10">
<p>
A common grouping operation is to zoom-in to the minimal well-formed
package that contains only certain specified elements. For example,
in our <code>M-Set</code> grouping, we may want to keep only <code>𝟙</code> but to be well-defined
we are forced to also keep the elements on which it depends &#x2014;namely, <code>Scalar</code>.
</p>

<p>
In particular, the following naive approach only works if the elements are
independent of one another &#x2014;which is rarely the case for Agda users.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">cute, but too brutish.</span>
&#119985;-generated by = <span style="color: #3a81c3;">:alter-elements</span> <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">lambda</span> <span style="color: #6c3163;">(</span>fs<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>-filter by fs<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
The coherent scheme is straightforward to implement.
For clarity, rather than efficiency,
the algorithm below forms a list <code>yeses</code> of the elements that should be kept
then traverses the elements list, adding all elements needed to ensure that list
is coherent. Moreover, for generality, we consider a predicate rather than an explicit
listing of items to be retained.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8220;by&#8221; is a predicate on elements.</span>
<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">&#119985;</span> generated by
  = <span style="color: #3a81c3;">:alter-elements</span>  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">lambda</span> <span style="color: #2d9574;">(</span>fs<span style="color: #2d9574;">)</span>
      <span style="color: #2d9574;">(</span><span style="color: #cd6600;">let*</span> <span style="color: #67b11d;">(</span> <span style="color: #b1951d;">(</span>yeses <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">--map</span> <span style="color: #6c3163;">(</span>funcall by it<span style="color: #6c3163;">)</span> fs<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
              <span style="color: #b1951d;">(</span>get-yeses <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">lambda</span> <span style="color: #6c3163;">()</span> <span style="color: #6c3163;">(</span><span style="color: #cd6600;">--filter</span> it <span style="color: #2d9574;">(</span><span style="color: #cd6600;">--zip-with</span> <span style="color: #887070;">(</span><span style="color: #cd6600;">if</span> it other<span style="color: #887070;">)</span> yeses fs<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
              <span style="color: #b1951d;">(</span>in-yeses <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">lambda</span> <span style="color: #6c3163;">(</span>e<span style="color: #6c3163;">)</span>
                          <span style="color: #6c3163;">(</span><span style="color: #cd6600;">--any</span>
                           <span style="color: #2d9574;">(</span>s-contains? <span style="color: #887070;">(</span>s-replace <span style="color: #2d9574;">"_"</span> <span style="color: #2d9574;">" "</span> <span style="color: #3a81c3;">(</span>get-name e<span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span> <span style="color: #887070;">(</span>get-type it<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>
                           <span style="color: #2d9574;">(</span>funcall get-yeses<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

        <span style="color: #67b11d;">(</span><span style="color: #cd6600;">loop</span> for _ in fs do
              <span style="color: #b1951d;">(</span><span style="color: #cd6600;">loop</span> for f in fs
                    for i from 0
                    do <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">when f in yess, set f to be yes.</span>
                    <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">when</span> <span style="color: #6c3163;">(</span>funcall in-yeses f<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span><span style="color: #cd6600;">setf</span> <span style="color: #2d9574;">(</span>nth i yeses<span style="color: #2d9574;">)</span> t<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

        <span style="color: #67b11d;">(</span>funcall get-yeses<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Here's an immediate application: Obtaining the types declared in a grouping mechanism.
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">&#119985;-sorts = generated :by (lambda (f) (s-contains? "Set" (target (get-type f))))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">M-Set-Sorts = M-Set record &#10228; sorts</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> M-Set-Sorts</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
  <span style="color: #ba2f59; font-weight: bold;"> Scalar</span>  : <span style="color: #cd6600;">Set</span>
  <span style="color: #ba2f59; font-weight: bold;"> Vector</span>  : <span style="color: #cd6600;">Set</span>
</pre>
</div>

<p>
We can even obtain a sub-signature wholesale:
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonoidSignature = M-Set record &#10228; generated :by (lambda (f) (and (s-contains? "Scalar" f) (not (s-contains? "Vector" f))))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> MonoidSignature</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
  <span style="color: #ba2f59; font-weight: bold;"> Scalar</span>  : <span style="color: #cd6600;">Set</span>
   &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
</pre>
</div>

<p>
This pattern of having a lawless grouping seems sufficiently desirable that we may
codify it.
</p>
<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">lisp</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">(defun targets-a-sort (element)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">  (--any (s-contains? it (target element)) (-map #'get-name (-filter #'is-sort $&#119890;&#119897;&#119890;&#119898;&#119890;&#119899;&#119905;&#119904;))))</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985; signature = generated :by (lambda (f) (targets-a-sort f)))</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">MonSig = M-Set record &#10228; signature</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> MonSig</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">field</span>
  <span style="color: #ba2f59; font-weight: bold;"> Scalar</span>  : <span style="color: #cd6600;">Set</span>
  <span style="color: #ba2f59; font-weight: bold;"> Vector</span>  : <span style="color: #cd6600;">Set</span>
   _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
   &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
</pre>
</div>

<p>
Neato!
</p>
</div>
</div>

<div id="outline-container-org860f09b" class="outline-3">
<h3 id="org860f09b"><span class="section-number-3">2.11</span> Automatically deriving homomorphism definitions ♥‿♥</h3>
<div class="outline-text-3" id="text-2-11">
<p>
The definition of “structure preservation” is, nearly always, mechanical to
formulate and that's just what we shall do to avoid having to write it out
by hand ever again.
</p>

<p>
The idea is not too complicated:
</p>
<ol class="org-ol">
<li>Suppose you have an operation <code>_·_ : Scalar → Vector → Vector</code>.</li>
<li>Suppose you have a numbering of the sorts; e.g., <code>sort₁ = Scalar, sort₂ = Vector</code>.</li>
<li>Form functions <code>mapᵢ : sortᵢ → sortᵢ′</code></li>
<li>Include implicit arguments in the type: <code>{x₁ : Scalar} → {x₂ : Vector} → Vector</code>.</li>
<li>The target type <code>Vector = sort₂</code> means we need to apply <code>map₂</code> to the expression
formed from the operation's name along with the arguments.
<ul class="org-ul">
<li>The left hand side is thus <code>map₂ (_·_ x₁ x₂)</code>.</li>
</ul></li>
<li>For the right hand side, we use the target-space's name, say <code>_·′_</code>,
along with <code>mapᵢ</code> applied to <code>xᵢ</code> for each <code>i</code> mentioned in the type.</li>

<li>The result:
<code>pres-· : {x₁ : Scalar} → {x₂ : Vector} →   map₂ (_·_ x₁ x₂)   ≡   _·′_ (map₁ x₁) (map₂ x₂)</code>.</li>
</ol>

<p>
First, we need a helper that forms the preservation formulae. In a <code>lisp</code> block:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">to-subscript</span> <span style="color: #6c3163;">(</span>n<span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span>nth n '<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"&#8320;"</span> <span style="color: #2d9574;">"&#8321;"</span> <span style="color: #2d9574;">"&#8322;"</span> <span style="color: #2d9574;">"&#8323;"</span> <span style="color: #2d9574;">"&#8324;"</span> <span style="color: #2d9574;">"&#8325;"</span> <span style="color: #2d9574;">"&#8326;"</span> <span style="color: #2d9574;">"&#8327;"</span> <span style="color: #2d9574;">"&#8328;"</span> <span style="color: #2d9574;">"&#8329;"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">homify</span> <span style="color: #6c3163;">(</span>typed-name sort<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Given a typed name, produce the associating &#8220;preservation&#8221; formula.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   E.g.,</span>
<span style="color: #da8b55; background-color: #ecf3ec;">            _&#183;_    : Scalar &#8594; Vector &#8594; Vector</span>
<span style="color: #da8b55; background-color: #ecf3ec;">            pres-&#183; : {x&#8321; : Scalar} &#8594; {x&#8322; : Vector} &#8594; map&#8322; (x&#8321; &#183; x&#8322;) = map&#8321; x&#8321; &#183;&#8242; map&#8322; x&#8322;</span>

<span style="color: #da8b55; background-color: #ecf3ec;">  Type &#964; gets variable x&#7522; provided (i, &#964;) &#8712; sorts; likewise we think of map&#7522; : &#964; &#8594; &#964;&#8242;.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  Note that we must have i &#8712; 0..9, otherwise there'll be unexpected subscripting errors.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">  The target name is primed, &#8220;&#183;&#8242;&#8221;.</span>
<span style="color: #da8b55; background-color: #ecf3ec;"> "</span>
 <span style="color: #6c3163;">(</span><span style="color: #cd6600;">letf*</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>sorts     <span style="color: #b1951d;">(</span>mapcar #'car sort<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>symbol-function 'index<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #cd6600;">lambda</span> <span style="color: #3a81c3;">(</span>s<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span>to-subscript <span style="color: #6c3163;">(</span>cdr <span style="color: #2d9574;">(</span>assoc it sort<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

         <span style="color: #67b11d;">(</span>tn&#8594;       <span style="color: #b1951d;">(</span>s-split <span style="color: #2d9574;">" &#8594; "</span> <span style="color: #3a81c3;">(</span>get-type typed-name<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #67b11d;">(</span>arg-count <span style="color: #b1951d;">(</span>1- <span style="color: #3a81c3;">(</span>length tn&#8594;<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

         <span style="color: #67b11d;">(</span>all-indicies  <span style="color: #b1951d;">(</span><span style="color: #cd6600;">--map</span> <span style="color: #3a81c3;">(</span>index it<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">--filter</span> <span style="color: #6c3163;">(</span>member <span style="color: #2d9574;">(</span>s-trim it<span style="color: #2d9574;">)</span> sorts<span style="color: #6c3163;">)</span> tn&#8594;<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #67b11d;">(</span>indicies  <span style="color: #b1951d;">(</span>-drop-last 1 all-indicies<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #67b11d;">(</span>tgt-idx   <span style="color: #b1951d;">(</span>car <span style="color: #3a81c3;">(</span>-take-last 1 all-indicies<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

         <span style="color: #67b11d;">(</span>op        <span style="color: #b1951d;">(</span>get-name typed-name<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #67b11d;">(</span>args      <span style="color: #b1951d;">(</span><span style="color: #cd6600;">--map</span> <span style="color: #3a81c3;">(</span>concat <span style="color: #2d9574;">"x"</span> it<span style="color: #3a81c3;">)</span> indicies<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #67b11d;">(</span>lhs       <span style="color: #b1951d;">(</span>format <span style="color: #2d9574;">"map%s (%s %s)"</span> tgt-idx op <span style="color: #3a81c3;">(</span>s-join <span style="color: #2d9574;">" "</span> args<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

         <span style="color: #67b11d;">(</span>op&#8242;       <span style="color: #b1951d;">(</span>rename-mixfix <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">lambda</span> <span style="color: #6c3163;">(</span>n<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>concat n <span style="color: #2d9574;">"&#8242;"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> op<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #67b11d;">(</span>map-args  <span style="color: #b1951d;">(</span><span style="color: #cd6600;">--map</span> <span style="color: #3a81c3;">(</span>format <span style="color: #2d9574;">"(map%s x%s)"</span> it it<span style="color: #3a81c3;">)</span> indicies<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #67b11d;">(</span>rhs       <span style="color: #b1951d;">(</span>format <span style="color: #2d9574;">"%s %s"</span> op&#8242; <span style="color: #3a81c3;">(</span>s-join <span style="color: #2d9574;">" "</span> map-args<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

         <span style="color: #67b11d;">(</span>target    <span style="color: #b1951d;">(</span>format <span style="color: #2d9574;">"  %s   &#8801;   %s"</span> lhs rhs<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
 <span style="color: #2d9574;">)</span>

 <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Change the target type.</span>
 <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> tn&#8594; <span style="color: #67b11d;">(</span><span style="color: #cd6600;">--map</span> <span style="color: #b1951d;">(</span><span style="color: #cd6600;">when</span> <span style="color: #3a81c3;">(</span>assoc it sort<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span>format <span style="color: #2d9574;">"{x%s : %s}"</span> <span style="color: #6c3163;">(</span>index it<span style="color: #6c3163;">)</span> it<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> tn&#8594;<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
 <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setf</span> <span style="color: #67b11d;">(</span>nth arg-count tn&#8594;<span style="color: #67b11d;">)</span> target<span style="color: #2d9574;">)</span>

 <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Stick it all together, with an updated name.</span>
 <span style="color: #2d9574;">(</span>make-tn
   <span style="color: #67b11d;">(</span>format <span style="color: #2d9574;">"pres-%s"</span> <span style="color: #b1951d;">(</span>s-replace <span style="color: #2d9574;">"_"</span> <span style="color: #2d9574;">""</span> <span style="color: #3a81c3;">(</span>get-name typed-name<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
   <span style="color: #67b11d;">(</span>s-join <span style="color: #2d9574;">" &#8594; "</span> tn&#8594;<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
 <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Test it out.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(homify "_&#183;_    : Scalar &#8594; Vector &#8594; Vector" '( ("Scalar" . 4) ("Vector" . 1)))</span>
</pre>
</div>

<p>
Then, we form the variational as follows &#x2014;also in a <code>lisp</code> block.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">&#119985;</span> hom
  = record &#10228;
    <span style="color: #3a81c3;">:waist</span> 2
    <span style="color: #3a81c3;">:waist-strings</span> '<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"open M-Set-R  Src"</span> <span style="color: #2d9574;">"open M-Set-R&#8242; Tgt"</span> <span style="color: #2d9574;">"field"</span><span style="color: #6c3163;">)</span>
    <span style="color: #3a81c3;">:alter-elements</span> <span style="color: #6c3163;">(</span><span style="color: #cd6600;">lambda</span> <span style="color: #2d9574;">(</span>es<span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">let</span> <span style="color: #67b11d;">(</span>maps eqns sorts<span style="color: #67b11d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Construct the map&#7522; : sort&#7522; &#8594; sort&#7522;&#8242;; keeping track of (sort . i) pairs.</span>
      <span style="color: #67b11d;">(</span><span style="color: #cd6600;">loop</span> for e in es
            for i from 1
       do

         <span style="color: #b1951d;">(</span><span style="color: #cd6600;">when</span> <span style="color: #3a81c3;">(</span>is-sort e<span style="color: #3a81c3;">)</span>
           <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">push</span> <span style="color: #6c3163;">(</span>cons <span style="color: #2d9574;">(</span>get-name e<span style="color: #2d9574;">)</span> i<span style="color: #6c3163;">)</span> sorts<span style="color: #3a81c3;">)</span>
           <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">push</span> <span style="color: #6c3163;">(</span>format <span style="color: #2d9574;">"map%s : %s &#8594; %s&#8242;"</span> <span style="color: #2d9574;">(</span>to-subscript i<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span>get-name e<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span>get-name e<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
                 maps<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>

          <span style="color: #b1951d;">(</span><span style="color: #cd6600;">when</span> <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">and</span> <span style="color: #6c3163;">(</span>targets-a-sort e<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>not <span style="color: #2d9574;">(</span>is-sort e<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
            <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">push</span> <span style="color: #6c3163;">(</span>homify e sorts<span style="color: #6c3163;">)</span> eqns<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Ensure we have a source and target space as elements.</span>
    <span style="color: #67b11d;">(</span>-cons* <span style="color: #2d9574;">"Src : M-Set-R"</span>
            <span style="color: #2d9574;">"Tgt : M-Set-R"</span>
    <span style="color: #b1951d;">(</span>reverse <span style="color: #3a81c3;">(</span>-concat eqns maps<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Here are two examples. <b>Note</b> that the latter allows us to <i>rename</i> the <code>mapᵢ</code> as we
wish &#x2014;which may be preferable to extending the variational to accommodate for new
names.
</p>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #2aa1ae; background-color: #ecf3ec;">{-</span><span style="color: #2aa1ae; background-color: #ecf3ec;">700</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Hom  = M-Set hom</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">Hom&#178; = M-Set hom &#10228; renaming :by "map&#8321; to scalar; pres-&#120793; to unity"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> Hom (Src</span> :<span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>)<span style="color: #ba2f59; font-weight: bold;"> (Tgt</span> :<span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>) :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">open</span> <span style="color: #ba2f59; font-weight: bold;">M-Set-R  Src</span>
 <span style="color: #cd6600;">open</span> <span style="color: #ba2f59; font-weight: bold;">M-Set-R&#8242; Tgt</span>
 <span style="color: #cd6600;">field</span>
   <span style="color: #0000cd;">map</span>&#8321; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242;
   <span style="color: #0000cd;">map</span>&#8322; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8242;
   <span style="color: #0000cd;">pres-</span>&#183; : {<span style="color: #0000cd;">x</span>&#8321; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} &#8594; {<span style="color: #0000cd;">x</span>&#8322; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594;   <span style="color: #0000cd;">map</span>&#8322; (_&#183;_ <span style="color: #0000cd;">x</span>&#8321; <span style="color: #0000cd;">x</span>&#8322;)   &#8801;   _&#183;&#8242;_ (<span style="color: #0000cd;">map</span>&#8321; <span style="color: #0000cd;">x</span>&#8321;) (<span style="color: #0000cd;">map</span>&#8322; <span style="color: #0000cd;">x</span>&#8322;)
   <span style="color: #0000cd;">pres-</span>&#120793; : <span style="color: #0000cd;">map</span>&#8321; (&#120793; )   &#8801;   &#120793;&#8242;
   <span style="color: #0000cd;">pres-</span>&#215; : {<span style="color: #0000cd;">x</span>&#8321; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} &#8594; {<span style="color: #0000cd;">x</span>&#8321; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} &#8594;   <span style="color: #0000cd;">map</span>&#8321; (_&#215;_ <span style="color: #0000cd;">x</span>&#8321; <span style="color: #0000cd;">x</span>&#8321;)   &#8801;   _&#215;&#8242;_ (<span style="color: #0000cd;">map</span>&#8321; <span style="color: #0000cd;">x</span>&#8321;) (<span style="color: #0000cd;">map</span>&#8321; <span style="color: #0000cd;">x</span>&#8321;)

<span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> Hom</span>&#178;<span style="color: #ba2f59; font-weight: bold;"> (Src</span> :<span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>)<span style="color: #ba2f59; font-weight: bold;"> (Tgt</span> :<span style="color: #ba2f59; font-weight: bold;"> M-Set-R</span>) :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">open</span> <span style="color: #ba2f59; font-weight: bold;">M-Set-R  Src</span>
 <span style="color: #cd6600;">open</span> <span style="color: #ba2f59; font-weight: bold;">M-Set-R&#8242; Tgt</span>
 <span style="color: #cd6600;">field</span>
   <span style="color: #0000cd;">scalar</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>&#8242;
   <span style="color: #0000cd;">map</span>&#8322; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>&#8242;
   <span style="color: #0000cd;">pres-</span>&#183; : {<span style="color: #0000cd;">x</span>&#8321; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} &#8594; {<span style="color: #0000cd;">x</span>&#8322; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594;   <span style="color: #0000cd;">map</span>&#8322; (_&#183;_ <span style="color: #0000cd;">x</span>&#8321; <span style="color: #0000cd;">x</span>&#8322;)   &#8801;   _&#183;&#8242;_ (<span style="color: #0000cd;">scalar</span> <span style="color: #0000cd;">x</span>&#8321;) (<span style="color: #0000cd;">map</span>&#8322; <span style="color: #0000cd;">x</span>&#8322;)
   <span style="color: #0000cd;">unity</span> : <span style="color: #0000cd;">scalar</span> (&#120793; )   &#8801;   &#120793;&#8242;
   <span style="color: #0000cd;">pres-</span>&#215; : {<span style="color: #0000cd;">x</span>&#8321; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} &#8594; {<span style="color: #0000cd;">x</span>&#8321; :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} &#8594;   <span style="color: #0000cd;">scalar</span> (_&#215;_ <span style="color: #0000cd;">x</span>&#8321; <span style="color: #0000cd;">x</span>&#8321;)   &#8801;   _&#215;&#8242;_ (<span style="color: #0000cd;">scalar</span> <span style="color: #0000cd;">x</span>&#8321;) (<span style="color: #0000cd;">scalar</span> <span style="color: #0000cd;">x</span>&#8321;)
</pre>
</div>

<p>
This is so cool (•̀ᴗ•́)و
</p>

<p>
We leave it to the reader to derive other constructs from a theory presentation.
Examples can be found in these <a href="https://github.com/alhassy/next-700-module-systems-proposal/blob/master/JC_Program_Generation_Talk_IFIP.pdf">Metaprogramming Agda</a> slides:
Homomorphism equality, application to carrier elements, isomorphisms,
isomorphisms where only one direction needs to preserve the structure
and an automatically derivable proof that the other direction is also
structure preserving, endomorphism and automorphism types, kernels,
product &amp; sum &amp; other categorical types.
</p>

<dl class="org-dl">
<dt>Challenge</dt><dd>Design a scheme to produce simple Cartesian products from a given theory.

<ol class="org-ol">
<li><p>
The only variable to this problem is an arbitrary record, say it is <code>M</code>.
</p>

<p>
For this exercise to be tractable, assume <code>M</code> consists of declarations
of sort symbols, function symbols, and nullary (non-implication) equations
which may have implicit arguments.
</p></li>

<li>Ensure you understood the definition of the homomorphism scheme above.</li>
<li>Mimic the homomorphism scheme to produce a typed <code>Prod</code> where <code>Prod A₀ A₁</code>
consists of a <code>M</code> value, say <code>P</code>, and two homomorphisms <code>Hom P Aᵢ</code>.</li>
<li>Write a Lisp code that produces a function <code>MakeProduct : (A₀ A₁ : M) → Prod A₀ A₁</code>.

<ul class="org-ul">
<li>The projection morphisms are straightforward.</li>
<li>Every <i>n</i>-ary function <code>f</code> could be defined by <code>fₚ = zipₙ f₀ f₁</code>.</li>
<li>Every equation <code>e</code> could be defined by <code>eₚ = cong₂ _,_ e₀ e₁</code>.</li>
</ul></li>

<li>If you have actually attempted this, then go on to include the remaining
artefacts to make the construction an actual categorical product.</li>
</ol></dd>
</dl>
</div>
</div>
</div>

<div id="outline-container-org0486626" class="outline-2">
<h2 id="org0486626"><span class="section-number-2">3</span> Strings and Things</h2>
<div class="outline-text-2" id="text-3">
<p>
Since our prototype is intended to be as minimally obtrusive as possible, we will
need to extract our special 700-syntactical items between delimited tokens
and process them.
</p>

<p>
The following subsections introduce:
</p>
<dl class="org-dl">
<dt><code>get-children</code></dt><dd>Obtaining intended items from a hierarchical listing.</dd>
<dt><code>sub-string-delimited-$</code></dt><dd>Finding the shortest substring between a prefix
<code>𝑳</code> and a postfix <code>𝑹</code> by using the ‘metavariable’ <code>$here</code>; e.g., <code>“𝑳 $here 𝑹”.</code></dd>
<dt><code>buffer-substring-delimited-whole-buffer</code></dt><dd>Yield all portions of the
buffer enclosed in the given delimiters, as a list of strings.</dd>
<dt><code>rename-mixfix</code></dt><dd>Renamaing Agda mixifix names where the rename operation
ignores the outermost (Agda) argument position markers ‘_’.</dd>
<dt><code>extract-imports</code></dt><dd>Obtain all ‘import’ clauses so that they can be
ported over to the generated file.</dd>
</dl>

<p>
First some useful libraries:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">String and list manipulation libraries</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">https://github.com/magnars/dash.el</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">https://github.com/magnars/s.el</span>
<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">require</span> '<span style="color: #4e3163;">s</span><span style="color: #3a81c3;">)</span>               <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8220;The long lost Emacs string manipulation library&#8221;</span>
<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">require</span> '<span style="color: #4e3163;">dash</span><span style="color: #3a81c3;">)</span>            <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8220;A modern list library for Emacs&#8221;</span>
</pre>
</div>
</div>

<div id="outline-container-org8b5deba" class="outline-3">
<h3 id="org8b5deba"><span class="section-number-3">3.1</span> Finding Children in the Wild</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Being a prototype, we are talking a mostly string-based approach to working
with hierarchical phrases.
For example, consider the following todo list,
</p>
<div class="org-src-container">
<pre class="src src-org" id="orgc580b00">+ item 1
  - subitem 1.1
    * subsubitem 1.1.1
  - subitem 1.2
+ item 2
  - subitem 2.2
+ item 3
</pre>
</div>

<ul class="org-ul">
<li>item 1
<ul class="org-ul">
<li>subitem 1.1
<ul class="org-ul">
<li>subsubitem 1.1.1</li>
</ul></li>
<li>subitem 1.2</li>
</ul></li>
<li>item 2
<ul class="org-ul">
<li>subitem 2.2</li>
</ul></li>
<li>item 3</li>
</ul>

<p>
We would think that <code>item 1</code> has two ‘children’, and, moreover, one grand-child.
Whereas <code>item 2</code> has a single child and <code>item 3</code> is barren.
</p>

<p>
Here's my intuitive algorithm: We obtain the indentation of the first child,
then all subsequent lines with at least that much indentation have the same ancestor.
</p>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> get-indentation Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">get-indentation</span> <span style="color: #6c3163;">(</span>string<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"How many spaces are there at the front of &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">string</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;?</span>

<span style="color: #da8b55; background-color: #ecf3ec;">  Property: The resulting number is &#8216;&#8804; length string&#8217;.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">if</span> string <span style="color: #2d9574;">(</span>length <span style="color: #67b11d;">(</span>s-shared-start string <span style="color: #b1951d;">(</span>s-repeat <span style="color: #3a81c3;">(</span>length string<span style="color: #3a81c3;">)</span> <span style="color: #2d9574;">" "</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> 0<span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> get-children Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">get-children</span> <span style="color: #6c3163;">(</span>parent the-wild <span style="color: #ba2f59; font-weight: bold;">&amp;key</span> <span style="color: #2d9574;">(</span>then #'identity<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Go into &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">the-wild</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; seeking out the first occurence of &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">parent</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;,</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   who once found, ought to have a minimal indentation for its children.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   &#8220;Minimal&#8221; in that if there are items with a greater indentation,</span>
<span style="color: #da8b55; background-color: #ecf3ec;">    then they are children of children and should be kept.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   The first input argument is of type &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">string</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;,</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   the second argument may be of type &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">string</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; or &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">list</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; of strings</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   ---if it's a string, we split along new lines---,</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   the optional &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">then</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; is a function acting on children strings.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   Result is the parent followed by its children, as a list of lines,</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   where each child has been altered using the optional &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">then</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; function.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   Moreover, we also return the rest of the unconsidered portion of &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">the-wild</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;:</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   Result list: (  unconsidered-prefix-of-the-wild</span>
<span style="color: #da8b55; background-color: #ecf3ec;">           (cons parent-line children-lines)</span>
<span style="color: #da8b55; background-color: #ecf3ec;">           unconsidered-remaining-lines )</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   The first element is the porition that does not contain an occurence</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   of &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">parent</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;. The second is the parent and its children, if possible.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   The third is the remainder of the wild.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   Implementation: Look at the indentation of the</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   first child, then use that as a lower bound to find the indentation</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   of the remaining children.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">let</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>lines <span style="color: #b1951d;">(</span><span style="color: #cd6600;">if</span> <span style="color: #3a81c3;">(</span>stringp the-wild<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span>s-lines the-wild<span style="color: #3a81c3;">)</span> the-wild<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
    <span style="color: #67b11d;">(</span>indentation -1<span style="color: #67b11d;">)</span>
    prefix
    parent-line<span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Ensure: lines &#8776; (cons (not-here-prefix) (cons parent-here more-lines) )</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> lines <span style="color: #67b11d;">(</span><span style="color: #cd6600;">--split-with</span> <span style="color: #b1951d;">(</span>not <span style="color: #3a81c3;">(</span>s-contains? parent it<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> lines<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Discard prefix, for now.</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> prefix <span style="color: #67b11d;">(</span>car lines<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> lines <span style="color: #67b11d;">(</span>cadr lines<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Discard parent, but remember its contextual line.</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> parent-line <span style="color: #67b11d;">(</span>car lines<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> lines <span style="color: #67b11d;">(</span>cdr lines<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">How far is the first child indented?</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> indentation <span style="color: #67b11d;">(</span>get-indentation <span style="color: #b1951d;">(</span>car lines<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Keep only the children that have at least this level of indentation.</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> lines&amp;more <span style="color: #67b11d;">(</span><span style="color: #cd6600;">--split-with</span> <span style="color: #b1951d;">(</span>&lt;= indentation <span style="color: #3a81c3;">(</span>get-indentation it<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> lines<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> lines <span style="color: #67b11d;">(</span>car lines&amp;more<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> unconsidered <span style="color: #67b11d;">(</span>cadr lines&amp;more<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Alter the children according to the given function.</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> lines <span style="color: #67b11d;">(</span>mapcar then lines<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Yield the parent line along with the children lines; and the unconsumed wild's prefix and suffix.</span>
    `<span style="color: #2d9574;">(</span>,prefix ,<span style="color: #67b11d;">(</span>cons parent-line lines<span style="color: #67b11d;">)</span> ,unconsidered<span style="color: #2d9574;">)</span>
  <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<p>
Let's try this out on our example hierarchy, <code>eh</code>, from earlier.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>cadr <span style="color: #6c3163;">(</span>get-children <span style="color: #2d9574;">"+ item 1"</span> eh<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">+ item 1</td>
<td class="org-left">- subitem 1.1</td>
<td class="org-left">* subsubitem 1.1.1</td>
<td class="org-left">- subitem 1.2</td>
</tr>
</tbody>
</table>

<p>
Excellent! Let's looks at the other parents.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>get-children <span style="color: #2d9574;">"+ item 2"</span> eh<span style="color: #3a81c3;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">+ item 1</td>
<td class="org-left">- subitem 1.1</td>
<td class="org-left">* subsubitem 1.1.1</td>
<td class="org-left">- subitem 1.2</td>
</tr>

<tr>
<td class="org-left">+ item 2</td>
<td class="org-left">- subitem 2.2</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">+ item 3</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
Notice that we found the parent <code>+ item 2</code> and its only child <code>- subitem 1.2</code>, and
we kept the prefix of <code>eh</code> that did not contain the parent as well as
the remaining unconsidered portion of <code>eh</code>. &#x2014;Moreover, it looks like we obtained
the transpose of the example hierarchy 😛
</p>

<p>
Finally, the barren parent.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>get-children <span style="color: #2d9574;">"+ item 3"</span> eh<span style="color: #3a81c3;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">+ item 1</td>
<td class="org-left">- subitem 1.1</td>
<td class="org-left">* subsubitem 1.1.1</td>
<td class="org-left">- subitem 1.2</td>
<td class="org-left">+ item 2</td>
<td class="org-left">- subitem 2.2</td>
</tr>

<tr>
<td class="org-left">+ item 3</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
Everything before it is considered the prefix. Yay :smile:
</p>

<p>
Before we move on, let's try altering a child clause; e.g., I'd like
<code>* subitem 1.1.1</code> to be renamed to <code>* subitem that is super deep</code>.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>cadr <span style="color: #6c3163;">(</span>get-children <span style="color: #2d9574;">"+ item 1"</span> eh
 <span style="color: #3a81c3;">:then</span> <span style="color: #2d9574;">(</span><span style="color: #cd6600;">lambda</span> <span style="color: #67b11d;">(</span>x<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span>s-replace <span style="color: #2d9574;">"1.1.1"</span> <span style="color: #2d9574;">"that is super deep"</span> x<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">+ item 1</td>
<td class="org-left">- subitem 1.1</td>
<td class="org-left">* subsubitem that is super deep</td>
<td class="org-left">- subitem 1.2</td>
</tr>
</tbody>
</table>

<p>
Nice :grin:
</p>

<p>
Now the moment of truth, let's try this out on our example.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>cadr <span style="color: #6c3163;">(</span>get-children <span style="color: #2d9574;">"PackageFormer"</span> test<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #cd6600;">|</span> <span style="color: #ba2f59; font-weight: bold;">PackageFormer M-Set</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span> <span style="color: #cd6600;">|</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span>  : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">|</span><span style="color: #ba2f59; font-weight: bold;"> Vector</span>  : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">|</span> _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> <span style="color: #cd6600;">|</span> &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> <span style="color: #cd6600;">|</span> _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> <span style="color: #cd6600;">|</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011; <span style="color: #cd6600;">|</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;) <span style="color: #cd6600;">|</span>
</pre>
</div>

<p>
Also, does the list variant work:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>cadr <span style="color: #6c3163;">(</span>get-children <span style="color: #2d9574;">"PackageFormer"</span> <span style="color: #2d9574;">(</span>s-lines test<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #cd6600;">|</span> <span style="color: #ba2f59; font-weight: bold;">PackageFormer M-Set</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span> <span style="color: #cd6600;">|</span><span style="color: #ba2f59; font-weight: bold;"> Scalar</span>  : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">|</span><span style="color: #ba2f59; font-weight: bold;"> Vector</span>  : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">|</span> _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> <span style="color: #cd6600;">|</span> &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> <span style="color: #cd6600;">|</span> _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> <span style="color: #cd6600;">|</span> <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011; <span style="color: #cd6600;">|</span> <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;) <span style="color: #cd6600;">|</span>
</pre>
</div>

<p>
Test-driven development doesn't seem bad 😲
</p>

<p>
These pretty-coloured tests and results may be nice for exposition,
however for maintenance it is ideal to include unit tests that can
be checked without human intervention. <code>M-x ert &lt;RET&gt; t &lt;RET&gt;</code>, after
executing the following block, will report which tests pass and tries to explain
why tests fail.
</p>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Tests </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">ert-deftest</span> <span style="color: #6c3163; font-weight: bold;">get-ind</span> <span style="color: #6c3163;">()</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">loop</span> for s in '<span style="color: #2d9574;">(</span>nil <span style="color: #2d9574;">""</span> <span style="color: #2d9574;">"x"</span> <span style="color: #2d9574;">"  x"</span> <span style="color: #2d9574;">"  x "</span><span style="color: #2d9574;">)</span>
    do <span style="color: #2d9574;">(</span><span style="color: #cd6600;">should</span> <span style="color: #67b11d;">(</span>&lt;= <span style="color: #b1951d;">(</span>get-indentation s<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>length s<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">ert-deftest</span> <span style="color: #6c3163; font-weight: bold;">get-child</span> <span style="color: #6c3163;">()</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">-let</span> <span style="color: #2d9574;">[</span>eh
<span style="color: #2d9574;">"+ item 1</span>
<span style="color: #2d9574;">  - subitem 1.1</span>
<span style="color: #2d9574;">    * subsubitem 1.1.1</span>
<span style="color: #2d9574;">  - subitem 1.2</span>
<span style="color: #2d9574;">+ item 2</span>
<span style="color: #2d9574;">  - subitem 2.2</span>
<span style="color: #2d9574;">+ item 3"</span><span style="color: #2d9574;">]</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Consider each line above as a parent, with &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">eh</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; as the wild.</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">loop</span> for parent in <span style="color: #67b11d;">(</span>s-split <span style="color: #2d9574;">"\n"</span> eh<span style="color: #67b11d;">)</span> do
      <span style="color: #67b11d;">(</span><span style="color: #cd6600;">let*</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3;">(</span>cs <span style="color: #6c3163;">(</span>get-children parent eh<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
         <span style="color: #3a81c3;">(</span>children <span style="color: #6c3163;">(</span>cdadr cs<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Result is a list of lists: Each is either nil or a cons.</span>
      <span style="color: #b1951d;">(</span><span style="color: #cd6600;">loop</span> for r in cs do <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">should</span> <span style="color: #6c3163;">(</span>listp r<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The parent line contains the parent.</span>
      <span style="color: #b1951d;">(</span><span style="color: #cd6600;">should</span> <span style="color: #3a81c3;">(</span>equal parent <span style="color: #6c3163;">(</span>caadr cs<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The children all have the same indentation.</span>
      <span style="color: #b1951d;">(</span><span style="color: #cd6600;">loop</span> for c in children for d in children do <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">should</span> <span style="color: #6c3163;">(</span>equal <span style="color: #2d9574;">(</span>get-indentation c<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span>get-indentation d<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Extensionality: Orginal input can be regained from resulting parts.</span>
      <span style="color: #b1951d;">(</span><span style="color: #cd6600;">should</span> <span style="color: #3a81c3;">(</span>equal eh <span style="color: #6c3163;">(</span>s-trim <span style="color: #2d9574;">(</span>s-join <span style="color: #2d9574;">"\n"</span> <span style="color: #887070;">(</span><span style="color: #cd6600;">--map</span> <span style="color: #3a81c3;">(</span>s-join <span style="color: #2d9574;">"\n"</span> it<span style="color: #3a81c3;">)</span> cs<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
    <span style="color: #67b11d;">)</span>
  <span style="color: #2d9574;">)</span>
<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>
</div>
</div>

<div id="outline-container-org739b954" class="outline-3">
<h3 id="org739b954"><span class="section-number-3">3.2</span> Substrings Delimited by Tokens</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-center">
<p>
<i>How do we find a string delimited by two tokens?</i>
</p>
</div>

<p>
Before we can get to the real stuff, we need to produce a few low-level &#x2014;string manipulation&#x2014;
utilities, so that we can work with higher-level abstract datatypes.
</p>

<ul class="org-ul">
<li><code>substring-delimited</code>: Given <code>prefix</code> and <code>suffix</code>,
this operation takes a string of the form  <code>⋯‘prefix’⟪needle⟫‘suffix’⋯</code> and yields <code>needle</code>.</li>
<li><code>substring-delimited-$</code>: Given <code>"⟪prefix⟫ $here ⟪suffix⟫"</code>
this operation takes a string of the form  <code>⋯‘prefix’⟪needle⟫‘suffix’⋯</code> and yields <code>needle</code>.</li>
</ul>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> substring-delimited Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">substring-delimited</span>
    <span style="color: #6c3163;">(</span>prefix suffix string<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Assuming &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">string</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; &#8776; &#8943;&#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">prefix</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;&#10218;needle&#10219;&#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">suffix</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;&#8943;, return the /first/ such needle.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">    NOTE: Delimiters &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">prefix</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; and &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">suffix</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; may be empty.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">  We convert all adjacent whitespace</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  characters to a single space in the input &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">string</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; and trim any surrounding</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  whitespace from the resulting output needle string.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">unless</span> <span style="color: #2d9574;">(</span>stringp string<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span><span style="color: #dc752f; background-color: #fbf8ef;">error</span> <span style="color: #2d9574;">"substring-delimited: Argument &#8216;</span><span style="color: #4e3163;">string</span><span style="color: #2d9574;">&#8217; must be a string."</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">let*</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>new <span style="color: #b1951d;">(</span>s-collapse-whitespace string<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

  <span style="color: #2d9574;">(</span><span style="color: #cd6600;">when</span> <span style="color: #67b11d;">(</span>not <span style="color: #b1951d;">(</span>s-blank? prefix<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
    <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> new <span style="color: #b1951d;">(</span>car <span style="color: #3a81c3;">(</span>-take-last <span style="color: #6c3163;">(</span><span style="color: #cd6600;">if</span> <span style="color: #2d9574;">(</span>equal prefix suffix<span style="color: #2d9574;">)</span> 2 1<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>s-split prefix new<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

  <span style="color: #2d9574;">(</span><span style="color: #cd6600;">when</span> <span style="color: #67b11d;">(</span>not <span style="color: #b1951d;">(</span>s-blank? suffix<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
    <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> new <span style="color: #b1951d;">(</span>car <span style="color: #3a81c3;">(</span>s-split suffix new<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

  <span style="color: #2d9574;">(</span>s-trim new<span style="color: #2d9574;">)</span>
  <span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">ert-deftest</span> <span style="color: #6c3163; font-weight: bold;">subst-delimit</span> <span style="color: #6c3163;">()</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">-let</span> <span style="color: #2d9574;">[</span>str <span style="color: #2d9574;">"&#120792; &#120793; &#120794; &#120795; &#120796; &#120797; &#120796; &#120798;"</span><span style="color: #2d9574;">]</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Intentionally repeated &#8216;&#120796;&#8217;.</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Pattern for loop: (prefix postfix expected-needle :comment))</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">loop</span> for it in `<span style="color: #67b11d;">(</span> <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">""</span> <span style="color: #2d9574;">""</span> ,str            <span style="color: #3a81c3;">:Identity</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"&#120792;"</span> <span style="color: #2d9574;">"&#120798;"</span> <span style="color: #2d9574;">"&#120793; &#120794; &#120795; &#120796; &#120797; &#120796;"</span>  <span style="color: #3a81c3;">:Boundaries</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">""</span> <span style="color: #2d9574;">"&#120798;"</span> <span style="color: #2d9574;">"&#120792; &#120793; &#120794; &#120795; &#120796; &#120797; &#120796;"</span> <span style="color: #3a81c3;">:NoLeft</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"&#120792;"</span> <span style="color: #2d9574;">""</span> <span style="color: #2d9574;">"&#120793; &#120794; &#120795; &#120796; &#120797; &#120796; &#120798;"</span> <span style="color: #3a81c3;">:NoRight</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"&#120800;"</span> <span style="color: #2d9574;">""</span>  ,str          <span style="color: #3a81c3;">:BogusL</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">""</span> <span style="color: #2d9574;">"&#8734;"</span>  ,str          <span style="color: #3a81c3;">:BogusR</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"&#120800;"</span> <span style="color: #2d9574;">"&#8734;"</span> ,str          <span style="color: #3a81c3;">:BogusLR</span><span style="color: #b1951d;">)</span>
             <span style="color: #67b11d;">)</span>
      do <span style="color: #67b11d;">(</span><span style="color: #cd6600;">should</span> <span style="color: #b1951d;">(</span>equal <span style="color: #3a81c3;">(</span>third it<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span>substring-delimited <span style="color: #6c3163;">(</span>first it<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>second it<span style="color: #6c3163;">)</span> str<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">should</span> <span style="color: #67b11d;">(</span>equal <span style="color: #2d9574;">"&#120795;"</span> <span style="color: #b1951d;">(</span>substring-delimited <span style="color: #2d9574;">"&#120794;"</span> <span style="color: #2d9574;">"&#120796;"</span> str<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Identical boundaries.</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">should</span> <span style="color: #67b11d;">(</span>equal <span style="color: #2d9574;">"&#120793;"</span> <span style="color: #b1951d;">(</span>substring-delimited <span style="color: #2d9574;">"&#119923;"</span> <span style="color: #2d9574;">"&#119923;"</span> <span style="color: #2d9574;">"&#119923; &#120793; &#119923;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">should</span> <span style="color: #67b11d;">(</span>equal <span style="color: #2d9574;">""</span>  <span style="color: #b1951d;">(</span>substring-delimited <span style="color: #2d9574;">"&#119923;"</span> <span style="color: #2d9574;">"&#119923;"</span> <span style="color: #2d9574;">"&#119923; &#119923;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">should</span> <span style="color: #67b11d;">(</span>equal <span style="color: #2d9574;">""</span>  <span style="color: #b1951d;">(</span>substring-delimited <span style="color: #2d9574;">"&#119923;"</span> <span style="color: #2d9574;">"&#119923;"</span> <span style="color: #2d9574;">"&#119923;&#119923;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Multiple occurances of prefix or postfix</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">should</span> <span style="color: #67b11d;">(</span>equal <span style="color: #2d9574;">"y"</span>  <span style="color: #b1951d;">(</span>substring-delimited <span style="color: #2d9574;">"&#119923;"</span> <span style="color: #2d9574;">"&#119929;"</span> <span style="color: #2d9574;">"&#119923; x &#119923; y &#119929;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">should</span> <span style="color: #67b11d;">(</span>equal <span style="color: #2d9574;">"x"</span>  <span style="color: #b1951d;">(</span>substring-delimited <span style="color: #2d9574;">"&#119923;"</span> <span style="color: #2d9574;">"&#119929;"</span> <span style="color: #2d9574;">"&#119923; x &#119929; y &#119929;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> substring-delimited-$ Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">substring-delimited-$</span>
    <span style="color: #6c3163;">(</span>context string <span style="color: #ba2f59; font-weight: bold;">&amp;key</span> preserve-spaces longest-substring<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Assuming &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">context</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; = &#8220;&#10218;prefix&#10219; $here &#10218;suffix&#10219;&#8221;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   and &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">string</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; &#8776; &#8943;&#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">prefix</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;&#10218;needle&#10219;&#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">suffix</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;&#8943;, return the /first/ such needle</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   by default, unless &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">longest-substring</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; is true, in which case yield /longest/</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   such needle.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">  NOTE: &#10218;prefix&#10219; and &#10218;suffix&#10219; cannot be emptry strings!</span>

<span style="color: #da8b55; background-color: #ecf3ec;">  Unless &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">preserve-spaces</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; is true, we convert all adjacent whitespace</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  characters to a single space in the input &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">string</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; and trim any surrounding</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  whitespace from the resulting output needle string.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">-let</span> <span style="color: #2d9574;">[</span>pre-post <span style="color: #67b11d;">(</span>s-split <span style="color: #2d9574;">"$here"</span> context<span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span>
    <span style="color: #2d9574;">(</span>substring-delimited <span style="color: #67b11d;">(</span>s-trim <span style="color: #b1951d;">(</span>car pre-post<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span>s-trim <span style="color: #b1951d;">(</span>cadr pre-post<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> string<span style="color: #2d9574;">)</span>
  <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">ert-deftest</span> <span style="color: #6c3163; font-weight: bold;">subst-delimit-$</span> <span style="color: #6c3163;">()</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">-let</span> <span style="color: #2d9574;">[</span>str <span style="color: #2d9574;">"&#120792; &#120793; &#120794; &#120795; &#120796; &#120797; &#120796; &#120798;"</span><span style="color: #2d9574;">]</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Intentionally repeated &#8216;&#120796;&#8217;.</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Pattern for loop: (prefix postfix expected-needle :comment)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">loop</span> for it in `<span style="color: #67b11d;">(</span> <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"$here"</span> ,str              <span style="color: #3a81c3;">:Identity</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"&#120792; $here &#120798;"</span> <span style="color: #2d9574;">"&#120793; &#120794; &#120795; &#120796; &#120797; &#120796;"</span>  <span style="color: #3a81c3;">:Boundaries</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"$here &#120798;"</span> <span style="color: #2d9574;">"&#120792; &#120793; &#120794; &#120795; &#120796; &#120797; &#120796;"</span>  <span style="color: #3a81c3;">:NoLeft</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"&#120792; $here"</span>  <span style="color: #2d9574;">"&#120793; &#120794; &#120795; &#120796; &#120797; &#120796; &#120798;"</span> <span style="color: #3a81c3;">:NoRight</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"&#120800; $here"</span>   ,str          <span style="color: #3a81c3;">:BogusL</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"$here &#8734;"</span>   ,str          <span style="color: #3a81c3;">:BogusR</span><span style="color: #b1951d;">)</span>
               <span style="color: #b1951d;">(</span> <span style="color: #2d9574;">"&#120800; $here &#8734;"</span> ,str          <span style="color: #3a81c3;">:BogusLR</span><span style="color: #b1951d;">)</span>
             <span style="color: #67b11d;">)</span>
      do <span style="color: #67b11d;">(</span><span style="color: #cd6600;">should</span> <span style="color: #b1951d;">(</span>equal <span style="color: #3a81c3;">(</span>second it<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span>substring-delimited-$ <span style="color: #6c3163;">(</span>first it<span style="color: #6c3163;">)</span> str<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Longest substring</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">should</span> <span style="color: #67b11d;">(</span>equal <span style="color: #2d9574;">"&#120795;"</span> <span style="color: #b1951d;">(</span>substring-delimited-$ <span style="color: #2d9574;">"&#120794; $here &#120796;"</span> str<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Identical boundaries.</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">should</span> <span style="color: #67b11d;">(</span>equal <span style="color: #2d9574;">"&#120793;"</span> <span style="color: #b1951d;">(</span>substring-delimited-$ <span style="color: #2d9574;">"&#120792; $here &#120792;"</span> <span style="color: #2d9574;">"&#120792; &#120793; &#120792;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">should</span> <span style="color: #67b11d;">(</span>equal <span style="color: #2d9574;">""</span>  <span style="color: #b1951d;">(</span>substring-delimited-$ <span style="color: #2d9574;">"&#120792; $here &#120792;"</span> <span style="color: #2d9574;">"&#120792; &#120792;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">should</span> <span style="color: #67b11d;">(</span>equal <span style="color: #2d9574;">""</span>  <span style="color: #b1951d;">(</span>substring-delimited-$ <span style="color: #2d9574;">"&#120792; $here &#120792;"</span> <span style="color: #2d9574;">"&#120792;&#120792;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Multiple occurances of prefix or postfix</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">should</span> <span style="color: #67b11d;">(</span>equal <span style="color: #2d9574;">"y"</span>  <span style="color: #b1951d;">(</span>substring-delimited-$ <span style="color: #2d9574;">"&#119923; $here &#119929;"</span> <span style="color: #2d9574;">"&#119923; x &#119923; y &#119929;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">should</span> <span style="color: #67b11d;">(</span>equal <span style="color: #2d9574;">"x"</span>  <span style="color: #b1951d;">(</span>substring-delimited-$ <span style="color: #2d9574;">"&#119923; $here &#119929;"</span> <span style="color: #2d9574;">"&#119923; x &#119929; y &#119929;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Space irrelevance for keyword &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">$here</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217;:</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">should</span> <span style="color: #67b11d;">(</span>equal <span style="color: #2d9574;">"&#120793;"</span> <span style="color: #b1951d;">(</span>substring-delimited-$ <span style="color: #2d9574;">"&#119923; $here &#119929;"</span> <span style="color: #2d9574;">"&#119923; &#120793; &#119929;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">should</span> <span style="color: #67b11d;">(</span>equal <span style="color: #2d9574;">"&#120793;"</span> <span style="color: #b1951d;">(</span>substring-delimited-$ <span style="color: #2d9574;">"&#119923; $here&#119929;"</span> <span style="color: #2d9574;">"&#119923; &#120793; &#119929;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">should</span> <span style="color: #67b11d;">(</span>equal <span style="color: #2d9574;">"&#120793;"</span> <span style="color: #b1951d;">(</span>substring-delimited-$ <span style="color: #2d9574;">"&#119923;$here &#119929;"</span> <span style="color: #2d9574;">"&#119923; &#120793; &#119929;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">should</span> <span style="color: #67b11d;">(</span>equal <span style="color: #2d9574;">"&#120793;"</span> <span style="color: #b1951d;">(</span>substring-delimited-$ <span style="color: #2d9574;">"&#119923;$here&#119929;"</span> <span style="color: #2d9574;">"&#119923; &#120793; &#119929;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">should</span> <span style="color: #67b11d;">(</span>equal <span style="color: #2d9574;">"&#120793;"</span> <span style="color: #b1951d;">(</span>substring-delimited-$ <span style="color: #2d9574;">"&#119923;      $here  &#119929;"</span> <span style="color: #2d9574;">"&#119923; &#120793; &#119929;"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<p>
Suppose a user provides us with an awkwardly spaced PackageFormer header,
our string manipulation setup is robust enough to get at the constituents:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">-let</span> <span style="color: #6c3163;">[</span>header <span style="color: #2d9574;">"PackageFormer  Semigroup   (  v : Variation) : Set (  &#8467;expr)   where"</span><span style="color: #6c3163;">]</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Three kinds of invocations; the last is my preferred choice &#9829;&#8255;&#9829;</span>
  `<span style="color: #6c3163;">(</span> ,<span style="color: #2d9574;">(</span>substring-delimited <span style="color: #2d9574;">"PackageFormer "</span> <span style="color: #2d9574;">"("</span> header <span style="color: #3a81c3;">:preserve-spaces</span> t <span style="color: #3a81c3;">:longest-substring</span> t<span style="color: #2d9574;">)</span>
     ,<span style="color: #2d9574;">(</span>substring-delimited <span style="color: #2d9574;">"PackageFormer "</span> <span style="color: #2d9574;">"("</span> header<span style="color: #2d9574;">)</span>
     ,<span style="color: #2d9574;">(</span>substring-delimited-$ <span style="color: #2d9574;">"PackageFormer $here ("</span> header<span style="color: #2d9574;">)</span>
   <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Semigroup   (  v : Variation) : Set</td>
<td class="org-left">Semigroup</td>
<td class="org-left">Semigroup</td>
</tr>
</tbody>
</table>

<p>
The aim is to eventually have an interface that interacts with an buffer containing Agda code.
To that end, we propose that our fictitious syntax be directly embedded via special comments,
<code>{-700 ⋯ -}</code>, henceforth referred to as “<a id="orgfeb9199">700-comments</a>”.
</p>

<ul class="org-ul">
<li><code>(buffer-substring-delimited starting-regexp ending-regexp)</code> yields the <i>next</i> portion of the buffer
as a string, relative to the current position of the cursor, that is contained in the ‘parenthesis’
<code>starting-regexp</code> and <code>ending-regexp</code>.</li>

<li><code>(buffer-substring-delimited-whole-buffer starting-regexp ending-regexp)</code> yields <i>all</i> portions of the buffer,
contained in the ‘parenthesis’ <code>starting-regexp</code> and <code>ending-regexp</code>, as a list of strings.

<ul class="org-ul">
<li>Cursor position is saved.</li>
<li>This function let's us obtain the contents of <i>all</i> <a href="#orgfeb9199">700-comments</a>.</li>
</ul></li>
</ul>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> buffer-substring-delimited Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">buffer-substring-delimited</span> <span style="color: #6c3163;">(</span>start end <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> more<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  Get the current buffer's /next/ available substring that is delimited</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  between the regexp tokens &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">start</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; up to &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">end</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;, exclusively.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">  If no tokens are found, an error is thrown.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">  &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">more</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; is a function that is called on the found instance:</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  It is a function of the start and end positions of the occurance.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">let</span> <span style="color: #2d9574;">(</span>start-pos end-pos sp ep content<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span>re-search-forward start<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> start-pos <span style="color: #67b11d;">(</span>point<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span>backward-word<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> sp <span style="color: #67b11d;">(</span>point<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span>re-search-forward end<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> ep <span style="color: #67b11d;">(</span>point<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span>backward-word<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> end-pos <span style="color: #67b11d;">(</span>point<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> content  <span style="color: #67b11d;">(</span>buffer-substring-no-properties start-pos end-pos<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">when</span> more <span style="color: #67b11d;">(</span>funcall more sp ep<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">when</span> 700-folding
      <span style="color: #67b11d;">(</span>goto-char start-pos<span style="color: #67b11d;">)</span>
      <span style="color: #67b11d;">(</span>push-mark end-pos<span style="color: #67b11d;">)</span>
      <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> mark-active t<span style="color: #67b11d;">)</span>
      <span style="color: #67b11d;">(</span>fold-active-region start-pos end-pos<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    content<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<p>
Where we have the following value:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(use-package fold-this :demand t :ensure t)</span>
<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defvar</span> <span style="color: #715ab1;">700-folding</span> nil
  <span style="color: #da8b55; background-color: #ecf3ec;">"Should 700 and lisp blocks be folded away when C-c C-l."</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> buffer-substring-delimited-whole-buffer Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">buffer-substring-delimited-whole-buffer</span> <span style="color: #6c3163;">(</span>start end <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> more<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Return a list of all substrings in the current buffer that</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   are delimited by regexp tokens &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">start</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; and &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">end</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;, exclusively.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">  &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">more</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; is a function that is called on the found instance:</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  It is a function of the start and end positions of the occurance.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Colour 700 keyword red &#8220;'error&#8221;</span>
  <span style="color: #6c3163;">(</span>highlight-phrase start 'error<span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">save-excursion</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">let</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>l nil<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>continue t<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>beginning-of-buffer<span style="color: #67b11d;">)</span>

     <span style="color: #67b11d;">(</span><span style="color: #cd6600;">while</span> continue
       <span style="color: #b1951d;">(</span><span style="color: #cd6600;">condition-case</span> nil
     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">attemptClause</span>
     <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">setq</span> l <span style="color: #6c3163;">(</span>cons <span style="color: #2d9574;">(</span>buffer-substring-delimited start end more<span style="color: #2d9574;">)</span> l<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">recoveryBody</span>
     <span style="color: #3a81c3;">(</span><span style="color: #dc752f; background-color: #fbf8ef;">error</span> <span style="color: #6c3163;">(</span><span style="color: #cd6600;">setq</span> continue nil<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">We've collected items as we saw them, so &#8216;l&#8217; is in reverse.</span>
    <span style="color: #67b11d;">(</span>reverse l<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<p>
Here are some possible invocations, the last one being our use case.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Get text delimited by quotes</span>
<span style="color: #3a81c3;">(</span>buffer-substring-delimited <span style="color: #2d9574;">"^\""</span> <span style="color: #2d9574;">"^\""</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Get text delimited by usual Agda comments</span>
<span style="color: #3a81c3;">(</span>buffer-substring-delimited <span style="color: #2d9574;">"^</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">{-"</span> <span style="color: #2d9574;">"^-</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">}"</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Execute the following in an Agda buffer to see this function in action.</span>
<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">setq</span> it <span style="color: #6c3163;">(</span>buffer-substring-delimited-whole-buffer <span style="color: #2d9574;">"^</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">{-700"</span> <span style="color: #2d9574;">"^-</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">}"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3a51221" class="outline-3">
<h3 id="org3a51221"><span class="section-number-3">3.3</span> Agda Mixfix Renaming and Imports</h3>
<div class="outline-text-3" id="text-3-3">
<p>
Renamaing Agda mixifix names where the rename operation ignores the outermost
position markers ‘_’.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">rename-mixfix</span> <span style="color: #6c3163;">(</span>f op<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Given an Agda mixfix operator, apply a function on strings &#8216;f&#8217; on</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   the inner-most delimiting tokens of the operator, in-particular ignoring</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   outer argument markers &#8216;_&#8217;.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   For example, if you wish to decorate an operator with a prime or a subscript,</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   we cannot simply catenate else we obtain &#8220;_&#8853;_&#8321;&#8221; rather than &#8220;_&#8853;&#8321;_&#8221;.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   Here are some sample results, assuming &#8220;f &#8776; (&#955; (it) (format &#8220;&#8320;%s&#185;&#8221; it))&#8221;:</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   _&#8853;_     &#8614;  _&#8320;&#8853;&#185;_</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   _[_&#8855;_]  &#8614;  _&#8320;[_&#8855;_]&#185;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   he_lo   &#8614;  &#8320;he_lo&#185;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   he-lo   &#8614;  &#8320;he-lo&#185;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">let*</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>parts <span style="color: #b1951d;">(</span>s-split <span style="color: #2d9574;">"_"</span> op<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span>front <span style="color: #b1951d;">(</span>s-blank? <span style="color: #3a81c3;">(</span>first parts<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span>rear <span style="color: #b1951d;">(</span>s-blank? <span style="color: #3a81c3;">(</span>car <span style="color: #6c3163;">(</span>last parts<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

  <span style="color: #2d9574;">(</span><span style="color: #cd6600;">--&gt;</span> <span style="color: #67b11d;">(</span>concat <span style="color: #b1951d;">(</span><span style="color: #cd6600;">when</span> front <span style="color: #2d9574;">"_"</span><span style="color: #b1951d;">)</span> <span style="color: #2d9574;">"$here"</span> <span style="color: #b1951d;">(</span><span style="color: #cd6600;">when</span> rear <span style="color: #2d9574;">"_"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
       <span style="color: #67b11d;">(</span>substring-delimited-$ it op <span style="color: #3a81c3;">:longest-substring</span> t<span style="color: #67b11d;">)</span>
       <span style="color: #67b11d;">(</span>funcall f it<span style="color: #67b11d;">)</span>
       <span style="color: #67b11d;">(</span>concat <span style="color: #b1951d;">(</span><span style="color: #cd6600;">when</span> front <span style="color: #2d9574;">"_"</span><span style="color: #b1951d;">)</span> it <span style="color: #b1951d;">(</span><span style="color: #cd6600;">when</span> rear <span style="color: #2d9574;">"_"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
   <span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
We also want to prefix the generated file with the imports of the current file.
</p>
<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> extract-imports Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">extract-imports</span> <span style="color: #6c3163;">()</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Return substring of buffer whose lines mention &#8220;import&#8221;.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   Throw away any that mention the substring &#8220;&#10218;FileName&#10219;_Generated&#8221;.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">thread-last</span> <span style="color: #2d9574;">(</span>buffer-substring-no-properties <span style="color: #67b11d;">(</span>point-min<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span>point-max<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span>s-split <span style="color: #2d9574;">"\n"</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">--filter</span> <span style="color: #67b11d;">(</span>s-contains? <span style="color: #2d9574;">"import "</span> it<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">--remove</span> <span style="color: #67b11d;">(</span>s-contains?
           <span style="color: #b1951d;">(</span>format  <span style="color: #2d9574;">"%s_Generated"</span> <span style="color: #3a81c3;">(</span>file-name-sans-extension <span style="color: #6c3163;">(</span>buffer-name<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> it<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span>s-join <span style="color: #2d9574;">"\n"</span><span style="color: #2d9574;">)</span>
  <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<p>
So much string meddling, hopefully no more 🙈 :hear<sub>no</sub><sub>evil</sub>: :speak<sub>no</sub><sub>evil</sub>:
</p>
</div>
</div>
</div>

<div id="outline-container-org9105fd9" class="outline-2">
<h2 id="org9105fd9"><span class="section-number-2">4</span> The <code>package-former</code> Datatype</h2>
<div class="outline-text-2" id="text-4">
<p>
For this prototype's <a href="#org49fea97">constraints</a>, a PackageFormer will generally declared as
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #ba2f59; font-weight: bold;">PackageFormer Name</span> : <span style="color: #cd6600;">Set</span> <span style="color: #0000cd;">level</span> <span style="color: #cd6600;">where</span>
     &#8942;
</pre>
</div>

<p>
The body, <code>⋮</code>, of such a declaration consists of a number of name-type declarations
and, equations ---<b>not yet supported</b>&#x2014; so let's form a type to work with these
components rather than meddle with strings all the time.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defstruct</span> package-former
  <span style="color: #da8b55; background-color: #ecf3ec;">"Record of components that form a PackageFormer.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   - &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">docstring</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;: Relevant documentation about this structure; e.g.,</span>
<span style="color: #da8b55; background-color: #ecf3ec;">      what is the instance declaration that generated this type, if any.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   - &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">kind</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;: PackageFormer, record, data, module, function, etc.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   - &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">name</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;: The name of the grouping mechanism schema.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   - &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">level</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;: The universe level that the instantiations will inhabit.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">          The universe level of the PackageFormer.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   - Finally, the children fields are the typed-names that constitute the body of the</span>
<span style="color: #da8b55; background-color: #ecf3ec;">     grouping mechanism. As long as consistent indentation is selected, it does not matter how much.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">     As such, we keep track of these indentation numerics ourselves in case we need to tweak them.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   - The first &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">waist</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;-many elements are considered parameters.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   &#8252; TODO: Eventually need to support variations?</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>
  docstring
  kind
  name
  level

  waist <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Delimits elements into parameters and fields.</span>
  waist-strings

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">children</span>
  indentation <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">useful for when new elements are added.</span>
  elements
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
We will keep track of all such declarations in a global list.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defvar</span> <span style="color: #715ab1;">package-formers</span> nil
  <span style="color: #da8b55; background-color: #ecf3ec;">"The list of PackageFormer schema declarations in the current Agda buffer."</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>

<div id="outline-container-org076966c" class="outline-3">
<h3 id="org076966c"><span class="section-number-3">4.1</span> Locally Opening a PackageFormer</h3>
<div class="outline-text-3" id="text-4-1">
<p>
It will get rather redundant to write <code>(package-former-X p)</code> to project the constituents of a PackageFormer <code>p</code>. As such, let's introduce
a useful macro to “open p” locally.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">An anaphoric macro ^_^</span>
<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defmacro</span> <span style="color: #6c3163; font-weight: bold;">open-pf</span> <span style="color: #6c3163;">(</span>p <span style="color: #ba2f59; font-weight: bold;">&amp;rest</span> body<span style="color: #6c3163;">)</span>
  `<span style="color: #6c3163;">(</span><span style="color: #cd6600;">let*</span>
    <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>docstring             <span style="color: #b1951d;">(</span>package-former-docstring ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>kind                  <span style="color: #b1951d;">(</span>package-former-kind ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>name                  <span style="color: #b1951d;">(</span>package-former-name ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>level                 <span style="color: #b1951d;">(</span>package-former-level ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>waist                 <span style="color: #b1951d;">(</span>package-former-waist ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>waist-strings         <span style="color: #b1951d;">(</span>package-former-waist-strings ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>indentation           <span style="color: #b1951d;">(</span>package-former-indentation ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>elements              <span style="color: #b1951d;">(</span>package-former-elements ,p<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8252; TODO: MA: Eventually need to support variations?</span>

    <span style="color: #67b11d;">(</span>parameters            <span style="color: #b1951d;">(</span>-take waist elements<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
    <span style="color: #67b11d;">(</span>fields                <span style="color: #b1951d;">(</span>-drop waist elements<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    ,@body
  <span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
( Lisp convention would advise this function to be named <code>with-pf</code>, but I'm using the prefix <code>open</code>,
as it is closer to the object language, Agda. )
</p>

<p>
It is crucial to realise that we have just established a convention
that partitions the elements of a PackageFormer:
</p>
<ul class="org-ul">
<li><a id="orgbfc27a3">parameters</a> are the elements before the waist line.</li>
<li><a id="org3a76688">fields</a> are the elements after the waist line.</li>
</ul>
</div>
</div>

<div id="outline-container-org63ce2ce" class="outline-3">
<h3 id="org63ce2ce"><span class="section-number-3">4.2</span> Typed Names</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Finally, it seems we need support for typed names &#x2014;pairs <code>“name : type”</code>.
We could use <code>car</code> and <code>cdr</code> on pairs, but let's use named projections instead
so we don't have this extra mental strain and implicit type-checking to ensure.
</p>
<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Working with “name : type” Pairs </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">make-tn</span> <span style="color: #6c3163;">(</span>name type<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Produce a typed-name pair; discard all surrounding whitespace."</span>
  <span style="color: #6c3163;">(</span>concat <span style="color: #2d9574;">(</span>s-trim name<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">" : "</span> <span style="color: #2d9574;">(</span>s-trim type<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">get-name</span> <span style="color: #6c3163;">(</span>tn<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Given a string &#8220;name : type&#8221;, return the &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">name</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   which will not have any colons in it.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   Whitespace at the edges is trimmed away.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>
  <span style="color: #6c3163;">(</span>s-trim <span style="color: #2d9574;">(</span>car <span style="color: #67b11d;">(</span>s-split <span style="color: #2d9574;">" : "</span> tn<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">get-type</span> <span style="color: #6c3163;">(</span>tn<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Given a string &#8220;name : type&#8221;, return the longest possible &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">type</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; substring.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  Whitespace at the edges is trimmed away."</span>
  <span style="color: #6c3163;">(</span>s-trim <span style="color: #2d9574;">(</span>s-join <span style="color: #2d9574;">" : "</span> <span style="color: #67b11d;">(</span>cdr <span style="color: #b1951d;">(</span>s-split <span style="color: #2d9574;">" : "</span> tn<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defmacro</span> <span style="color: #6c3163; font-weight: bold;">map-name</span> <span style="color: #6c3163;">(</span>fbody tn<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Apply string expression &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">fbody</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; to the &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">name</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; position of a typed-named structure.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">fbody</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; may mention &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">name</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>
  `<span style="color: #6c3163;">(</span>make-tn <span style="color: #2d9574;">(</span>rename-mixfix <span style="color: #67b11d;">(</span><span style="color: #cd6600;">lambda</span> <span style="color: #b1951d;">(</span>name<span style="color: #b1951d;">)</span> ,fbody<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span>get-name ,tn<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span>get-type ,tn<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defmacro</span> <span style="color: #6c3163; font-weight: bold;">map-type</span> <span style="color: #6c3163;">(</span>fbody tn<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Apply string expression &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">fbody</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; to the &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">type</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; position of a typed-named structure.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">fbody</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; may mention &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">type</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>
  `<span style="color: #6c3163;">(</span><span style="color: #cd6600;">let</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>type <span style="color: #b1951d;">(</span>get-type ,tn<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
       <span style="color: #2d9574;">(</span>make-tn <span style="color: #67b11d;">(</span>get-name ,tn<span style="color: #67b11d;">)</span> ,fbody<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">ert-deftest</span> <span style="color: #6c3163; font-weight: bold;">tn</span> <span style="color: #6c3163;">()</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Superflous space</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span>equal <span style="color: #2d9574;">"name"</span> <span style="color: #67b11d;">(</span>get-name <span style="color: #2d9574;">"name   : type"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Multiple &#8220;:&#8221;.</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span>equal <span style="color: #2d9574;">"&#8704; {X : Obj &#119966;} &#8594; (X &#10230; X)"</span>
         <span style="color: #67b11d;">(</span>get-type<span style="color: #2d9574;">"Id : &#8704; {X : Obj &#119966;} &#8594; (X &#10230; X)"</span><span style="color: #67b11d;">)</span> <span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #3a81c3;">)</span>

</pre>
</div>
</details>
</div>
</div>

<div id="outline-container-org9a8491f" class="outline-3">
<h3 id="org9a8491f"><span class="section-number-3">4.3</span> Package Former Parsing and Pretty Printing</h3>
<div class="outline-text-3" id="text-4-3">
<p>
With this in hand, let's produce a robust parser.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">load-package-former</span> <span style="color: #6c3163;">(</span>lines<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"The input &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">lines</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; must be a list of lines forming a full PackageFormer declaration;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   e.g., obtained by calling &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">get-children</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   It is parsed and a &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">package-former</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; value is returned.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   - Whitespace is stripped off of items.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   - Docstrings are ignored.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">when</span> <span style="color: #2d9574;">(</span>not lines<span style="color: #2d9574;">)</span>
      <span style="color: #2d9574;">(</span><span style="color: #dc752f; background-color: #fbf8ef;">error</span> <span style="color: #2d9574;">"load-package-former: Error: Input must be non-empty list."</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">catch</span> '<span style="color: #4e3163;">exit</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">let*</span> <span style="color: #67b11d;">(</span>pf
           <span style="color: #b1951d;">(</span>header <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">or</span> <span style="color: #6c3163;">(</span>car lines<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span><span style="color: #cd6600;">throw</span> '<span style="color: #4e3163;">exit</span> nil<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
           <span style="color: #b1951d;">(</span>name <span style="color: #3a81c3;">(</span>substring-delimited-$ <span style="color: #2d9574;">"PackageFormer $here :"</span> header<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
           <span style="color: #b1951d;">(</span>level <span style="color: #3a81c3;">(</span>substring-delimited-$ <span style="color: #2d9574;">"Set $here where"</span> header<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

      <span style="color: #67b11d;">(</span><span style="color: #cd6600;">when</span> 700-highlighting
        <span style="color: #b1951d;">(</span><span style="color: #cd6600;">--map</span> <span style="color: #3a81c3;">(</span>highlight-phrase <span style="color: #6c3163;">(</span>s-trim it<span style="color: #6c3163;">)</span> 'hi-yellow<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span>cdr lines<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

      <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> pf
            <span style="color: #b1951d;">(</span>make-package-former
             <span style="color: #3a81c3;">:kind</span>                     <span style="color: #2d9574;">"PackageFormer"</span>
             <span style="color: #3a81c3;">:name</span>                     name
             <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">level</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; may be &#8220;&#8221;, that's okay.</span>
             <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">It may be a subscript or implicitly zero &amp; so no space after &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">Set</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217;.</span>
             <span style="color: #3a81c3;">:level</span>                    level
             <span style="color: #3a81c3;">:waist</span>                    0
             <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8252; TODO: Currently no parameter support for arbitrary PackageFormers.</span>
             <span style="color: #3a81c3;">:indentation</span>              <span style="color: #3a81c3;">(</span>get-indentation <span style="color: #6c3163;">(</span>cadr lines<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
             <span style="color: #3a81c3;">:elements</span>                 <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">--map</span> <span style="color: #6c3163;">(</span>s-trim it<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>cdr lines<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
             <span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

      <span style="color: #67b11d;">(</span><span style="color: #cd6600;">push</span> <span style="color: #b1951d;">(</span>cons name pf<span style="color: #b1951d;">)</span> package-formers<span style="color: #67b11d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">return value</span>
      pf<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Let's try this out.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>load-package-former <span style="color: #6c3163;">(</span>cadr <span style="color: #2d9574;">(</span>get-children <span style="color: #2d9574;">"PackageFormer"</span> test<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">#s(package-former nil PackageFormer M-Set ₁ 0 nil 3 (Scalar  : Set Vector  : Set <span class="underline">·</span>     : Scalar → Vector → Vector 𝟙       : Scalar <span class="underline">×</span>     : Scalar → Scalar → Scalar leftId  : {𝓋 : Vector}  →  𝟙 · 𝓋  ≡  𝓋 assoc   : {a b : Scalar} {𝓋 : Vector} → (a × b) · 𝓋  ≡  a · (b · 𝓋)))</td>
</tr>
</tbody>
</table>

<p>
Conversely, let's have a pretty printer.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">special</span> <span style="color: #6c3163;">(</span>f<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Special elements, for whatever reason are exceptional, and so</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   are maked as singleton lists and their indentation is lessened.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   That is, these denote sibling fields rather than more children.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   Special elements include: field, private.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   See &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">show-package-former</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; for their use and how their printed.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">--any?</span> <span style="color: #2d9574;">(</span>s-contains? it f<span style="color: #2d9574;">)</span> '<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"field"</span> <span style="color: #2d9574;">"private"</span> <span style="color: #2d9574;">"open"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">show-package-former</span> <span style="color: #6c3163;">(</span>p <span style="color: #ba2f59; font-weight: bold;">&amp;key</span> extra-waist-strings
                 omit-docstring omit-car-element<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Pretty print a package-former record value.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   -&#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">waist-strings</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;: Arbitrary new elements that are input at the location of the</span>
<span style="color: #da8b55; background-color: #ecf3ec;">     PackageFormer's waist. E.g., the following results in a new local alias &#8216;n&#8217;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">     before the remaining constitutents are printed under a &#8220;field&#8221; clause.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">     :waist-strings (list &#8220;private&#8221; &#8220;n : &#8469;&#8221; &#8220;n = 3&#8221; &#8220;field&#8221;)</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">open-pf</span> p
    <span style="color: #2d9574;">(</span>s-join <span style="color: #2d9574;">"\n"</span>
      <span style="color: #67b11d;">(</span>-cons*

       <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The documentation string</span>
       <span style="color: #b1951d;">(</span><span style="color: #cd6600;">and</span> <span style="color: #3a81c3;">(</span>not omit-docstring<span style="color: #3a81c3;">)</span> docstring <span style="color: #3a81c3;">(</span>format <span style="color: #2d9574;">"{- %s -}"</span> docstring<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>

       <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The schema declaration</span>
       <span style="color: #b1951d;">(</span>s-collapse-whitespace
        <span style="color: #3a81c3;">(</span>s-join <span style="color: #2d9574;">" "</span>
                <span style="color: #6c3163;">(</span>list kind
                      name
                      <span style="color: #2d9574;">(</span>s-join <span style="color: #2d9574;">" "</span> <span style="color: #887070;">(</span><span style="color: #cd6600;">--map</span> <span style="color: #3a81c3;">(</span>concat <span style="color: #2d9574;">"("</span> it <span style="color: #2d9574;">")"</span><span style="color: #3a81c3;">)</span> parameters<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>
                      <span style="color: #2d9574;">(</span><span style="color: #cd6600;">unless</span> <span style="color: #887070;">(</span>equal level 'none<span style="color: #887070;">)</span> <span style="color: #887070;">(</span>concat <span style="color: #2d9574;">": Set"</span> level<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>
                      <span style="color: #2d9574;">"where"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>

       <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The elements of a PackageFormer</span>
       <span style="color: #b1951d;">(</span><span style="color: #cd6600;">thread-last</span> fields
         <span style="color: #3a81c3;">(</span>-concat waist-strings<span style="color: #3a81c3;">)</span>
         <span style="color: #3a81c3;">(</span>-concat extra-waist-strings<span style="color: #3a81c3;">)</span>

         <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Indent all elements, less indentation for the specials.</span>
         <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">--map</span> <span style="color: #6c3163;">(</span>concat <span style="color: #2d9574;">(</span>s-repeat <span style="color: #887070;">(</span>- indentation <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">if</span> <span style="color: #6c3163;">(</span>special it<span style="color: #6c3163;">)</span> 2 0<span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span> <span style="color: #2d9574;">" "</span><span style="color: #2d9574;">)</span> it<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
         <span style="color: #3a81c3;">(</span>funcall <span style="color: #6c3163;">(</span><span style="color: #cd6600;">if</span> omit-car-element #'cdr #'identity<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Let's test it out by <i>introducing</i> a whole new local variable and trying
to include the <code>field</code> Agda keyword.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">let*</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>raw <span style="color: #67b11d;">(</span>cadr <span style="color: #b1951d;">(</span>get-children <span style="color: #2d9574;">"PackageFormer"</span> test<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
       <span style="color: #2d9574;">(</span>pf <span style="color: #67b11d;">(</span>load-package-former raw<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
       <span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">setf</span> <span style="color: #2d9574;">(</span>package-former-waist pf<span style="color: #2d9574;">)</span> 2<span style="color: #6c3163;">)</span>
   <span style="color: #6c3163;">(</span>show-package-former pf
    <span style="color: #3a81c3;">:omit-car-element</span> t
    <span style="color: #3a81c3;">:extra-waist-strings</span> <span style="color: #2d9574;">(</span>list <span style="color: #2d9574;">"."</span> <span style="color: #2d9574;">"private"</span> <span style="color: #2d9574;">"n : &#8469;"</span> <span style="color: #2d9574;">"n = 3"</span> <span style="color: #2d9574;">"field {- elements -} "</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
   <span style="color: #3a81c3;">)</span><span style="color: #e0211d; font-weight: bold; text-decoration: overline;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda">
<span style="color: #ba2f59; font-weight: bold;">PackageFormer M-Set (Scalar</span> : <span style="color: #cd6600;">Set</span>)<span style="color: #ba2f59; font-weight: bold;"> (Vector</span> : <span style="color: #cd6600;">Set</span>) :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
 <span style="color: #cd6600;">private</span>
   <span style="color: #0000cd;">n</span> : <span style="color: #ba2f59; font-weight: bold;">&#8469;</span>
   <span style="color: #0000cd;">n</span> <span style="color: #cd6600;">=</span> <span style="color: #a020f0;">3</span>
 <span style="color: #cd6600;">field</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">elements </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
   _&#183;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Vector</span>
   &#120793;       :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   _&#215;_     :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>
   <span style="color: #ba2f59; font-weight: bold;">leftId</span>  : {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011;
   <span style="color: #ba2f59; font-weight: bold;">assoc</span>   : {<span style="color: #0000cd;">a</span> <span style="color: #0000cd;">b</span> :<span style="color: #ba2f59; font-weight: bold;"> Scalar</span>} {&#120011; :<span style="color: #ba2f59; font-weight: bold;"> Vector</span>} &#8594; (<span style="color: #0000cd;">a</span> &#215; <span style="color: #0000cd;">b</span>) &#183; &#120011;  &#8801;  <span style="color: #0000cd;">a</span> &#183; (<span style="color: #0000cd;">b</span> &#183; &#120011;)
</pre>
</div>

<p>
The call to <code>s-collapse-whitespace</code> permits us to phrase an approximation of the opinion
that parsing and showing should be inverses.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">-let</span> <span style="color: #6c3163;">[</span>pf <span style="color: #2d9574;">(</span>cadr <span style="color: #67b11d;">(</span>get-children <span style="color: #2d9574;">"PackageFormer"</span> test<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">]</span>
  <span style="color: #6c3163;">(</span>equal <span style="color: #2d9574;">(</span>concat <span style="color: #2d9574;">"\n"</span> <span style="color: #67b11d;">(</span>s-join <span style="color: #2d9574;">"\n"</span> pf<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
     <span style="color: #2d9574;">(</span>show-package-former <span style="color: #67b11d;">(</span>load-package-former pf<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">t</td>
</tr>
</tbody>
</table>

<div class="org-center">
<p>
( <i>In Lisp, <code>t</code> denotes “true”!</i> )
</p>
</div>


<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Unit Tests </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">ert-deftest</span> <span style="color: #6c3163; font-weight: bold;">pf-parse</span> <span style="color: #6c3163;">()</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Error on empty list of lines.</span>
   <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should-error</span> <span style="color: #2d9574;">(</span>load-package-former nil<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">No crash on empty line.</span>
   <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span>load-package-former <span style="color: #67b11d;">(</span>list <span style="color: #2d9574;">""</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">No crash on PackageFormer with no elements.</span>
   <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span>load-package-former <span style="color: #67b11d;">(</span>list <span style="color: #2d9574;">"PackageFormer PF : Set &#8467; where"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Levels</span>
   <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span>equal <span style="color: #2d9574;">"&#8467;"</span> <span style="color: #67b11d;">(</span>package-former-level <span style="color: #b1951d;">(</span>load-package-former <span style="color: #3a81c3;">(</span>list <span style="color: #2d9574;">"PackageFormer PF : Set &#8467; where"</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
   <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
   <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span>equal <span style="color: #2d9574;">""</span> <span style="color: #67b11d;">(</span>package-former-level <span style="color: #b1951d;">(</span>load-package-former <span style="color: #3a81c3;">(</span>list <span style="color: #2d9574;">"PackageFormer PF : Set  where"</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
   <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
   <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span>equal <span style="color: #2d9574;">"&#8323;"</span> <span style="color: #67b11d;">(</span>package-former-level <span style="color: #b1951d;">(</span>load-package-former <span style="color: #3a81c3;">(</span>list <span style="color: #2d9574;">"PackageFormer PF : Set&#8323; where"</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
   <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
   <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span>equal <span style="color: #2d9574;">"(Level.suc &#8467;)"</span> <span style="color: #67b11d;">(</span>package-former-level <span style="color: #b1951d;">(</span>load-package-former <span style="color: #3a81c3;">(</span>list <span style="color: #2d9574;">"PackageFormer PF : Set (Level.suc &#8467;) where"</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Full parsing.</span>
   <span style="color: #6c3163;">(</span><span style="color: #cd6600;">-let</span> <span style="color: #2d9574;">[</span>pf <span style="color: #67b11d;">(</span>load-package-former <span style="color: #b1951d;">(</span>cadr <span style="color: #3a81c3;">(</span>get-children <span style="color: #2d9574;">"PackageFormer"</span> test<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span>
     <span style="color: #2d9574;">(</span>equal <span style="color: #67b11d;">(</span>format <span style="color: #2d9574;">"%s"</span> pf<span style="color: #67b11d;">)</span>
            <span style="color: #2d9574;">"#s(package-former nil PackageFormer M-Set &#8321; 0 nil 3 (Scalar  : Set Vector  : Set _&#183;_     : Scalar &#8594; Vector &#8594; Vector &#120793;       : Scalar _&#215;_     : Scalar &#8594; Scalar &#8594; Scalar leftId  : {&#120011; : Vector}  &#8594;  &#120793; &#183; &#120011;  &#8801;  &#120011; assoc   : {a b : Scalar} {&#120011; : Vector} &#8594; (a &#215; b) &#183; &#120011;  &#8801;  a &#183; (b &#183; &#120011;)))"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">-let</span> <span style="color: #2d9574;">[</span>pf <span style="color: #67b11d;">(</span>cadr <span style="color: #b1951d;">(</span>get-children <span style="color: #2d9574;">"PackageFormer"</span> test<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">should</span> <span style="color: #67b11d;">(</span>equal <span style="color: #b1951d;">(</span>s-concat <span style="color: #2d9574;">"\n"</span> <span style="color: #3a81c3;">(</span>s-join <span style="color: #2d9574;">"\n"</span> pf<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
                   <span style="color: #b1951d;">(</span>show-package-former <span style="color: #3a81c3;">(</span>load-package-former pf<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

<span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>
</div>
</div>
</div>

<div id="outline-container-orgdeb0c69" class="outline-2">
<h2 id="orgdeb0c69"><span class="section-number-2">5</span> Variational Language</h2>
<div class="outline-text-2" id="text-5">
<p>
A variational has the syntactic form specfied by
</p>

<div class="org-src-container">
<pre class="src src-text">        &#120011;   ::=  identifier (identifier)* = &#120011;&#119992;
        &#120011;&#119992;  ::= [identifier] (:key value)* (&#10228; &#120011;&#119992;)*

        identifier &#8776; key &#8776; value &#8776; string of text
</pre>
</div>

<p>
With the intention that <code>l a = r</code> is a list of key-value pairs
determined from the right-hand side where the arguments <code>a</code>
are to be considered place-holders. Whenever one mentions free variables,
or terms, one actually speaks of functions. Hence, let's reify these as functions.
</p>
</div>

<div id="outline-container-org3a54f99" class="outline-3">
<h3 id="org3a54f99"><span class="section-number-3">5.1</span> 𝒱𝒸,  𝒱-, and 𝒱</h3>
<div class="outline-text-3" id="text-5-1">
<p>
Variationals are refieid as functions with the prefix 𝒱-;
doing otherwise may override existing utilities in Emacs
&#x2014;for example, ‘record’ is a useful name for a variational
but is a super important utility function in Emacs.
The apporach we take is to allow users to write ‘record’
but the implementation will refer to it with a prefix.
</p>

<p>
Parsing variational clauses is then straightforward:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defvar</span> <span style="color: #715ab1;">*parent-context*</span> nil
  <span style="color: #da8b55; background-color: #ecf3ec;">"For error report; what is the current parent context of a child item.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   Should be set whenver a parent invokes a child.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   Since we have no grandchildren, we only need one level.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">"</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">&#119985;&#119992;</span> <span style="color: #6c3163;">(</span>body-list <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> context args<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Parse a single &#119985;ariational &#119992;lause, as a list, of the form &#8220;[label] (:key :value)*&#8221;.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   If there is a &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">label</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;, then yield &#8216;(label :key value &#8943;)&#8217;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   since &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">label</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; is assumed to exist as a variational having the given</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   keys as arguments. The result should be a list of pairs.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   If there is no label, the parse the list of pairs.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">  For example,</span>
<span style="color: #da8b55; background-color: #ecf3ec;">     (cl-defun &#119985;-test (&amp;key height kind) (format \"%s &amp; %s\" height kind))</span>
<span style="color: #da8b55; background-color: #ecf3ec;">     (&#119985;&#8321; '(test :height 3 :kind 'data)) &#8658; &#8220;3 &amp; data&#8221; &#8776; (test :height 3 :kind data)</span>
<span style="color: #da8b55; background-color: #ecf3ec;">     (&#119985;&#8321; '(     :height 3 :kind data)) &#8658; ((:height . 3) (:kind . data))</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   Newer items c&#8320; &#10228; &#8943; &#10228; c&#8345; should be at the front of the list;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   access should then be using &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">assoc</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">let*</span> <span style="color: #2d9574;">(</span>res <span style="color: #67b11d;">(</span>*parent-context* context<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">loop</span> for clause in <span style="color: #67b11d;">(</span><span style="color: #cd6600;">-split-on</span> '&#10228; body-list<span style="color: #67b11d;">)</span>
          do <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> res <span style="color: #b1951d;">(</span>-concat
                 <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Symbols starting with &#8220;:&#8221; are keywords.</span>
                 <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">if</span> <span style="color: #6c3163;">(</span>not <span style="color: #2d9574;">(</span>keywordp <span style="color: #887070;">(</span>car clause<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
                     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Function invocation case</span>
                     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">We turn everything into a string so that we may</span>
                     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">prepend the function name with a &#119985;-</span>
                     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">then turn that into Lisp with the first eval</span>
                     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">then invoke the resulting function call with the second eval.</span>
                     <span style="color: #6c3163;">(</span>eval `<span style="color: #2d9574;">(</span> ,<span style="color: #887070;">(</span>&#119985;- <span style="color: #3a81c3;">(</span>car clause<span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span> ,@<span style="color: #887070;">(</span>cdr clause<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
                   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">List of key-value pairs</span>
                   `,<span style="color: #6c3163;">(</span><span style="color: #cd6600;">loop</span> for key   in clause by #'cddr
                           for value in <span style="color: #2d9574;">(</span>cdr clause<span style="color: #2d9574;">)</span> by #'cddr
                           collect <span style="color: #2d9574;">(</span>700-wf key value context args<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8220;700-wf&#8221; is just a fancy &#8220;cons&#8221;.</span>
                 <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Newer items c&#8320; &#10228; &#8943; &#10228; c&#8345; should be at the front of the list;</span>
                 <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">access should then be using assoc.</span>
                 res<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    res<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
<p>
Where we have used the following helper to prefix Lisp code with “𝒱-”.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">&#119985;-</span> <span style="color: #6c3163;">(</span>name<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Prefix the Lisp data &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">name</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; with a &#8220;&#119985;-&#8221;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   then yield that as a Lisp datum.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span>symbolp name<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">thread-last</span> name
    <span style="color: #2d9574;">(</span>format <span style="color: #2d9574;">"&#119985;-%s"</span><span style="color: #2d9574;">)</span>
    read-from-string
    car<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
We now handle variational declarations by introducing a DSL; i.e., a macro that
expects the syntax outlined earlier.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defmacro</span> <span style="color: #6c3163; font-weight: bold;">&#119985;</span> <span style="color: #6c3163;">(</span>name <span style="color: #ba2f59; font-weight: bold;">&amp;rest</span> body<span style="color: #6c3163;">)</span>

  <span style="color: #da8b55; background-color: #ecf3ec;">"Reify as Lisp a variational declaration using the following grammar.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">        &#120011;   ::=  identifier (identifier)* = &#120011;&#119992;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">        &#120011;&#119992;  ::= [identifier] (:key value)* (&#10228; &#120011;&#119992;)*</span>

<span style="color: #da8b55; background-color: #ecf3ec;">    The resulting generated function has its code embeded as a docstring viewable</span>
<span style="color: #da8b55; background-color: #ecf3ec;">    with &#8220;C-h o&#8221;.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">For beauty, let's colour variational names green.</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Only colour occurances that have a space before or after.</span>
  <span style="color: #6c3163;">(</span>highlight-phrase <span style="color: #2d9574;">(</span>format <span style="color: #2d9574;">"[- </span><span style="color: #C57BDB; font-weight: bold;">\\</span><span style="color: #C57BDB; font-weight: bold;">|</span><span style="color: #2d9574;"> ]%s "</span> `,name<span style="color: #2d9574;">)</span> 'hi-green<span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Main code follows.</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">let*</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>context <span style="color: #b1951d;">(</span>mapconcat <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">lambda</span> <span style="color: #6c3163;">(</span>x<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>prin1-to-string x t<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span>cons name body<span style="color: #3a81c3;">)</span> <span style="color: #2d9574;">" "</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
         <span style="color: #67b11d;">(</span>args-body <span style="color: #b1951d;">(</span><span style="color: #cd6600;">-split-on</span> '= body<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> args body res actual-code<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">pcase</span> <span style="color: #67b11d;">(</span>length args-body<span style="color: #67b11d;">)</span>
      <span style="color: #67b11d;">(</span>2 <span style="color: #b1951d;">(</span><span style="color: #cd6600;">setq</span> args <span style="color: #3a81c3;">(</span>car args-body<span style="color: #3a81c3;">)</span>
               body <span style="color: #3a81c3;">(</span>cadr args-body<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
      <span style="color: #67b11d;">(</span>t <span style="color: #b1951d;">(</span><span style="color: #cd6600;">setq</span> body <span style="color: #3a81c3;">(</span>car args-body<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> res <span style="color: #67b11d;">(</span>&#119985;&#119992; body context args<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">I want to be able to actually, visually, see the resulting</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">generated definition of a function.</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Hence, I embed its source code as a string in the code.</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">I'm using strings so that they appear in the docstring via C-h o.</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> actual-code
    `<span style="color: #67b11d;">(</span><span style="color: #cd6600;">cl-defun</span> ,<span style="color: #b1951d;">(</span>&#119985;- name<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #ba2f59; font-weight: bold;">&amp;key</span> ,@args<span style="color: #b1951d;">)</span>

       <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Stage the formal names *now*, then evaluate their values at run time.</span>
       <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Traverse the list of pairs and change the nested formal names with the</span>
       <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">given values. Praise the Lord!</span>
      <span style="color: #b1951d;">(</span><span style="color: #cd6600;">let*</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163;">(</span>give-goal <span style="color: #2d9574;">(</span><span style="color: #cd6600;">quote</span> ,res<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>give-goal&#8320; give-goal<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
        <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">when</span> <span style="color: #6c3163;">(</span><span style="color: #cd6600;">quote</span> ,args<span style="color: #6c3163;">)</span>

          <span style="color: #2d9574;">"Stage the formal names *now*, then evaluate their values at run time."</span>
          <span style="color: #6c3163;">(</span><span style="color: #cd6600;">loop</span> for a in <span style="color: #2d9574;">(</span><span style="color: #cd6600;">quote</span> ,args<span style="color: #2d9574;">)</span>
                do <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> give-goal <span style="color: #887070;">(</span>subst <span style="color: #3a81c3;">(</span>eval a<span style="color: #3a81c3;">)</span> a give-goal<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">TODO, maybe.</span>
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">"Check that substituted values are well-typed"</span>
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(--map (700-wf (car it) (or (cdr it)</span>
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;;                             </span><span style="color: #2aa1ae; background-color: #ecf3ec;">;; Mention which argument is not supplied.</span>
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;;                             </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(format "No Value for :%s Provided!"</span>
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;;                                     </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(cdr (assoc (car it) (reverse give-goal&#8320;)))))</span>
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;;                </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(s-concat (when *parent-context* (s-concat *parent-context* "\n\t&#10153;\t")) ,context)) give-goal)</span>

          <span style="color: #3a81c3;">)</span>

         give-goal<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Now splice the code as a documentation string in it.</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> actual-code <span style="color: #67b11d;">(</span>-concat <span style="color: #b1951d;">(</span>-take 3 actual-code<span style="color: #b1951d;">)</span>
                           <span style="color: #b1951d;">(</span>list <span style="color: #3a81c3;">(</span>format <span style="color: #2d9574;">"%s\n\n%s"</span> context <span style="color: #6c3163;">(</span>pp-to-string actual-code<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
                           <span style="color: #b1951d;">(</span>nthcdr 3 actual-code<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Return value:</span>
    actual-code<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Consequently, any item declared with 𝒱 now has a docstring containing its user-facing
definition as well as its Lisp realisation ^_^ &#x2014;simply press “C-h o ENTER” on its name.
</p>
</div>
</div>

<div id="outline-container-org6d47006" class="outline-3">
<h3 id="org6d47006"><span class="section-number-3">5.2</span> Well-formed checks &#x2014;Error reporting</h3>
<div class="outline-text-3" id="text-5-2">
<p>
What is the above “fancy cons” we mentioned? Here it is.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">700-error</span> <span style="color: #6c3163;">(</span>condition message context<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Ensure &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">condition</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; is true, otherwise emit &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">message</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   and indicate the offending &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">context</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">when</span> condition
    <span style="color: #2d9574;">(</span><span style="color: #dc752f; background-color: #fbf8ef;">error</span> <span style="color: #67b11d;">(</span>format <span style="color: #2d9574;">"700: %s\n\n\t&#8680;\t%s"</span> message context<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">700-wf</span> <span style="color: #6c3163;">(</span>key value <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> context args<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"This operation checks that the &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">value</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; of &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">key</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   is well-formed according to 700-specifications ---which are stated</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   explicitly within this method--- and if it is well-formed we</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   return the &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">value</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; /interpreted/ along with the &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">key</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   When the value is not well-formed, we use the provided &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">context</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   in an error message. No error is reported if &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">value</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; is an &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">arg</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;ument</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   of a variational begin declared.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">let</span> <span style="color: #2d9574;">(</span> condition message
         <span style="color: #67b11d;">(</span>wf '<span style="color: #b1951d;">(</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">:kind</span>   <span style="color: #6c3163;">(</span>-contains? '<span style="color: #2d9574;">(</span>record data module PackageFormer<span style="color: #2d9574;">)</span> value<span style="color: #6c3163;">)</span>
                         <span style="color: #6c3163;">(</span>format <span style="color: #2d9574;">"This kind &#8220;%s&#8221; is not supported by Agda!\n     Valid kinds: record, data, module, PackageFormer."</span> value<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
                <span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">:waist</span>  <span style="color: #6c3163;">(</span>numberp value<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>format <span style="color: #2d9574;">"The waist should be a number; which &#8220;%s&#8221; is not."</span> value<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
                <span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">:waist-strings</span> <span style="color: #6c3163;">(</span>listp value<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>format <span style="color: #2d9574;">"The waist-strings should be a Lisp list of strings; which &#8220;%s&#8221; is not."</span> value<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
                <span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">:level</span> <span style="color: #6c3163;">(</span>-contains? '<span style="color: #2d9574;">(</span>inc dec none<span style="color: #2d9574;">)</span> value<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>format <span style="color: #2d9574;">"The &#8220;level&#8221; must be &#8220;inc&#8221; or &#8220;dec&#8221; or &#8220;none&#8221;; which &#8220;%s&#8221; is not."</span> value<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
                <span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">:alter-elements</span> <span style="color: #6c3163;">(</span>functionp value<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>format <span style="color: #2d9574;">"Componenet alter-elements should be a function; which &#8220;%s&#8221; is not."</span> value<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
                       <span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">when-let</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>here <span style="color: #3a81c3;">(</span>assoc key wf<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
      <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> condition        <span style="color: #b1951d;">(</span>eval <span style="color: #3a81c3;">(</span>nth 1 here<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
            message          <span style="color: #b1951d;">(</span>eval <span style="color: #3a81c3;">(</span>nth 2 here<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
      <span style="color: #67b11d;">(</span>700-error <span style="color: #b1951d;">(</span>not <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">or</span> condition <span style="color: #6c3163;">(</span>-contains? args value<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> message context<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Return the key-value as a pair for further processing.</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">:kind and :level values are symbols and so cannot be evaluated furthur.</span>
    <span style="color: #2d9574;">(</span>cons key
          <span style="color: #67b11d;">(</span><span style="color: #cd6600;">if</span>
           <span style="color: #b1951d;">(</span><span style="color: #cd6600;">or</span> <span style="color: #3a81c3;">(</span>-contains? args value<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span>-contains? '<span style="color: #6c3163;">(</span><span style="color: #3a81c3;">:kind</span> <span style="color: #3a81c3;">:level</span> <span style="color: #3a81c3;">:waist-strings</span><span style="color: #6c3163;">)</span> key<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
           value
           <span style="color: #b1951d;">(</span>eval value<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcf2f002" class="outline-3">
<h3 id="orgcf2f002"><span class="section-number-3">5.3</span> Loading Variationals: Super Simple Conversion From String to Lisp</h3>
<div class="outline-text-3" id="text-5-3">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">load-variational</span> <span style="color: #6c3163;">(</span>variation-string<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Obtain lines of the buffer that start with &#8220;&#119985;-&#8221;.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   Realise them as Lisp association lists.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   A line is something like:</span>

<span style="color: #da8b55; background-color: #ecf3ec;">      &#119985;-name x&#8320; &#8230; x&#8345;  =  ([label&#8320;] :key&#8320; val&#8321; &#8943; :key&#8344; val&#8344; &#10228;)*</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   The result is a list of 3-tuples (name (x&#8320; &#8943; x&#8345;) ((key&#8320; val&#8320;) &#8943; (key&#8344; val&#8344;))),</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   containing the clause's name, argument list, and key-value pairs.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   If the optional &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">string-list</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; is provided, then use</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   that instead of searching the buffer. This feature</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   has been added on to make the presentation of tests</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   and examples easier to digest ---without the mockup</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   of fletting &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">buffer-substring-no-properties</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; to return</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   what could instead be &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">string-list</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;. It was the addition</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   of a simple &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">or</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; ---far less than this string explaning it.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   For now, the RHS must be an expression of the form &#8220;:key&#8320; value&#8320; &#8943; :key&#8345; value&#8345;&#8221;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   - where the value&#7522; are legitmate Lisp expressions</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   - and the LHS is an atomic name, possibly with argument names.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">thread-last</span> variation-string
    <span style="color: #2d9574;">(</span>s-replace <span style="color: #2d9574;">"&#119985;-"</span> <span style="color: #2d9574;">"&#119985; "</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span>format <span style="color: #2d9574;">"(%s)"</span><span style="color: #2d9574;">)</span>
    read-from-string
    car
    eval<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Unit Tests </font> </strong> </summary>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">ert-deftest</span> <span style="color: #6c3163; font-weight: bold;">variationals-&#119985;&#119992;</span> <span style="color: #6c3163;">()</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span>equal <span style="color: #67b11d;">(</span>&#119985;- 'nice<span style="color: #67b11d;">)</span>
                 '&#119985;-nice<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span>equal <span style="color: #67b11d;">(</span>&#119985;&#119992; '<span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:height</span> 3 <span style="color: #3a81c3;">:kind</span> 'data<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
                '<span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:height</span> . 3<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:kind</span> . data<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>


  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Error along with &#8220;noice&#8221;.</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should-error</span> <span style="color: #2d9574;">(</span>&#119985;&#119992; '<span style="color: #67b11d;">(</span><span style="color: #3a81c3;">:height</span> 3 <span style="color: #3a81c3;">:kind</span> datda<span style="color: #67b11d;">)</span> 'noice nil<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">nice error.</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should-error</span> <span style="color: #2d9574;">(</span>&#119985;&#119992; '<span style="color: #67b11d;">(</span><span style="color: #3a81c3;">:level</span> 3<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">&#119985;-test</span> <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">&amp;key</span> height kind<span style="color: #2d9574;">)</span> `<span style="color: #2d9574;">(</span> <span style="color: #67b11d;">(</span>first . ,height<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">(</span>second . ,kind<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span>equal <span style="color: #67b11d;">(</span>&#119985;&#119992; '<span style="color: #b1951d;">(</span>test <span style="color: #3a81c3;">:height</span> 3 <span style="color: #3a81c3;">:kind</span> 'three &#10228; <span style="color: #3a81c3;">:kind</span> 'module<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
                 '<span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:kind</span> . module<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>first . 3<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>second . three<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">NOTE: &#119985;-tests&#8242; :kind is optional</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span>equal <span style="color: #67b11d;">(</span>&#119985;&#119992; '<span style="color: #b1951d;">(</span>test <span style="color: #3a81c3;">:height</span> 3 &#10228; <span style="color: #3a81c3;">:kind</span> 'module<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
                 '<span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:kind</span> . module<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>first . 3<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>second<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span>equal <span style="color: #67b11d;">(</span>&#119985;&#119992; '<span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:height</span> 3 &#10228; <span style="color: #3a81c3;">:kind</span> 'module<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
                 '<span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:kind</span> . module<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:height</span> . 3<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Recursively place 3 (new) wherever 'it (old) occurs.</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This' a standard Lisp utility.</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span>equal
           <span style="color: #67b11d;">(</span>subst 3 'it '<span style="color: #b1951d;">(</span>1 2 it 4 <span style="color: #3a81c3;">(</span>5 it<span style="color: #3a81c3;">)</span> 7 <span style="color: #3a81c3;">(</span>+ 8 it<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
           '<span style="color: #67b11d;">(</span>1 2 3 4 <span style="color: #b1951d;">(</span>5 3<span style="color: #b1951d;">)</span> 7 <span style="color: #b1951d;">(</span>+ 8 3<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">ert-deftest</span> <span style="color: #6c3163; font-weight: bold;">variationals-&#119985;</span> <span style="color: #6c3163;">()</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Nullary</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span><span style="color: #cd6600;">&#119985;</span> test&#8320;  = <span style="color: #3a81c3;">:kind</span> 'record <span style="color: #3a81c3;">:waist</span> 3<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span>equal <span style="color: #67b11d;">(</span>&#119985;-test&#8320;<span style="color: #67b11d;">)</span>
               '<span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:kind</span> . record<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:waist</span> . 3<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Unary</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span><span style="color: #cd6600;">&#119985;</span> test&#8321; heightish = <span style="color: #3a81c3;">:kind</span> 'record <span style="color: #3a81c3;">:waist</span> heightish<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span>equal <span style="color: #67b11d;">(</span>&#119985;-test&#8321; <span style="color: #3a81c3;">:heightish</span> 6<span style="color: #67b11d;">)</span>
                 '<span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:kind</span> . record<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:waist</span> . 6<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Invoking the previously defined variational</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span><span style="color: #cd6600;">&#119985;</span> test&#8322;  = <span style="color: #3a81c3;">:kind</span> 'data &#10228; test&#8321; <span style="color: #3a81c3;">:heightish</span> 2<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span>equal <span style="color: #67b11d;">(</span>&#119985;-test&#8322;<span style="color: #67b11d;">)</span>
                 '<span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:kind</span> . record<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:waist</span> . 2<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:kind</span> . data<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">See a nice error message ^_^</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should-error</span> <span style="color: #2d9574;">(</span><span style="color: #cd6600;">&#119985;</span> test&#8323; = <span style="color: #3a81c3;">:kind</span> recordd<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">ert-deftest</span> <span style="color: #6c3163; font-weight: bold;">variationals-loading</span> <span style="color: #6c3163;">()</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span>load-variational <span style="color: #2d9574;">"&#119985;-tc this height = :level this :waist height"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">NEATO! (Has desired error)</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(-let [*parent-context* "woadh"]</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;;   </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(&#119985;-tc :height 'no :this 'inc))</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Does not pass: I've commented out the type checking in &#119985; above, for now.</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span>&#119985;-tc <span style="color: #3a81c3;">:height</span> 9 <span style="color: #3a81c3;">:this</span> 'inc<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">should</span> <span style="color: #2d9574;">(</span>equal <span style="color: #67b11d;">(</span>&#119985;&#119992; '<span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:a</span> 'b &#10228; tc <span style="color: #3a81c3;">:height</span> 1<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
                 '<span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:level</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:waist</span> . 1<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3;">:a</span> . b<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">;</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>
</div>
</div>
</div>

<div id="outline-container-org3d18d04" class="outline-2">
<h2 id="org3d18d04"><span class="section-number-2">6</span> Loading an Agda Buffer</h2>
<div class="outline-text-2" id="text-6">
<p>
Before we can parse an Agda buffer, we need to be able to parse an instantiation declaration;
for which we would later generate code.
</p>
</div>

<div id="outline-container-org42ac504" class="outline-3">
<h3 id="org42ac504"><span class="section-number-3">6.1</span> Loading an Instance &#x2014;The Core Utility</h3>
<div class="outline-text-3" id="text-6-1">
<p>
An instance declaration is of the form:
</p>
<div class="org-src-container">
<pre class="src src-results-agda">PF&#8242; <span style="color: #cd6600;">=</span><span style="color: #ba2f59; font-weight: bold;"> PF</span> <span style="color: #0000cd;">variational</span>&#8321; <span style="color: #0000cd;">args</span>&#8321; &#10228;  &#8943; &#10228; <span style="color: #0000cd;">variational</span>&#8345; (<span style="color: #0000cd;">args</span>&#8345;)
</pre>
</div>

<p>
This gives rise to a simple nice structure:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defstruct</span> instance-declaration
  <span style="color: #da8b55; background-color: #ecf3ec;">"Record of components for an PackageFormer instance declaration:</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   &#10218;name&#10219; = &#10218;package-former&#10219; (&#10228; &#10218;variation&#10219; [&#10218;args&#10219;])*</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>

  docstring      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">What the declaration looks like, useful for reference.</span>
  name           <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Left-hand side</span>
  package-former <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Parent grouping mechanism</span>
  alterations    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">List of variationals along with their arguments.</span>
<span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
Loading an instantiation into our list is now trivial.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">load-instance-declaration</span> <span style="color: #6c3163;">(</span>line <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> show-it<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"If the current &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">line</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; string is an instance declaration,</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   then produce a new PackageFormer from it. Else, do nothing.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   &#8658; Whitespace is automatically collopased from &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">line</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217;.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   &#8658; Nil elements are discarded; e.g., due to a filter.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   &#8658; Duplicates are discarded; e.g., due to a rename.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   Variational clauses may mention</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   &#8658; $&#119899;&#119886;&#119898;&#119890;: The name of the PackageFormer currently being declared; i.e., the LHS name.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   &#8658; $&#119890;&#119897;&#119890;&#119898;&#119890;&#119899;&#119905;&#119904;: Many variationals will act on individal elements, but may check a</span>
<span style="color: #da8b55; background-color: #ecf3ec;">              property relative to all elements and this name allows us to avoid</span>
<span style="color: #da8b55; background-color: #ecf3ec;">              having variationals that simply accomodate for binary functions</span>
<span style="color: #da8b55; background-color: #ecf3ec;">              that operate on an individual element while also needing to refer to all</span>
<span style="color: #da8b55; background-color: #ecf3ec;">              elements. For example, a variational that keeps an element if it's related</span>
<span style="color: #da8b55; background-color: #ecf3ec;">              to another element somehow.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">letf*</span> <span style="color: #2d9574;">(</span>
     <span style="color: #67b11d;">(</span>pieces <span style="color: #b1951d;">(</span>s-split <span style="color: #2d9574;">" "</span> <span style="color: #3a81c3;">(</span>s-collapse-whitespace line<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>$&#119899;&#119886;&#119898;&#119890;      <span style="color: #b1951d;">(</span>nth 0 pieces<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>$&#119890;&#119897;&#119890;&#119898;&#119890;&#119899;&#119905;&#119904;    nil<span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>eqSymb     <span style="color: #b1951d;">(</span>nth 1 pieces<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>$&#119901;&#119886;&#119903;&#119890;&#119899;&#119905;     <span style="color: #b1951d;">(</span>nth 2 pieces<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>variations <span style="color: #b1951d;">(</span>nthcdr 3 pieces<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>alterations nil<span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>self <span style="color: #b1951d;">(</span>copy-package-former <span style="color: #3a81c3;">(</span>cdr <span style="color: #6c3163;">(</span>assoc $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905; package-formers<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>symbol-function '&#8265;<span style="color: #b1951d;">)</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">If componenet &#8216;c&#8217; is in the &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">alterations</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; list of the instance declaration,</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">then evalaute any given &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">more</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; code, get the value for &#8216;c&#8217; and turn it</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">into a string, if &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">str</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; is true, then set the new PackageFormer's &#8216;c&#8217;</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">componenet to be this value.</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Well-formedness checks happen at the &#119985; and &#119985;&#119992; stages, see below.</span>
         <span style="color: #b1951d;">(</span><span style="color: #cd6600;">lambda</span> <span style="color: #3a81c3;">(</span>c <span style="color: #ba2f59; font-weight: bold;">&amp;optional</span> str more<span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">when-let</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>it <span style="color: #887070;">(</span>cdr <span style="color: #3a81c3;">(</span>assoc <span style="color: #6c3163;">(</span>intern <span style="color: #2d9574;">(</span>format <span style="color: #2d9574;">":%s"</span> c<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> alterations<span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
                           <span style="color: #6c3163;">(</span>eval `<span style="color: #2d9574;">(</span><span style="color: #cd6600;">progn</span> ,@more<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
                           <span style="color: #6c3163;">(</span><span style="color: #cd6600;">when</span> str <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> it <span style="color: #887070;">(</span>format <span style="color: #2d9574;">"%s"</span> it<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
                           <span style="color: #6c3163;">(</span>eval `<span style="color: #2d9574;">(</span><span style="color: #cd6600;">setf</span> <span style="color: #887070;">(</span>,<span style="color: #3a81c3;">(</span>car <span style="color: #6c3163;">(</span>read-from-string <span style="color: #2d9574;">(</span>format <span style="color: #2d9574;">"package-former-%s"</span> c<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> self<span style="color: #887070;">)</span> it<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>

        <span style="color: #67b11d;">)</span>
     <span style="color: #2d9574;">)</span>

   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Ensure instance declaration is well-formed.</span>
    <span style="color: #2d9574;">(</span>700-error <span style="color: #67b11d;">(</span><span style="color: #cd6600;">or</span> <span style="color: #b1951d;">(</span>s-blank? <span style="color: #3a81c3;">(</span>s-trim $&#119899;&#119886;&#119898;&#119890;<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>not <span style="color: #3a81c3;">(</span>equal <span style="color: #2d9574;">"="</span> eqSymb<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>not $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905;<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
               <span style="color: #67b11d;">(</span>concat <span style="color: #2d9574;">"An instance declaration is of the form "</span>
                       <span style="color: #2d9574;">"&#8220;new-name = parent-package-former variational-clauses&#8221;."</span><span style="color: #67b11d;">)</span>
               line<span style="color: #2d9574;">)</span>

   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Let's not overwrite existing PackageFormers.</span>
    <span style="color: #2d9574;">(</span>700-error <span style="color: #67b11d;">(</span>assoc $&#119899;&#119886;&#119898;&#119890; package-formers<span style="color: #67b11d;">)</span>
               <span style="color: #67b11d;">(</span>format <span style="color: #2d9574;">"PackageFormer &#8220;%s&#8221; is already defined; use a new name."</span> $&#119899;&#119886;&#119898;&#119890;<span style="color: #67b11d;">)</span>
               line<span style="color: #2d9574;">)</span>

   <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Ensure the PackageFormer to be instantiated is defined.</span>
    <span style="color: #2d9574;">(</span>700-error <span style="color: #67b11d;">(</span>not self<span style="color: #67b11d;">)</span>
               <span style="color: #67b11d;">(</span>format <span style="color: #2d9574;">"Parent &#8220;%s&#8221; not defined."</span> $&#119901;&#119886;&#119903;&#119890;&#119899;&#119905;<span style="color: #67b11d;">)</span>
               line<span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Update the new PackageFormer with a docstring of its instantiation</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">as well as its name.</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setf</span> <span style="color: #67b11d;">(</span>package-former-docstring self<span style="color: #67b11d;">)</span> line<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setf</span> <span style="color: #67b11d;">(</span>package-former-name self<span style="color: #67b11d;">)</span> $&#119899;&#119886;&#119898;&#119890;<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> $&#119890;&#119897;&#119890;&#119898;&#119890;&#119899;&#119905;&#119904; <span style="color: #67b11d;">(</span>package-former-elements self<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Parse the &#8220;&#120011;&#8320; &#10228; &#8943; &#10228; &#120011;&#8345;&#8221; portion of an instance declaration.</span>
     <span style="color: #2d9574;">(</span><span style="color: #cd6600;">thread-last</span>  variations
       <span style="color: #67b11d;">(</span>s-join <span style="color: #2d9574;">" "</span><span style="color: #67b11d;">)</span>     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Stick the rest back together.</span>
       <span style="color: #67b11d;">(</span>format <span style="color: #2d9574;">"'(%s)"</span><span style="color: #67b11d;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Construe as a lisp list</span>
       read-from-string
       cadar
       <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> variations<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
     <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
     <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> alterations <span style="color: #67b11d;">(</span>&#119985;&#119992; variations line<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">c.f. &#8265; above</span>
     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Now that the aterations have been parsed, let's attach</span>
     <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">the new components of the PackageFormer being made.</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">:kind &#8776; The vocabulary that replaces &#8220;PackageFormer&#8221;.</span>
      <span style="color: #2d9574;">(</span>&#8265; 'kind 'string-please<span style="color: #2d9574;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">:waist &#8776; The division between parameters and remaining elements.</span>
      <span style="color: #2d9574;">(</span>&#8265; 'waist<span style="color: #2d9574;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">:waist-strings &#8776; Extra strings to insert at the waist position.</span>
      <span style="color: #2d9574;">(</span>&#8265; 'waist-strings nil
          '<span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span><span style="color: #cd6600;">setq</span> it <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">--map</span> <span style="color: #6c3163;">(</span>eval it<span style="color: #6c3163;">)</span> it<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
          <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The &#8220;eval&#8221; is since we may have Lisp that results in strings.</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">:level &#8776; Either 'inc or 'dec, for increment or decrementing the level.</span>
      <span style="color: #2d9574;">(</span>&#8265; 'level nil <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">'string-please</span>
         '<span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span><span style="color: #cd6600;">let*</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163;">(</span>lvl <span style="color: #2d9574;">(</span>package-former-level self<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
                  <span style="color: #6c3163;">(</span>toLevel <span style="color: #2d9574;">(</span><span style="color: #cd6600;">lambda</span> <span style="color: #887070;">(</span>n<span style="color: #887070;">)</span> <span style="color: #887070;">(</span>s-join <span style="color: #2d9574;">""</span> <span style="color: #3a81c3;">(</span>-concat
                        <span style="color: #6c3163;">(</span>-repeat n <span style="color: #2d9574;">"Level.suc ("</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>list <span style="color: #2d9574;">"Level.zero"</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>-repeat n <span style="color: #2d9574;">")"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
                 <span style="color: #6c3163;">(</span>subs `<span style="color: #2d9574;">(</span><span style="color: #2d9574;">""</span> <span style="color: #2d9574;">"&#8321;"</span> <span style="color: #2d9574;">"&#8322;"</span> <span style="color: #2d9574;">"&#8323;"</span> <span style="color: #2d9574;">"&#8324;"</span> <span style="color: #2d9574;">"&#8325;"</span> <span style="color: #2d9574;">"&#8326;"</span> <span style="color: #2d9574;">"&#8327;"</span> <span style="color: #2d9574;">"&#8328;"</span> <span style="color: #2d9574;">"&#8329;"</span> ,<span style="color: #887070;">(</span>funcall toLevel 10<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
                 <span style="color: #6c3163;">(</span>here <span style="color: #2d9574;">(</span>-elem-index <span style="color: #887070;">(</span>s-trim lvl<span style="color: #887070;">)</span> subs<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

             <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">setq</span> it
                   <span style="color: #6c3163;">(</span><span style="color: #cd6600;">if</span> here

                       <span style="color: #2d9574;">(</span><span style="color: #cd6600;">pcase</span> it
                         <span style="color: #887070;">(</span>'inc <span style="color: #3a81c3;">(</span>nth <span style="color: #6c3163;">(</span>1+ here<span style="color: #6c3163;">)</span> subs<span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span>
                         <span style="color: #887070;">(</span>'dec <span style="color: #3a81c3;">(</span>nth <span style="color: #6c3163;">(</span>1- here<span style="color: #6c3163;">)</span> subs<span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>

                     <span style="color: #2d9574;">(</span><span style="color: #cd6600;">pcase</span> it
                       <span style="color: #887070;">(</span>'inc <span style="color: #3a81c3;">(</span>format <span style="color: #2d9574;">"Level.suc (%s)"</span> lvl<span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span>
                       <span style="color: #887070;">(</span>'dec <span style="color: #3a81c3;">(</span>s-join <span style="color: #2d9574;">"suc"</span> <span style="color: #6c3163;">(</span>cdr <span style="color: #2d9574;">(</span>s-split <span style="color: #2d9574;">"suc"</span> lvl <span style="color: #3a81c3;">:omit-nulls</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

             <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">unless</span> it <span style="color: #6c3163;">(</span><span style="color: #cd6600;">setq</span> it 'none<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">:alter-elements &#8776; Access the typed name constituents list.</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Perform *all* element alterations, in the left-to-right &#10228; order; if any at all.</span>
        <span style="color: #2d9574;">(</span><span style="color: #cd6600;">loop</span> for ae in <span style="color: #67b11d;">(</span>reverse <span style="color: #b1951d;">(</span>mapcar #'cdr <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">--filter</span> <span style="color: #6c3163;">(</span>equal '<span style="color: #3a81c3;">:alter-elements</span> <span style="color: #2d9574;">(</span>car it<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> alterations<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
              do
        <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> $&#119890;&#119897;&#119890;&#119898;&#119890;&#119899;&#119905;&#119904;
              <span style="color: #b1951d;">(</span>remove-duplicates <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">--filter</span> it <span style="color: #6c3163;">(</span>funcall ae $&#119890;&#119897;&#119890;&#119898;&#119890;&#119899;&#119905;&#119904;<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">:test</span> #'equal <span style="color: #3a81c3;">:from-end</span> t<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Filter in only the non-nil constituents &amp; remove duplicates.</span>
              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">We do this each time, rather than at the end, since variationals</span>
              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">may loop over all possible elements and we do not want to consider</span>
              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">intermediary nils or duplicates.</span>
        <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setf</span> <span style="color: #67b11d;">(</span>package-former-elements self<span style="color: #67b11d;">)</span> $&#119890;&#119897;&#119890;&#119898;&#119890;&#119899;&#119905;&#119904;<span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">We've just formed a new PackageFormer, which can be modified, specialised, later on.</span>
    <span style="color: #2d9574;">(</span>add-to-list 'package-formers <span style="color: #67b11d;">(</span>cons $&#119899;&#119886;&#119898;&#119890; self<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">when</span> show-it <span style="color: #67b11d;">(</span>show-package-former self<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org501e372" class="outline-3">
<h3 id="org501e372"><span class="section-number-3">6.2</span> <code>load-700-comments</code> and <code>lisp</code> blocks</h3>
<div class="outline-text-3" id="text-6-2">
<p>
We already two global lists &#x2014;for our loaded PackageFormers and varitionals
declarared&#x2014; we need two additional globals: One for the contents of <a href="#orgfeb9199">700-comments</a>,
primarily for basic efficiency, and the other to port whatever is within
<a href="#orgfeb9199">700-comments</a> but is not <a href="#org0f40ab6">700-syntax</a>. The latter is for when we want definitions
or generalised variables to be accessible in <i>both</i> <a href="#orgfeb9199">700-comments</a> and the
surrounding script. Which is achieved since the matter is exported to
the generated file in the Elisp stage, then imported at the Agda level.
</p>

<p>
However, since content to be ported may occur between PackageFormer definitions
and instance declarations, we need to remember the position of items that are ported.
The simplest thing to do is simply place items for porting into the package-formers
list &#x2014;then take care to check if an item is for porting or not when printing
PackageFormers to a generated file.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defvar</span> <span style="color: #715ab1;">700-comments</span> nil
  <span style="color: #da8b55; background-color: #ecf3ec;">"The contents of the 700-comments.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   If this variable does not change, we short-circut all processing.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   See step &#8216;&#189;&#8217; below.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">cl-defun</span> <span style="color: #6c3163; font-weight: bold;">load-700-comments</span> <span style="color: #6c3163;">()</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"Parse comments of the form &#8220;{-700 &#8943; -}&#8221; and add all PackageFormer declarations</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   to the &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">package-formers</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; list and all instantations to the</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">instantiations-remaining</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; list.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">   We also execute any valid Lisp code in &#8220;{-lisp -}&#8221; comments;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   which may contain an arbitrary number of Lisp forms ---a &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">progn</span><span style="color: #da8b55; background-color: #ecf3ec;">&#8217; is auto provided.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   Lisp is executed before any 700-comments are; which is preferable</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   due to Lisp's dynamic scope.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">interactive</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">First, let's run all the lisp. We enclose each in a progn in-case the user</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">has multiple forms in a single lisp-block.</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">loop</span> for lispstr in <span style="color: #2d9574;">(</span>buffer-substring-delimited-whole-buffer <span style="color: #2d9574;">"^</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">{-lisp"</span> <span style="color: #2d9574;">"^-</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">}"</span><span style="color: #2d9574;">)</span>
        do <span style="color: #2d9574;">(</span>eval <span style="color: #67b11d;">(</span>car <span style="color: #b1951d;">(</span>read-from-string <span style="color: #3a81c3;">(</span>format <span style="color: #2d9574;">"(progn %s)"</span> lispstr<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">For now, &#8216;</span><span style="color: #4e3163; background-color: #ecf3ec;">item</span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#8217; is a PackageFormer, instantiation declaration, or other Agda code.</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">let</span> <span style="color: #2d9574;">(</span>item lines 700-cmnts<span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Catenate all 700-comments into a single string.</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> 700-cmnts
          <span style="color: #67b11d;">(</span>s-join <span style="color: #2d9574;">"\n"</span> <span style="color: #b1951d;">(</span>buffer-substring-delimited-whole-buffer <span style="color: #2d9574;">"^</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">{-700"</span> <span style="color: #2d9574;">"^-</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">}"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">if</span> <span style="color: #67b11d;">(</span>equal 700-comments 700-cmnts<span style="color: #67b11d;">)</span>

        <span style="color: #67b11d;">(</span>message <span style="color: #2d9574;">"700-comments Unchanged."</span><span style="color: #67b11d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Update global.</span>
      <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> 700-comments 700-cmnts<span style="color: #67b11d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">View comments as a sequence of lines, ignore empty lines</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">---which are not in our grammar.</span>
      <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> lines <span style="color: #b1951d;">(</span><span style="color: #cd6600;">--remove</span> <span style="color: #3a81c3;">(</span>s-blank? <span style="color: #6c3163;">(</span>s-collapse-whitespace it<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span>s-lines 700-comments<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Traverse the 700-comments:</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#10153; Skip comments; lines starting with &#8220;-- &#8221;.</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#10153; If we see a &#8220;&#119985;-lhs = rhs&#8221; equation, then load it as a variational.</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#10153; If we view a &#8220;lhs = rhs&#8221; equation, then load it as an instance delcaration.</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&#10153; If we view a PackageFormer declaration, then load it into our</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;;   </span><span style="color: #2aa1ae; background-color: #ecf3ec;">package-formers list.</span>
      <span style="color: #67b11d;">(</span><span style="color: #cd6600;">while</span> lines
        <span style="color: #b1951d;">(</span><span style="color: #cd6600;">setq</span> item <span style="color: #3a81c3;">(</span>car lines<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>

        <span style="color: #b1951d;">(</span><span style="color: #cd6600;">if</span> <span style="color: #3a81c3;">(</span>not <span style="color: #6c3163;">(</span>s-blank? <span style="color: #2d9574;">(</span>s-shared-start <span style="color: #2d9574;">"-- "</span> item<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
            <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">setq</span> lines <span style="color: #6c3163;">(</span>cdr lines<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

          <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">if</span> <span style="color: #6c3163;">(</span>not <span style="color: #2d9574;">(</span>s-blank? <span style="color: #887070;">(</span>s-shared-start <span style="color: #2d9574;">"&#119985;-"</span> item<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
              <span style="color: #6c3163;">(</span><span style="color: #cd6600;">progn</span> <span style="color: #2d9574;">(</span>load-variational item<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> lines <span style="color: #887070;">(</span>cdr lines<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

            <span style="color: #6c3163;">(</span><span style="color: #cd6600;">if</span> <span style="color: #2d9574;">(</span>s-contains? <span style="color: #2d9574;">" = "</span> item<span style="color: #2d9574;">)</span>
                <span style="color: #2d9574;">(</span><span style="color: #cd6600;">progn</span> <span style="color: #887070;">(</span>load-instance-declaration item<span style="color: #887070;">)</span> <span style="color: #887070;">(</span><span style="color: #cd6600;">setq</span> lines <span style="color: #3a81c3;">(</span>cdr lines<span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>

              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Else we have a PackageFormer declaration</span>
              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">and other possiblly-non-700 items.</span>
              <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> item <span style="color: #887070;">(</span>get-children <span style="color: #2d9574;">"PackageFormer"</span> lines<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>
              <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">port non-700 items to generated file</span>
              <span style="color: #2d9574;">(</span><span style="color: #cd6600;">push</span> <span style="color: #887070;">(</span>cons 'porting <span style="color: #3a81c3;">(</span>s-join <span style="color: #2d9574;">"\n"</span> <span style="color: #6c3163;">(</span>car item<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span> package-formers<span style="color: #2d9574;">)</span>
                    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">acknowledge PackageFormer declaration, if any</span>
                    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">when</span> <span style="color: #887070;">(</span>cadr item<span style="color: #887070;">)</span> <span style="color: #887070;">(</span>load-package-former <span style="color: #3a81c3;">(</span>cadr item<span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>
                    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Update lines to be the unconsidered porition</span>
                    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">of the wild comments.</span>
                    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> lines <span style="color: #887070;">(</span>caddr item<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

        <span style="color: #67b11d;">(</span>message <span style="color: #2d9574;">"Finished parsing 700-comments."</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org411aaff" class="outline-2">
<h2 id="org411aaff"><span class="section-number-2">7</span> Emacs Interface</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-orgbc038d0" class="outline-3">
<h3 id="orgbc038d0"><span class="section-number-3">7.1</span> Advising our Beloved <code>C-c C-l</code></h3>
<div class="outline-text-3" id="text-7-1">
<p>
Let's give the current buffer access to the location of the generated file.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">insert-generated-import</span> <span style="color: #6c3163;">(</span>name-of-generated-file<span style="color: #6c3163;">)</span>
  <span style="color: #da8b55; background-color: #ecf3ec;">"In the current file, find the top-most module declaration</span>
<span style="color: #da8b55; background-color: #ecf3ec;">   then insert an import of the generated file.</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">interactive</span><span style="color: #6c3163;">)</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">save-excursion</span>
    <span style="color: #2d9574;">(</span>beginning-of-buffer<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">condition-case</span> the-err
        <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">attemptClause:</span>
        <span style="color: #67b11d;">(</span>re-search-forward <span style="color: #b1951d;">(</span>concat <span style="color: #2d9574;">"open import "</span> name-of-generated-file<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">recoveryBody:</span>
      <span style="color: #67b11d;">(</span><span style="color: #dc752f; background-color: #fbf8ef;">error</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(message-box (format "%s" the-err))</span>
       <span style="color: #b1951d;">(</span>re-search-forward <span style="color: #2d9574;">"</span><span style="color: #C57BDB; font-weight: bold;">\\</span><span style="color: #C57BDB; font-weight: bold;">(</span><span style="color: #2d9574;">module.*</span><span style="color: #C57BDB; font-weight: bold;">\\</span><span style="color: #C57BDB; font-weight: bold;">)</span><span style="color: #2d9574;">"</span><span style="color: #b1951d;">)</span>
       <span style="color: #b1951d;">(</span>replace-match <span style="color: #3a81c3;">(</span>concat <span style="color: #2d9574;">"\\1\nopen import "</span> name-of-generated-file<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>

<p>
The aim is to process test enclosed in <code>{-700 ⋯ -}</code> comments,
produce legitimate Agda from that, and ensure the generated Agda is accessible to the
current buffer automatically.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">reify-package-formers</span> <span style="color: #6c3163;">(</span>orig-fun <span style="color: #ba2f59; font-weight: bold;">&amp;rest</span> args<span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">interactive</span><span style="color: #6c3163;">)</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">let</span> <span style="color: #2d9574;">(</span>generated-file-name
        <span style="color: #67b11d;">(</span>parent-imports <span style="color: #b1951d;">(</span>extract-imports<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Sometimes we may want the full name due to files being in a nested</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">directory hierarchy: (file-name-sans-extension buffer-file-name)</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> generated-file-name
          <span style="color: #67b11d;">(</span>concat<span style="color: #b1951d;">(</span>file-name-sans-extension <span style="color: #3a81c3;">(</span>buffer-name<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>
                 <span style="color: #2d9574;">"_Generated"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Load variationals, PackageFormers, instantiations, and porting list.</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Setting the following to nil each time is not ideal.</span>
    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span>   variationals              nil
            package-formers           nil
            700-comments              nil<span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span>load-700-comments<span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span><span style="color: #cd6600;">with-temp-buffer</span>
      <span style="color: #67b11d;">(</span>beginning-of-buffer<span style="color: #67b11d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Copy/paste imports from parent file.</span>
      <span style="color: #67b11d;">(</span>insert <span style="color: #b1951d;">(</span>s-join <span style="color: #2d9574;">"\n"</span> `<span style="color: #3a81c3;">(</span>
         <span style="color: #2d9574;">"{- This file is generated ;; do not alter. -}\n"</span>
         ,parent-imports
         <span style="color: #2d9574;">"open import Level as Level"</span>
         ,<span style="color: #6c3163;">(</span>format <span style="color: #2d9574;">"module %s where "</span> generated-file-name<span style="color: #6c3163;">)</span>
         <span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Print the package-formers</span>
      <span style="color: #67b11d;">(</span><span style="color: #cd6600;">setq</span> package-formers
            <span style="color: #b1951d;">(</span><span style="color: #cd6600;">--map</span>
             <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">if</span> <span style="color: #6c3163;">(</span>equal 'porting <span style="color: #2d9574;">(</span>car it<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>format <span style="color: #2d9574;">"%s"</span> <span style="color: #2d9574;">(</span>cdr it<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
               <span style="color: #6c3163;">(</span>format
                <span style="color: #2d9574;">(</span><span style="color: #cd6600;">if</span> <span style="color: #887070;">(</span>equal <span style="color: #2d9574;">"PackageFormer"</span> <span style="color: #3a81c3;">(</span>package-former-kind <span style="color: #6c3163;">(</span>cdr it<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #887070;">)</span>
                    <span style="color: #887070;">(</span>concat <span style="color: #2d9574;">"{- Kind &#8220;PackageFormer&#8221; does not correspond "</span>
                            <span style="color: #2d9574;">" to a concrete Agda type. \n%s -}"</span><span style="color: #887070;">)</span>
                       <span style="color: #2d9574;">"%s"</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574; background-color: #fbf8ef;">(</span><span style="color: #dc752f; background-color: #fbf8ef;">show-package-former </span><span style="color: #887070; background-color: #fbf8ef;">(</span><span style="color: #dc752f; background-color: #fbf8ef;">cdr it</span><span style="color: #887070; background-color: #fbf8ef;">)</span><span style="color: #2d9574; background-color: #fbf8ef;">)</span><span style="color: #6c3163; background-color: #fbf8ef;">)</span><span style="color: #3a81c3; background-color: #fbf8ef;">)</span>
             <span style="color: #3a81c3;">(</span>reverse package-formers<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;;</span>
      <span style="color: #67b11d;">(</span>insert <span style="color: #b1951d;">(</span>s-join <span style="color: #2d9574;">"\n\n\n"</span> package-formers<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(setq package-formers nil) ;; So no accidental</span>

      <span style="color: #67b11d;">(</span>write-region <span style="color: #b1951d;">(</span>beginning-of-buffer<span style="color: #b1951d;">)</span> <span style="color: #b1951d;">(</span>end-of-buffer<span style="color: #b1951d;">)</span>
                    <span style="color: #b1951d;">(</span>concat generated-file-name <span style="color: #2d9574;">".agda"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>

    <span style="color: #2d9574;">(</span>insert-generated-import generated-file-name<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Need to revert buffer to discard old colours.</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(save-buffer) (revert-buffer t t t)</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">call agda2-load</span>
  <span style="color: #6c3163;">(</span>apply orig-fun args<span style="color: #6c3163;">)</span>

  <span style="color: #6c3163;">(</span>message <span style="color: #2d9574;">"700 &#8759; All the best coding! (&#8226;&#768;&#7447;&#8226;&#769;)&#1608;"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Users can enable this feature if they're interested in using it; disbale it otherwise.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(advice-add 'agda2-load :around #'reify-package-formers)</span>
</pre>
</div>

<p>
Personal note:
Using <code>(write-file "Generated.agda")</code> means we make a file
then the temporary buffer <i>visits</i> the Agda file, which loads the
Agda process therein, which is undesirable since it could leave
Agda working on the buffer even after it has been killed!
</p>
<ul class="org-ul">
<li>This would necessiate calling <code>(agda2-restart)</code> afterwards.</li>
<li>Instead we write the whole region, without visiting the resuting file.</li>
</ul>
</div>
</div>

<div id="outline-container-org27e1267" class="outline-3">
<h3 id="org27e1267"><span class="section-number-3">7.2</span> Menu matter</h3>
<div class="outline-text-3" id="text-7-2">
<p>
Let's quickly add a menu bar that allows users to enable or disable using PackageFormer's;
along with a brief help menu.
</p>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> The global map </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defvar</span> <span style="color: #715ab1;">700-menu-bar</span> <span style="color: #6c3163;">(</span>make-sparse-keymap <span style="color: #2d9574;">"700 PackageFormers"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span>define-key global-map <span style="color: #6c3163;">[</span>menu-bar 700menu<span style="color: #6c3163;">]</span> <span style="color: #6c3163;">(</span>cons <span style="color: #2d9574;">"700PackageFormers"</span> 700-menu-bar<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Enabling the feature </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>define-key 700-menu-bar <span style="color: #6c3163;">[</span>enable-package-formers<span style="color: #6c3163;">]</span>
  '<span style="color: #6c3163;">(</span>menu-item <span style="color: #2d9574;">"Enable PackageFormer Generation"</span> enable-package-formers<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">enable-package-formers</span> <span style="color: #6c3163;">()</span>
 <span style="color: #6c3163;">(</span><span style="color: #cd6600;">interactive</span><span style="color: #6c3163;">)</span>
 <span style="color: #6c3163;">(</span>advice-add 'agda2-load <span style="color: #3a81c3;">:around</span> #'reify-package-formers<span style="color: #6c3163;">)</span>
 <span style="color: #6c3163;">(</span>message-box <span style="color: #2d9574;">"C-c C-l now reifies &#8220;700-comments&#8221; into legitimate Agda."</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Disabling the feature </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>define-key 700-menu-bar <span style="color: #6c3163;">[</span>disable-package-formers<span style="color: #6c3163;">]</span>
  '<span style="color: #6c3163;">(</span>menu-item <span style="color: #2d9574;">"Disable PackageFormer Generation"</span> disable-package-formers<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">disable-package-formers</span> <span style="color: #6c3163;">()</span>
 <span style="color: #6c3163;">(</span><span style="color: #cd6600;">interactive</span><span style="color: #6c3163;">)</span>
 <span style="color: #6c3163;">(</span>advice-remove 'agda2-load #'reify-package-formers<span style="color: #6c3163;">)</span>
 <span style="color: #6c3163;">(</span><span style="color: #cd6600;">setq</span> global-mode-string <span style="color: #2d9574;">(</span>remove <span style="color: #2d9574;">"700 (&#8226;&#768;&#7447;&#8226;&#769;)&#1608; "</span> global-mode-string<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
  <span style="color: #6c3163;">(</span>message-box <span style="color: #2d9574;">"C-c C-l now behaves as it always has."</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> About menu </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>define-key 700-menu-bar <span style="color: #6c3163;">[</span>package-formers-about<span style="color: #6c3163;">]</span>
  '<span style="color: #6c3163;">(</span>menu-item <span style="color: #2d9574;">"About PackageFormers"</span> package-formers-about<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">package-formers-about</span> <span style="color: #6c3163;">()</span>
 <span style="color: #6c3163;">(</span><span style="color: #cd6600;">interactive</span><span style="color: #6c3163;">)</span>
 <span style="color: #6c3163;">(</span>switch-to-buffer <span style="color: #2d9574;">"*PackageFormer-About*"</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span>insert
  <span style="color: #2d9574;">" This is an editor extension prototyping &#8220;the next 700 module systems&#8221; proposed research.</span>

<span style="color: #2d9574;">    An informal documentation, with examples, page can be found at</span>
<span style="color: #2d9574;">    https://alhassy.github.io/next-700-module-systems-proposal/PackageFormer.html</span>

<span style="color: #2d9574;">    The technical matter can be found at https://alhassy.github.io/next-700-module-systems-proposal/</span>

<span style="color: #2d9574;">    If you experience anything &#8220;going wrong&#8221; or have any ideas for improvement,</span>
<span style="color: #2d9574;">    please contact Musa Al-hassy at alhassy@gmail.com; thank-you &#9829;&#8255;&#9829;</span>
<span style="color: #2d9574;">  "</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Bare Bones Agda </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>define-key 700-menu-bar <span style="color: #6c3163;">[</span>700-bare-bones<span style="color: #6c3163;">]</span>
  '<span style="color: #6c3163;">(</span>menu-item <span style="color: #2d9574;">"Copy file with 700 annotations stripped away"</span> 700-bare-bones<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">700-bare-bones</span> <span style="color: #6c3163;">()</span>
 <span style="color: #6c3163;">(</span><span style="color: #cd6600;">interactive</span><span style="color: #6c3163;">)</span>

 <span style="color: #6c3163;">(</span><span style="color: #cd6600;">let*</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>src <span style="color: #b1951d;">(</span>file-name-sans-extension <span style="color: #3a81c3;">(</span>buffer-name<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
        <span style="color: #67b11d;">(</span>src-agda <span style="color: #b1951d;">(</span>format <span style="color: #2d9574;">"%s.agda"</span> src<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
        <span style="color: #67b11d;">(</span>bare-agda <span style="color: #b1951d;">(</span>format <span style="color: #2d9574;">"%s_Bare.agda"</span> src<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
   <span style="color: #2d9574;">(</span><span style="color: #cd6600;">with-temp-buffer</span>
     <span style="color: #67b11d;">(</span>insert-file-contents src-agda<span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>beginning-of-buffer<span style="color: #67b11d;">)</span>
       <span style="color: #67b11d;">(</span>re-search-forward <span style="color: #b1951d;">(</span>format <span style="color: #2d9574;">"module %s"</span> src<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
       <span style="color: #67b11d;">(</span>replace-match <span style="color: #b1951d;">(</span>format <span style="color: #2d9574;">"module %s_Bare"</span> src<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span><span style="color: #cd6600;">loop</span> for pre in '<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"^</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">{-lisp"</span> <span style="color: #2d9574;">"^</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">{-700"</span><span style="color: #b1951d;">)</span>
      do
      <span style="color: #b1951d;">(</span>beginning-of-buffer<span style="color: #b1951d;">)</span>
      <span style="color: #b1951d;">(</span>buffer-substring-delimited-whole-buffer pre <span style="color: #2d9574;">"^-</span><span style="color: #dc752f; background-color: #fbf8ef;">\</span><span style="color: #2d9574;">}"</span>
           <span style="color: #3a81c3;">(</span><span style="color: #cd6600;">lambda</span> <span style="color: #6c3163;">(</span>sp ep<span style="color: #6c3163;">)</span>
             <span style="color: #6c3163;">(</span><span style="color: #cd6600;">save-excursion</span>
             <span style="color: #2d9574;">(</span>goto-char <span style="color: #887070;">(</span>- sp 2<span style="color: #887070;">)</span><span style="color: #2d9574;">)</span>
             <span style="color: #2d9574;">(</span>push-mark ep<span style="color: #2d9574;">)</span>
             <span style="color: #2d9574;">(</span><span style="color: #cd6600;">setq</span> mark-active t<span style="color: #2d9574;">)</span>
             <span style="color: #2d9574;">(</span>delete-region <span style="color: #887070;">(</span>- sp 2<span style="color: #887070;">)</span> ep<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>write-file bare-agda<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
     <span style="color: #2d9574;">(</span>message <span style="color: #2d9574;">"%s_Bare.agda has been written."</span> src<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Menu of Defined 700 Contents </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>define-key 700-menu-bar <span style="color: #6c3163;">[</span>show-variationals<span style="color: #6c3163;">]</span>
  '<span style="color: #6c3163;">(</span>menu-item <span style="color: #2d9574;">"Show all registered variationals"</span> show-variationals<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">show-variationals</span> <span style="color: #6c3163;">()</span>
 <span style="color: #6c3163;">(</span><span style="color: #cd6600;">interactive</span><span style="color: #6c3163;">)</span>
 <span style="color: #6c3163;">(</span>occur <span style="color: #2d9574;">"&#119985;[ </span><span style="color: #C57BDB; font-weight: bold;">\\</span><span style="color: #C57BDB; font-weight: bold;">|</span><span style="color: #2d9574;">-]"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span>define-key 700-menu-bar <span style="color: #6c3163;">[</span>show-pfs<span style="color: #6c3163;">]</span>
  '<span style="color: #6c3163;">(</span>menu-item <span style="color: #2d9574;">"Show all concrete PackageFormers"</span> show-pfs<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">show-pfs</span> <span style="color: #6c3163;">()</span>
 <span style="color: #6c3163;">(</span><span style="color: #cd6600;">interactive</span><span style="color: #6c3163;">)</span>
 <span style="color: #6c3163;">(</span>occur <span style="color: #2d9574;">"PackageFormer .* where"</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Folding Away 700-Comments </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span>define-key 700-menu-bar <span style="color: #6c3163;">[</span>fold-700-matter<span style="color: #6c3163;">]</span>
  '<span style="color: #6c3163;">(</span>menu-item <span style="color: #2d9574;">"Toggle folding away &#8220;700&#8221; and &#8220;lisp&#8221; blocks"</span> fold-700-matter<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3;">(</span><span style="color: #cd6600;">defun</span> <span style="color: #6c3163; font-weight: bold;">fold-700-matter</span> <span style="color: #6c3163;">()</span>
 <span style="color: #6c3163;">(</span><span style="color: #cd6600;">interactive</span><span style="color: #6c3163;">)</span>
 <span style="color: #6c3163;">(</span><span style="color: #cd6600;">setq</span> 700-folding <span style="color: #2d9574;">(</span>not 700-folding<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
 <span style="color: #6c3163;">(</span><span style="color: #cd6600;">if</span> 700-folding
     <span style="color: #2d9574;">(</span>message <span style="color: #2d9574;">"C-c C-l will now fold away &#8220;700&#8221; and &#8220;lisp&#8221; blocks. Press ENTER to unfold a block. "</span><span style="color: #2d9574;">)</span>
     <span style="color: #2d9574;">(</span>fold-this-unfold-all<span style="color: #2d9574;">)</span>
     <span style="color: #2d9574;">(</span>message <span style="color: #2d9574;">"Blocks &#8220;700&#8221; and &#8220;lisp&#8221; have been unfolded."</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>

<p>
Let's pack these together into a minor mode.
</p>
<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Minor mode </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #3a81c3;">(</span><span style="color: #cd6600;">define-minor-mode</span> <span style="color: #6c3163; font-weight: bold;">700-mode</span>
    <span style="color: #da8b55; background-color: #ecf3ec;">"This is an editor extension prototyping &#8220;the next 700 module systems&#8221; proposed research.</span>

<span style="color: #da8b55; background-color: #ecf3ec;">    An informal documentation, with examples, page can be found at</span>
<span style="color: #da8b55; background-color: #ecf3ec;">    https://alhassy.github.io/next-700-module-systems-proposal/PackageFormer.html</span>

<span style="color: #da8b55; background-color: #ecf3ec;">    The technical matter can be found at https://alhassy.github.io/next-700-module-systems-proposal/</span>

<span style="color: #da8b55; background-color: #ecf3ec;">    If you experience anything &#8220;going wrong&#8221; or have any ideas for improvement,</span>
<span style="color: #da8b55; background-color: #ecf3ec;">    please contact Musa Al-hassy at alhassy@gmail.com; thank-you &#9829;&#8255;&#9829;</span>
<span style="color: #da8b55; background-color: #ecf3ec;">  "</span>
  <span style="color: #3a81c3;">:lighter</span> <span style="color: #2d9574;">" 700 (&#8226;&#768;&#7447;&#8226;&#769;)&#1608;"</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Icon to display indicating the mode is enabled.</span>
  <span style="color: #3a81c3;">:require</span> 'foo

  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Toggle the menu bar</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(define-key global-map [menu-bar 700menu] t)(not 700-mode))</span>
  <span style="color: #6c3163;">(</span>define-key global-map <span style="color: #2d9574;">[</span>menu-bar 700menu<span style="color: #2d9574;">]</span> <span style="color: #2d9574;">(</span><span style="color: #cd6600;">and</span> 700-mode <span style="color: #67b11d;">(</span>cons <span style="color: #2d9574;">"700PackageFormers"</span> 700-menu-bar<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>

  <span style="color: #6c3163;">(</span><span style="color: #cd6600;">letf</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span> <span style="color: #b1951d;">(</span>symbol-function 'message-box<span style="color: #b1951d;">)</span> #'message<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
  <span style="color: #2d9574;">(</span><span style="color: #cd6600;">if</span> 700-mode
      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Initilisation</span>
      <span style="color: #67b11d;">(</span>enable-package-formers<span style="color: #67b11d;">)</span>

      <span style="color: #2aa1ae; background-color: #ecf3ec;">;; </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Closing</span>
      <span style="color: #67b11d;">(</span>disable-package-formers<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
</details>
</div>
</div>
</div>

<div id="outline-container-org2d2db67" class="outline-2">
<h2 id="org2d2db67"><span class="section-number-2">8</span> <span class="done Future">Future</span> Work</h2>
<div class="outline-text-2" id="text-8">
<p>
Well, that was a lot of Lisp I had to learn <code>(งಠ_ಠ)ง</code>
</p>

<p>
Hopefully the resulting prototype will be useful to others;
drop me a line if you're interested in this effort or have
any feedback or pointers!
</p>

<div class="org-center">
<p>
★ ★ ★
</p>
</div>

<p>
Below are some desirable features to work on.
</p>

<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> Colouring for 700-syntactical items.</li>

<li class="off"><code>[&#xa0;]</code> Tooltips</li>

<li class="off"><code>[&#xa0;]</code> MA: WK: hiding ↦ dropping</li>

<li class="off"><code>[&#xa0;]</code> Use buffer-substring-delimited-whole-buffer to parse <i>multiple</i>
<a href="#orgfeb9199">700-comments</a>!</li>

<li class="off"><code>[&#xa0;]</code> Add a level component to an instance structure; reduce it if Carrier is a parameter and otherwise leave it alone.
Instead, let the level of a PackageFormer denote the level of the typeclass instantiation, then with this in mind
we increase the level component of an instance structure only for those variations that keep the carrier as a field.
When we move to multi-sorted, as in Graphs, this issue will need to be revisited.</li>

<li class="off"><code>[&#xa0;]</code> Currently can only perform simple variational clauses; need to support complex clauses.</li>

<li class="off"><code>[&#xa0;]</code> Examples from the user-manual
should be exported into an Agda file which is then easily checked;
or the resulting generated code should be generated when export happens.</li>

<li class="off"><code>[&#xa0;]</code> Currently variational clauses apply as follows <code>PF v clause</code>, it would be useful to have them also apply
as <code>I clause</code> where <code>I = PF v</code> has already been declared. This would requuire we keep a list of instances and their parent PF;
our current list is consumed and thrown away.</li>

<li class="on"><code>[X]</code> Need to implement a <b>front-end</b> system to extend variational clauses.</li>

<li class="off"><code>[&#xa0;]</code> The <code>elements</code> of a PackageFormer should be  an alist, <code>'(name . type)</code>.
<ul class="org-ul">
<li>Maybe not, the front-end lets users treat them as strings, easily.</li>
<li>Maybe such a view is useful for the user? It is provided via <code>get-name</code> and <code>get-type</code>.</li>
</ul></li>

<li class="off"><code>[&#xa0;]</code> Refactor load-instantions function to make use of an <code>alter</code> field rather than overloading alter-<a href="#org3a76688">fields</a> in reify-instances.</li>

<li class="off"><code>[&#xa0;]</code> Refactor <code>instantiate</code> to make use of an <code>instance</code> structure, rather than 13 arguments.</li>

<li class="off"><code>[&#xa0;]</code> Why does ‘buffer-substring-delimited-whole-buffer’ return a list of strings? Why not join its result to simply return a list?</li>

<li class="off"><code>[&#xa0;]</code> Generated.agda needs to inherit all open/import declarations from parent.</li>

<li class="off"><code>[&#xa0;]</code> Give an example PackageFormer with some definitions or derived constructs, then hoist-up your waist so that the non-defined items are <code>module</code> <a href="#orgbfc27a3">parameters</a>.</li>

<li class="off"><code>[&#xa0;]</code> <code>B = cs ⟨+ A ⟨+ cs′</code> where each cs is a single name-type declaration and the operation is left-associative, and A is an existing packageformer. This gives us a nice way to build a hierarchy. Note that since only A has a name, we may form a forgetful coercion B⇒A automatically.
E.g., <code>Monoid = Type ⟨+ Pointed ⟨+ (Magma renaming (_⊕_ to _⨾_)) ⟨+ LeftUnital ⟨+ RightUnital ⟨+ assoc : ∀ {x y z} → (x ⨾ y) ⨾ z ≡ x ⨾ (y ⨾ z)</code> gives, automatically, <code>Monoid⇒Type, Monoid⇒Pointed, Monoid⇒Magma, Monoid⇒LeftUnital, Magma⇒RightUnital</code> (•̀ᴗ•́)و MA: To begin with, ignore the rename and work up the sequence one ⟨+ at a time.</li>

<li class="off"><code>[&#xa0;]</code> PF's should account for equations. For simplicity they become components of a record &amp; module, but derived operations on datatypes.</li>

<li class="off"><code>[&#xa0;]</code> Demonstrate how generative modules can be emulated.</li>

<li class="off"><code>[&#xa0;]</code> For now, PackageFormer's have no other <a href="#orgbfc27a3">parameters</a> besides the variation symbol.</li>

<li class="off"><code>[&#xa0;]</code> The global variables package-formers &amp; instance-declaration should be <i>buffer</i> specific?</li>

<li class="off"><code>[&#xa0;]</code> Assign to a local var, check equality against global <a href="#orgfeb9199">700-comments</a>,
if identical, no more processing since everything already generated.</li>

<li class="off"><code>[&#xa0;]</code> Make use of docstring so that when a user enters a key sequence or selects from a menu, we can show them a listing of all ‘major’ components of a program: An org-mode file is displayed with an enumeration of the items, each being a link to the source, and only their docstring is shown. This is a nice ‘overview’ of the program source.</li>

<li class="off"><code>[&#xa0;]</code> Currently it looks like we are a minor mode, but this is not true. We only have a menu and the icon (•̀ᴗ•́)و is displayed when our feature is supported.</li>

<li class="off"><code>[&#xa0;]</code> Generate all instances of a PackageFormer schema.</li>

<li class="off"><code>[&#xa0;]</code> <p>
Allow package formers to have explicit <code>Variation</code> <a href="#orgbfc27a3">parameters</a>; but
how do we then deal with nested invocations? What are the uses of
having differing invocations?
</p>

<p>
For example,
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #ba2f59; font-weight: bold;">PackageFormer LawfullyPointed</span> (<span style="color: #0000cd;">v</span> :<span style="color: #ba2f59; font-weight: bold;"> Variation</span>) : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
   <span style="color: #0000cd;">point</span> :<span style="color: #ba2f59; font-weight: bold;"> LawfullyPointed</span> <span style="color: #0000cd;">v</span>
   <span style="color: #0000cd;">law</span>   :<span style="color: #ba2f59; font-weight: bold;"> LawfullyPointed FOL</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Concrete variation </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>

</pre>
</div>
<p>
Would elaborate to something like:
</p>
<div class="org-src-container">
<pre class="src src-agda">       <span style="color: #cd6600;">data</span><span style="color: #ba2f59; font-weight: bold;"> LP-Term (Vars</span> : <span style="color: #cd6600;">Set</span>) : <span style="color: #cd6600;">Set</span> <span style="color: #cd6600;">where</span>
        <span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Abstract fields from constituents of packageformer </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
       <span style="color: #ba2f59; font-weight: bold;"> Point</span>    :<span style="color: #ba2f59; font-weight: bold;"> LP-Term</span>
        <span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Fragment of first order logic term formation </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
        _&#8242;       :<span style="color: #ba2f59; font-weight: bold;"> Vars</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> LP-Term</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">{- </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Injection of vars as terms </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-}</span>
        _&#8776;_      :<span style="color: #ba2f59; font-weight: bold;"> LP-Term</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> LP-Term</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> LP-Term</span>
        &#8704;&#8242; &#8707;&#8242;    :<span style="color: #ba2f59; font-weight: bold;"> (Vars</span> &#8594;<span style="color: #ba2f59; font-weight: bold;"> LP-Term</span>) &#8594;<span style="color: #ba2f59; font-weight: bold;"> LP-Term</span>

       <span style="color: #cd6600;">record</span><span style="color: #ba2f59; font-weight: bold;"> LP</span> :<span style="color: #ba2f59; font-weight: bold;"> Set</span>&#8321; <span style="color: #cd6600;">where</span>
     <span style="color: #cd6600;">constructor</span> _,_,_
     <span style="color: #cd6600;">field</span>
       <span style="color: #ba2f59; font-weight: bold;"> Carrier</span> : <span style="color: #cd6600;">Set</span>
        <span style="color: #0000cd;">point</span>   :<span style="color: #ba2f59; font-weight: bold;"> Carrier</span>
        <span style="color: #0000cd;">law</span>     :<span style="color: #ba2f59; font-weight: bold;"> LP-Term Carrier</span>
</pre>
</div>

<p>
With the following example uses.
</p>
<div class="org-src-container">
<pre class="src src-agda">     <span style="color: #ba2f59; font-weight: bold;"> Contractable</span> :<span style="color: #ba2f59; font-weight: bold;"> (A</span> : <span style="color: #cd6600;">Set</span>) (<span style="color: #0000cd;">a</span> :<span style="color: #ba2f59; font-weight: bold;"> A</span>) &#8594;<span style="color: #ba2f59; font-weight: bold;"> LP</span>
     <span style="color: #ba2f59; font-weight: bold;"> Contractable A</span> <span style="color: #0000cd;">a</span> <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;"> A</span> , <span style="color: #0000cd;">a</span> , &#8704;&#8242; (<span style="color: #cd6600;">&#955;</span> <span style="color: #0000cd;">x</span> &#8594; <span style="color: #0000cd;">x</span> &#8776; <span style="color: #0000cd;">a</span> &#8242;)

     <span style="color: #ba2f59; font-weight: bold;"> Indistinguishable</span> :<span style="color: #ba2f59; font-weight: bold;"> (A</span> : <span style="color: #cd6600;">Set</span>)  &#8594; <span style="color: #ba2f59; font-weight: bold;"> LP</span> <span style="color: #cd6600;">hiding</span> <span style="color: #0000cd;">point</span>
     <span style="color: #ba2f59; font-weight: bold;"> Indistinguishable A</span> <span style="color: #0000cd;">a</span> <span style="color: #cd6600;">=</span> <span style="color: #ba2f59; font-weight: bold;"> A</span> , &#8704;&#8242; (<span style="color: #cd6600;">&#955;</span> <span style="color: #0000cd;">x</span> &#8594; &#8704;&#8242; (<span style="color: #cd6600;">&#955;</span> <span style="color: #0000cd;">y</span> &#8594; <span style="color: #0000cd;">x</span> &#8776; <span style="color: #0000cd;">y</span>))
</pre>
</div>
<p>
Where <code>PF hiding c</code> is the largest sub-PackageFormer of <code>PF</code> with constituent <code>c</code>
removed &#x2014;in particular, constituents that depend on <code>c</code> would also be dropped.
</p></li>
</ul>
</div>
</div>
</div>
</body>
</html>
