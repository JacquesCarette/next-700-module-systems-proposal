<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-07-22 Mon 16:25 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Prototyping PackageFormers with Elisp</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Musa Al-hassy" />
<meta name="description" content="Generalising ADTS, records, typeclasses to “package formers”."
 />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Prototyping PackageFormers with Elisp</h1>

<style>

/* wrap lengthy lines for code blocks */
pre{white-space:pre-wrap}

/* inline code; see here for other colours: https://www.w3schools.com/colors/colors_names.asp */
code { background: LightGray;
       border-radius: 5px; /* How curvy the borders should be. */
}

table {
    background: pink;
    border-radius: 10px; /* How curvy the borders should be. */
    /* width:90% */

    border-bottom: hidden;
    border-top: hidden;

    /* Put table in the center of the page, horizontally. */
    margin-left:auto;margin-right:auto;

    font-family:"Courier New";
    font-size:90%;
}

/* table ‘d’ata elements */
td {
    border: 1px solid red; padding: 1em;
    /* border: none;
    border-left: 1px solid transparent;
    border-right: 1px solid transparent; */


}


/* Alter visible labels of source blocks */
pre.src-agda:before { content: 'Agda'; }
pre.src-haskell:before { content: 'Agda'; }
pre.src-org:before { content: 'Text'; }

/* Using source blocks “agda-results” as pink-background coloured blocks in HTML. */
/* pre.src-results-agda:before { content: 'Results: Agda'; } */
pre.src-results-agda { background: pink;}
/* Execute this for alias: (add-to-list 'org-src-lang-modes '("results-agda" . org-agda)) */

</style>


<div class="org-center">
<p>
<b>Abstract</b>
</p>
</div>

<p>
This article is about implementing a prototype supporting <a href="https://alhassy.github.io/next-700-module-systems-proposal/">“the next 700 module systems” proposal</a>
as an editor extension. In particular, we show how intimately related presentations of a type
can be <i>derived automatically</i> from a single generic declaration which we call a <code>PackageFormer</code>.
</p>

<p>
Think of a language that does not support currying and you need to have a function of
10 arguments that needs to support accepting any number of arguments less than 10, say
for partial application. In such languages, one must utilise the builder design pattern,
or quickly copy-paste the function 10 times, altering it slightly each time.
In general, if such a function definition requires <i>N</i> lines and <i>M</i> forms of the function
are needed, then nearly <i>N × M</i> lines of code are written manually.
</p>

<p>
Our prototype deals with this problem, among others, for functions on <i>types</i>
&#x2014;i.e., type constructors&#x2014; and reduces this quadractic count to a linear
count <i>N + M</i>: One declaration of <i>N</i> lines, then <i>M</i> lines, each being an instantiation
of the desired form. These ideas are discussed in the pre-print
<a href="https://github.com/alhassy/next-700-module-systems-proposal/blob/master/Paper0.pdf">A Language Feature to Unbundle Data at Will</a>.
</p>

<p>
The <a href="#org60b9b8b">first section</a> below quickly elaborates on our goal,
after that is a ‘<a href="#user-manual">user manual</a>’, then the remainder of
the article serves as literate documentation of the prototype;
as well as an opportunity for me to explore emojis.
To follow along, it may be useful to look at an <a href="https://alhassy.github.io/ElispCheatSheet/">Elisp Cheat Sheet</a>.
</p>

<div class="org-center">
<p>
<i>Everything here works with Agda version 2.6.0.</i>
</p>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Results of tests will be in pink, like this.</td>
</tr>
</tbody>
</table>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org60b9b8b">1. Aim: <i>Scrap the Repetition</i></a></li>
<li><a href="#user-manual">2. User Manual</a>
<ul>
<li><a href="#org1bf8eff">2.1. Installation</a></li>
<li><a href="#org08ac90b">2.2. Syntax</a></li>
<li><a href="#orgee656c0">2.3. Summary of Variational Clauses</a></li>
<li><a href="#org214eb44">2.4. Currying for Datatypes</a></li>
</ul>
</li>
<li><a href="#orgff0c48f">3. Strings and Things</a>
<ul>
<li><a href="#org02e8a1c">3.1. Finding Children in the Wild</a></li>
<li><a href="#orge6f0dfd">3.2. Substrings Delimited by Tokens</a></li>
<li><a href="#org58a9f0a">3.3. <code>Itify</code>: A macro that makes macros ♥‿♥</a></li>
</ul>
</li>
<li><a href="#org6596ae2">4. The <code>package-former</code> Datatype</a>
<ul>
<li><a href="#orgb680f2f">4.1. Package Former Parsing and Pretty Printing</a></li>
</ul>
</li>
<li><a href="#org5360375">5. Parsing an Agda Buffer</a>
<ul>
<li><a href="#orgeedfebf">5.1. <code>instantiations-remaining</code> list</a></li>
<li><a href="#org3251694">5.2. <code>parse-700-comments</code></a></li>
</ul>
</li>
<li><a href="#org90f2f8f">6. <code>instantiate</code> &#x2014;the core utility</a>
<ul>
<li><a href="#org6ab9e88">6.1. Module instantions</a></li>
<li><a href="#orge2ac64b">6.2. Instantiate all items in <code>instantiations-remaining</code></a></li>
</ul>
</li>
<li><a href="#org829e1b0">7. Advising our Beloved <code>C-c C-l</code></a></li>
<li><a href="#org0e1f84d">8. Menu matter</a></li>
<li><a href="#org567a78a">9. <span class="done Future">Future</span> Work</a></li>
</ul>
</div>
</div>


<p>
&#x2014;Colouring momentarily disabled&#x2014;
</p>
<div id="outline-container-org60b9b8b" class="outline-2">
<h2 id="org60b9b8b"><span class="section-number-2">1</span> Aim: <i>Scrap the Repetition</i></h2>
<div class="outline-text-2" id="text-1">
<p>
We're going to write a code generator in Lisp that is going to interpret
fictitious Agda code &#x2014;henceforth referred to as “700 code”&#x2014;
into currently legitimate Agda code.
</p>

<p>
For example, something like the following, henceforth referred to as <code>test</code>:
</p>
<div class="org-src-container">
<pre class="src src-agda" id="orgc763451"><span style="color: #b58900; font-style: italic;">PackageFormer Semigroup</span> (<span style="color: #0000cd;">v</span> :<span style="color: #b58900; font-style: italic;"> Variation</span>) : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
    <span style="color: #b58900; font-style: italic;">_&#10814;_</span> :<span style="color: #b58900; font-style: italic;"> Semigroup</span> <span style="color: #0000cd;">v</span> &#8594;<span style="color: #b58900; font-style: italic;"> Semigroup</span> <span style="color: #0000cd;">v</span> &#8594;<span style="color: #b58900; font-style: italic;"> Semigroup</span> <span style="color: #0000cd;">v</span>
   <span style="color: #b58900; font-style: italic;"> Id</span>  :<span style="color: #b58900; font-style: italic;"> Semigroup</span> <span style="color: #0000cd;">v</span>
    <span style="color: #b58900; font-style: italic;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)

<span style="color: #b58900; font-style: italic;">Semigroup-semantics</span>  <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #b58900; font-style: italic;"> Semigroup</span> <span style="color: #859900; font-weight: bold;">record</span>
<span style="color: #b58900; font-style: italic;">Semigroup-syntax</span>     <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #b58900; font-style: italic;"> Semigroup</span> <span style="color: #859900; font-weight: bold;">data</span>
<span style="color: #b58900; font-style: italic;">SemigroupOn</span>          <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #b58900; font-style: italic;"> Semigroup</span> <span style="color: #859900; font-weight: bold;">typeclass</span>
</pre>
</div>

<p>
Will behave as if it were written:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #859900; font-weight: bold;">record</span> <span style="color: #b58900; font-style: italic;">Semigroup-semantics</span>  : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
  <span style="color: #859900; font-weight: bold;">field</span>
   <span style="color: #b58900; font-style: italic;"> Carrier</span> : <span style="color: #859900; font-weight: bold;">Set</span>
    <span style="color: #b58900; font-style: italic;">_&#10814;_</span> :<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span>
   <span style="color: #b58900; font-style: italic;"> Id</span>  :<span style="color: #b58900; font-style: italic;"> Carrier</span>
    <span style="color: #b58900; font-style: italic;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)

<span style="color: #859900; font-weight: bold;">data</span> <span style="color: #b58900; font-style: italic;">Semigroup-syntax</span> : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
    <span style="color: #b58900; font-style: italic;">_&#10814;_</span> :<span style="color: #b58900; font-style: italic;"> SemigroupD</span> &#8594;<span style="color: #b58900; font-style: italic;"> SemigroupD</span> &#8594;<span style="color: #b58900; font-style: italic;"> SemigroupD</span>
   <span style="color: #b58900; font-style: italic;"> Id</span>  :<span style="color: #b58900; font-style: italic;"> SemigroupD</span>

<span style="color: #859900; font-weight: bold;">record</span> <span style="color: #b58900; font-style: italic;">SemigroupOn (Carrier</span> : <span style="color: #859900; font-weight: bold;">Set</span>) : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
  <span style="color: #859900; font-weight: bold;">field</span>
    <span style="color: #b58900; font-style: italic;">_&#10814;_</span> :<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span>
   <span style="color: #b58900; font-style: italic;"> Id</span>  :<span style="color: #b58900; font-style: italic;"> Carrier</span>
    <span style="color: #b58900; font-style: italic;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
</pre>
</div>
<p>
This is a nearly <a id="orgb1b97aa">200% increase</a> in size; that is, our fictitious code will
save us a lot of repetition.
</p>

<p>
Below is a sample source file which contains special comments that are picked up
by the prototype which then copy-paste-cuts to produce a generated file.
</p>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Testing.agda </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">(load-file "PackageFormer.el") </span><span style="color: #93a1a1;">-}</span>

<span style="color: #859900; font-weight: bold;">module</span> <span style="color: #a020f0;">Testing</span> <span style="color: #859900; font-weight: bold;">where</span>

<span style="color: #859900; font-weight: bold;">open</span> <span style="color: #859900; font-weight: bold;">import</span> <span style="color: #a020f0;">Testing_Generated</span>
<span style="color: #859900; font-weight: bold;">open</span> <span style="color: #859900; font-weight: bold;">import</span> <span style="color: #a020f0;">Level</span>
<span style="color: #859900; font-weight: bold;">open</span> <span style="color: #859900; font-weight: bold;">import</span> <span style="color: #a020f0;">Data.Bool</span>
<span style="color: #859900; font-weight: bold;">open</span> <span style="color: #859900; font-weight: bold;">import</span> <span style="color: #a020f0;">Relation.Binary.PropositionalEquality</span> <span style="color: #859900; font-weight: bold;">using</span> (_&#8801;_)

<span style="color: #93a1a1;">{-</span><span style="color: #96A7A9; font-style: italic;">700</span>

<span style="color: #96A7A9; font-style: italic;">variable</span>
<span style="color: #96A7A9; font-style: italic;">   &#8467; : Level</span>

<span style="color: #96A7A9; font-style: italic;">PackageFormer Monoid (v : Variation) : Set where</span>
<span style="color: #96A7A9; font-style: italic;">    _&#10814;_     : Monoid v &#8594; Monoid v &#8594; Monoid v</span>
<span style="color: #96A7A9; font-style: italic;">    Id      : Monoid v</span>
<span style="color: #96A7A9; font-style: italic;">    assoc   : &#8704; {x y z} &#8594; (x &#10814; y) &#10814; z &#8801; x &#10814; (y &#10814; z)</span>
<span style="color: #96A7A9; font-style: italic;">    leftId  : &#8704; {x : Monoid v} &#8594; Id &#10814; x &#8801; x</span>
<span style="color: #96A7A9; font-style: italic;">    rightId : &#8704; {x : Monoid v} &#8594; x &#10814; Id &#8801; x</span>
<span style="color: #93a1a1;">-}</span>


<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">Since 700-comments generate code which is imported, we may use their results</span>
<span style="color: #96A7A9; font-style: italic;">   seemingly before their definition </span><span style="color: #93a1a1;">-}</span>

_ <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #b58900; font-style: italic;">MonoidR</span>
<span style="color: #859900; font-weight: bold;">open</span> <span style="color: #b58900; font-style: italic;">MonoidR&#8242;</span>

<span style="color: #93a1a1;">{-</span><span style="color: #96A7A9; font-style: italic;">700</span>
<span style="color: #96A7A9; font-style: italic;">MonoidR   = Monoid record</span>
<span style="color: #96A7A9; font-style: italic;">MonoidR&#8242;  = Monoid opening MonoidR (&#955; x &#8594; x ++ "&#8242;")</span>
<span style="color: #96A7A9; font-style: italic;">MonoidR&#8321;  = Monoid opening MonoidR (&#955; x &#8594; x ++ "&#8321;")</span>
<span style="color: #96A7A9; font-style: italic;">MonoidR&#8322;  = Monoid opening MonoidR (&#955; x &#8594; x ++ "&#8322;")</span>
<span style="color: #93a1a1;">-}</span>

<span style="color: #859900; font-weight: bold;">record</span><span style="color: #b58900; font-style: italic;"> Monoid-Hom</span> (&#119982; &#119983; :<span style="color: #b58900; font-style: italic;"> MonoidR</span>) : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
  <span style="color: #859900; font-weight: bold;">open</span><span style="color: #b58900; font-style: italic;"> MonoidR</span>&#8321; &#119982;; <span style="color: #859900; font-weight: bold;">open</span><span style="color: #b58900; font-style: italic;"> MonoidR</span>&#8322; &#119983;
  <span style="color: #859900; font-weight: bold;">field</span>
    <span style="color: #0000cd;">mor</span>     :<span style="color: #b58900; font-style: italic;"> Carrier</span>&#8321; &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span>&#8322;
    <span style="color: #0000cd;">id-pres</span> : <span style="color: #0000cd;">mor</span><span style="color: #b58900; font-style: italic;"> Id</span>&#8321; &#8801;<span style="color: #b58900; font-style: italic;"> Id</span>&#8322;
    <span style="color: #0000cd;">op-pres</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span>} &#8594; <span style="color: #0000cd;">mor</span> (<span style="color: #0000cd;">x</span> &#10814;&#8321; <span style="color: #0000cd;">y</span>) &#8801; <span style="color: #0000cd;">mor</span> <span style="color: #0000cd;">x</span> &#10814;&#8322; <span style="color: #0000cd;">mor</span> <span style="color: #0000cd;">y</span>

<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">Below are other examples, from the past. </span><span style="color: #93a1a1;">-}</span>

<span style="color: #93a1a1;">{-</span><span style="color: #96A7A9; font-style: italic;">700</span>
<span style="color: #96A7A9; font-style: italic;">MonoidTypeclass = Monoid typeclass hiding (_&#10814;_)</span>
<span style="color: #96A7A9; font-style: italic;">MonoidT         = Monoid typeclass renaming (Carrier to C; _&#10814;_ to _&#8853;_)</span>
<span style="color: #96A7A9; font-style: italic;">MonoidE         = Monoid record exposing (Carrier; Id)</span>
<span style="color: #96A7A9; font-style: italic;">MonoidB         = Monoid record with (Carrier to Bool; Id to false)</span>
<span style="color: #96A7A9; font-style: italic;">MonoidD         = Monoid data renaming (_&#10814;_ to _&#916;_)</span>
<span style="color: #93a1a1;">-}</span>

--<span style="color: #b58900; font-style: italic;"> MonoidR</span>         <span style="color: #859900; font-weight: bold;">=</span><span style="color: #b58900; font-style: italic;"> Monoid</span> <span style="color: #859900; font-weight: bold;">record</span> <span style="color: #0000cd;">unbundling</span> <span style="color: #a020f0;">2</span>
--<span style="color: #b58900; font-style: italic;"> MonoidD</span>&#8242;        <span style="color: #859900; font-weight: bold;">=</span><span style="color: #b58900; font-style: italic;"> Monoid</span> <span style="color: #859900; font-weight: bold;">data</span> <span style="color: #0000cd;">decorated</span> (<span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #0000cd;">it</span> &#8594; <span style="color: #2aa198;">"&#9586;"</span> ++ <span style="color: #0000cd;">it</span> ++ <span style="color: #2aa198;">"&#9585;"</span>)

--<span style="color: #b58900; font-style: italic;"> Accidentally</span> &#8220;<span style="color: #0000cd;">datar</span>&#8221; <span style="color: #0000cd;">instead</span> <span style="color: #0000cd;">of</span> &#8220;<span style="color: #859900; font-weight: bold;">data</span>&#8221;.
--<span style="color: #b58900; font-style: italic;"> Whoops</span> <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #b58900; font-style: italic;">Monoid datar</span>

_ <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #b58900; font-style: italic;">MonoidTypeclass</span>
<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">record MonoidTypeclass (Carrier : Set) : Set where &#8230; </span><span style="color: #93a1a1;">-}</span>

_ <span style="color: #859900; font-weight: bold;">=</span><span style="color: #b58900; font-style: italic;"> MonoidT</span> ; <span style="color: #859900; font-weight: bold;">open</span><span style="color: #b58900; font-style: italic;"> MonoidT</span> <span style="color: #859900; font-weight: bold;">using</span> (_&#8853;_)
<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">record MonoidT (C : Set) : Set where &#8230; </span><span style="color: #93a1a1;">-}</span>

_ <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #b58900; font-style: italic;">MonoidR</span>
<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">record MonoidR (Carrier : Set) (_&#10814;_ : Carrier &#8594; Carrier &#8594; Carrier) : Set where &#8230; </span><span style="color: #93a1a1;">-}</span>

_ <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #b58900; font-style: italic;">MonoidD</span>
<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">data MonoidD : Set where &#8230; </span><span style="color: #93a1a1;">-}</span>

_ <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #b58900; font-style: italic;">MonoidE</span>
<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">record MonoidE (Carrier : Set) (Id : Carrier) : Set where &#8230; </span><span style="color: #93a1a1;">-}</span>

_ <span style="color: #859900; font-weight: bold;">=</span><span style="color: #b58900; font-style: italic;"> MonoidB</span> ; <span style="color: #859900; font-weight: bold;">open</span><span style="color: #b58900; font-style: italic;"> MonoidB</span> <span style="color: #859900; font-weight: bold;">using</span> (<span style="color: #0000cd;">leftfalse</span>)
<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">record MonoidB : Set&#8320; where &#8230; </span><span style="color: #93a1a1;">-}</span>

-- _ <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #b58900; font-style: italic;">MonoidD&#8242;</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Testing_Generated.agda </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">This file is generated ;; do not alter. </span><span style="color: #93a1a1;">-}</span>

<span style="color: #859900; font-weight: bold;">open</span> <span style="color: #859900; font-weight: bold;">import</span> <span style="color: #a020f0;">Level</span>
<span style="color: #859900; font-weight: bold;">open</span> <span style="color: #859900; font-weight: bold;">import</span> <span style="color: #a020f0;">Data.Bool</span>
<span style="color: #859900; font-weight: bold;">open</span> <span style="color: #859900; font-weight: bold;">import</span> <span style="color: #a020f0;">Relation.Binary.PropositionalEquality</span> <span style="color: #859900; font-weight: bold;">using</span> (_&#8801;_)
<span style="color: #859900; font-weight: bold;">open</span> <span style="color: #859900; font-weight: bold;">import</span> <span style="color: #a020f0;">Level</span><span style="color: #268bd2;"> as</span><span style="color: #b58900; font-style: italic;"> Level</span>
<span style="color: #859900; font-weight: bold;">module</span> <span style="color: #a020f0;">Testing_Generated</span> <span style="color: #859900; font-weight: bold;">where</span>
<span style="color: #0000cd;">variable</span>
   &#8467; :<span style="color: #b58900; font-style: italic;"> Level</span>
<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">MonoidR   = Monoid record </span><span style="color: #93a1a1;">-}</span>
<span style="color: #859900; font-weight: bold;">record</span><span style="color: #b58900; font-style: italic;"> MonoidR</span> : <span style="color: #859900; font-weight: bold;">Set</span><span style="color: #b58900; font-style: italic;"> (Level</span>.<span style="color: #0000cd;">suc</span><span style="color: #b58900; font-style: italic;"> Level</span>.<span style="color: #0000cd;">zero</span>) <span style="color: #859900; font-weight: bold;">where</span>
  <span style="color: #859900; font-weight: bold;">field</span>
   <span style="color: #b58900; font-style: italic;"> Carrier</span> : <span style="color: #859900; font-weight: bold;">Set</span>
    <span style="color: #b58900; font-style: italic;">_&#10814;_</span>     :<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span>
   <span style="color: #b58900; font-style: italic;"> Id</span>      :<span style="color: #b58900; font-style: italic;"> Carrier</span>
    <span style="color: #b58900; font-style: italic;">assoc</span>   : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #b58900; font-style: italic;">leftId</span>  : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #b58900; font-style: italic;"> Carrier</span>} &#8594;<span style="color: #b58900; font-style: italic;"> Id</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #b58900; font-style: italic;">rightId</span> : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #b58900; font-style: italic;"> Carrier</span>} &#8594; <span style="color: #0000cd;">x</span> &#10814;<span style="color: #b58900; font-style: italic;"> Id</span> &#8801; <span style="color: #0000cd;">x</span>

<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">MonoidR&#8242;  = Monoid opening MonoidR (&#955; x &#8594; x ++ "&#8242;") </span><span style="color: #93a1a1;">-}</span>
<span style="color: #859900; font-weight: bold;">module</span> <span style="color: #a020f0;">MonoidR</span>&#8242; (&#8475; :<span style="color: #b58900; font-style: italic;"> MonoidR</span>) <span style="color: #859900; font-weight: bold;">where</span>
    <span style="color: #859900; font-weight: bold;">open</span><span style="color: #b58900; font-style: italic;"> MonoidR</span> &#8475; <span style="color: #859900; font-weight: bold;">public</span>
         <span style="color: #859900; font-weight: bold;">renaming</span>
            (<span style="color: #b58900; font-style: italic;"> Carrier</span> <span style="color: #0000cd;">to</span><span style="color: #b58900; font-style: italic;"> Carrier</span>&#8242;
            ; <span style="color: #b58900; font-style: italic;">_&#10814;_</span> <span style="color: #0000cd;">to</span> _&#10814;&#8242;_
            ;<span style="color: #b58900; font-style: italic;"> Id</span> <span style="color: #0000cd;">to</span><span style="color: #b58900; font-style: italic;"> Id</span>&#8242;
            ; <span style="color: #b58900; font-style: italic;">assoc</span> <span style="color: #0000cd;">to</span> <span style="color: #b58900; font-style: italic;">assoc</span>&#8242;
            ; <span style="color: #b58900; font-style: italic;">leftId</span> <span style="color: #0000cd;">to</span> <span style="color: #b58900; font-style: italic;">leftId</span>&#8242;
            ; <span style="color: #b58900; font-style: italic;">rightId</span> <span style="color: #0000cd;">to</span> <span style="color: #b58900; font-style: italic;">rightId</span>&#8242;
            )

<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">MonoidR&#8321;  = Monoid opening MonoidR (&#955; x &#8594; x ++ "&#8321;") </span><span style="color: #93a1a1;">-}</span>
<span style="color: #859900; font-weight: bold;">module</span> <span style="color: #a020f0;">MonoidR</span>&#8321; (&#8475; :<span style="color: #b58900; font-style: italic;"> MonoidR</span>) <span style="color: #859900; font-weight: bold;">where</span>
    <span style="color: #859900; font-weight: bold;">open</span><span style="color: #b58900; font-style: italic;"> MonoidR</span> &#8475; <span style="color: #859900; font-weight: bold;">public</span>
         <span style="color: #859900; font-weight: bold;">renaming</span>
            (<span style="color: #b58900; font-style: italic;"> Carrier</span> <span style="color: #0000cd;">to</span><span style="color: #b58900; font-style: italic;"> Carrier</span>&#8321;
            ; <span style="color: #b58900; font-style: italic;">_&#10814;_</span> <span style="color: #0000cd;">to</span> _&#10814;&#8321;_
            ;<span style="color: #b58900; font-style: italic;"> Id</span> <span style="color: #0000cd;">to</span><span style="color: #b58900; font-style: italic;"> Id</span>&#8321;
            ; <span style="color: #b58900; font-style: italic;">assoc</span> <span style="color: #0000cd;">to</span> <span style="color: #b58900; font-style: italic;">assoc</span>&#8321;
            ; <span style="color: #b58900; font-style: italic;">leftId</span> <span style="color: #0000cd;">to</span> <span style="color: #b58900; font-style: italic;">leftId</span>&#8321;
            ; <span style="color: #b58900; font-style: italic;">rightId</span> <span style="color: #0000cd;">to</span> <span style="color: #b58900; font-style: italic;">rightId</span>&#8321;
            )

<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">MonoidR&#8322;  = Monoid opening MonoidR (&#955; x &#8594; x ++ "&#8322;") </span><span style="color: #93a1a1;">-}</span>
<span style="color: #859900; font-weight: bold;">module</span> <span style="color: #a020f0;">MonoidR</span>&#8322; (&#8475; :<span style="color: #b58900; font-style: italic;"> MonoidR</span>) <span style="color: #859900; font-weight: bold;">where</span>
    <span style="color: #859900; font-weight: bold;">open</span><span style="color: #b58900; font-style: italic;"> MonoidR</span> &#8475; <span style="color: #859900; font-weight: bold;">public</span>
         <span style="color: #859900; font-weight: bold;">renaming</span>
            (<span style="color: #b58900; font-style: italic;"> Carrier</span> <span style="color: #0000cd;">to</span><span style="color: #b58900; font-style: italic;"> Carrier</span>&#8322;
            ; <span style="color: #b58900; font-style: italic;">_&#10814;_</span> <span style="color: #0000cd;">to</span> _&#10814;&#8322;_
            ;<span style="color: #b58900; font-style: italic;"> Id</span> <span style="color: #0000cd;">to</span><span style="color: #b58900; font-style: italic;"> Id</span>&#8322;
            ; <span style="color: #b58900; font-style: italic;">assoc</span> <span style="color: #0000cd;">to</span> <span style="color: #b58900; font-style: italic;">assoc</span>&#8322;
            ; <span style="color: #b58900; font-style: italic;">leftId</span> <span style="color: #0000cd;">to</span> <span style="color: #b58900; font-style: italic;">leftId</span>&#8322;
            ; <span style="color: #b58900; font-style: italic;">rightId</span> <span style="color: #0000cd;">to</span> <span style="color: #b58900; font-style: italic;">rightId</span>&#8322;
            )

<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">MonoidTypeclass = Monoid typeclass hiding (_&#10814;_) </span><span style="color: #93a1a1;">-}</span>
<span style="color: #859900; font-weight: bold;">record</span><span style="color: #b58900; font-style: italic;"> MonoidTypeclass (Carrier</span> : <span style="color: #859900; font-weight: bold;">Set</span>) : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
  <span style="color: #859900; font-weight: bold;">field</span>
   <span style="color: #b58900; font-style: italic;"> Id</span>      :<span style="color: #b58900; font-style: italic;"> Carrier</span>

<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">MonoidT         = Monoid typeclass renaming (Carrier to C; _&#10814;_ to _&#8853;_) </span><span style="color: #93a1a1;">-}</span>
<span style="color: #859900; font-weight: bold;">record</span><span style="color: #b58900; font-style: italic;"> MonoidT (C</span> : <span style="color: #859900; font-weight: bold;">Set</span>) : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
  <span style="color: #859900; font-weight: bold;">field</span>
    _&#8853;_     : <span style="color: #859900; font-weight: bold;">let</span><span style="color: #b58900; font-style: italic;"> Carrier</span> <span style="color: #859900; font-weight: bold;">=</span><span style="color: #b58900; font-style: italic;"> C</span> <span style="color: #859900; font-weight: bold;">in</span><span style="color: #b58900; font-style: italic;"> C</span> &#8594;<span style="color: #b58900; font-style: italic;"> C</span> &#8594;<span style="color: #b58900; font-style: italic;"> C</span>
   <span style="color: #b58900; font-style: italic;"> Id</span>      : <span style="color: #859900; font-weight: bold;">let</span><span style="color: #b58900; font-style: italic;"> Carrier</span> <span style="color: #859900; font-weight: bold;">=</span><span style="color: #b58900; font-style: italic;"> C</span> <span style="color: #859900; font-weight: bold;">in</span><span style="color: #b58900; font-style: italic;"> C</span>
    <span style="color: #b58900; font-style: italic;">assoc</span>   : <span style="color: #859900; font-weight: bold;">let</span> <span style="color: #b58900; font-style: italic;">_&#10814;_</span> <span style="color: #859900; font-weight: bold;">=</span> _&#8853;_ <span style="color: #859900; font-weight: bold;">in</span> <span style="color: #859900; font-weight: bold;">let</span><span style="color: #b58900; font-style: italic;"> Carrier</span> <span style="color: #859900; font-weight: bold;">=</span><span style="color: #b58900; font-style: italic;"> C</span> <span style="color: #859900; font-weight: bold;">in</span> &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #b58900; font-style: italic;">leftId</span>  : <span style="color: #859900; font-weight: bold;">let</span> <span style="color: #b58900; font-style: italic;">_&#10814;_</span> <span style="color: #859900; font-weight: bold;">=</span> _&#8853;_ <span style="color: #859900; font-weight: bold;">in</span> <span style="color: #859900; font-weight: bold;">let</span><span style="color: #b58900; font-style: italic;"> Carrier</span> <span style="color: #859900; font-weight: bold;">=</span><span style="color: #b58900; font-style: italic;"> C</span> <span style="color: #859900; font-weight: bold;">in</span> &#8704; {<span style="color: #0000cd;">x</span> : <span style="color: #859900; font-weight: bold;">let</span> <span style="color: #b58900; font-style: italic;">_&#10814;_</span> <span style="color: #859900; font-weight: bold;">=</span> _&#8853;_ <span style="color: #859900; font-weight: bold;">in</span> <span style="color: #859900; font-weight: bold;">let</span><span style="color: #b58900; font-style: italic;"> Carrier</span> <span style="color: #859900; font-weight: bold;">=</span><span style="color: #b58900; font-style: italic;"> C</span> <span style="color: #859900; font-weight: bold;">in</span><span style="color: #b58900; font-style: italic;"> C</span>} &#8594;<span style="color: #b58900; font-style: italic;"> Id</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #b58900; font-style: italic;">rightId</span> : <span style="color: #859900; font-weight: bold;">let</span> <span style="color: #b58900; font-style: italic;">_&#10814;_</span> <span style="color: #859900; font-weight: bold;">=</span> _&#8853;_ <span style="color: #859900; font-weight: bold;">in</span> <span style="color: #859900; font-weight: bold;">let</span><span style="color: #b58900; font-style: italic;"> Carrier</span> <span style="color: #859900; font-weight: bold;">=</span><span style="color: #b58900; font-style: italic;"> C</span> <span style="color: #859900; font-weight: bold;">in</span> &#8704; {<span style="color: #0000cd;">x</span> : <span style="color: #859900; font-weight: bold;">let</span> <span style="color: #b58900; font-style: italic;">_&#10814;_</span> <span style="color: #859900; font-weight: bold;">=</span> _&#8853;_ <span style="color: #859900; font-weight: bold;">in</span> <span style="color: #859900; font-weight: bold;">let</span><span style="color: #b58900; font-style: italic;"> Carrier</span> <span style="color: #859900; font-weight: bold;">=</span><span style="color: #b58900; font-style: italic;"> C</span> <span style="color: #859900; font-weight: bold;">in</span><span style="color: #b58900; font-style: italic;"> C</span>} &#8594; <span style="color: #0000cd;">x</span> &#10814;<span style="color: #b58900; font-style: italic;"> Id</span> &#8801; <span style="color: #0000cd;">x</span>

<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">MonoidE         = Monoid record exposing (Carrier; Id) </span><span style="color: #93a1a1;">-}</span>
<span style="color: #859900; font-weight: bold;">record</span><span style="color: #b58900; font-style: italic;"> MonoidE (Carrier</span> : <span style="color: #859900; font-weight: bold;">Set</span>)<span style="color: #b58900; font-style: italic;"> (Id</span> :<span style="color: #b58900; font-style: italic;"> Carrier</span>) : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
  <span style="color: #859900; font-weight: bold;">field</span>
    <span style="color: #b58900; font-style: italic;">_&#10814;_</span>     :<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span>
    <span style="color: #b58900; font-style: italic;">assoc</span>   : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #b58900; font-style: italic;">leftId</span>  : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #b58900; font-style: italic;"> Carrier</span>} &#8594;<span style="color: #b58900; font-style: italic;"> Id</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #b58900; font-style: italic;">rightId</span> : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #b58900; font-style: italic;"> Carrier</span>} &#8594; <span style="color: #0000cd;">x</span> &#10814;<span style="color: #b58900; font-style: italic;"> Id</span> &#8801; <span style="color: #0000cd;">x</span>

<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">MonoidB         = Monoid record with (Carrier to Bool; Id to false) </span><span style="color: #93a1a1;">-}</span>
<span style="color: #859900; font-weight: bold;">record</span><span style="color: #b58900; font-style: italic;"> MonoidB</span> : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
  <span style="color: #859900; font-weight: bold;">field</span>
    <span style="color: #b58900; font-style: italic;">_&#10814;_</span>     :<span style="color: #b58900; font-style: italic;"> Bool</span> &#8594;<span style="color: #b58900; font-style: italic;"> Bool</span> &#8594;<span style="color: #b58900; font-style: italic;"> Bool</span>
    <span style="color: #b58900; font-style: italic;">assoc</span>   : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #0000cd;">leftfalse</span>  : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #b58900; font-style: italic;"> Bool</span>} &#8594; <span style="color: #0000cd;">false</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #0000cd;">rightfalse</span> : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #b58900; font-style: italic;"> Bool</span>} &#8594; <span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">false</span> &#8801; <span style="color: #0000cd;">x</span>

<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">MonoidD         = Monoid data renaming (_&#10814;_ to _&#916;_) </span><span style="color: #93a1a1;">-}</span>
<span style="color: #859900; font-weight: bold;">data</span><span style="color: #b58900; font-style: italic;"> MonoidD</span> : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
    _&#916;_     : <span style="color: #b58900; font-style: italic;">MonoidD &#8594; MonoidD &#8594; MonoidD</span>
   <span style="color: #b58900; font-style: italic;"> Id</span>      : <span style="color: #859900; font-weight: bold;">let</span> <span style="color: #b58900; font-style: italic;">_&#10814;_</span> <span style="color: #859900; font-weight: bold;">=</span> _&#916;_ <span style="color: #859900; font-weight: bold;">in</span> <span style="color: #b58900; font-style: italic;">MonoidD</span>
</pre>
</div>
</details>

<p>
For this prototype, we have the following <a id="org4850a43">constraints</a>:
</p>

<ol class="org-ol">
<li>The type of a PackageFormer is <code>Set ℓ</code> where <code>ℓ</code> is the empty string
or a parenthesised expression of type <code>Level</code>.
<ul class="org-ul">
<li>In-particular, subscript types are not yet supported.</li>
</ul></li>

<li>The <code>where</code> keyword appears on the same line as the <code>PackageFormer</code> key-phrase.</li>

<li>The name of the PackageFormer should not contain <code>PackageFormer</code> as a sub-identifier.
<ul class="org-ul">
<li>Likewise, no element should be named <code>to</code>.</li>
</ul></li>

<li><p>
We are only considering single-sorted structures, for now.
</p>

<p>
The research <a href="https://alhassy.github.io/next-700-module-systems-proposal/">proposal</a> addresses how to move beyond this issue.
</p></li>
</ol>

<p>
There are many useful features outlined in the proposal, such as default implementations, that we
hope to include in the future. For now, we just want something that works, is decently documented, and
can be useful.
</p>
</div>
</div>

<div id="outline-container-org3947ded" class="outline-2">
<h2 id="user-manual"><span class="section-number-2">2</span> User Manual</h2>
<div class="outline-text-2" id="text-user-manual">
<p>
If the previous section is unclear regarding the aims and uses of this prototype,
please consult the pre-print <a href="https://github.com/alhassy/next-700-module-systems-proposal/blob/master/Paper0.pdf">A Language Feature to Unbundle Data at Will</a>
or <a href="https://alhassy.github.io/next-700-module-systems-proposal/">the next 700 module systems proposal</a>.
</p>
</div>

<div id="outline-container-org1bf8eff" class="outline-3">
<h3 id="org1bf8eff"><span class="section-number-3">2.1</span> Installation</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Click here to obtain <a href="https://raw.githubusercontent.com/alhassy/next-700-module-systems-proposal/master/PackageFormer.el">PackageFormer.el</a>, place it somewhere, open an Agda file, execute
<code>M-x your/locatio/PackageFormer.el</code>, then enable the mode by executing <code>M-x 700-mode</code>.
</p>

<p>
<b>Alternatively</b>, add the following to your Emacs configuration file:
</p>
<pre class="example">
;; Ensure you have the pre-requsite libraries ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;
;; String and list manipulation libraries
;; https://github.com/magnars/dash.el
;; https://github.com/magnars/s.el
(package-install 's)                ;; “The long lost Emacs string manipulation library”
(package-install 'dash)             ;; “A modern list library for Emacs”
(package-install 'dash-functional)  ;; “Function combinators”
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;; Obtain the Elisp file, load it, and attach it to Agda.

(shell-command (concat "curl "
  "https://raw.githubusercontent.com/alhassy/next-700-module-systems-proposal/master/PackageFormer.el "
  "&gt;&gt; ~/.emacs.d/PackageFormer.el"))

(load-file "~/.emacs.d/PackageFormer.el")

(add-hook 'agda2-mode-hook #'700-mode)
</pre>

<p>
When you enable <code>700-mode</code>:
</p>

<ol class="org-ol">
<li>A menu-bar <code>700PackageFormers</code> will be added.</li>

<li>It will allow you to temporarily disable and enable this new feature,
as well as providing a help menu. Invoke <code>M-x 700-mode</code> to toggle turning off this feature
completely.</li>

<li>The string icon <code>700 (•̀ᴗ•́)و</code> is displayed in the mode line &#x2014;near the bottom of Emacs.</li>

<li>You may use <code>C-c c-l</code> as usual, but it will now recognise <a href="#org7d7e11a">700-comments</a> and generate
legitimate Agda code from them &#x2014;more on this later.

<ul class="org-ul">
<li>PackageFormer syntactical items are coloured green, PackageFormer names are
coloured yellow, and their instantations are simply bolded. To update a coloured
item, simply save then revert-buffer (F5), then reload with C-c C-l.</li>
</ul></li>
</ol>

<p>
If you need any assistance, please contact me!
</p>
</div>
</div>

<div id="outline-container-org08ac90b" class="outline-3">
<h3 id="org08ac90b"><span class="section-number-3">2.2</span> Syntax</h3>
<div class="outline-text-3" id="text-2-2">
<p>
The prototype works by translating fictitious <a href="#orge7a250c">700-syntax</a> into legitimate Agda;
as follows:
</p>
<div class="org-src-container">
<pre class="src src-agda">...<span style="color: #0000cd;">agda</span> <span style="color: #0000cd;">code</span> <span style="color: #0000cd;">here</span>...
<span style="color: #93a1a1;">{-</span><span style="color: #96A7A9; font-style: italic;">700</span>
<span style="color: #96A7A9; font-style: italic;">       ...700-syntactical items here</span>
<span style="color: #93a1a1;">-}</span>
...<span style="color: #0000cd;">more</span> <span style="color: #0000cd;">agda</span> <span style="color: #0000cd;">code</span>...
</pre>
</div>
<p>
Since the first section provides an example source fragment with both <a href="#org7d7e11a">700-comments</a> as well
as instantiations, we shall only enclose <a href="#orge7a250c">700-syntax</a> in <a href="#org7d7e11a">700-comments</a> when it is surrounded
by other Agda code, and otherwise leave it free standing.
</p>

<p>
<i>We will provide full source listings at the end of discussions that only display fragments!</i>
</p>

<p>
<a id="orge7a250c">700-syntax</a> is defined informally as follows:
</p>
<pre class="example">
⟪700-syntax⟫    ::=  ⟪PackageFormer⟫ | ⟪Instantiation⟫ | ⟪Agda⟫

⟪PackageFormer⟫ ::= PackageFormer ⟪Identifier⟫ (v : Variation) : Set (⟪level⟫) where
                       ⟪newline-with-indentation⟫ ⟪Element⟫*

⟪Element⟫       ::=  ⟪Identifier⟫ : ⟪Any-Agda-Type⟫

⟪instantiation⟫ ::= ⟪Identifier⟫ = ⟪Identifier⟫ ⟪Variation⟫ [⟪VOp⟫]

{- Only listing the currently implemented -}
⟪Variation⟫     ::= typeclass | data | record
⟪VOp⟫           ::=   renaming ⟪ToList⟫
                    | unbundling ⟪ℕ⟫
                    | exposing (⟪Semicolon-seperated-list-of-Identifiers⟫)
                    | with     ⟪ToList⟫

⟪ToList⟫ ::= (⟪Identifier₀⟫ to ⟪Identifier₀⟫; ⋯; ⟪Identifierₙ⟫ to ⟪Identifierₙ⟫) {- for any n : ℕ -}
</pre>

<p>
One derives many presentations of a grouping mechanism by what we call ‘variational clauses’,
for which there is currently only simple support &#x2014;namely, they cannot be combined in intricate ways.
</p>

<ul class="org-ul">
<li>Example uses of the variational clauses could be seen in the <code>Testing.agda</code> listing in the first section above.</li>
</ul>
</div>
</div>

<div id="outline-container-orgee656c0" class="outline-3">
<h3 id="orgee656c0"><span class="section-number-3">2.3</span> Summary of Variational Clauses</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Let <code>PF</code> denote the name of a PackageFormer, then
<code>PF′ = PF Clause</code> behaves as follows:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><span class="underline">Clause</span></td>
<td class="org-left"><span class="underline">Behaviour</span></td>
</tr>

<tr>
<td class="org-left"><code>data</code></td>
<td class="org-left">A data, ADT, is declared</td>
</tr>

<tr>
<td class="org-left"><code>record</code></td>
<td class="org-left">A record having a new field ‘Carrier’</td>
</tr>

<tr>
<td class="org-left"><code>typeclass</code></td>
<td class="org-left">A record with one parameter ‘Carrier’</td>
</tr>

<tr>
<td class="org-left"><code>v unbundling N</code></td>
<td class="org-left">Instantiation  <code>v</code> with first <code>N</code> items as <a href="#org11fbf28">parameters</a></td>
</tr>

<tr>
<td class="org-left"><code>v exposing (e₀;…;eₙ)</code></td>
<td class="org-left">Instantiation <code>v</code> with <a href="#org11fbf28">parameters</a> <code>eᵢ</code></td>
</tr>

<tr>
<td class="org-left"><code>v hiding (e₀;…;eₙ)</code></td>
<td class="org-left">Instantiation <code>v</code> discarding <code>eᵢ</code></td>
</tr>

<tr>
<td class="org-left"><code>v renaming (eᵢ to eᵢ′)</code></td>
<td class="org-left">Instantiation <code>v</code> with specified renames</td>
</tr>

<tr>
<td class="org-left"><code>v with (eᵢ to eᵢ′)</code></td>
<td class="org-left">Instantiation <code>v</code> with specified rewrites</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org214eb44" class="outline-3">
<h3 id="org214eb44"><span class="section-number-3">2.4</span> Currying for Datatypes</h3>
<div class="outline-text-3" id="text-2-4">
<p>
Suppose you're a Haskell programmer and want to have multiple monoid instances for the Booleans.
You may make isomorphic copies of the Booleans, say <code>And</code> and <code>Any</code>, and implement the desired instance
for each. What about if you want a Monoid instance but insist only that the unit be <code>false</code>, what do you do then?
</p>

<p>
With this prototype, you expose the carrier and the operation in the first case, and expose the identity in the second case.
Moreover, you only write the definition of monoid once, leading to our motto:
</p>
<div class="org-center">
<p>
<i>Write once, derive many!</i>
</p>
</div>

<p>
Here's our formalisation of monoids:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #b58900; font-style: italic;">PackageFormer Monoid</span> (<span style="color: #0000cd;">v</span> :<span style="color: #b58900; font-style: italic;"> Variation</span>) : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
    <span style="color: #b58900; font-style: italic;">_&#10814;_</span>     : <span style="color: #b58900; font-style: italic;">Monoid v &#8594; Monoid v &#8594; Monoid v</span>
   <span style="color: #b58900; font-style: italic;"> Id</span>      : <span style="color: #b58900; font-style: italic;">Monoid v</span>
    <span style="color: #b58900; font-style: italic;">assoc</span>   : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #b58900; font-style: italic;">leftId</span>  : &#8704; {<span style="color: #0000cd;">x</span> : <span style="color: #b58900; font-style: italic;">Monoid v} &#8594; Id &#10814; x &#8801; x</span>
    <span style="color: #b58900; font-style: italic;">rightId</span> : &#8704; {<span style="color: #0000cd;">x</span> : <span style="color: #b58900; font-style: italic;">Monoid v} &#8594; x &#10814; Id &#8801; x</span>
</pre>
</div>

<p>
We regain the Haskell-style typeclass definition with the following declaration:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #b58900; font-style: italic;"> Classical</span> <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #b58900; font-style: italic;">Monoid typeclass</span>
</pre>
</div>
<p>
Loading the script, with <code>C-c C-l</code> as usual, produces a generated file that elaborate this definition as follows:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #859900; font-weight: bold;">record</span><span style="color: #b58900; font-style: italic;"> Classical (Carrier</span> : <span style="color: #859900; font-weight: bold;">Set</span>) : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
  <span style="color: #859900; font-weight: bold;">field</span>
    <span style="color: #b58900; font-style: italic;">_&#10814;_</span>     :<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span>
   <span style="color: #b58900; font-style: italic;"> Id</span>      :<span style="color: #b58900; font-style: italic;"> Carrier</span>
    <span style="color: #b58900; font-style: italic;">assoc</span>   : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #b58900; font-style: italic;">leftId</span>  : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #b58900; font-style: italic;"> Carrier</span>} &#8594;<span style="color: #b58900; font-style: italic;"> Id</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #b58900; font-style: italic;">rightId</span> : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #b58900; font-style: italic;"> Carrier</span>} &#8594; <span style="color: #0000cd;">x</span> &#10814;<span style="color: #b58900; font-style: italic;"> Id</span> &#8801; <span style="color: #0000cd;">x</span>
</pre>
</div>
<p>
Notice that a name <code>Carrier</code> has been introduced and it has replaced all syntactic occurences of <code>Monoid v</code>.
</p>

<p>
We could use the letter <code>m</code> in-place of <code>Carrier</code>, as is done in Haskell, as follows.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #b58900; font-style: italic;"> Monoid-m</span> <span style="color: #859900; font-weight: bold;">=</span><span style="color: #b58900; font-style: italic;"> Monoid</span> <span style="color: #859900; font-weight: bold;">typeclass</span> <span style="color: #859900; font-weight: bold;">renaming</span><span style="color: #b58900; font-style: italic;"> (Carrier</span> <span style="color: #0000cd;">to</span> <span style="color: #0000cd;">m</span>)
</pre>
</div>
<p>
Which propagates <code>Carrier = m</code> into the <a href="#orga516fc5">fields</a>. The propagation is necessary
if we were, for example, to rename <code>_⨾_ to _⊕_</code> &#x2014;otherwise we would need to parse
mixfix applications of this operator, as in <code>assoc</code>!
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #859900; font-weight: bold;">record</span><span style="color: #b58900; font-style: italic;"> Monoid-m</span> (<span style="color: #0000cd;">m</span> : <span style="color: #859900; font-weight: bold;">Set</span>) : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
  <span style="color: #859900; font-weight: bold;">field</span>
    <span style="color: #b58900; font-style: italic;">_&#10814;_</span>     : <span style="color: #859900; font-weight: bold;">let</span><span style="color: #b58900; font-style: italic;"> Carrier</span> <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #0000cd;">m</span> <span style="color: #859900; font-weight: bold;">in</span> <span style="color: #0000cd;">m</span> &#8594; <span style="color: #0000cd;">m</span> &#8594; <span style="color: #0000cd;">m</span>
   <span style="color: #b58900; font-style: italic;"> Id</span>      : <span style="color: #859900; font-weight: bold;">let</span><span style="color: #b58900; font-style: italic;"> Carrier</span> <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #0000cd;">m</span> <span style="color: #859900; font-weight: bold;">in</span> <span style="color: #0000cd;">m</span>
    <span style="color: #b58900; font-style: italic;">assoc</span>   : <span style="color: #859900; font-weight: bold;">let</span><span style="color: #b58900; font-style: italic;"> Carrier</span> <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #0000cd;">m</span> <span style="color: #859900; font-weight: bold;">in</span> &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #b58900; font-style: italic;">leftId</span>  : <span style="color: #859900; font-weight: bold;">let</span><span style="color: #b58900; font-style: italic;"> Carrier</span> <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #0000cd;">m</span> <span style="color: #859900; font-weight: bold;">in</span> &#8704; {<span style="color: #0000cd;">x</span> : <span style="color: #859900; font-weight: bold;">let</span><span style="color: #b58900; font-style: italic;"> Carrier</span> <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #0000cd;">m</span> <span style="color: #859900; font-weight: bold;">in</span> <span style="color: #0000cd;">m</span>} &#8594;<span style="color: #b58900; font-style: italic;"> Id</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #b58900; font-style: italic;">rightId</span> : <span style="color: #859900; font-weight: bold;">let</span><span style="color: #b58900; font-style: italic;"> Carrier</span> <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #0000cd;">m</span> <span style="color: #859900; font-weight: bold;">in</span> &#8704; {<span style="color: #0000cd;">x</span> : <span style="color: #859900; font-weight: bold;">let</span><span style="color: #b58900; font-style: italic;"> Carrier</span> <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #0000cd;">m</span> <span style="color: #859900; font-weight: bold;">in</span> <span style="color: #0000cd;">m</span>} &#8594; <span style="color: #0000cd;">x</span> &#10814;<span style="color: #b58900; font-style: italic;"> Id</span> &#8801; <span style="color: #0000cd;">x</span>
</pre>
</div>

<p>
Since Agda supports ‘named instances’, the Haskeller's first problem is solved. However, we demonstrate
an alternative solution that will allow us to solve the second problem in a fashion that current Agda
can only awkwardly approximate.
</p>

<p>
For example, with the current setup, we may go about requesting multiple monoid instances for the Booleans:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #859900; font-weight: bold;">open</span><span style="color: #b58900; font-style: italic;"> Classical</span> <span style="color: #859900; font-weight: bold;">using</span> () <span style="color: #859900; font-weight: bold;">renaming</span> (<span style="color: #b58900; font-style: italic;">_&#10814;_</span> <span style="color: #0000cd;">to</span><span style="color: #b58900; font-style: italic;"> Op</span>)

<span style="color: #0000cd;">yuck-one</span> : <span style="color: #b58900; font-style: italic;"> (X Y</span> :<span style="color: #b58900; font-style: italic;"> Classical</span> &#120121;)
         &#8594; <span style="color: #b58900; font-style: italic;"> Op X</span>  &#8801; _&#8743;_  &#8594; <span style="color: #b58900; font-style: italic;"> Op Y</span>  &#8801; _&#8744;_
         &#8594;  <span style="color: #859900; font-weight: bold;">Set</span>
<span style="color: #0000cd;">yuck-one</span> <span style="color: #859900; font-weight: bold;">=</span> ???
</pre>
</div>

<p>
The following declaration lets us ‘uncurry’ the first <code>N = 2</code> elements
from the field-position to the parameter-position; namely the
monoidal operation, <code>_⨾_</code> since the first element is always <code>Carrier</code>.
In fact, <code>typeclass</code> is sugar that behaves as if it were <code>record unbundled 1</code>.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #b58900; font-style: italic;"> MonoidOp</span> <span style="color: #859900; font-weight: bold;">=</span><span style="color: #b58900; font-style: italic;"> Monoid</span> <span style="color: #859900; font-weight: bold;">record</span> <span style="color: #0000cd;">unbundling</span> <span style="color: #a020f0;">2</span>
</pre>
</div>

<p>
This then yields:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #859900; font-weight: bold;">record</span><span style="color: #b58900; font-style: italic;"> MonoidOp (Carrier</span> : <span style="color: #859900; font-weight: bold;">Set</span>) (<span style="color: #b58900; font-style: italic;">_&#10814;_</span> :<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span>) : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
  <span style="color: #859900; font-weight: bold;">field</span>
   <span style="color: #b58900; font-style: italic;"> Id</span>      :<span style="color: #b58900; font-style: italic;"> Carrier</span>
    <span style="color: #b58900; font-style: italic;">assoc</span>   : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #b58900; font-style: italic;">leftId</span>  : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #b58900; font-style: italic;"> Carrier</span>} &#8594;<span style="color: #b58900; font-style: italic;"> Id</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #b58900; font-style: italic;">rightId</span> : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #b58900; font-style: italic;"> Carrier</span>} &#8594; <span style="color: #0000cd;">x</span> &#10814;<span style="color: #b58900; font-style: italic;"> Id</span> &#8801; <span style="color: #0000cd;">x</span>
</pre>
</div>

<p>
Which let's us solve the first problem elegantly as so:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #0000cd;">first-problem</span> :<span style="color: #b58900; font-style: italic;"> MonoidOp</span> &#120121; _&#8743;_  &#8594; <span style="color: #b58900; font-style: italic;"> MonoidOp</span> &#120121; _&#8744;_  &#8594; <span style="color: #859900; font-weight: bold;">Set</span>
<span style="color: #0000cd;">first-problem</span> <span style="color: #859900; font-weight: bold;">=</span> ???
</pre>
</div>

<p>
Neato ^_^ Short and sweet.
</p>

<p>
Now for the second problem. Rather than forming a new data-type,
we hoist up the <code>Id</code>-entity field as a parameter.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #b58900; font-style: italic;"> MonoidId</span> <span style="color: #859900; font-weight: bold;">=</span><span style="color: #b58900; font-style: italic;"> Monoid</span> <span style="color: #859900; font-weight: bold;">record</span> <span style="color: #0000cd;">exposing</span><span style="color: #b58900; font-style: italic;"> (Carrier</span>;<span style="color: #b58900; font-style: italic;"> Id</span>)
</pre>
</div>
<p>
Which results in:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #859900; font-weight: bold;">record</span><span style="color: #b58900; font-style: italic;"> MonoidId (Carrier</span> : <span style="color: #859900; font-weight: bold;">Set</span>)<span style="color: #b58900; font-style: italic;"> (Id</span> :<span style="color: #b58900; font-style: italic;"> Carrier</span>) : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
  <span style="color: #859900; font-weight: bold;">field</span>
    <span style="color: #b58900; font-style: italic;">_&#10814;_</span>     :<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span>
    <span style="color: #b58900; font-style: italic;">assoc</span>   : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #b58900; font-style: italic;">leftId</span>  : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #b58900; font-style: italic;"> Carrier</span>} &#8594;<span style="color: #b58900; font-style: italic;"> Id</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #b58900; font-style: italic;">rightId</span> : &#8704; {<span style="color: #0000cd;">x</span> :<span style="color: #b58900; font-style: italic;"> Carrier</span>} &#8594; <span style="color: #0000cd;">x</span> &#10814;<span style="color: #b58900; font-style: italic;"> Id</span> &#8801; <span style="color: #0000cd;">x</span>
</pre>
</div>

<p>
Resulting in the solution type:
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #0000cd;">second-problem-okay</span> :<span style="color: #b58900; font-style: italic;"> (X Y</span> :<span style="color: #b58900; font-style: italic;"> MonoidId</span> &#120121; <span style="color: #0000cd;">false</span>) &#8594; <span style="color: #859900; font-weight: bold;">Set</span>
<span style="color: #0000cd;">second-problem-okay</span> <span style="color: #859900; font-weight: bold;">=</span> ???
</pre>
</div>
<p>
However, this too can get tedious if we wish to only consider monoids
with unit <code>false</code>. In that case, we <i>treat</i> the <a href="#orga516fc5">fields</a> as if they where
manifest <a href="#orga516fc5">fields</a> and instantiate them to form a new type.
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #93a1a1;">{-</span><span style="color: #96A7A9; font-style: italic;">700 Monoid-false = Monoid record with (Carrier to &#120121;; Id to false) </span><span style="color: #93a1a1;">-}</span>

<span style="color: #859900; font-weight: bold;">record</span><span style="color: #b58900; font-style: italic;"> Monoid-false</span> : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
  <span style="color: #859900; font-weight: bold;">field</span>
    <span style="color: #b58900; font-style: italic;">_&#10814;_</span>     : &#120121; &#8594; &#120121; &#8594; &#120121;
    <span style="color: #b58900; font-style: italic;">assoc</span>   : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #0000cd;">leftfalse</span>  : &#8704; {<span style="color: #0000cd;">x</span> : &#120121;} &#8594; <span style="color: #0000cd;">false</span> &#10814; <span style="color: #0000cd;">x</span> &#8801; <span style="color: #0000cd;">x</span>
    <span style="color: #0000cd;">rightfalse</span> : &#8704; {<span style="color: #0000cd;">x</span> : &#120121;} &#8594; <span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">false</span> &#8801; <span style="color: #0000cd;">x</span>

<span style="color: #0000cd;">second-problem-better</span> :<span style="color: #b58900; font-style: italic;"> (X Y</span> :<span style="color: #b58900; font-style: italic;"> Monoid-false</span>) &#8594; <span style="color: #859900; font-weight: bold;">Set</span>
<span style="color: #0000cd;">second-problem-better</span> <span style="color: #859900; font-weight: bold;">=</span> ???
</pre>
</div>

<p>
The full source of this discussion is as follows.
</p>
<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> CaseStudy.agda </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">(load-file "PackageFormer.el") </span><span style="color: #93a1a1;">-}</span>

<span style="color: #859900; font-weight: bold;">module</span> <span style="color: #a020f0;">CaseStudy</span> <span style="color: #859900; font-weight: bold;">where</span>
<span style="color: #859900; font-weight: bold;">open</span> <span style="color: #859900; font-weight: bold;">import</span> <span style="color: #a020f0;">CaseStudy_Generated</span>
<span style="color: #859900; font-weight: bold;">open</span> <span style="color: #859900; font-weight: bold;">import</span> <span style="color: #a020f0;">Level</span>
<span style="color: #859900; font-weight: bold;">open</span> <span style="color: #859900; font-weight: bold;">import</span> <span style="color: #a020f0;">Data.Bool</span> <span style="color: #859900; font-weight: bold;">renaming</span><span style="color: #b58900; font-style: italic;"> (Bool</span> <span style="color: #0000cd;">to</span> &#120121;)
<span style="color: #859900; font-weight: bold;">open</span> <span style="color: #859900; font-weight: bold;">import</span> <span style="color: #a020f0;">Relation.Binary.PropositionalEquality</span> <span style="color: #859900; font-weight: bold;">using</span> (_&#8801;_)

<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">To make the exposition easier to read.</span>
<span style="color: #96A7A9; font-style: italic;">   The &#8216;???&#8217; is whatever the user whishes to</span>
<span style="color: #96A7A9; font-style: italic;">   accomplish in the task at hand; i.e., it's a hole.</span>
<span style="color: #93a1a1;">-}</span>
<span style="color: #859900; font-weight: bold;">postulate</span> ??? : &#8704; {&#8467;} {A : <span style="color: #859900; font-weight: bold;">Set</span> &#8467;} &#8594;<span style="color: #b58900; font-style: italic;"> A</span>

<span style="color: #93a1a1;">{-</span><span style="color: #96A7A9; font-style: italic;">700</span>
<span style="color: #96A7A9; font-style: italic;">variable</span>
<span style="color: #96A7A9; font-style: italic;">   &#8467; : Level</span>

<span style="color: #96A7A9; font-style: italic;">PackageFormer Monoid (v : Variation) : Set where</span>
<span style="color: #96A7A9; font-style: italic;">    _&#10814;_     : Monoid v &#8594; Monoid v &#8594; Monoid v</span>
<span style="color: #96A7A9; font-style: italic;">    Id      : Monoid v</span>
<span style="color: #96A7A9; font-style: italic;">    assoc   : &#8704; {x y z} &#8594; (x &#10814; y) &#10814; z &#8801; x &#10814; (y &#10814; z)</span>
<span style="color: #96A7A9; font-style: italic;">    leftId  : &#8704; {x : Monoid v} &#8594; Id &#10814; x &#8801; x</span>
<span style="color: #96A7A9; font-style: italic;">    rightId : &#8704; {x : Monoid v} &#8594; x &#10814; Id &#8801; x</span>

<span style="color: #96A7A9; font-style: italic;">Classical = Monoid typeclass</span>
<span style="color: #96A7A9; font-style: italic;">MonoidOp = Monoid record unbundling 2</span>
<span style="color: #96A7A9; font-style: italic;">MonoidId = Monoid record exposing (Carrier; Id)</span>
<span style="color: #96A7A9; font-style: italic;">Monoid-false = Monoid record with (Carrier to &#120121;; Id to false)</span>

<span style="color: #96A7A9; font-style: italic;">Monoid-m = Monoid typeclass renaming (Carrier to m)</span>
<span style="color: #93a1a1;">-}</span>

<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">M-. on these to see their elaborated forms. </span><span style="color: #93a1a1;">-}</span>
_ <span style="color: #859900; font-weight: bold;">=</span><span style="color: #b58900; font-style: italic;"> Classical</span>
_ <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #b58900; font-style: italic;">MonoidOp</span>
_ <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #b58900; font-style: italic;">MonoidId</span>

<span style="color: #859900; font-weight: bold;">open</span><span style="color: #b58900; font-style: italic;"> Classical</span> <span style="color: #859900; font-weight: bold;">using</span> () <span style="color: #859900; font-weight: bold;">renaming</span> (<span style="color: #b58900; font-style: italic;">_&#10814;_</span> <span style="color: #0000cd;">to</span><span style="color: #b58900; font-style: italic;"> Op</span>)

<span style="color: #0000cd;">yuck-one</span> :   <span style="color: #b58900; font-style: italic;"> (X Y</span> :<span style="color: #b58900; font-style: italic;"> Classical</span> &#120121;)
         &#8594; <span style="color: #b58900; font-style: italic;"> Op X</span>  &#8801; _&#8743;_
         &#8594; <span style="color: #b58900; font-style: italic;"> Op Y</span>  &#8801; _&#8744;_
         &#8594;  <span style="color: #859900; font-weight: bold;">Set</span>
<span style="color: #0000cd;">yuck-one</span> <span style="color: #859900; font-weight: bold;">=</span> ???

<span style="color: #0000cd;">first-problem</span> :<span style="color: #b58900; font-style: italic;"> MonoidOp</span> &#120121; _&#8743;_  &#8594; <span style="color: #b58900; font-style: italic;"> MonoidOp</span> &#120121; _&#8744;_  &#8594; <span style="color: #859900; font-weight: bold;">Set</span>
<span style="color: #0000cd;">first-problem</span> <span style="color: #859900; font-weight: bold;">=</span> ???

<span style="color: #0000cd;">second-problem-okay</span> :<span style="color: #b58900; font-style: italic;"> (X Y</span> :<span style="color: #b58900; font-style: italic;"> MonoidId</span> &#120121; <span style="color: #0000cd;">false</span>) &#8594; <span style="color: #859900; font-weight: bold;">Set</span>
<span style="color: #0000cd;">second-problem-okay</span> <span style="color: #859900; font-weight: bold;">=</span> ???

<span style="color: #0000cd;">second-problem-better</span> :<span style="color: #b58900; font-style: italic;"> (X Y</span> :<span style="color: #b58900; font-style: italic;"> Monoid-false</span>) &#8594; <span style="color: #859900; font-weight: bold;">Set</span>
<span style="color: #0000cd;">second-problem-better</span> <span style="color: #859900; font-weight: bold;">=</span> ???
</pre>
</div>
</details>
</div>
</div>
</div>

<div id="outline-container-orgff0c48f" class="outline-2">
<h2 id="orgff0c48f"><span class="section-number-2">3</span> Strings and Things</h2>
<div class="outline-text-2" id="text-3">
<p>
Since our prototype is intended to be as minimally obtrusive as possible, we will
need to extract our special 700-syntactical items between delimited tokens
and process them.
</p>

<p>
The following subsections introduce:
</p>
<dl class="org-dl">
<dt><code>get-children</code></dt><dd>Obtaining intended items from a hierarchical listing.</dd>
<dt><code>sub-string-delimited-$</code></dt><dd>Finding the shortest substring between a prefix
<code>𝑳</code> and a postfix <code>𝑹</code> by using the ‘metavariable’ <code>$here</code>; e.g., <code>“𝑳 $here 𝑹”.</code></dd>
<dt><code>buffer-substring-delimited-whole-buffer</code></dt><dd>Yield all portions of the
buffer enclosed in the given delimiters, as a list of strings.</dd>
<dt><code>extract-imports</code></dt><dd>Obtain all ‘import’ clauses so that they can be
ported over to the generated file.</dd>
<dt><code>itify</code></dt><dd><p>
A macro that generates macros!
</p>

<p>
A common pattern I've observed is code of the form
<code>(f (lambda (x) body-with-x) arg)</code> &#x2014;i.e., there is a useful
function <code>f</code> that is invoked with two arguments; the first being a
function. The declaration <code>(itify f</code>) will produce a macro named <code>f-it</code>
that takes two arguments where the first is an expression involving
a free variable <code>it</code> such that
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>(f-it expr-with-it more)  ≈  (f (λ (it) expr-with-it) more)</code></td>
</tr>
</tbody>
</table>

<p>
We then test this out on the utility <code>rename-mixfix</code>.
</p>
<dl class="org-dl">
<dt><code>rename-mixfix</code></dt><dd>Ignore outermost Agda argument markers ‘_’
when renaming an mixfix argument;
e.g., <code>_[_⊗_]  ↦  _₀[_⊗_]¹</code> where this particular renaming
is a prefix subscript 0 and postfix 1.</dd>
</dl></dd>
</dl>

<p>
First some useful libraries:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">String and list manipulation libraries</span>
<span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">https://github.com/magnars/dash.el</span>
<span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">https://github.com/magnars/s.el</span>
<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #6c71c4; font-weight: bold;">s</span><span style="color: #268bd2;">)</span>               <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8220;The long lost Emacs string manipulation library&#8221;</span>
<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #6c71c4; font-weight: bold;">dash</span><span style="color: #268bd2;">)</span>            <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8220;A modern list library for Emacs&#8221;</span>
<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #6c71c4; font-weight: bold;">dash-functional</span><span style="color: #268bd2;">)</span> <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8220;Function combinators&#8221;</span>
</pre>
</div>
</div>

<div id="outline-container-org02e8a1c" class="outline-3">
<h3 id="org02e8a1c"><span class="section-number-3">3.1</span> Finding Children in the Wild</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Being a prototype, we are talking a mostly string-based approach to working
with hierarchical phrases.
For example, consider the following todo list,
</p>
<div class="org-src-container">
<pre class="src src-org" id="org4393ffa">+ item 1
  - subitem 1.1
    * subsubitem 1.1.1
  - subitem 1.2
+ item 2
  - subitem 2.2
+ item 3
</pre>
</div>

<ul class="org-ul">
<li>item 1
<ul class="org-ul">
<li>subitem 1.1
<ul class="org-ul">
<li>subsubitem 1.1.1</li>
</ul></li>
<li>subitem 1.2</li>
</ul></li>
<li>item 2
<ul class="org-ul">
<li>subitem 2.2</li>
</ul></li>
<li>item 3</li>
</ul>

<p>
We would think that <code>item 1</code> has two ‘children’, and, moreover, one grand-child.
Whereas <code>item 2</code> has a single child and <code>item 3</code> is barren.
</p>

<p>
Here's my intuitive algorithm: We obtain the indentation of the first child,
then all subsequent lines with at least that much indentation have the same ancestor.
</p>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> get-indentation Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">get-indentation</span> <span style="color: #d33682;">(</span>string<span style="color: #d33682;">)</span>
  <span style="color: #35a69c;">"How many spaces are there at the front of &#8216;</span><span style="color: #6c71c4; font-weight: bold;">string</span><span style="color: #35a69c;">&#8217;?</span>

<span style="color: #35a69c;">  Property: The resulting number is &#8216;&#8804; length string&#8217;.</span>
<span style="color: #35a69c;">  "</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">if</span> string <span style="color: #859900;">(</span>length <span style="color: #cb4b16;">(</span>s-shared-start string <span style="color: #6c71c4;">(</span>s-repeat <span style="color: #b58900;">(</span>length string<span style="color: #b58900;">)</span> <span style="color: #2aa198;">" "</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span> 0<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> get-children Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">get-children</span> <span style="color: #d33682;">(</span>parent the-wild <span style="color: #b58900; font-style: italic;">&amp;key</span> <span style="color: #859900;">(</span>then #'identity<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
  <span style="color: #35a69c;">"Go into &#8216;</span><span style="color: #6c71c4; font-weight: bold;">the-wild</span><span style="color: #35a69c;">&#8217; seeking out the first occurence of &#8216;</span><span style="color: #6c71c4; font-weight: bold;">parent</span><span style="color: #35a69c;">&#8217;,</span>
<span style="color: #35a69c;">   who once found, ought to have a minimal indentation for its children.</span>

<span style="color: #35a69c;">   &#8220;Minimal&#8221; in that if there are items with a greater indentation,</span>
<span style="color: #35a69c;">    then they are children of children and should be kept.</span>

<span style="color: #35a69c;">   The first input argument is of type &#8216;</span><span style="color: #6c71c4; font-weight: bold;">string</span><span style="color: #35a69c;">&#8217;,</span>
<span style="color: #35a69c;">   the second argument may be of type &#8216;</span><span style="color: #6c71c4; font-weight: bold;">string</span><span style="color: #35a69c;">&#8217; or &#8216;</span><span style="color: #6c71c4; font-weight: bold;">list</span><span style="color: #35a69c;">&#8217; of strings</span>
<span style="color: #35a69c;">   ---if it's a string, we split along new lines---,</span>
<span style="color: #35a69c;">   the optional &#8216;</span><span style="color: #6c71c4; font-weight: bold;">then</span><span style="color: #35a69c;">&#8217; is a function acting on children strings.</span>

<span style="color: #35a69c;">   Result is the parent followed by its children, as a list of lines,</span>
<span style="color: #35a69c;">   where each child has been altered using the optional &#8216;</span><span style="color: #6c71c4; font-weight: bold;">then</span><span style="color: #35a69c;">&#8217; function.</span>
<span style="color: #35a69c;">   Moreover, we also return the rest of the unconsidered portion of &#8216;</span><span style="color: #6c71c4; font-weight: bold;">the-wild</span><span style="color: #35a69c;">&#8217;:</span>

<span style="color: #35a69c;">   Result list: (  unconsidered-prefix-of-the-wild</span>
<span style="color: #35a69c;">                   (cons parent-line children-lines)</span>
<span style="color: #35a69c;">                   unconsidered-remaining-lines )</span>

<span style="color: #35a69c;">   The first element is the porition that does not contain an occurence</span>
<span style="color: #35a69c;">   of &#8216;</span><span style="color: #6c71c4; font-weight: bold;">parent</span><span style="color: #35a69c;">&#8217;. The second is the parent and its children, if possible.</span>
<span style="color: #35a69c;">   The third is the remainder of the wild.</span>

<span style="color: #35a69c;">   Implementation: Look at the indentation of the</span>
<span style="color: #35a69c;">   first child, then use that as a lower bound to find the indentation</span>
<span style="color: #35a69c;">   of the remaining children.</span>
<span style="color: #35a69c;">  "</span>

  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #859900;">(</span><span style="color: #cb4b16;">(</span>lines <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>stringp the-wild<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>s-lines the-wild<span style="color: #b58900;">)</span> the-wild<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
        <span style="color: #cb4b16;">(</span>indentation -1<span style="color: #cb4b16;">)</span>
        prefix
        parent-line<span style="color: #859900;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Ensure: lines &#8776; (cons (not-here-prefix) (cons parent-here more-lines) )</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> lines <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">--split-with</span> <span style="color: #6c71c4;">(</span>not <span style="color: #b58900;">(</span>s-contains? parent it<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span> lines<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Discard prefix, for now.</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> prefix <span style="color: #cb4b16;">(</span>car lines<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> lines <span style="color: #cb4b16;">(</span>cadr lines<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Discard parent, but remember its contextual line.</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> parent-line <span style="color: #cb4b16;">(</span>car lines<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> lines <span style="color: #cb4b16;">(</span>cdr lines<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">How far is the first child indented?</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> indentation <span style="color: #cb4b16;">(</span>get-indentation <span style="color: #6c71c4;">(</span>car lines<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Keep only the children that have at least this level of indentation.</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> lines&amp;more <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">--split-with</span> <span style="color: #6c71c4;">(</span>&lt;= indentation <span style="color: #b58900;">(</span>get-indentation it<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span> lines<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> lines <span style="color: #cb4b16;">(</span>car lines&amp;more<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> unconsidered <span style="color: #cb4b16;">(</span>cadr lines&amp;more<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Alter the children according to the given function.</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> lines <span style="color: #cb4b16;">(</span>mapcar then lines<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Yield the parent line along with the children lines; and the unconsumed wild's prefix and suffix.</span>
    `<span style="color: #859900;">(</span>,prefix ,<span style="color: #cb4b16;">(</span>cons parent-line lines<span style="color: #cb4b16;">)</span> ,unconsidered<span style="color: #859900;">)</span>
  <span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>
</pre>
</div>
</details>

<p>
Let's try this out on our example hierarchy, <code>eh</code>, from earlier.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span>cadr <span style="color: #d33682;">(</span>get-children <span style="color: #2aa198;">"+ item 1"</span> eh<span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">+ item 1</td>
<td class="org-left">- subitem 1.1</td>
<td class="org-left">* subsubitem 1.1.1</td>
<td class="org-left">- subitem 1.2</td>
</tr>
</tbody>
</table>

<p>
Excellent! Let's looks at the other parents.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span>get-children <span style="color: #2aa198;">"+ item 2"</span> eh<span style="color: #268bd2;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">+ item 1</td>
<td class="org-left">- subitem 1.1</td>
<td class="org-left">* subsubitem 1.1.1</td>
<td class="org-left">- subitem 1.2</td>
</tr>

<tr>
<td class="org-left">+ item 2</td>
<td class="org-left">- subitem 2.2</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">+ item 3</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
Notice that we found the parent <code>+ item 2</code> and its only child <code>- subitem 1.2</code>, and
we kept the prefix of <code>eh</code> that did not contain the parent as well as
the remaining unconsidered portion of <code>eh</code>. &#x2014;Moreover, it looks like we obtained
the transpose of the example hierarchy 😛
</p>

<p>
Finally, the barren parent.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span>get-children <span style="color: #2aa198;">"+ item 3"</span> eh<span style="color: #268bd2;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">+ item 1</td>
<td class="org-left">- subitem 1.1</td>
<td class="org-left">* subsubitem 1.1.1</td>
<td class="org-left">- subitem 1.2</td>
<td class="org-left">+ item 2</td>
<td class="org-left">- subitem 2.2</td>
</tr>

<tr>
<td class="org-left">+ item 3</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
Everything before it is considered the prefix. Yay :smile:
</p>

<p>
Before we move on, let's try altering a child clause; e.g., I'd like
<code>* subitem 1.1.1</code> to be renamed to <code>* subitem that is super deep</code>.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span>cadr <span style="color: #d33682;">(</span>get-children <span style="color: #2aa198;">"+ item 1"</span> eh
 <span style="color: #d33682; font-weight: bold; font-style: italic;">:then</span> <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #cb4b16;">(</span>x<span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>s-replace <span style="color: #2aa198;">"1.1.1"</span> <span style="color: #2aa198;">"that is super deep"</span> x<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">+ item 1</td>
<td class="org-left">- subitem 1.1</td>
<td class="org-left">* subsubitem that is super deep</td>
<td class="org-left">- subitem 1.2</td>
</tr>
</tbody>
</table>

<p>
Nice :grin:
</p>

<p>
Now the moment of truth, let's try this out on our example.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span>cadr <span style="color: #d33682;">(</span>get-children <span style="color: #2aa198;">"PackageFormer"</span> test<span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #859900; font-weight: bold;">|</span> <span style="color: #b58900; font-style: italic;">PackageFormer Semigroup</span> (<span style="color: #0000cd;">v</span> :<span style="color: #b58900; font-style: italic;"> Variation</span>) : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span> <span style="color: #859900; font-weight: bold;">|</span> <span style="color: #b58900; font-style: italic;">_&#10814;_</span> :<span style="color: #b58900; font-style: italic;"> Semigroup</span> <span style="color: #0000cd;">v</span> &#8594;<span style="color: #b58900; font-style: italic;"> Semigroup</span> <span style="color: #0000cd;">v</span> &#8594;<span style="color: #b58900; font-style: italic;"> Semigroup</span> <span style="color: #0000cd;">v</span> <span style="color: #859900; font-weight: bold;">|</span><span style="color: #b58900; font-style: italic;"> Id</span>  :<span style="color: #b58900; font-style: italic;"> Semigroup</span> <span style="color: #0000cd;">v</span> <span style="color: #859900; font-weight: bold;">|</span> <span style="color: #b58900; font-style: italic;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>) <span style="color: #859900; font-weight: bold;">|</span>
</pre>
</div>

<p>
Also, does the list variant work:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span>cadr <span style="color: #d33682;">(</span>get-children <span style="color: #2aa198;">"PackageFormer"</span> <span style="color: #859900;">(</span>s-lines test<span style="color: #859900;">)</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #859900; font-weight: bold;">|</span> <span style="color: #b58900; font-style: italic;">PackageFormer Semigroup</span> (<span style="color: #0000cd;">v</span> :<span style="color: #b58900; font-style: italic;"> Variation</span>) : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span> <span style="color: #859900; font-weight: bold;">|</span> <span style="color: #b58900; font-style: italic;">_&#10814;_</span> :<span style="color: #b58900; font-style: italic;"> Semigroup</span> <span style="color: #0000cd;">v</span> &#8594;<span style="color: #b58900; font-style: italic;"> Semigroup</span> <span style="color: #0000cd;">v</span> &#8594;<span style="color: #b58900; font-style: italic;"> Semigroup</span> <span style="color: #0000cd;">v</span> <span style="color: #859900; font-weight: bold;">|</span><span style="color: #b58900; font-style: italic;"> Id</span>  :<span style="color: #b58900; font-style: italic;"> Semigroup</span> <span style="color: #0000cd;">v</span> <span style="color: #859900; font-weight: bold;">|</span> <span style="color: #b58900; font-style: italic;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>) <span style="color: #859900; font-weight: bold;">|</span>
</pre>
</div>

<p>
Test-driven development doesn't seem bad 😲
</p>

<p>
These pretty-coloured tests and results may be nice for exposition,
however for maintenance it is ideal to include unit tests that can
be checked without human intervention. <code>M-x ert &lt;RET&gt; t &lt;RET&gt;</code>, after
executing the following block, will report which tests pass and tries to explain
why tests fail.
</p>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Tests </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">ert-deftest</span> <span style="color: #b58900;">get-ind</span> <span style="color: #d33682;">()</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">loop</span> for s in '<span style="color: #859900;">(</span>nil <span style="color: #2aa198;">""</span> <span style="color: #2aa198;">"x"</span> <span style="color: #2aa198;">"  x"</span> <span style="color: #2aa198;">"  x "</span><span style="color: #859900;">)</span>
    do <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>&lt;= <span style="color: #6c71c4;">(</span>get-indentation s<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>length s<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
  <span style="color: #268bd2;">)</span>

<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">ert-deftest</span> <span style="color: #b58900;">get-child</span> <span style="color: #d33682;">()</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">-let</span> <span style="color: #859900;">[</span>eh
<span style="color: #2aa198;">"+ item 1</span>
<span style="color: #2aa198;">  - subitem 1.1</span>
<span style="color: #2aa198;">    * subsubitem 1.1.1</span>
<span style="color: #2aa198;">  - subitem 1.2</span>
<span style="color: #2aa198;">+ item 2</span>
<span style="color: #2aa198;">  - subitem 2.2</span>
<span style="color: #2aa198;">+ item 3"</span><span style="color: #859900;">]</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Consider each line above as a parent, with &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">eh</span><span style="color: #96A7A9; font-style: italic;">&#8217; as the wild.</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">loop</span> for parent in <span style="color: #cb4b16;">(</span>s-split <span style="color: #2aa198;">"\n"</span> eh<span style="color: #cb4b16;">)</span> do
      <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #6c71c4;">(</span><span style="color: #b58900;">(</span>cs <span style="color: #35a69c;">(</span>get-children parent eh<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span>
             <span style="color: #b58900;">(</span>children <span style="color: #35a69c;">(</span>cdadr cs<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>

      <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Result is a list of lists: Each is either nil or a cons.</span>
      <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">loop</span> for r in cs do <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #35a69c;">(</span>listp r<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>

      <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">The parent line contains the parent.</span>
      <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #b58900;">(</span>equal parent <span style="color: #35a69c;">(</span>caadr cs<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>

      <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">The children all have the same indentation.</span>
      <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">loop</span> for c in children for d in children do <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #35a69c;">(</span>equal <span style="color: #6c71c4;">(</span>get-indentation c<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>get-indentation d<span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>

      <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Extensionality: Orginal input can be regained from resulting parts.</span>
      <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #b58900;">(</span>equal eh <span style="color: #35a69c;">(</span>s-trim <span style="color: #6c71c4;">(</span>s-join <span style="color: #2aa198;">"\n"</span> <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">--map</span> <span style="color: #268bd2;">(</span>s-join <span style="color: #2aa198;">"\n"</span> it<span style="color: #268bd2;">)</span> cs<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>
    <span style="color: #cb4b16;">)</span>
  <span style="color: #859900;">)</span>
<span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>
</details>
</div>
</div>

<div id="outline-container-orge6f0dfd" class="outline-3">
<h3 id="orge6f0dfd"><span class="section-number-3">3.2</span> Substrings Delimited by Tokens</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-center">
<p>
<i>How do we find a string delimited by two tokens?</i>
</p>
</div>

<p>
Before we can get to the real stuff, we need to produce a few low-level &#x2014;string manipulation&#x2014;
utilities, so that we can work with higher-level abstract datatypes.
</p>

<ul class="org-ul">
<li><code>substring-delimited</code>: Given <code>prefix</code> and <code>suffix</code>,
this operation takes a string of the form  <code>⋯‘prefix’⟪needle⟫‘suffix’⋯</code> and yields <code>needle</code>.</li>
<li><code>substring-delimited-$</code>: Given <code>"⟪prefix⟫ $here ⟪suffix⟫"</code>
this operation takes a string of the form  <code>⋯‘prefix’⟪needle⟫‘suffix’⋯</code> and yields <code>needle</code>.</li>
</ul>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> substring-delimited Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">substring-delimited</span>
    <span style="color: #d33682;">(</span>prefix suffix string <span style="color: #b58900; font-style: italic;">&amp;key</span> preserve-spaces longest-substring<span style="color: #d33682;">)</span>
  <span style="color: #35a69c;">"Assuming &#8216;</span><span style="color: #6c71c4; font-weight: bold;">string</span><span style="color: #35a69c;">&#8217; &#8776; &#8943;&#8216;</span><span style="color: #6c71c4; font-weight: bold;">prefix</span><span style="color: #35a69c;">&#8217;&#10218;needle&#10219;&#8216;</span><span style="color: #6c71c4; font-weight: bold;">suffix</span><span style="color: #35a69c;">&#8217;&#8943;, return the /first/ such needle</span>
<span style="color: #35a69c;">   by default, unless &#8216;</span><span style="color: #6c71c4; font-weight: bold;">longest-substring</span><span style="color: #35a69c;">&#8217; is true, in which case yield /longest/</span>
<span style="color: #35a69c;">   such needle.</span>

<span style="color: #35a69c;">  NOTE: Delimiters &#8216;</span><span style="color: #6c71c4; font-weight: bold;">prefix</span><span style="color: #35a69c;">&#8217; and &#8216;</span><span style="color: #6c71c4; font-weight: bold;">suffix</span><span style="color: #35a69c;">&#8217; may be empty.</span>

<span style="color: #35a69c;">  Unless &#8216;</span><span style="color: #6c71c4; font-weight: bold;">preserve-spaces</span><span style="color: #35a69c;">&#8217; is true, we convert all adjacent whitespace</span>
<span style="color: #35a69c;">  characters to a single space in the input &#8216;</span><span style="color: #6c71c4; font-weight: bold;">string</span><span style="color: #35a69c;">&#8217; and trim any surrounding</span>
<span style="color: #35a69c;">  whitespace from the resulting output needle string.</span>
<span style="color: #35a69c;">  "</span>

  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>not <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #6c71c4;">(</span>s-contains? prefix string<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>s-contains? suffix string<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span> string
  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">--&gt;</span> string
   <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">if</span> preserve-spaces it <span style="color: #6c71c4;">(</span>s-collapse-whitespace <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">or</span> it <span style="color: #2aa198;">""</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
   <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>s-blank? prefix<span style="color: #6c71c4;">)</span> it <span style="color: #6c71c4;">(</span>s-join prefix <span style="color: #b58900;">(</span>cdr <span style="color: #35a69c;">(</span>s-split prefix it<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span> <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Discard stuff before hand, join remaining possibly multiple parts seperated by prefix.</span>
   <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>s-blank? suffix<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>list it 'empty<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>s-split suffix it<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
   <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>&lt; 1 <span style="color: #b58900;">(</span>length it<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>-drop-last 1 it<span style="color: #6c71c4;">)</span> it<span style="color: #cb4b16;">)</span> <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Discard stuff after the final occurence of &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">suffix</span><span style="color: #96A7A9; font-style: italic;">&#8217;, if any. Indeed when suffix &#8776; prefix, there wont be any.</span>
   <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">if</span> longest-substring <span style="color: #6c71c4;">(</span>s-join suffix it<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>car it<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
   <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">if</span> preserve-spaces it <span style="color: #6c71c4;">(</span>s-trim it<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
  <span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">ert-deftest</span> <span style="color: #b58900;">subst-delimit</span> <span style="color: #d33682;">()</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">-let</span> <span style="color: #859900;">[</span>str <span style="color: #2aa198;">"&#120792; &#120793; &#120794; &#120795; &#120796; &#120797; &#120796; &#120798;"</span><span style="color: #859900;">]</span> <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Intentionally repeated &#8216;&#120796;&#8217;.</span>
    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Pattern for loop: (prefix postfix expected-needle :comment))</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">loop</span> for it in `<span style="color: #cb4b16;">(</span> <span style="color: #6c71c4;">(</span> <span style="color: #2aa198;">""</span> <span style="color: #2aa198;">""</span> ,str            <span style="color: #d33682; font-weight: bold; font-style: italic;">:Identity</span><span style="color: #6c71c4;">)</span>
                       <span style="color: #6c71c4;">(</span> <span style="color: #2aa198;">"&#120792;"</span> <span style="color: #2aa198;">"&#120798;"</span> <span style="color: #2aa198;">"&#120793; &#120794; &#120795; &#120796; &#120797; &#120796;"</span>  <span style="color: #d33682; font-weight: bold; font-style: italic;">:Boundaries</span><span style="color: #6c71c4;">)</span>
                       <span style="color: #6c71c4;">(</span> <span style="color: #2aa198;">""</span> <span style="color: #2aa198;">"&#120798;"</span> <span style="color: #2aa198;">"&#120792; &#120793; &#120794; &#120795; &#120796; &#120797; &#120796;"</span> <span style="color: #d33682; font-weight: bold; font-style: italic;">:NoLeft</span><span style="color: #6c71c4;">)</span>
                       <span style="color: #6c71c4;">(</span> <span style="color: #2aa198;">"&#120792;"</span> <span style="color: #2aa198;">""</span> <span style="color: #2aa198;">"&#120793; &#120794; &#120795; &#120796; &#120797; &#120796; &#120798;"</span> <span style="color: #d33682; font-weight: bold; font-style: italic;">:NoRight</span><span style="color: #6c71c4;">)</span>
                       <span style="color: #6c71c4;">(</span> <span style="color: #2aa198;">"&#120800;"</span> <span style="color: #2aa198;">""</span>  ,str          <span style="color: #d33682; font-weight: bold; font-style: italic;">:BogusL</span><span style="color: #6c71c4;">)</span>
                       <span style="color: #6c71c4;">(</span> <span style="color: #2aa198;">""</span> <span style="color: #2aa198;">"&#8734;"</span>  ,str          <span style="color: #d33682; font-weight: bold; font-style: italic;">:BogusR</span><span style="color: #6c71c4;">)</span>
                       <span style="color: #6c71c4;">(</span> <span style="color: #2aa198;">"&#120800;"</span> <span style="color: #2aa198;">"&#8734;"</span> ,str          <span style="color: #d33682; font-weight: bold; font-style: italic;">:BogusLR</span><span style="color: #6c71c4;">)</span>
                     <span style="color: #cb4b16;">)</span>
      do <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #6c71c4;">(</span>equal <span style="color: #b58900;">(</span>third it<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>substring-delimited <span style="color: #35a69c;">(</span>first it<span style="color: #35a69c;">)</span> <span style="color: #35a69c;">(</span>second it<span style="color: #35a69c;">)</span> str<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Longest substring</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #2aa198;">"&#120795;"</span> <span style="color: #6c71c4;">(</span>substring-delimited <span style="color: #2aa198;">"&#120794;"</span> <span style="color: #2aa198;">"&#120796;"</span> str<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #2aa198;">"&#120795; &#120796; &#120797;"</span> <span style="color: #6c71c4;">(</span>substring-delimited <span style="color: #2aa198;">"&#120794;"</span> <span style="color: #2aa198;">"&#120796;"</span> str <span style="color: #d33682; font-weight: bold; font-style: italic;">:longest-substring</span> t<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">We expect to see from &#120794; to the very final occurance of a &#120796;.</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Identical boundaries.</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #2aa198;">"&#120793;"</span> <span style="color: #6c71c4;">(</span>substring-delimited <span style="color: #2aa198;">"&#120792;"</span> <span style="color: #2aa198;">"&#120792;"</span> <span style="color: #2aa198;">"&#120792; &#120793; &#120792;"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #2aa198;">""</span>  <span style="color: #6c71c4;">(</span>substring-delimited <span style="color: #2aa198;">"&#120792;"</span> <span style="color: #2aa198;">"&#120792;"</span> <span style="color: #2aa198;">"&#120792; &#120792;"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #2aa198;">""</span>  <span style="color: #6c71c4;">(</span>substring-delimited <span style="color: #2aa198;">"&#120792;"</span> <span style="color: #2aa198;">"&#120792;"</span> <span style="color: #2aa198;">"&#120792;&#120792;"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Multiple occurances of prefix or postfix</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #2aa198;">"x &#119923; y"</span>  <span style="color: #6c71c4;">(</span>substring-delimited <span style="color: #2aa198;">"&#119923;"</span> <span style="color: #2aa198;">"&#119929;"</span> <span style="color: #2aa198;">"&#119923; x &#119923; y &#119929;"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #2aa198;">"x"</span>  <span style="color: #6c71c4;">(</span>substring-delimited <span style="color: #2aa198;">"&#119923;"</span> <span style="color: #2aa198;">"&#119929;"</span> <span style="color: #2aa198;">"&#119923; x &#119929; y &#119929;"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #2aa198;">"x &#119929; y"</span>  <span style="color: #6c71c4;">(</span>substring-delimited <span style="color: #2aa198;">"&#119923;"</span> <span style="color: #2aa198;">"&#119929;"</span> <span style="color: #2aa198;">"&#119923; x &#119929; y &#119929;"</span> <span style="color: #d33682; font-weight: bold; font-style: italic;">:longest-substring</span> t<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

    <span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> substring-delimited-$ Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">substring-delimited-$</span>
    <span style="color: #d33682;">(</span>context string <span style="color: #b58900; font-style: italic;">&amp;key</span> preserve-spaces longest-substring<span style="color: #d33682;">)</span>
  <span style="color: #35a69c;">"Assuming &#8216;</span><span style="color: #6c71c4; font-weight: bold;">context</span><span style="color: #35a69c;">&#8217; = &#8220;&#10218;prefix&#10219; $here &#10218;suffix&#10219;&#8221;</span>
<span style="color: #35a69c;">   and &#8216;</span><span style="color: #6c71c4; font-weight: bold;">string</span><span style="color: #35a69c;">&#8217; &#8776; &#8943;&#8216;</span><span style="color: #6c71c4; font-weight: bold;">prefix</span><span style="color: #35a69c;">&#8217;&#10218;needle&#10219;&#8216;</span><span style="color: #6c71c4; font-weight: bold;">suffix</span><span style="color: #35a69c;">&#8217;&#8943;, return the /first/ such needle</span>
<span style="color: #35a69c;">   by default, unless &#8216;</span><span style="color: #6c71c4; font-weight: bold;">longest-substring</span><span style="color: #35a69c;">&#8217; is true, in which case yield /longest/</span>
<span style="color: #35a69c;">   such needle.</span>

<span style="color: #35a69c;">  NOTE: &#10218;prefix&#10219; and &#10218;suffix&#10219; cannot be emptry strings!</span>

<span style="color: #35a69c;">  Unless &#8216;</span><span style="color: #6c71c4; font-weight: bold;">preserve-spaces</span><span style="color: #35a69c;">&#8217; is true, we convert all adjacent whitespace</span>
<span style="color: #35a69c;">  characters to a single space in the input &#8216;</span><span style="color: #6c71c4; font-weight: bold;">string</span><span style="color: #35a69c;">&#8217; and trim any surrounding</span>
<span style="color: #35a69c;">  whitespace from the resulting output needle string.</span>
<span style="color: #35a69c;">  "</span>

  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">-let</span> <span style="color: #859900;">[</span>pre-post <span style="color: #cb4b16;">(</span>s-split <span style="color: #2aa198;">"$here"</span> context<span style="color: #cb4b16;">)</span><span style="color: #859900;">]</span>
    <span style="color: #859900;">(</span>substring-delimited <span style="color: #cb4b16;">(</span>s-trim <span style="color: #6c71c4;">(</span>car pre-post<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>s-trim <span style="color: #6c71c4;">(</span>cadr pre-post<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span> string
     <span style="color: #d33682; font-weight: bold; font-style: italic;">:preserve-spaces</span> preserve-spaces <span style="color: #d33682; font-weight: bold; font-style: italic;">:longest-substring</span> longest-substring<span style="color: #859900;">)</span>
  <span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>

<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">ert-deftest</span> <span style="color: #b58900;">subst-delimit-$</span> <span style="color: #d33682;">()</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">-let</span> <span style="color: #859900;">[</span>str <span style="color: #2aa198;">"&#120792; &#120793; &#120794; &#120795; &#120796; &#120797; &#120796; &#120798;"</span><span style="color: #859900;">]</span> <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Intentionally repeated &#8216;&#120796;&#8217;.</span>
    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Pattern for loop: (prefix postfix expected-needle :comment)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">loop</span> for it in `<span style="color: #cb4b16;">(</span> <span style="color: #6c71c4;">(</span> <span style="color: #2aa198;">"$here"</span> ,str              <span style="color: #d33682; font-weight: bold; font-style: italic;">:Identity</span><span style="color: #6c71c4;">)</span>
                       <span style="color: #6c71c4;">(</span> <span style="color: #2aa198;">"&#120792; $here &#120798;"</span> <span style="color: #2aa198;">"&#120793; &#120794; &#120795; &#120796; &#120797; &#120796;"</span>  <span style="color: #d33682; font-weight: bold; font-style: italic;">:Boundaries</span><span style="color: #6c71c4;">)</span>
                       <span style="color: #6c71c4;">(</span> <span style="color: #2aa198;">"$here &#120798;"</span> <span style="color: #2aa198;">"&#120792; &#120793; &#120794; &#120795; &#120796; &#120797; &#120796;"</span>  <span style="color: #d33682; font-weight: bold; font-style: italic;">:NoLeft</span><span style="color: #6c71c4;">)</span>
                       <span style="color: #6c71c4;">(</span> <span style="color: #2aa198;">"&#120792; $here"</span>  <span style="color: #2aa198;">"&#120793; &#120794; &#120795; &#120796; &#120797; &#120796; &#120798;"</span> <span style="color: #d33682; font-weight: bold; font-style: italic;">:NoRight</span><span style="color: #6c71c4;">)</span>
                       <span style="color: #6c71c4;">(</span> <span style="color: #2aa198;">"&#120800; $here"</span>   ,str          <span style="color: #d33682; font-weight: bold; font-style: italic;">:BogusL</span><span style="color: #6c71c4;">)</span>
                       <span style="color: #6c71c4;">(</span> <span style="color: #2aa198;">"$here &#8734;"</span>   ,str          <span style="color: #d33682; font-weight: bold; font-style: italic;">:BogusR</span><span style="color: #6c71c4;">)</span>
                       <span style="color: #6c71c4;">(</span> <span style="color: #2aa198;">"&#120800; $here &#8734;"</span> ,str          <span style="color: #d33682; font-weight: bold; font-style: italic;">:BogusLR</span><span style="color: #6c71c4;">)</span>
                     <span style="color: #cb4b16;">)</span>
      do <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #6c71c4;">(</span>equal <span style="color: #b58900;">(</span>second it<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>substring-delimited-$ <span style="color: #35a69c;">(</span>first it<span style="color: #35a69c;">)</span> str<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Longest substring</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #2aa198;">"&#120795;"</span> <span style="color: #6c71c4;">(</span>substring-delimited-$ <span style="color: #2aa198;">"&#120794; $here &#120796;"</span> str<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #2aa198;">"&#120795; &#120796; &#120797;"</span> <span style="color: #6c71c4;">(</span>substring-delimited-$ <span style="color: #2aa198;">"&#120794; $here &#120796;"</span> str <span style="color: #d33682; font-weight: bold; font-style: italic;">:longest-substring</span> t<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">We expect to see from &#120794; to the very final occurance of a &#120796;.</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Identical boundaries.</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #2aa198;">"&#120793;"</span> <span style="color: #6c71c4;">(</span>substring-delimited-$ <span style="color: #2aa198;">"&#120792; $here &#120792;"</span> <span style="color: #2aa198;">"&#120792; &#120793; &#120792;"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #2aa198;">""</span>  <span style="color: #6c71c4;">(</span>substring-delimited-$ <span style="color: #2aa198;">"&#120792; $here &#120792;"</span> <span style="color: #2aa198;">"&#120792; &#120792;"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #2aa198;">""</span>  <span style="color: #6c71c4;">(</span>substring-delimited-$ <span style="color: #2aa198;">"&#120792; $here &#120792;"</span> <span style="color: #2aa198;">"&#120792;&#120792;"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Multiple occurances of prefix or postfix</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #2aa198;">"x &#119923; y"</span>  <span style="color: #6c71c4;">(</span>substring-delimited-$ <span style="color: #2aa198;">"&#119923; $here &#119929;"</span> <span style="color: #2aa198;">"&#119923; x &#119923; y &#119929;"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #2aa198;">"x"</span>  <span style="color: #6c71c4;">(</span>substring-delimited-$ <span style="color: #2aa198;">"&#119923; $here &#119929;"</span> <span style="color: #2aa198;">"&#119923; x &#119929; y &#119929;"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #2aa198;">"x &#119929; y"</span>  <span style="color: #6c71c4;">(</span>substring-delimited-$ <span style="color: #2aa198;">"&#119923; $here &#119929;"</span> <span style="color: #2aa198;">"&#119923; x &#119929; y &#119929;"</span> <span style="color: #d33682; font-weight: bold; font-style: italic;">:longest-substring</span> t<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Space irrelevance for keyword &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">$here</span><span style="color: #96A7A9; font-style: italic;">&#8217;:</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #2aa198;">"&#120793;"</span> <span style="color: #6c71c4;">(</span>substring-delimited-$ <span style="color: #2aa198;">"&#119923; $here &#119929;"</span> <span style="color: #2aa198;">"&#119923; &#120793; &#119929;"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #2aa198;">"&#120793;"</span> <span style="color: #6c71c4;">(</span>substring-delimited-$ <span style="color: #2aa198;">"&#119923; $here&#119929;"</span> <span style="color: #2aa198;">"&#119923; &#120793; &#119929;"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #2aa198;">"&#120793;"</span> <span style="color: #6c71c4;">(</span>substring-delimited-$ <span style="color: #2aa198;">"&#119923;$here &#119929;"</span> <span style="color: #2aa198;">"&#119923; &#120793; &#119929;"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #2aa198;">"&#120793;"</span> <span style="color: #6c71c4;">(</span>substring-delimited-$ <span style="color: #2aa198;">"&#119923;$here&#119929;"</span> <span style="color: #2aa198;">"&#119923; &#120793; &#119929;"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #2aa198;">"&#120793;"</span> <span style="color: #6c71c4;">(</span>substring-delimited-$ <span style="color: #2aa198;">"&#119923;      $here  &#119929;"</span> <span style="color: #2aa198;">"&#119923; &#120793; &#119929;"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>
</details>

<p>
Suppose a user provides us with an awkwardly spaced PackageFormer header,
our string manipulation setup is robust enough to get at the constituents:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">-let</span> <span style="color: #d33682;">[</span>header <span style="color: #2aa198;">"PackageFormer  Semigroup   (  v : Variation) : Set (  &#8467;expr)   where"</span><span style="color: #d33682;">]</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Three kinds of invocations; the last is my preferred choice &#9829;&#8255;&#9829;</span>
  `<span style="color: #d33682;">(</span> ,<span style="color: #859900;">(</span>substring-delimited <span style="color: #2aa198;">"PackageFormer "</span> <span style="color: #2aa198;">"("</span> header <span style="color: #d33682; font-weight: bold; font-style: italic;">:preserve-spaces</span> t <span style="color: #d33682; font-weight: bold; font-style: italic;">:longest-substring</span> t<span style="color: #859900;">)</span>
     ,<span style="color: #859900;">(</span>substring-delimited <span style="color: #2aa198;">"PackageFormer "</span> <span style="color: #2aa198;">"("</span> header<span style="color: #859900;">)</span>
     ,<span style="color: #859900;">(</span>substring-delimited-$ <span style="color: #2aa198;">"PackageFormer $here ("</span> header<span style="color: #859900;">)</span>
   <span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Semigroup   (  v : Variation) : Set</td>
<td class="org-left">Semigroup</td>
<td class="org-left">Semigroup</td>
</tr>
</tbody>
</table>

<p>
The aim is to eventually have an interface that interacts with an buffer containing Agda code.
To that end, we propose that our fictitious syntax be directly embedded via special comments,
<code>{-700 ⋯ -}</code>, henceforth referred to as “<a id="org7d7e11a">700-comments</a>”.
</p>

<ul class="org-ul">
<li><code>(buffer-substring-delimited starting-regexp ending-regexp)</code> yields the <i>next</i> portion of the buffer
as a string, relative to the current position of the cursor, that is contained in the ‘parenthesis’
<code>starting-regexp</code> and <code>ending-regexp</code>.</li>

<li><code>(buffer-substring-delimited-whole-buffer starting-regexp ending-regexp)</code> yields <i>all</i> portions of the buffer,
contained in the ‘parenthesis’ <code>starting-regexp</code> and <code>ending-regexp</code>, as a list of strings.

<ul class="org-ul">
<li>Cursor position is saved.</li>
<li>This function let's us obtain the contents of <i>all</i> <a href="#org7d7e11a">700-comments</a>.</li>
</ul></li>
</ul>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> buffer-substring-delimited Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">buffer-substring-delimited</span> <span style="color: #d33682;">(</span>start end <span style="color: #b58900; font-style: italic;">&amp;optional</span> <span style="color: #859900;">(</span>highlight nil<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
  <span style="color: #35a69c;">"</span>
<span style="color: #35a69c;">  Get the current buffer's /next/ available substring that is delimited</span>
<span style="color: #35a69c;">  between the regexp tokens &#8216;</span><span style="color: #6c71c4; font-weight: bold;">start</span><span style="color: #35a69c;">&#8217; up to &#8216;</span><span style="color: #6c71c4; font-weight: bold;">end</span><span style="color: #35a69c;">&#8217;, exclusively.</span>

<span style="color: #35a69c;">  If no tokens are found, an error is thrown.</span>

<span style="color: #35a69c;">  The &#8216;</span><span style="color: #6c71c4; font-weight: bold;">highlight</span><span style="color: #35a69c;">&#8217; option simply highlights the selected region ---visual feedback</span>
<span style="color: #35a69c;">  for the user.</span>
<span style="color: #35a69c;">  "</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #859900;">(</span>p1 p2<span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span>re-search-forward start<span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> p1 <span style="color: #cb4b16;">(</span>point<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

    <span style="color: #859900;">(</span>re-search-forward end<span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span>backward-word<span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> p2 <span style="color: #cb4b16;">(</span>point<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">when</span> highlight <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">do we want to highlight the region?</span>
      <span style="color: #cb4b16;">(</span>goto-char p1<span style="color: #cb4b16;">)</span>
      <span style="color: #cb4b16;">(</span>push-mark p2<span style="color: #cb4b16;">)</span>
      <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> mark-active t<span style="color: #cb4b16;">)</span>
    <span style="color: #859900;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">(copy-region-as-kill p1 p2)</span>
    <span style="color: #859900;">(</span>buffer-substring-no-properties p1 p2<span style="color: #859900;">)</span>
<span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> buffer-substring-delimited-whole-buffer Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">buffer-substring-delimited-whole-buffer</span> <span style="color: #d33682;">(</span>start end<span style="color: #d33682;">)</span>
  <span style="color: #35a69c;">"Return a list of all substrings in the current buffer that</span>
<span style="color: #35a69c;">   are delimited by regexp tokens &#8216;</span><span style="color: #6c71c4; font-weight: bold;">start</span><span style="color: #35a69c;">&#8217; and &#8216;</span><span style="color: #6c71c4; font-weight: bold;">end</span><span style="color: #35a69c;">&#8217;, exclusively.</span>
<span style="color: #35a69c;">  "</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">save-excursion</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #cb4b16;">(</span><span style="color: #6c71c4;">(</span>l nil<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>continue t<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
     <span style="color: #cb4b16;">(</span>beginning-of-buffer<span style="color: #cb4b16;">)</span>

     <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">while</span> continue
       <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">condition-case</span> nil
         <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">attemptClause</span>
         <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> l <span style="color: #35a69c;">(</span>cons <span style="color: #6c71c4;">(</span>buffer-substring-delimited start end<span style="color: #6c71c4;">)</span> l<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span>
         <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">recoveryBody</span>
         <span style="color: #b58900;">(</span><span style="color: #b58900; font-weight: bold;">error</span> <span style="color: #35a69c;">(</span><span style="color: #859900; font-weight: bold;">setq</span> continue nil<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>

     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">We've collected items as we saw them, so &#8216;l&#8217; is in reverse.</span>
    <span style="color: #cb4b16;">(</span>reverse l<span style="color: #cb4b16;">)</span>
    <span style="color: #859900;">)</span>
  <span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>
</pre>
</div>
</details>

<p>
Here are some possible invocations, the last one being our use case.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Get text delimited by quotes</span>
<span style="color: #268bd2;">(</span>buffer-substring-delimited <span style="color: #2aa198;">"^\""</span> <span style="color: #2aa198;">"^\""</span><span style="color: #268bd2;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Get text delimited by usual Agda comments</span>
<span style="color: #268bd2;">(</span>buffer-substring-delimited <span style="color: #2aa198;">"^</span><span style="color: #b58900; font-weight: bold;">\</span><span style="color: #2aa198;">{-"</span> <span style="color: #2aa198;">"^-</span><span style="color: #b58900; font-weight: bold;">\</span><span style="color: #2aa198;">}"</span><span style="color: #268bd2;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Execute the following in an Agda buffer to see this function in action.</span>
<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">setq</span> it <span style="color: #d33682;">(</span>buffer-substring-delimited-whole-buffer <span style="color: #2aa198;">"^</span><span style="color: #b58900; font-weight: bold;">\</span><span style="color: #2aa198;">{-700"</span> <span style="color: #2aa198;">"^-</span><span style="color: #b58900; font-weight: bold;">\</span><span style="color: #2aa198;">}"</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>

<p>
We also want to prefix the generated file with the imports of the current file.
</p>
<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> extract-imports Implementation </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">extract-imports</span> <span style="color: #d33682;">()</span>
  <span style="color: #35a69c;">"Return substring of buffer whose lines mention &#8220;import&#8221;.</span>
<span style="color: #35a69c;">   Throw away any that mention the substring &#8220;&#10218;FileName&#10219;_Generated&#8221;.</span>
<span style="color: #35a69c;">  "</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">thread-last</span> <span style="color: #859900;">(</span>buffer-substring-no-properties <span style="color: #cb4b16;">(</span>point-min<span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>point-max<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span>s-split <span style="color: #2aa198;">"\n"</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">--filter</span> <span style="color: #cb4b16;">(</span>s-contains? <span style="color: #2aa198;">"import"</span> it<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">--remove</span> <span style="color: #cb4b16;">(</span>s-contains?
               <span style="color: #6c71c4;">(</span>format  <span style="color: #2aa198;">"%s_Generated"</span> <span style="color: #b58900;">(</span>file-name-sans-extension <span style="color: #35a69c;">(</span>buffer-name<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span> it<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span>s-join <span style="color: #2aa198;">"\n"</span><span style="color: #859900;">)</span>
  <span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>
</pre>
</div>
</details>

<p>
So much string meddling, hopefully no more 🙈 :hear<sub>no</sub><sub>evil</sub>: :speak<sub>no</sub><sub>evil</sub>:
</p>
</div>
</div>

<div id="outline-container-org58a9f0a" class="outline-3">
<h3 id="org58a9f0a"><span class="section-number-3">3.3</span> <code>Itify</code>: A macro that makes macros ♥‿♥</h3>
<div class="outline-text-3" id="text-3-3">
<p>
A common pattern I've observed is code of the form
<code>(f (lambda (x) body-with-x) arg)</code> &#x2014;i.e., there is a useful
function <code>f</code> that is invoked with two arguments; the first being a
function. The declaration <code>(itify f</code>) will produce a macro named <code>f-it</code>
that takes two arguments where the first is an expression involving
a free variable <code>it</code> such that
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>(f-it expr-with-it more)  ≈  (f (λ (it) expr-with-it) more)</code></td>
</tr>
</tbody>
</table>

<p>
I'm only considering binary functions, since they're my most common
case &#x2014;it's little trouble to move to the general case.
</p>

<p>
Let's consider the simplest binary operator whose first argument is
necessarily a function &#x2014;namely, function application.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">ap</span> <span style="color: #d33682;">(</span>f x<span style="color: #d33682;">)</span> <span style="color: #35a69c;">"bye"</span> <span style="color: #d33682;">(</span>funcall f x<span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>

<p>
Let's form the desired macro:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defmacro</span> <span style="color: #b58900;">ap-it</span> <span style="color: #d33682;">(</span>itbody more<span style="color: #d33682;">)</span>
  <span style="color: #d33682;">(</span>list 'ap <span style="color: #859900;">(</span>list 'lambda '<span style="color: #cb4b16;">(</span>it<span style="color: #cb4b16;">)</span> itbody<span style="color: #859900;">)</span> more<span style="color: #d33682;">)</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8776; `(ap (lambda (it) ,itbody) ,more)</span>
  <span style="color: #268bd2;">)</span>
</pre>
</div>

<p>
We have elected to present this with the <code>list</code> form
rather than the quasi-quote, since it's clear how to
yield the former as part of a macro <i>result</i>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defmacro</span> <span style="color: #b58900;">itify</span> <span style="color: #d33682;">(</span>fname<span style="color: #d33682;">)</span>
  <span style="color: #35a69c;">"</span>
<span style="color: #35a69c;">   From a function (h f x), obtain a macro (h-it (&#8943;it&#8943;) x) that rewrites into</span>
<span style="color: #35a69c;">   the orginal such that the first (functional) argument  may now be an expression</span>
<span style="color: #35a69c;">   with free variable &#8216;</span><span style="color: #6c71c4; font-weight: bold;">it</span><span style="color: #35a69c;">&#8217;. One declates (itify h) for a named top-level function &#8216;h&#8217;.</span>

<span style="color: #35a69c;">   NOTE: Since functions are of the form (cons 'macro-or-fun (function (lambda args body)))</span>
<span style="color: #35a69c;">   we can obtain the number of args by getting &#8216;</span><span style="color: #6c71c4; font-weight: bold;">args</span><span style="color: #35a69c;">&#8217; and taking its length.</span>
<span style="color: #35a69c;">   Then we can change any of its indices to take an expression rather than a function.</span>
<span style="color: #35a69c;">   Indeed, (macroexpand '(itify ap))</span>
<span style="color: #35a69c;">         &#8658; (defalias (quote ap-it) (cons (quote macro) (function (lambda (itbody more)</span>
<span style="color: #35a69c;">             (list (quote ap) (list (quote lambda) (quote (it)) itbody) more)))))      .</span>
<span style="color: #35a69c;">  "</span>

  `<span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">defmacro</span> ,<span style="color: #859900;">(</span>intern <span style="color: #cb4b16;">(</span>format <span style="color: #2aa198;">"%s-it"</span> <span style="color: #6c71c4;">(</span>symbol-name fname<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span> <span style="color: #859900;">(</span>itbody more<span style="color: #859900;">)</span>
       <span style="color: #859900;">(</span>list <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">quote</span> ,fname<span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>list 'lambda '<span style="color: #6c71c4;">(</span>it<span style="color: #6c71c4;">)</span> itbody<span style="color: #cb4b16;">)</span> more<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>
</pre>
</div>

<p>
Let's test this out.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">0. Too clunky</span>
<span style="color: #268bd2;">(</span>ap <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #859900;">(</span>it<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>+ 2 it<span style="color: #859900;">)</span><span style="color: #d33682;">)</span> 3<span style="color: #268bd2;">)</span> <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; 5</span>

<span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">1. Desired</span>
<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">itify</span> ap<span style="color: #268bd2;">)</span>
<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">ap-it</span> <span style="color: #d33682;">(</span>+ 2 it<span style="color: #d33682;">)</span> 3<span style="color: #268bd2;">)</span> <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">nice.</span>

<span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">2. Works with lambdas?</span>
<span style="color: #268bd2;">(</span><span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #859900;">(</span>e<span style="color: #859900;">)</span> <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">ap-it</span> <span style="color: #cb4b16;">(</span>+ 2 it<span style="color: #cb4b16;">)</span> e<span style="color: #859900;">)</span><span style="color: #d33682;">)</span> 2<span style="color: #268bd2;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">3. Scoping is fine?</span>
<span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Outermost &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">it</span><span style="color: #96A7A9; font-style: italic;">&#8217; belongs to --map; inner-most &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">it</span><span style="color: #96A7A9; font-style: italic;">&#8217; belongs to ap-it. (&#9472;&#8255;&#8255;&#9472;)</span>
<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">--map</span> <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">ap-it</span> <span style="color: #859900;">(</span>+ 2 it<span style="color: #859900;">)</span> it<span style="color: #d33682;">)</span> '<span style="color: #d33682;">(</span>1 2 3<span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span> <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; (3 4 5)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">4. Works well with read/eval?</span>
<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">ap-it</span> <span style="color: #d33682;">(</span>eval <span style="color: #859900;">(</span>car <span style="color: #cb4b16;">(</span>read-from-string <span style="color: #2aa198;">"(+ 2 it)"</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span> 3<span style="color: #268bd2;">)</span> <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; 5</span>
</pre>
</div>

<p>
A common use of the following will be when ‘threads’ are used for
sequential processing.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">itify</span> funcall<span style="color: #268bd2;">)</span>
</pre>
</div>

<p>
Now for a more useful and complex setting.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">rename-mixfix</span> <span style="color: #d33682;">(</span>f op<span style="color: #d33682;">)</span>
  <span style="color: #35a69c;">"Given an Agda mixfix operator, apply a function on strings &#8216;f&#8217; on</span>
<span style="color: #35a69c;">   the inner-most delimiting tokens of the operator, in-particular ignoring</span>
<span style="color: #35a69c;">   outer argument markers &#8216;_&#8217;.</span>

<span style="color: #35a69c;">   For example, if you wish to decorate an operator with a prime or a subscript,</span>
<span style="color: #35a69c;">   we cannot simply catenate else we obtain &#8220;_&#8853;_&#8321;&#8221; rather than &#8220;_&#8853;&#8321;_&#8221;.</span>

<span style="color: #35a69c;">   Here are some sample results, assuming &#8220;f &#8776; (&#955; (it) (format &#8220;&#8320;%s&#185;&#8221; it))&#8221;:</span>
<span style="color: #35a69c;">   _&#8853;_     &#8614;  _&#8320;&#8853;&#185;_</span>
<span style="color: #35a69c;">   _[_&#8855;_]  &#8614;  _&#8320;[_&#8855;_]&#185;</span>
<span style="color: #35a69c;">   he_lo   &#8614;  &#8320;he_lo&#185;</span>
<span style="color: #35a69c;">   he-lo   &#8614;  &#8320;he-lo&#185;</span>
<span style="color: #35a69c;">  "</span>

  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #859900;">(</span><span style="color: #cb4b16;">(</span>parts <span style="color: #6c71c4;">(</span>s-split <span style="color: #2aa198;">"_"</span> op<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>front <span style="color: #6c71c4;">(</span>s-blank? <span style="color: #b58900;">(</span>first parts<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>rear <span style="color: #6c71c4;">(</span>s-blank? <span style="color: #b58900;">(</span>car <span style="color: #35a69c;">(</span>last parts<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">--&gt;</span> <span style="color: #cb4b16;">(</span>concat <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">when</span> front <span style="color: #2aa198;">"_"</span><span style="color: #6c71c4;">)</span> <span style="color: #2aa198;">"$here"</span> <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">when</span> rear <span style="color: #2aa198;">"_"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
       <span style="color: #cb4b16;">(</span>substring-delimited-$ it op <span style="color: #d33682; font-weight: bold; font-style: italic;">:longest-substring</span> t<span style="color: #cb4b16;">)</span>
       <span style="color: #cb4b16;">(</span>funcall f it<span style="color: #cb4b16;">)</span>
       <span style="color: #cb4b16;">(</span>concat <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">when</span> front <span style="color: #2aa198;">"_"</span><span style="color: #6c71c4;">)</span> it <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">when</span> rear <span style="color: #2aa198;">"_"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
   <span style="color: #859900;">)</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Need this for &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">reify-instances</span><span style="color: #96A7A9; font-style: italic;">&#8217;.</span>
<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">itify</span> rename-mixfix<span style="color: #268bd2;">)</span>
</pre>
</div>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Unit Tests </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">ert-deftest</span> <span style="color: #b58900;">rename-mixfix</span> <span style="color: #d33682;">()</span>

  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal <span style="color: #cb4b16;">(</span>rename-mixfix #'identity <span style="color: #2aa198;">"_&#8853;_"</span><span style="color: #cb4b16;">)</span> <span style="color: #2aa198;">"_&#8853;_"</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal <span style="color: #2aa198;">"_&#8853;&#8242;_"</span> <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">rename-mixfix-it</span> <span style="color: #6c71c4;">(</span>eval <span style="color: #b58900;">(</span>car <span style="color: #35a69c;">(</span>read-from-string <span style="color: #2aa198;">"(concat it \"&#8242;\")"</span><span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span> <span style="color: #2aa198;">"_&#8853;_"</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span>  <span style="color: #859900;">(</span>equal <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">--map</span> <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">rename-mixfix-it</span> <span style="color: #b58900;">(</span>format <span style="color: #2aa198;">"&#8320;%s&#185;"</span> it<span style="color: #b58900;">)</span> it<span style="color: #6c71c4;">)</span> '<span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"_&#8853;_"</span> <span style="color: #2aa198;">"_[_&#8855;_]"</span> <span style="color: #2aa198;">"he_lo"</span> <span style="color: #2aa198;">"he-lo"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
       <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Outermost &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">it</span><span style="color: #96A7A9; font-style: italic;">&#8217; belongs to --map; inner-most &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">it</span><span style="color: #96A7A9; font-style: italic;">&#8217; belongs to rename-mixfix-it.</span>
  '<span style="color: #cb4b16;">(</span><span style="color: #2aa198;">"_&#8320;&#8853;&#185;_"</span> <span style="color: #2aa198;">"_&#8320;[_&#8855;_]&#185;"</span> <span style="color: #2aa198;">"&#8320;he_lo&#185;"</span> <span style="color: #2aa198;">"&#8320;he-lo&#185;"</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>
</details>
</div>
</div>
</div>

<div id="outline-container-org6596ae2" class="outline-2">
<h2 id="org6596ae2"><span class="section-number-2">4</span> The <code>package-former</code> Datatype</h2>
<div class="outline-text-2" id="text-4">
<p>
For this prototype's <a href="#org4850a43">constraints</a>, a PackageFormer will generally declared as
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #b58900; font-style: italic;">PackageFormer Semigroup</span> (<span style="color: #0000cd;">v</span> :<span style="color: #b58900; font-style: italic;"> Variation</span>) : <span style="color: #859900; font-weight: bold;">Set</span> &#8467; <span style="color: #859900; font-weight: bold;">where</span>
     &#8942;
</pre>
</div>

<p>
The body, <code>⋮</code>, of such a declaration mentions <code>Semigroup v</code>, which we would like to rewrite
with other names when the package is instantiated. Likewise, we also want to erase or rewrite
the sole parameter, and possibly increment the level. Let's form a type to work with these components
rather than meddle with strings all the time.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #268bd2;">package-formers</span> nil
  <span style="color: #35a69c;">"The list of PackageFormer schema declarations in the current Agda buffer."</span><span style="color: #268bd2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defstruct</span> package-former
  <span style="color: #35a69c;">"Record of components that form a PackageFormer.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">docstring</span><span style="color: #35a69c;">&#8217;: Relevant documentation about this structure; e.g.,</span>
<span style="color: #35a69c;">      what is the instance declaration that generated this type, if any.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">type</span><span style="color: #35a69c;">&#8217;: PackageFormer, record, data, module, etc.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">name</span><span style="color: #35a69c;">&#8217;: The name of the grouping mechanism schema.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">level</span><span style="color: #35a69c;">&#8217;: The universe level that the instantiations will inhabit.</span>
<span style="color: #35a69c;">              The universe level of the PackageFormer.</span>

<span style="color: #35a69c;">   - Finally, the children fields are the typed-names that constitute the body of the</span>
<span style="color: #35a69c;">     grouping mechanism. As long as consistent indentation is selected, it does not matter how much.</span>
<span style="color: #35a69c;">     As such, we keep track of these indentation numerics ourselves in case we need to tweak them.</span>

<span style="color: #35a69c;">   - Internally, the zeroth element always refers to the variation symbol whereas the first element</span>
<span style="color: #35a69c;">     refers to the &#8216;universe of discourse &#119984;&#8217;, if any is explicitly provided, and the next &#8216;</span><span style="color: #6c71c4; font-weight: bold;">waist</span><span style="color: #35a69c;">&#8217;-many</span>
<span style="color: #35a69c;">     elements are considered parameters. Note that for an ADT, &#119984; is the ADT name, the &#119984; of a record</span>
<span style="color: #35a69c;">     is the record name, but for a typeclass &#119984; is generally specfiied as a set, say &#8220;Carrier : Set &#8467;&#8221;.</span>
<span style="color: #35a69c;">  "</span>
  docstring
  type
  name
  level

  waist <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Delimits elements into parameters and fields.</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">children</span>
  indentation <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">useful for when new elements are added.</span>
  elements
<span style="color: #268bd2;">)</span>
</pre>
</div>

<p>
It will get rather redundant to write <code>(package-former-X p)</code> to project the constituents of a PackageFormer <code>p</code>. As such, let's introduce
a useful macro to “open p” locally.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">An anaphoric macro ^_^</span>
<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defmacro</span> <span style="color: #b58900;">open-pf</span> <span style="color: #d33682;">(</span>p <span style="color: #b58900; font-style: italic;">&amp;rest</span> body<span style="color: #d33682;">)</span>
  `<span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">let*</span>
    <span style="color: #859900;">(</span><span style="color: #cb4b16;">(</span>docstring             <span style="color: #6c71c4;">(</span>package-former-docstring ,p<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
     <span style="color: #cb4b16;">(</span>type                  <span style="color: #6c71c4;">(</span>package-former-type ,p<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
     <span style="color: #cb4b16;">(</span>name                  <span style="color: #6c71c4;">(</span>package-former-name ,p<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
     <span style="color: #cb4b16;">(</span>level                 <span style="color: #6c71c4;">(</span>package-former-level ,p<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
     <span style="color: #cb4b16;">(</span>waist                 <span style="color: #6c71c4;">(</span>package-former-waist ,p<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
     <span style="color: #cb4b16;">(</span>indentation           <span style="color: #6c71c4;">(</span>package-former-indentation ,p<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
     <span style="color: #cb4b16;">(</span>elements              <span style="color: #6c71c4;">(</span>package-former-elements ,p<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">It is the user's repsonsibility to pop-off the variation,</span>
    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">if it is undesirable.</span>

    <span style="color: #cb4b16;">(</span>carrier               <span style="color: #6c71c4;">(</span>nth 1 elements<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
    <span style="color: #cb4b16;">(</span>parameters            <span style="color: #6c71c4;">(</span>-take waist elements<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
    <span style="color: #cb4b16;">(</span>fields                <span style="color: #6c71c4;">(</span>-drop waist elements<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
    ,@body
  <span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>
</pre>
</div>

<p>
( Lisp convention would advise this function to be named <code>with-pf</code>, but I'm using the prefix <code>open</code>,
as it is closer to the object language, Agda. )
</p>

<p>
It is crucial to realise that we have just established a convention
that partitions the elements of a PackageFormer:
</p>
<ul class="org-ul">
<li><a id="org11fbf28">parameters</a> are the elements before the waist line.</li>
<li><a id="orga516fc5">fields</a> are the elements after the waist line.</li>
</ul>

<p>
Finally, it seems we need support for typed names &#x2014;pairs <code>“name : type”</code>.
We could use <code>car</code> and <code>cdr</code> on pairs, but let's use named projections instead
so we don't have this extra mental strain and implicit type-checking to ensure.
</p>
<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Working with “name : type” Pairs </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">make-tn</span> <span style="color: #d33682;">(</span>name type<span style="color: #d33682;">)</span>
  <span style="color: #35a69c;">"Produce a typed-name pair."</span>
  <span style="color: #d33682;">(</span>concat <span style="color: #859900;">(</span>s-trim name<span style="color: #859900;">)</span> <span style="color: #2aa198;">" : "</span> <span style="color: #859900;">(</span>s-trim type<span style="color: #859900;">)</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>

<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">get-name</span> <span style="color: #d33682;">(</span>tn<span style="color: #d33682;">)</span>
  <span style="color: #35a69c;">"Given a string &#8220;name : type&#8221;, return the &#8216;</span><span style="color: #6c71c4; font-weight: bold;">name</span><span style="color: #35a69c;">&#8217;;</span>
<span style="color: #35a69c;">   which will not have any colons in it.</span>
<span style="color: #35a69c;">   Whitespace at the edges is trimmed away.</span>
<span style="color: #35a69c;">  "</span>
  <span style="color: #d33682;">(</span>s-trim <span style="color: #859900;">(</span>car <span style="color: #cb4b16;">(</span>s-split <span style="color: #2aa198;">" : "</span> tn<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>

<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">get-type</span> <span style="color: #d33682;">(</span>tn<span style="color: #d33682;">)</span>
  <span style="color: #35a69c;">"Given a string &#8220;name : type&#8221;, return the longest possible &#8216;</span><span style="color: #6c71c4; font-weight: bold;">type</span><span style="color: #35a69c;">&#8217; substring.</span>
<span style="color: #35a69c;">  Whitespace at the edges is trimmed away."</span>
  <span style="color: #d33682;">(</span>s-trim <span style="color: #859900;">(</span>s-join <span style="color: #2aa198;">" : "</span> <span style="color: #cb4b16;">(</span>cdr <span style="color: #6c71c4;">(</span>s-split <span style="color: #2aa198;">" : "</span> tn<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>

<span style="color: #93a1a1;">;;</span>

<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defmacro</span> <span style="color: #b58900;">map-name</span> <span style="color: #d33682;">(</span>fbody tn<span style="color: #d33682;">)</span>
  <span style="color: #35a69c;">"Apply string expression &#8216;</span><span style="color: #6c71c4; font-weight: bold;">fbody</span><span style="color: #35a69c;">&#8217; to the &#8216;</span><span style="color: #6c71c4; font-weight: bold;">name</span><span style="color: #35a69c;">&#8217; position of a typed-named structure.</span>
<span style="color: #35a69c;">   &#8216;</span><span style="color: #6c71c4; font-weight: bold;">fbody</span><span style="color: #35a69c;">&#8217; may mention &#8216;</span><span style="color: #6c71c4; font-weight: bold;">name</span><span style="color: #35a69c;">&#8217;.</span>
<span style="color: #35a69c;">  "</span>
  `<span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #859900;">(</span><span style="color: #cb4b16;">(</span>name <span style="color: #6c71c4;">(</span>get-name ,tn<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
       <span style="color: #859900;">(</span>make-tn ,fbody <span style="color: #cb4b16;">(</span>get-type ,tn<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>

<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defmacro</span> <span style="color: #b58900;">map-type</span> <span style="color: #d33682;">(</span>fbody tn<span style="color: #d33682;">)</span>
  <span style="color: #35a69c;">"Apply string expression &#8216;</span><span style="color: #6c71c4; font-weight: bold;">fbody</span><span style="color: #35a69c;">&#8217; to the &#8216;</span><span style="color: #6c71c4; font-weight: bold;">type</span><span style="color: #35a69c;">&#8217; position of a typed-named structure.</span>
<span style="color: #35a69c;">   &#8216;</span><span style="color: #6c71c4; font-weight: bold;">fbody</span><span style="color: #35a69c;">&#8217; may mention &#8216;</span><span style="color: #6c71c4; font-weight: bold;">type</span><span style="color: #35a69c;">&#8217;.</span>
<span style="color: #35a69c;">  "</span>
  `<span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #859900;">(</span><span style="color: #cb4b16;">(</span>type <span style="color: #6c71c4;">(</span>get-type ,tn<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
       <span style="color: #859900;">(</span>make-tn <span style="color: #cb4b16;">(</span>get-name ,tn<span style="color: #cb4b16;">)</span> ,fbody<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>

<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">ert-deftest</span> <span style="color: #b58900;">tn</span> <span style="color: #d33682;">()</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Superflous space</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal <span style="color: #2aa198;">"name"</span> <span style="color: #cb4b16;">(</span>get-name <span style="color: #2aa198;">"name   : type"</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Multiple &#8220;:&#8221;.</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal <span style="color: #2aa198;">"&#8704; {X : Obj &#119966;} &#8594; (X &#10230; X)"</span>
                 <span style="color: #cb4b16;">(</span>get-type<span style="color: #2aa198;">"Id : &#8704; {X : Obj &#119966;} &#8594; (X &#10230; X)"</span><span style="color: #cb4b16;">)</span> <span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
  <span style="color: #268bd2;">)</span>

</pre>
</div>
</details>
</div>

<div id="outline-container-orgb680f2f" class="outline-3">
<h3 id="orgb680f2f"><span class="section-number-3">4.1</span> Package Former Parsing and Pretty Printing</h3>
<div class="outline-text-3" id="text-4-1">
<p>
With this in hand, let's produce a robust parser.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">parse-package-former</span> <span style="color: #d33682;">(</span>lines<span style="color: #d33682;">)</span>
  <span style="color: #35a69c;">"The input &#8216;</span><span style="color: #6c71c4; font-weight: bold;">lines</span><span style="color: #35a69c;">&#8217; must be a list of lines forming a full PackageFormer declaration;</span>
<span style="color: #35a69c;">   e.g., obtained by calling &#8216;</span><span style="color: #6c71c4; font-weight: bold;">get-children</span><span style="color: #35a69c;">&#8217;.</span>

<span style="color: #35a69c;">   It is parsed and a &#8216;</span><span style="color: #6c71c4; font-weight: bold;">package-former</span><span style="color: #35a69c;">&#8217; value is returned.</span>

<span style="color: #35a69c;">   - Whitespace is stripped off of items.</span>
<span style="color: #35a69c;">   - Docstrings are ignored.</span>
<span style="color: #35a69c;">  "</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Precondition example, with intentionally strange whitespacing:</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">header &#8776; &#8220;PackageFormer Semigroup   (v : Variation) : Set  ( &#8467;expr)   where&#8221;</span>

  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>not lines<span style="color: #859900;">)</span>
      <span style="color: #859900;">(</span><span style="color: #b58900; font-weight: bold;">error</span> <span style="color: #2aa198;">"parse-package-former: Error: Input must be non-empty list."</span><span style="color: #859900;">)</span>

  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #cb4b16;">(</span><span style="color: #6c71c4;">(</span>header <span style="color: #b58900;">(</span>car lines<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>vs <span style="color: #b58900;">(</span>substring-delimited-$ <span style="color: #2aa198;">"($here : Variation"</span> header<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>name <span style="color: #b58900;">(</span>substring-delimited-$ <span style="color: #2aa198;">"PackageFormer $here ("</span> header<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>level <span style="color: #b58900;">(</span>substring-delimited-$ <span style="color: #2aa198;">"Set$here where"</span> header<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>carrier <span style="color: #b58900;">(</span>concat name <span style="color: #2aa198;">" "</span> vs <span style="color: #2aa198;">" : Set"</span> level<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">MA: Replace with a hook.</span>
    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">(--map (highlight-phrase (s-trim it) 'hi-yellow) (cdr lines))</span>

    <span style="color: #cb4b16;">(</span>make-package-former
     <span style="color: #d33682; font-weight: bold; font-style: italic;">:type</span>                     <span style="color: #2aa198;">"PackageFormer"</span>
     <span style="color: #d33682; font-weight: bold; font-style: italic;">:name</span>                     name
     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">level</span><span style="color: #96A7A9; font-style: italic;">&#8217; may be &#8220;&#8221;, that's okay. It may be a subscript &amp; so no space after &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">Set</span><span style="color: #96A7A9; font-style: italic;">&#8217;.</span>
     <span style="color: #d33682; font-weight: bold; font-style: italic;">:level</span>                    level
     <span style="color: #d33682; font-weight: bold; font-style: italic;">:waist</span>                    1 <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">The variation symbol is a parameter</span>
     <span style="color: #d33682; font-weight: bold; font-style: italic;">:indentation</span>              <span style="color: #6c71c4;">(</span>get-indentation <span style="color: #b58900;">(</span>cadr lines<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>
     <span style="color: #d33682; font-weight: bold; font-style: italic;">:elements</span>                 <span style="color: #6c71c4;">(</span>-cons* <span style="color: #b58900;">(</span>concat vs <span style="color: #2aa198;">" : Variation"</span><span style="color: #b58900;">)</span> carrier <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">--map</span> <span style="color: #35a69c;">(</span>s-trim it<span style="color: #35a69c;">)</span> <span style="color: #35a69c;">(</span>cdr lines<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
  <span style="color: #859900;">)</span>
<span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>

<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">ert-deftest</span> <span style="color: #b58900;">pf-parse</span> <span style="color: #d33682;">()</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Error on empty list of lines.</span>
   <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should-error</span> <span style="color: #859900;">(</span>parse-package-former nil<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

   <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">No crash on empty line.</span>
   <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>parse-package-former <span style="color: #cb4b16;">(</span>list <span style="color: #2aa198;">""</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

   <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">No crash on PackageFormer with no elements.</span>
   <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>parse-package-former <span style="color: #cb4b16;">(</span>list <span style="color: #2aa198;">"PackageFormer PF (w : Variation) : Set &#8467; where"</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

   <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Full parsing.</span>
   <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">-let</span> <span style="color: #859900;">[</span>pf <span style="color: #cb4b16;">(</span>parse-package-former <span style="color: #6c71c4;">(</span>cadr <span style="color: #b58900;">(</span>get-children <span style="color: #2aa198;">"PackageFormer"</span> test<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">]</span>
     <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #cb4b16;">(</span>equal pf
                    #s<span style="color: #6c71c4;">(</span>package-former nil <span style="color: #2aa198;">"PackageFormer"</span> <span style="color: #2aa198;">"Semigroup"</span> <span style="color: #2aa198;">""</span> 1 4
                        <span style="color: #b58900;">(</span><span style="color: #2aa198;">"v : Variation"</span> <span style="color: #2aa198;">"Semigroup v : Set"</span>
                         <span style="color: #2aa198;">"_&#10814;_ : Semigroup v &#8594; Semigroup v &#8594; Semigroup v"</span>
                         <span style="color: #2aa198;">"Id  : Semigroup v"</span>
                         <span style="color: #2aa198;">"assoc : &#8704; {x y z} &#8594; (x &#10814; y) &#10814; z &#8801; x &#10814; (y &#10814; z)"</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
  <span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>

<p>
Let's try this out.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span>parse-package-former <span style="color: #d33682;">(</span>cadr <span style="color: #859900;">(</span>get-children <span style="color: #2aa198;">"PackageFormer"</span> test<span style="color: #859900;">)</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">#s(package-former nil PackageFormer Semigroup  1 4 (v : Variation Semigroup v : Set <span class="underline">⨾</span> : Semigroup v → Semigroup v → Semigroup v Id  : Semigroup v assoc : ∀ {x y z} → (x ⨾ y) ⨾ z ≡ x ⨾ (y ⨾ z)))</td>
</tr>
</tbody>
</table>

<p>
Conversely, let's have a pretty printer.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">special</span> <span style="color: #d33682;">(</span>f<span style="color: #d33682;">)</span>
  <span style="color: #35a69c;">"Special elements, for whatever reason are exceptional, and so</span>
<span style="color: #35a69c;">   are maked as singleton lists and their indentation is lessened.</span>
<span style="color: #35a69c;">   That is, these denote sibling fields rather than more children.</span>

<span style="color: #35a69c;">   Special elements include: field, private.</span>

<span style="color: #35a69c;">   See &#8216;</span><span style="color: #6c71c4; font-weight: bold;">show-package-former</span><span style="color: #35a69c;">&#8217; for their use and how their printed.</span>
<span style="color: #35a69c;">  "</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">--any?</span> <span style="color: #859900;">(</span>s-contains? it f<span style="color: #859900;">)</span> '<span style="color: #859900;">(</span><span style="color: #2aa198;">"field"</span> <span style="color: #2aa198;">"private"</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">show-package-former</span> <span style="color: #d33682;">(</span>p <span style="color: #b58900; font-style: italic;">&amp;key</span> waist-strings
                                 <span style="color: #859900;">(</span>omit-level nil<span style="color: #859900;">)</span> omit-docstring omit-car-element<span style="color: #d33682;">)</span>
  <span style="color: #35a69c;">"Pretty print a package-former record value.</span>

<span style="color: #35a69c;">   -&#8216;</span><span style="color: #6c71c4; font-weight: bold;">waist-strings</span><span style="color: #35a69c;">&#8217;: Arbitrary new elements that are input at the location of the</span>
<span style="color: #35a69c;">     PackageFormer's waist. E.g., the following results in a new local alias &#8216;n&#8217;</span>
<span style="color: #35a69c;">     before the remaining constitutents are printed under a &#8220;field&#8221; clause.</span>

<span style="color: #35a69c;">         :waist-strings (list &#8220;private&#8221; &#8220;n : &#8469;&#8221; &#8220;n = 3&#8221; &#8220;field&#8221;)</span>
<span style="color: #35a69c;">  "</span>

  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">open-pf</span> p <span style="color: #859900;">(</span>s-join <span style="color: #2aa198;">"\n"</span> <span style="color: #cb4b16;">(</span>-cons*

     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">0. The documentation string</span>
     <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #b58900;">(</span>not omit-docstring<span style="color: #b58900;">)</span> docstring <span style="color: #b58900;">(</span>format <span style="color: #2aa198;">"{- %s -}"</span> docstring<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>

     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">1. The schema declaration</span>
     <span style="color: #6c71c4;">(</span>s-collapse-whitespace <span style="color: #b58900;">(</span>s-join <span style="color: #2aa198;">" "</span>
        <span style="color: #35a69c;">(</span>list type name <span style="color: #6c71c4;">(</span>s-join <span style="color: #2aa198;">" "</span> <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">--map</span> <span style="color: #268bd2;">(</span>concat <span style="color: #2aa198;">"("</span> it <span style="color: #2aa198;">")"</span><span style="color: #268bd2;">)</span> parameters<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
              <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">unless</span> omit-level <span style="color: #859900;">(</span>concat <span style="color: #2aa198;">": Set"</span> level<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
              <span style="color: #2aa198;">"where"</span><span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>

     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">The elements of a PackageFormer</span>
       <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">thread-last</span> fields

        <span style="color: #b58900;">(</span>-concat waist-strings<span style="color: #b58900;">)</span>

        <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Indent all elements, less indentation for the specials.</span>
        <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">--map</span> <span style="color: #35a69c;">(</span>concat <span style="color: #6c71c4;">(</span>s-repeat <span style="color: #859900;">(</span>- indentation <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #d33682;">(</span>special it<span style="color: #d33682;">)</span> 2 0<span style="color: #268bd2;">)</span><span style="color: #859900;">)</span> <span style="color: #2aa198;">" "</span><span style="color: #6c71c4;">)</span> it<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span>
        <span style="color: #b58900;">(</span>funcall <span style="color: #35a69c;">(</span><span style="color: #859900; font-weight: bold;">if</span> omit-car-element #'cdr #'identity<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span>
        <span style="color: #6c71c4;">)</span>
    <span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>

<p>
Let's test it out by <i>including</i> a whole new local variable and trying
to include the <code>field</code> Agda keyword.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #d33682;">(</span><span style="color: #859900;">(</span>raw <span style="color: #cb4b16;">(</span>cadr <span style="color: #6c71c4;">(</span>get-children <span style="color: #2aa198;">"PackageFormer"</span> test<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
       <span style="color: #859900;">(</span>pf <span style="color: #cb4b16;">(</span>parse-package-former raw<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
       <span style="color: #d33682;">)</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">setf</span> <span style="color: #859900;">(</span>package-former-waist pf<span style="color: #859900;">)</span> 2<span style="color: #d33682;">)</span>
   <span style="color: #d33682;">(</span>show-package-former pf
    <span style="color: #d33682; font-weight: bold; font-style: italic;">:omit-car-element</span> t
    <span style="color: #d33682; font-weight: bold; font-style: italic;">:waist-strings</span> <span style="color: #859900;">(</span>list <span style="color: #2aa198;">"private"</span> <span style="color: #2aa198;">"n : &#8469;"</span> <span style="color: #2aa198;">"n = 3"</span> <span style="color: #2aa198;">"field {- elements -} "</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
   <span style="color: #268bd2;">)</span><span style="color: #dc322f; background-color: #fdf6e3; font-weight: bold;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda">
<span style="color: #b58900; font-style: italic;">PackageFormer Semigroup</span> (<span style="color: #0000cd;">v</span> :<span style="color: #b58900; font-style: italic;"> Variation</span>)<span style="color: #b58900; font-style: italic;"> (Semigroup</span> <span style="color: #0000cd;">v</span> : <span style="color: #859900; font-weight: bold;">Set</span>) : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
    <span style="color: #0000cd;">n</span> : <span style="color: #b58900; font-style: italic;">&#8469;</span>
    <span style="color: #0000cd;">n</span> <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #a020f0;">3</span>
  <span style="color: #859900; font-weight: bold;">field</span> <span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">elements </span><span style="color: #93a1a1;">-}</span>
    <span style="color: #b58900; font-style: italic;">_&#10814;_</span> :<span style="color: #b58900; font-style: italic;"> Semigroup</span> <span style="color: #0000cd;">v</span> &#8594;<span style="color: #b58900; font-style: italic;"> Semigroup</span> <span style="color: #0000cd;">v</span> &#8594;<span style="color: #b58900; font-style: italic;"> Semigroup</span> <span style="color: #0000cd;">v</span>
   <span style="color: #b58900; font-style: italic;"> Id</span>  :<span style="color: #b58900; font-style: italic;"> Semigroup</span> <span style="color: #0000cd;">v</span>
    <span style="color: #b58900; font-style: italic;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
</pre>
</div>

<p>
The call to <code>s-collapse-whitespace</code> permits us to phrase an approximation of the opinion
that parsing and showing should be inverses.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">-let</span> <span style="color: #d33682;">[</span>pf <span style="color: #859900;">(</span>cadr <span style="color: #cb4b16;">(</span>get-children <span style="color: #2aa198;">"PackageFormer"</span> test<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">]</span>
  <span style="color: #d33682;">(</span>equal <span style="color: #859900;">(</span>s-concat <span style="color: #2aa198;">"\n"</span> <span style="color: #cb4b16;">(</span>s-join <span style="color: #2aa198;">"\n"</span> pf<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
         <span style="color: #859900;">(</span>show-package-former <span style="color: #cb4b16;">(</span>parse-package-former pf<span style="color: #cb4b16;">)</span> <span style="color: #d33682; font-weight: bold; font-style: italic;">:omit-car-element</span> t<span style="color: #859900;">)</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">t</td>
</tr>
</tbody>
</table>

<div class="org-center">
<p>
( <i>In Lisp, <code>t</code> denotes “true”!</i> )
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org5360375" class="outline-2">
<h2 id="org5360375"><span class="section-number-2">5</span> Parsing an Agda Buffer</h2>
<div class="outline-text-2" id="text-5">
<p>
Before we can parse an Agda buffer, we need to be able to parse an instantiation declaration;
for which we would later generate code.
</p>
</div>

<div id="outline-container-orgeedfebf" class="outline-3">
<h3 id="orgeedfebf"><span class="section-number-3">5.1</span> <code>instantiations-remaining</code> list</h3>
<div class="outline-text-3" id="text-5-1">
<p>
Here in we define the datatype of <code>instance-declaration</code>, describe how
to parse such entities, and monitor them within list.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #268bd2;">instantiations-remaining</span> nil
  <span style="color: #35a69c;">"The PackageFormer instantiations that need to be performed."</span><span style="color: #268bd2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defstruct</span> instance-declaration
  <span style="color: #35a69c;">"Record of componenets for an PackageFormer instance declaration:</span>
<span style="color: #35a69c;">   &#10218;name&#10219; = &#10218;package-former&#10219; &#10218;variation&#10219; (&#10218;renames&#10219; | &#10218;hidings&#10219; | &#10218;manifest&#10219; | &#10218;exposes&#10219; | &#10218;decorations&#10219;)</span>
<span style="color: #35a69c;">   &#10218;renames&#10219;     = &#949; | renaming (&#945; to &#945;&#8242; ; &#8230; ; &#969; to &#969;&#8242;)</span>
<span style="color: #35a69c;">   &#10218;opening&#10219;     = &#949; | opening (&#10218;record-name&#10219;; &#945; to &#945;&#8242; ; &#8230; ; &#969; to &#969;&#8242;)</span>
<span style="color: #35a69c;">   &#10218;hidings&#10219;     = &#949; | hiding (&#945;; &#8230;; &#969;)</span>
<span style="color: #35a69c;">   &#10218;manifest&#10219;    = &#949; | with (&#945; to &#945;&#8242; ; &#8230; ; &#969; to &#969;&#8242;)</span>
<span style="color: #35a69c;">   &#10218;exposes&#10219;     = &#949; | exposes (&#945;; &#8230;; &#969;)</span>
<span style="color: #35a69c;">   &#10218;decoration&#10219;  = decorated (it-exprssion)  ;; TODO: Form generalised renaming; use a &#955;: Agda users aren't acustomed to anaphoric macros.</span>
<span style="color: #35a69c;">  "</span>
  docstring <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">What the declaration looks like, useful for reference.</span>
  name package-former variation
  <span style="color: #d33682;">(</span>waist 0<span style="color: #d33682;">)</span>

  renames  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">an association list, trimmed whitespace</span>

  hidings  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">list, trimmed whitespace</span>
  manifest <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">an association list, trimmed whitespace</span>
  exposes  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">list, trimmed whitespace</span>
  decorations <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">function to be applied to name and element-names of a PackageFormer.</span>
  openings  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">(list type args) ;; FIXME: Not ideal; merge with renaming?</span>
  extra-params
<span style="color: #268bd2;">)</span>
</pre>
</div>

<p>
TODO: Above, instead of <code>renames</code> have a field, say, <code>alteration</code> which is intended
to be a functional reification of a Variation expression; e.g., the renaming ops are within <code>alteration</code>.
Before moving to this generality, ensure <code>renames</code> works then generalise.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">parse-labelled-to-list</span> <span style="color: #d33682;">(</span>label the-list <span style="color: #b58900; font-style: italic;">&amp;key</span> <span style="color: #859900;">(</span>no-to nil<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

     <span style="color: #35a69c;">"Given a &#8220;to-list&#8221; of the form &#8220;label (x&#8320; to y&#8320;; &#8230;; x&#8345; to y&#8345;; &#955; x &#8594; Bx)&#8221;</span>
<span style="color: #35a69c;">      yield the Lisp list of dotted pairs &#8220;( ((x&#8320; . y&#8320;) &#8943; (x&#8345; . y&#8345;)) &#8220;(lambda (x) Bx)&#8221;)&#8221;</span>
<span style="color: #35a69c;">      where the *optional* final clause of the to-list is considered a default or &#8216;</span><span style="color: #6c71c4; font-weight: bold;">otherwise</span><span style="color: #35a69c;">&#8217;</span>
<span style="color: #35a69c;">      case and is converted into a legitimate Lisp function.</span>

<span style="color: #35a69c;">      No label results in to-list becoming a dotted list.</span>
<span style="color: #35a69c;">      When the otherwise clause is absent, we yield the identity function.</span>

<span style="color: #35a69c;">      If &#8220;no-to&#8221; is true, then we do not parse the to-clauses, yielding</span>
<span style="color: #35a69c;">      a list of strings.</span>

<span style="color: #35a69c;">      Errors on an empty list. Yields nil if the label is not found.</span>
<span style="color: #35a69c;">      Note that n = 0 is fine is okay provided the otherwise clause</span>
<span style="color: #35a69c;">      is present.</span>
<span style="color: #35a69c;">     "</span>

     <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">when</span> <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">or</span> <span style="color: #cb4b16;">(</span>equal <span style="color: #6c71c4;">(</span>car the-list<span style="color: #6c71c4;">)</span> label<span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>s-blank? <span style="color: #6c71c4;">(</span>s-trim label<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

     <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">-let*</span> <span style="color: #cb4b16;">(</span><span style="color: #6c71c4;">(</span>result <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">thread-last</span> the-list

                      <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Stick them back together</span>
                      <span style="color: #35a69c;">(</span>s-join <span style="color: #2aa198;">" "</span><span style="color: #35a69c;">)</span>

                      <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Discard identifying label</span>
                      <span style="color: #35a69c;">(</span>substring-delimited-$ <span style="color: #6c71c4;">(</span>format <span style="color: #2aa198;">"%s ($here)"</span> label<span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span>

                      <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Split along semicolons.</span>
                      <span style="color: #35a69c;">(</span>s-split <span style="color: #2aa198;">";"</span><span style="color: #35a69c;">)</span>

                      <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Removed superflous whitespace</span>
                      <span style="color: #35a69c;">(</span><span style="color: #859900; font-weight: bold;">--map</span> <span style="color: #6c71c4;">(</span>s-trim it<span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>

             otherwise var<span style="color: #cb4b16;">)</span>

       <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">If there is a &#8220;otherwise&#8221; function to apply,</span>
       <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">then turn it into a Lisp function and drop it</span>
       <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">from the prefix of the to-list. Else, set otherwise to identity.</span>
       <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>not <span style="color: #b58900;">(</span>s-contains? <span style="color: #2aa198;">"&#955;"</span> <span style="color: #35a69c;">(</span>car <span style="color: #6c71c4;">(</span>-take-last 1 result<span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>

           <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">setq</span> otherwise #'identity<span style="color: #6c71c4;">)</span>

         <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Drop the Agda's &#955;&#8594; in-favour of Lisp's (lambda &#8943;).</span>
         <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Replace Agda catenation's with Lisp concat.</span>
         <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">setq</span> otherwise <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">thread-last</span> <span style="color: #35a69c;">(</span>car <span style="color: #6c71c4;">(</span>-take-last 1 result<span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span>
               <span style="color: #35a69c;">(</span>s-replace <span style="color: #2aa198;">"++"</span> <span style="color: #2aa198;">" "</span><span style="color: #35a69c;">)</span>
               <span style="color: #35a69c;">(</span>substring-delimited-$ <span style="color: #2aa198;">"&#955; $here"</span><span style="color: #35a69c;">)</span>
               <span style="color: #35a69c;">(</span>s-split <span style="color: #2aa198;">" &#8594; "</span><span style="color: #35a69c;">)</span>
               <span style="color: #35a69c;">(</span><span style="color: #859900; font-weight: bold;">funcall-it</span> <span style="color: #6c71c4;">(</span>format <span style="color: #2aa198;">"(lambda (%s) (concat %s))"</span> <span style="color: #859900;">(</span>car it<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>cadr it<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span>
               read-from-string
               car
               <span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>

         <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">setq</span> result <span style="color: #b58900;">(</span>-drop-last 1 result<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>

       <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Turn into dotted pairs, unless suggested otherwise.</span>
       <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Need to ensure &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">result</span><span style="color: #96A7A9; font-style: italic;">&#8217; is non-empty; since it may</span>
       <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">be a singleton that was dropped into the &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">otherwise</span><span style="color: #96A7A9; font-style: italic;">&#8217;.</span>
       <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">when</span> <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">and</span> result <span style="color: #b58900;">(</span>not no-to<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">setq</span> result <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">thread-last</span> result
             <span style="color: #35a69c;">(</span><span style="color: #859900; font-weight: bold;">--map</span> <span style="color: #6c71c4;">(</span>s-split <span style="color: #2aa198;">" to "</span> it<span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span>
             <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Need to ensure it's a list of pairs; otherwise something went wrong.</span>
             <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Suffices to ensure the head element has a second componenet.</span>
             <span style="color: #35a69c;">(</span><span style="color: #859900; font-weight: bold;">funcall-it</span> <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>cadar it<span style="color: #859900;">)</span> it
                 <span style="color: #859900;">(</span><span style="color: #b58900; font-weight: bold;">error</span> <span style="color: #2aa198;">"parse-labelled-to-list: Is this &#8220;to-list&#8221; well-formed: %s &#8263;"</span> <span style="color: #268bd2;">(</span>pp it<span style="color: #268bd2;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span>
             <span style="color: #35a69c;">(</span><span style="color: #859900; font-weight: bold;">--map</span> <span style="color: #6c71c4;">(</span>cons <span style="color: #859900;">(</span>s-trim <span style="color: #268bd2;">(</span>first it<span style="color: #268bd2;">)</span><span style="color: #859900;">)</span> <span style="color: #859900;">(</span>s-trim <span style="color: #268bd2;">(</span>second it<span style="color: #268bd2;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>

       <span style="color: #cb4b16;">(</span>list result otherwise<span style="color: #cb4b16;">)</span>
   <span style="color: #859900;">)</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>

<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">ert-deftest</span> <span style="color: #b58900;">parse-tos</span> <span style="color: #d33682;">()</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Expected use</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal '<span style="color: #cb4b16;">(</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"a"</span> . <span style="color: #2aa198;">"b"</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"c"</span> . <span style="color: #2aa198;">"d"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>car<span style="color: #6c71c4;">(</span>parse-labelled-to-list <span style="color: #2aa198;">"map"</span> <span style="color: #b58900;">(</span>s-split <span style="color: #2aa198;">" "</span> <span style="color: #2aa198;">"map (a to b; c to d)"</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal '<span style="color: #cb4b16;">(</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"a"</span> . <span style="color: #2aa198;">"b"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>car<span style="color: #6c71c4;">(</span>parse-labelled-to-list <span style="color: #2aa198;">"map"</span> <span style="color: #b58900;">(</span>s-split <span style="color: #2aa198;">" "</span> <span style="color: #2aa198;">"map (a to b)"</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal '<span style="color: #cb4b16;">(</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"a"</span> . <span style="color: #2aa198;">"b"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>car<span style="color: #6c71c4;">(</span>parse-labelled-to-list <span style="color: #2aa198;">"map"</span> <span style="color: #b58900;">(</span>s-split <span style="color: #2aa198;">" "</span> <span style="color: #2aa198;">"map (a to b; &#955; x &#8594; x)"</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #6c71c4;">(</span>x<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>concat x<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>cadr<span style="color: #6c71c4;">(</span>parse-labelled-to-list <span style="color: #2aa198;">"map"</span> <span style="color: #b58900;">(</span>s-split <span style="color: #2aa198;">" "</span> <span style="color: #2aa198;">"map (a to b; &#955; x &#8594; x)"</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #6c71c4;">(</span>x<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>concat x <span style="color: #2aa198;">"&#8242;"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>cadr<span style="color: #6c71c4;">(</span>parse-labelled-to-list <span style="color: #2aa198;">"map"</span> <span style="color: #b58900;">(</span>s-split <span style="color: #2aa198;">" "</span> <span style="color: #2aa198;">"map (a to b; &#955; x &#8594; x ++ \"&#8242;\")"</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #6c71c4;">(</span>x<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>concat x <span style="color: #2aa198;">"&#8242;"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>cadr<span style="color: #6c71c4;">(</span>parse-labelled-to-list <span style="color: #2aa198;">"map"</span> <span style="color: #b58900;">(</span>s-split <span style="color: #2aa198;">" "</span> <span style="color: #2aa198;">"map (&#955; x &#8594; x ++ \"&#8242;\")"</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Empty list errors.</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should-error</span> <span style="color: #859900;">(</span>parse-labelled-to-list <span style="color: #2aa198;">"map"</span> <span style="color: #cb4b16;">(</span>s-split <span style="color: #2aa198;">" "</span> <span style="color: #2aa198;">"map ()"</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Singleton list</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal '<span style="color: #cb4b16;">(</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"a"</span> . <span style="color: #2aa198;">"b"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>car <span style="color: #6c71c4;">(</span>parse-labelled-to-list <span style="color: #2aa198;">"map"</span> <span style="color: #b58900;">(</span>s-split <span style="color: #2aa198;">" "</span> <span style="color: #2aa198;">"map (a to b)"</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">No label results in to-list becoming a dotted list.</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal '<span style="color: #cb4b16;">(</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"a"</span> . <span style="color: #2aa198;">"b"</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"c"</span> . <span style="color: #2aa198;">"d"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>car<span style="color: #6c71c4;">(</span>parse-labelled-to-list <span style="color: #2aa198;">""</span> <span style="color: #b58900;">(</span>s-split <span style="color: #2aa198;">" "</span> <span style="color: #2aa198;">"(a to b; c to d)"</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Unmatched label.</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal nil <span style="color: #cb4b16;">(</span>car<span style="color: #6c71c4;">(</span>parse-labelled-to-list <span style="color: #2aa198;">"mapp"</span> <span style="color: #b58900;">(</span>s-split <span style="color: #2aa198;">" "</span> <span style="color: #2aa198;">"map (a to b)"</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Ill-formed list.</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should-error</span> <span style="color: #859900;">(</span>parse-labelled-to-list <span style="color: #2aa198;">"map"</span> <span style="color: #cb4b16;">(</span>s-split <span style="color: #2aa198;">" "</span> <span style="color: #2aa198;">"map (a what b)"</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">load-instance-declaration</span> <span style="color: #d33682;">(</span>line<span style="color: #d33682;">)</span>
  <span style="color: #35a69c;">"If the current &#8216;</span><span style="color: #6c71c4; font-weight: bold;">line</span><span style="color: #35a69c;">&#8217; string is an instance declaration,</span>
<span style="color: #35a69c;">   then parse and add it to the list of &#8216;</span><span style="color: #6c71c4; font-weight: bold;">instantiations-remaining</span><span style="color: #35a69c;">&#8217;;</span>
<span style="color: #35a69c;">   else do nothing.</span>

<span style="color: #35a69c;">   Returns the instance-declaration that was loaded, otherwise nil.</span>

<span style="color: #35a69c;">   Whitespace is automatically collopased from &#8216;</span><span style="color: #6c71c4; font-weight: bold;">line</span><span style="color: #35a69c;">&#8217;.</span>
<span style="color: #35a69c;">  "</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Example instance declaration:</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8220;MagmaR = Magma record renaming (Carrier to C; _&#10814;_ to _&#8728;_)&#8221;</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; &#8805;4 pieces, separated by spaces, where second item must be an equality.</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Note: (cddddr nil) &#8776; nil</span>

  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #859900;">(</span>inst <span style="color: #cb4b16;">(</span>pieces <span style="color: #6c71c4;">(</span>s-split <span style="color: #2aa198;">" "</span> <span style="color: #b58900;">(</span>s-collapse-whitespace line<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>more <span style="color: #6c71c4;">(</span>cddddr pieces<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
              renames hidings exposes manifest <span style="color: #cb4b16;">(</span>unbundling 0<span style="color: #cb4b16;">)</span> decorations openings openings-param<span style="color: #859900;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Minimal check that the the declaration is well-formed.</span>
   <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #cb4b16;">(</span>not <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #b58900;">(</span>&lt;= 4 <span style="color: #35a69c;">(</span>length pieces<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>equal <span style="color: #35a69c;">(</span>nth 1 pieces<span style="color: #35a69c;">)</span> <span style="color: #2aa198;">"="</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>not <span style="color: #35a69c;">(</span>s-blank? <span style="color: #6c71c4;">(</span>s-trim <span style="color: #859900;">(</span>nth 0 pieces<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
       <span style="color: #cb4b16;">(</span>message <span style="color: #2aa198;">"load-instance-declaration: Declarations should have at least 4 non-empty pieces; %s &#8263;"</span> line<span style="color: #cb4b16;">)</span>
       <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">We do not crash here since we also arbitrary Agda to flow through the 700-comments as well.</span>

     <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">when</span> <span style="color: #6c71c4;">(</span>equal <span style="color: #b58900;">(</span>car more<span style="color: #b58900;">)</span> <span style="color: #2aa198;">"unbundling"</span><span style="color: #6c71c4;">)</span>

       <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Discard identifying tokens</span>
       <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">setq</span> unbundling <span style="color: #b58900;">(</span>string-to-number <span style="color: #35a69c;">(</span>cadr more<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>

     <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> hidings <span style="color: #6c71c4;">(</span>car <span style="color: #b58900;">(</span>parse-labelled-to-list <span style="color: #2aa198;">"hiding"</span> more <span style="color: #d33682; font-weight: bold; font-style: italic;">:no-to</span> t<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>

     <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> exposes <span style="color: #6c71c4;">(</span>car <span style="color: #b58900;">(</span>parse-labelled-to-list <span style="color: #2aa198;">"exposing"</span> more <span style="color: #d33682; font-weight: bold; font-style: italic;">:no-to</span> t<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
       <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">The exposed items should be hoisted upwards in the elements listing.</span>
       <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Then the waist is also hoisted.</span>
       <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">when</span> exposes <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">setq</span> unbundling <span style="color: #b58900;">(</span>length exposes<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>

     <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> renames <span style="color: #6c71c4;">(</span>car <span style="color: #b58900;">(</span>parse-labelled-to-list <span style="color: #2aa198;">"renaming"</span> more<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>

     <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> manifest <span style="color: #6c71c4;">(</span>car <span style="color: #b58900;">(</span>parse-labelled-to-list <span style="color: #2aa198;">"with"</span> more<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
       <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">If &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">Carrier</span><span style="color: #96A7A9; font-style: italic;">&#8217; is one of the items, then reduce the waist line;</span>
       <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">otherwise the next item is hoisted upwards.</span>
       <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">when</span> <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">--any?</span> <span style="color: #b58900;">(</span>equal it <span style="color: #2aa198;">"Carrier"</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>-map #'car manifest<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>
           <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">decf</span> unbundling<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>

     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">E.g., PF&#8242; = PF v decorated (&#955; x &#8594; &#8943;x&#8943; ++ "&#8242;")</span>
     <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> decorations <span style="color: #6c71c4;">(</span>cadr <span style="color: #b58900;">(</span>parse-labelled-to-list <span style="color: #2aa198;">"decorated"</span> more<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>

     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">LHS = PF opening &#10218;record-name&#10219; (&#945; to &#945;&#8242; ; &#8230; ; &#969; to &#969;&#8242;)</span>
     <span style="color: #93a1a1;">;;</span>
     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Since a &#10218;record-name&#10219; is requested, the PF may appear to be irrelevant.</span>
     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">However, we need it in order to invoke the &#8220;instantiate&#8221; function</span>
     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">later: It requires a PackageFormer to specialise.</span>
     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Alternatively, we could keep track of the parents of instantiations</span>
     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">but this is a new list to maintain and the result is that this</span>
     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">instance declaration breaks uniformity from the others.</span>
     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Uniformity is preferable, for now.</span>
     <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">when</span> <span style="color: #6c71c4;">(</span>equal <span style="color: #b58900;">(</span>nth 3 pieces<span style="color: #b58900;">)</span> <span style="color: #2aa198;">"opening"</span><span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">setq</span> openings <span style="color: #b58900;">(</span>parse-labelled-to-list <span style="color: #2aa198;">""</span> <span style="color: #35a69c;">(</span>cdr more<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">setq</span> openings <span style="color: #b58900;">(</span>cons <span style="color: #35a69c;">(</span>nth 4 pieces<span style="color: #35a69c;">)</span> openings<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span> <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">carrier - renames - otherwise</span>
      <span style="color: #cb4b16;">)</span>

     <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> inst <span style="color: #6c71c4;">(</span>make-instance-declaration
                 <span style="color: #d33682; font-weight: bold; font-style: italic;">:docstring</span>      line
                 <span style="color: #d33682; font-weight: bold; font-style: italic;">:name</span>           <span style="color: #b58900;">(</span>nth 0 pieces<span style="color: #b58900;">)</span>
                 <span style="color: #d33682; font-weight: bold; font-style: italic;">:package-former</span> <span style="color: #b58900;">(</span>nth 2 pieces<span style="color: #b58900;">)</span>
                 <span style="color: #d33682; font-weight: bold; font-style: italic;">:variation</span>      <span style="color: #b58900;">(</span>nth 3 pieces<span style="color: #b58900;">)</span>
                 <span style="color: #d33682; font-weight: bold; font-style: italic;">:waist</span>          unbundling
                 <span style="color: #d33682; font-weight: bold; font-style: italic;">:hidings</span>        hidings
                 <span style="color: #d33682; font-weight: bold; font-style: italic;">:exposes</span>        exposes
                 <span style="color: #d33682; font-weight: bold; font-style: italic;">:manifest</span>       manifest
                 <span style="color: #d33682; font-weight: bold; font-style: italic;">:openings</span>       openings
                 <span style="color: #d33682; font-weight: bold; font-style: italic;">:decorations</span>    decorations
                 <span style="color: #d33682; font-weight: bold; font-style: italic;">:renames</span>        renames<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>

     <span style="color: #cb4b16;">(</span>add-to-list 'instantiations-remaining inst<span style="color: #cb4b16;">)</span>

     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">PackageFormer names are in yellow; instances are are bolded.</span>
     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">(highlight-phrase (format "%s " (nth 2 pieces)) 'hi-yellow)</span>
     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">(highlight-phrase (nth 0 pieces) 'bold) ;; 'warning) ;; i.e., orange</span>
     <span style="color: #93a1a1;">;;</span>
     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">MA: Replace with a hook.</span>

   <span style="color: #859900;">)</span>
   <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Return value.</span>
   inst
  <span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>

</pre>
</div>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Tests </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">ert-deftest</span> <span style="color: #b58900;">lid</span> <span style="color: #d33682;">()</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Basic invocation shape</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>load-instance-declaration <span style="color: #2aa198;">"LHS = PF var"</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Ill-formed: LHS name is empty string.</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>not <span style="color: #cb4b16;">(</span>load-instance-declaration <span style="color: #2aa198;">" = PF var"</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Renames</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal <span style="color: #2aa198;">"((Carrier . C) (_&#10814;_ . _&#8728;_))"</span> <span style="color: #cb4b16;">(</span>format <span style="color: #2aa198;">"%s"</span> <span style="color: #6c71c4;">(</span>instance-declaration-renames <span style="color: #b58900;">(</span>load-instance-declaration
  <span style="color: #2aa198;">"LHS = Magma record renaming (Carrier to C; _&#10814;_ to _&#8728;_)"</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">unbundling</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal 3 <span style="color: #cb4b16;">(</span>instance-declaration-waist <span style="color: #6c71c4;">(</span>load-instance-declaration <span style="color: #2aa198;">"MagmaR = Magma record unbundling 3"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">hiding</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal <span style="color: #2aa198;">"(Id)"</span> <span style="color: #cb4b16;">(</span>format <span style="color: #2aa198;">"%s"</span> <span style="color: #6c71c4;">(</span>instance-declaration-hidings <span style="color: #b58900;">(</span>load-instance-declaration <span style="color: #2aa198;">"MagmaR = Magma record hiding (Id)"</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">manifest</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal <span style="color: #2aa198;">"((Carrier . &#120121;) (Id . false))"</span> <span style="color: #cb4b16;">(</span>format <span style="color: #2aa198;">"%s"</span> <span style="color: #6c71c4;">(</span>instance-declaration-manifest <span style="color: #b58900;">(</span>load-instance-declaration <span style="color: #2aa198;">"MonoidB = Monoid record with (Carrier to &#120121;; Id to false)"</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
  <span style="color: #93a1a1;">;;</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">This limits us to have monoidal operations &#8744; or &#8802;, for example, but forbids &#8743; and &#8801;.</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">exposes</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal <span style="color: #2aa198;">"(Carrier Id)"</span> <span style="color: #cb4b16;">(</span>format <span style="color: #2aa198;">"%s"</span> <span style="color: #6c71c4;">(</span>instance-declaration-exposes <span style="color: #b58900;">(</span>load-instance-declaration <span style="color: #2aa198;">"MonoidB = Monoid record exposing (Carrier; Id)"</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
  <span style="color: #93a1a1;">;;</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">This is a counterpart to Agda's ~using~ keyword, we are only showing items as parameters and the rest are &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">hidden</span><span style="color: #96A7A9; font-style: italic;">&#8217; as components.</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">decoration</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #6c71c4;">(</span>x<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>concat x <span style="color: #2aa198;">"&#8242;"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>instance-declaration-decorations <span style="color: #6c71c4;">(</span>load-instance-declaration <span style="color: #2aa198;">"MonoidB = Monoid record decorated (&#955; x &#8594; x ++ \"&#8242;\")"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">opening</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal <span style="color: #2aa198;">"(MagmaR ((Carrier . C) (_&#10814;_ . _&#8728;_)) (lambda (x) (concat x &#8242;)))"</span> <span style="color: #cb4b16;">(</span>format <span style="color: #2aa198;">"%s"</span> <span style="color: #6c71c4;">(</span>instance-declaration-openings <span style="color: #b58900;">(</span>load-instance-declaration <span style="color: #2aa198;">"LHS = Magma opening MagmaR (Carrier to C; _&#10814;_ to _&#8728;_; &#955; x &#8594; x ++ \"&#8242;\")"</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal <span style="color: #2aa198;">"(MagmaR ((Carrier . C)) identity)"</span> <span style="color: #cb4b16;">(</span>format <span style="color: #2aa198;">"%s"</span> <span style="color: #6c71c4;">(</span>instance-declaration-openings <span style="color: #b58900;">(</span>load-instance-declaration <span style="color: #2aa198;">"LHS = Magma opening MagmaR (Carrier to C)"</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

<span style="color: #268bd2;">)</span>
</pre>
</div>
</details>
</div>
</div>

<div id="outline-container-org3251694" class="outline-3">
<h3 id="org3251694"><span class="section-number-3">5.2</span> <code>parse-700-comments</code></h3>
<div class="outline-text-3" id="text-5-2">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #268bd2;">700-comments</span> nil
  <span style="color: #35a69c;">"The contents of the 700-comments.</span>

<span style="color: #35a69c;">   If this variable does not change, we short-circut all processing.</span>
<span style="color: #35a69c;">   See step &#8216;&#189;&#8217; below.</span>
<span style="color: #35a69c;">  "</span><span style="color: #268bd2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #268bd2;">porting-list</span> nil
  <span style="color: #35a69c;">"List of items in 700-comments that are neither PackageFormer declarations</span>
<span style="color: #35a69c;">   nor instantations, and so are ported to the generated file."</span><span style="color: #268bd2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">parse-700-comments</span> <span style="color: #d33682;">()</span>
  <span style="color: #35a69c;">"</span>
<span style="color: #35a69c;">   Parse comments of the form &#8220;{-700 &#8943; -}&#8221; and add all PackageFormer declarations</span>
<span style="color: #35a69c;">   to the &#8216;</span><span style="color: #6c71c4; font-weight: bold;">package-formers</span><span style="color: #35a69c;">&#8217; list and all instantations to the &#8216;</span><span style="color: #6c71c4; font-weight: bold;">instantiations-remaining</span><span style="color: #35a69c;">&#8217; list.</span>
<span style="color: #35a69c;">  "</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">interactive</span><span style="color: #d33682;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">For now, &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">item</span><span style="color: #96A7A9; font-style: italic;">&#8217; is either a PackageFormer or instantiation declaration.</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #859900;">(</span>item lines 700-cmnts<span style="color: #859900;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">0. Catenate all 700-comments into a single string.</span>
  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> 700-cmnts <span style="color: #cb4b16;">(</span>s-join <span style="color: #2aa198;">"\n"</span> <span style="color: #6c71c4;">(</span>buffer-substring-delimited-whole-buffer <span style="color: #2aa198;">"^</span><span style="color: #b58900; font-weight: bold;">\</span><span style="color: #2aa198;">{-700"</span> <span style="color: #2aa198;">"^-</span><span style="color: #b58900; font-weight: bold;">\</span><span style="color: #2aa198;">}"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #cb4b16;">(</span>equal 700-comments 700-cmnts<span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>message <span style="color: #2aa198;">"700-comments Unchanged."</span><span style="color: #cb4b16;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">&#189;. Update global.</span>
    <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> 700-comments 700-cmnts<span style="color: #cb4b16;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">1. View comments as a sequence of lines, ignore empty lines ---which are not in our grammar.</span>
    <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> lines <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">--remove</span> <span style="color: #b58900;">(</span>s-blank? <span style="color: #35a69c;">(</span>s-collapse-whitespace it<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>s-lines 700-comments<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">2. Traverse the 700-comments:</span>
    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">If we view a &#8220;lhs = rhs&#8221; equation, add to global &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">instantiations-remaining</span><span style="color: #96A7A9; font-style: italic;">&#8217; list.</span>
    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">If we view a PackageFormer declaration, add to global &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">package-formers</span><span style="color: #96A7A9; font-style: italic;">&#8217; list.</span>
    <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">while</span> lines
     <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">setq</span> item <span style="color: #b58900;">(</span>car lines<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>load-instance-declaration item<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> lines <span style="color: #35a69c;">(</span>cdr lines<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span>
       <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Else we have a PackageFormer declaration and other possiblly-non-700 items.</span>
       <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> item <span style="color: #35a69c;">(</span>get-children <span style="color: #2aa198;">"PackageFormer"</span> lines<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span>
       <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">push</span> <span style="color: #35a69c;">(</span>s-join <span style="color: #2aa198;">"\n"</span> <span style="color: #6c71c4;">(</span>car item<span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span> porting-list<span style="color: #b58900;">)</span> <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">port non-700 items to generated file</span>
       <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">when</span> <span style="color: #35a69c;">(</span>cadr item<span style="color: #35a69c;">)</span> <span style="color: #35a69c;">(</span>add-to-list 'package-formers <span style="color: #6c71c4;">(</span>parse-package-former <span style="color: #859900;">(</span>cadr item<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span> <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">acknowledge PackageFormer declaration, if any</span>
       <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> lines <span style="color: #35a69c;">(</span>caddr item<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>                                        <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Update lines to be the unconsidered porition of the wild comments.</span>

  <span style="color: #cb4b16;">(</span>message <span style="color: #2aa198;">"Finished parsing 700-comments."</span><span style="color: #cb4b16;">)</span>
  <span style="color: #859900;">)</span>
<span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>

<p>
Let's test this out on our sample input file, <code>Testing.agda</code>.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">progn</span>
  <span style="color: #d33682;">(</span>find-file <span style="color: #2aa198;">"Testing.agda"</span><span style="color: #d33682;">)</span>

  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">setq</span> package-formers nil<span style="color: #d33682;">)</span> <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">setq</span> 700-comments nil<span style="color: #d33682;">)</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">setq</span> instantiations-remaining nil<span style="color: #d33682;">)</span>
  <span style="color: #d33682;">(</span>parse-700-comments<span style="color: #d33682;">)</span>

  <span style="color: #d33682;">(</span>switch-to-buffer <span style="color: #2aa198;">"PackageFormer.org"</span><span style="color: #d33682;">)</span>

  <span style="color: #d33682;">(</span>s-join <span style="color: #2aa198;">"\n\n"</span>
          <span style="color: #859900;">(</span>list <span style="color: #cb4b16;">(</span>s-trim 700-comments<span style="color: #cb4b16;">)</span>
                <span style="color: #cb4b16;">(</span>pp package-formers<span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>pp instantiations-remaining<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #0000cd;">variable</span>
   &#8467; :<span style="color: #b58900; font-style: italic;"> Level</span>

<span style="color: #b58900; font-style: italic;">PackageFormer Monoid</span> (<span style="color: #0000cd;">v</span> :<span style="color: #b58900; font-style: italic;"> Variation</span>) : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
    <span style="color: #b58900; font-style: italic;">_&#10814;_</span>     : <span style="color: #b58900; font-style: italic;">Monoid v &#8594; Monoid v &#8594; Monoid v</span>
   <span style="color: #b58900; font-style: italic;"> Id</span>      : <span style="color: #b58900; font-style: italic;">Monoid v</span>
    <span style="color: #b58900; font-style: italic;">assoc</span>   : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
    <span style="color: #b58900; font-style: italic;">leftId</span>  : &#8704; {<span style="color: #0000cd;">x</span> : <span style="color: #b58900; font-style: italic;">Monoid v} &#8594; Id &#10814; x &#8801; x</span>
    <span style="color: #b58900; font-style: italic;">rightId</span> : &#8704; {<span style="color: #0000cd;">x</span> : <span style="color: #b58900; font-style: italic;">Monoid v} &#8594; x &#10814; Id &#8801; x</span>

M<span style="color: #0000cd;">onoidTypeclass</span> <span style="color: #859900; font-weight: bold;">=</span><span style="color: #b58900; font-style: italic;"> Monoid</span> <span style="color: #859900; font-weight: bold;">typeclass</span> <span style="color: #859900; font-weight: bold;">hiding</span> (<span style="color: #b58900; font-style: italic;">_&#10814;_</span>)
M<span style="color: #0000cd;">onoidT</span> <span style="color: #859900; font-weight: bold;">=</span><span style="color: #b58900; font-style: italic;"> Monoid</span> <span style="color: #859900; font-weight: bold;">typeclass</span> <span style="color: #859900; font-weight: bold;">renaming</span><span style="color: #b58900; font-style: italic;"> (Carrier</span> <span style="color: #0000cd;">to</span><span style="color: #b58900; font-style: italic;"> C</span>; <span style="color: #b58900; font-style: italic;">_&#10814;_</span> <span style="color: #0000cd;">to</span> _&#8853;_)
M<span style="color: #0000cd;">onoidR</span> <span style="color: #859900; font-weight: bold;">=</span><span style="color: #b58900; font-style: italic;"> Monoid</span> <span style="color: #859900; font-weight: bold;">record</span> <span style="color: #0000cd;">unbundling</span> <span style="color: #a020f0;">2</span>

(#<span style="color: #0000cd;">s</span>(<span style="color: #0000cd;">package-former</span> <span style="color: #0000cd;">nil</span> <span style="color: #2aa198;">"PackageFormer"</span> <span style="color: #2aa198;">"Monoid"</span> <span style="color: #2aa198;">""</span> <span style="color: #a020f0;">1</span> <span style="color: #a020f0;">4</span>
                   (<span style="color: #2aa198;">"v : Variation"</span> <span style="color: #2aa198;">"Monoid v : Set"</span> <span style="color: #2aa198;">"_&#10814;_     : Monoid v &#8594; Monoid v &#8594; Monoid v"</span> <span style="color: #2aa198;">"Id      : Monoid v"</span> <span style="color: #2aa198;">"assoc   : &#8704; {x y z} &#8594; (x &#10814; y) &#10814; z &#8801; x &#10814; (y &#10814; z)"</span> <span style="color: #2aa198;">"leftId  : &#8704; {x : Monoid v} &#8594; Id &#10814; x &#8801; x"</span> <span style="color: #2aa198;">"rightId : &#8704; {x : Monoid v} &#8594; x &#10814; Id &#8801; x"</span>)))


(#<span style="color: #0000cd;">s</span>(<span style="color: #0000cd;">instance-declaration</span> <span style="color: #2aa198;">"MonoidR = Monoid record unbundling 2"</span> <span style="color: #2aa198;">"MonoidR"</span> <span style="color: #2aa198;">"Monoid"</span> <span style="color: #2aa198;">"record"</span> <span style="color: #a020f0;">2</span> <span style="color: #0000cd;">nil</span> <span style="color: #0000cd;">nil</span> <span style="color: #0000cd;">nil</span> <span style="color: #0000cd;">nil</span> <span style="color: #0000cd;">nil</span>)
   #<span style="color: #0000cd;">s</span>(<span style="color: #0000cd;">instance-declaration</span> <span style="color: #2aa198;">"MonoidT = Monoid typeclass renaming (Carrier to C; _&#10814;_ to _&#8853;_)"</span> <span style="color: #2aa198;">"MonoidT"</span> <span style="color: #2aa198;">"Monoid"</span> <span style="color: #2aa198;">"typeclass"</span> <span style="color: #a020f0;">0</span>
                           ((<span style="color: #2aa198;">"Carrier"</span> . <span style="color: #2aa198;">"C"</span>)
                            (<span style="color: #2aa198;">"_&#10814;_"</span> . <span style="color: #2aa198;">"_&#8853;_"</span>))
                           <span style="color: #0000cd;">nil</span> <span style="color: #0000cd;">nil</span> <span style="color: #0000cd;">nil</span> <span style="color: #0000cd;">nil</span>)
   #<span style="color: #0000cd;">s</span>(<span style="color: #0000cd;">instance-declaration</span> <span style="color: #2aa198;">"MonoidTypeclass = Monoid typeclass hiding (_&#10814;_)"</span> <span style="color: #2aa198;">"MonoidTypeclass"</span> <span style="color: #2aa198;">"Monoid"</span> <span style="color: #2aa198;">"typeclass"</span> <span style="color: #a020f0;">0</span> <span style="color: #0000cd;">nil</span>
                           (<span style="color: #2aa198;">"_&#10814;_"</span>)
                           <span style="color: #0000cd;">nil</span> <span style="color: #0000cd;">nil</span> <span style="color: #0000cd;">nil</span>))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org90f2f8f" class="outline-2">
<h2 id="org90f2f8f"><span class="section-number-2">6</span> <code>instantiate</code> &#x2014;the core utility</h2>
<div class="outline-text-2" id="text-6">
<p>
Let's put the pieces together.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">instantiate</span> <span style="color: #d33682;">(</span>decls <span style="color: #b58900; font-style: italic;">&amp;key</span>

  new-name <span style="color: #859900;">(</span>type <span style="color: #2aa198;">"record"</span><span style="color: #859900;">)</span> carrier
  name-suffix
  universe-of-discourse

  omit-level-decl
  <span style="color: #859900;">(</span>waist 0<span style="color: #859900;">)</span>
  waist-strings
  prefix-fields
  suffix-fields
  <span style="color: #859900;">(</span>keep-fields <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #6c71c4;">(</span>x<span style="color: #6c71c4;">)</span> t<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
  <span style="color: #859900;">(</span>alter-raw-fields #'identity<span style="color: #859900;">)</span>
  <span style="color: #859900;">(</span>alter-fields #'identity<span style="color: #859900;">)</span>
  docstring
  <span style="color: #859900;">(</span>inc-level t<span style="color: #859900;">)</span>
  <span style="color: #d33682;">)</span>

  <span style="color: #35a69c;">"Given a PackageFormer declaration, instantiate it into a concrete Agda type.</span>

<span style="color: #35a69c;">   Remarks or example values:</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">decls</span><span style="color: #35a69c;">&#8217; is immediately provided to &#8216;</span><span style="color: #6c71c4; font-weight: bold;">get-children</span><span style="color: #35a69c;">&#8217;, so it may be a string,</span>
<span style="color: #35a69c;">      a list, or a value of type &#8216;</span><span style="color: #6c71c4; font-weight: bold;">package-former</span><span style="color: #35a69c;">&#8217;.</span>
<span style="color: #35a69c;">      NOTE: If you do pass in a &#8216;</span><span style="color: #6c71c4; font-weight: bold;">package-former</span><span style="color: #35a69c;">&#8217;, we will not alter yours;</span>
<span style="color: #35a69c;">      we will copy it and work with the local copy.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">type</span><span style="color: #35a69c;">&#8217;: The replacement for &#8220;PackageFormer&#8221;; default is &#8220;record&#8221;.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">carrier</span><span style="color: #35a69c;">&#8217;: What is the carrier of this new instance? E.g., &#8220;Carrier&#8221;.</span>
<span style="color: #35a69c;">      By default it's the &#8216;</span><span style="color: #6c71c4; font-weight: bold;">new-name</span><span style="color: #35a69c;">&#8217;; but this is unresonable when, say, a typeclass</span>
<span style="color: #35a69c;">      variation is requested.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">name-suffix</span><span style="color: #35a69c;">&#8217;: When no &#8216;</span><span style="color: #6c71c4; font-weight: bold;">new-name</span><span style="color: #35a69c;">&#8217; is provided, the default is</span>
<span style="color: #35a69c;">      &#8220;&#10218;PackageFormer'sName&#10219;-&#10218;variation&#10219;-g*&#8221;, where &#8216;*&#8217; is an arbitrarily generated number.</span>

<span style="color: #35a69c;">     This may be useful for rapid development when one does not want to provide</span>
<span style="color: #35a69c;">     a name to an instance, but simply wants the instance to exist.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">waist</span><span style="color: #35a69c;">&#8217;: Agda grouping mechanisms ---e.g., record, data, module, function---</span>
<span style="color: #35a69c;">      essentially take a list of parameters. The nebulous consitutents of a PackageFormer</span>
<span style="color: #35a69c;">      are partitioned into two groups: The first &#8216;</span><span style="color: #6c71c4; font-weight: bold;">waist</span><span style="color: #35a69c;">&#8217;-many elements are the parameters,</span>
<span style="color: #35a69c;">      and the remaining are the fields/constructor/constituent componenets.</span>
<span style="color: #35a69c;">      The anaology is that the parameters are like the top-porition of a person,</span>
<span style="color: #35a69c;">      the part you notice immediately, delimited by the waist.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">universe-of-discourse</span><span style="color: #35a69c;">&#8217;: '(&#8220;Carrier&#8221; . &#8220;Set&#8221;); empty string by default.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">waist-strings</span><span style="color: #35a69c;">&#8217;: List of additional strings to insert at the waist position.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">has-level-decl</span><span style="color: #35a69c;">&#8217;: Is the top-most level to appear?</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">prefix-fields</span><span style="color: #35a69c;">&#8217;: List of fields, &#8220;name : type&#8221;, to be added at the beginning</span>
<span style="color: #35a69c;">      of the field declaration. Default is empty string.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">suffix-fields</span><span style="color: #35a69c;">&#8217;: List of fields, &#8220;name : type&#8221;, to be added at the beginning</span>
<span style="color: #35a69c;">      of the field declaration. Default is empty string.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">keep-fields</span><span style="color: #35a69c;">&#8217;: Predicate that determines which fields should be kept.</span>
<span style="color: #35a69c;">      By default, no fields are dropped.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">alter-raw-fields</span><span style="color: #35a69c;">&#8217;: A function that alters the list of fields of a PackageFormer *before*</span>
<span style="color: #35a69c;">     any processing has transpiried. This is the identity function by default.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">alter-fields</span><span style="color: #35a69c;">&#8217;: A function to alter existing fields *after* processing;</span>
<span style="color: #35a69c;">     it does not alter inserted fields via &#8216;</span><span style="color: #6c71c4; font-weight: bold;">prefix-fields</span><span style="color: #35a69c;">&#8217; nor &#8216;</span><span style="color: #6c71c4; font-weight: bold;">suffix-fields</span><span style="color: #35a69c;">&#8217;.</span>
<span style="color: #35a69c;">     This is the identity function by default.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">docstring</span><span style="color: #35a69c;">&#8217;: What is the parent PackageFormer, or instance declaration, of</span>
<span style="color: #35a69c;">     the currently intantiated data-type.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">inc-level</span><span style="color: #35a69c;">&#8217;: Should the level be incremented? Yes, by default.</span>
<span style="color: #35a69c;">  "</span>

  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #859900;">(</span><span style="color: #cb4b16;">(</span>pf <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>package-former-p decls<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>copy-package-former decls<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>parse-package-former <span style="color: #35a69c;">(</span>cadr <span style="color: #6c71c4;">(</span>get-children <span style="color: #2aa198;">"PackageFormer"</span> decls<span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
         <span style="color: #cb4b16;">(</span>pf-name <span style="color: #6c71c4;">(</span>package-former-name pf<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
         <span style="color: #cb4b16;">(</span>variation <span style="color: #6c71c4;">(</span>car <span style="color: #b58900;">(</span>s-split <span style="color: #2aa198;">" : "</span> <span style="color: #35a69c;">(</span>car <span style="color: #6c71c4;">(</span>package-former-elements pf<span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
         <span style="color: #cb4b16;">(</span>pfv <span style="color: #6c71c4;">(</span>concat pf-name <span style="color: #2aa198;">" "</span> variation<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
         <span style="color: #cb4b16;">(</span>fields     <span style="color: #6c71c4;">(</span>funcall alter-raw-fields <span style="color: #b58900;">(</span>package-former-elements pf<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
         <span style="color: #859900;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">-1. Source generation declaration.</span>
  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setf</span> <span style="color: #cb4b16;">(</span>package-former-docstring pf<span style="color: #cb4b16;">)</span>
    <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">or</span> docstring <span style="color: #6c71c4;">(</span>format <span style="color: #2aa198;">"This was generated from the PackageFormer %s ."</span> pf-name<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">0. Replace "PackageFormer" string with provided &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">type</span><span style="color: #96A7A9; font-style: italic;">&#8217; qualifier.</span>
  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setf</span> <span style="color: #cb4b16;">(</span>package-former-type pf<span style="color: #cb4b16;">)</span> type<span style="color: #859900;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">1. First element is always the variation; let's drop it.</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Instantiations should not have an abstract varation component.</span>
  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setf</span> <span style="color: #cb4b16;">(</span>package-former-elements pf<span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>cdr <span style="color: #6c71c4;">(</span>package-former-elements pf<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">&#189;. TODO: When we move to multi-sorted, as in Graphs, this issue will need to be revisited.</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">If the carrier is not exposed, then we need to increase the level.</span>
  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">when</span> <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #6c71c4;">(</span>equal waist 0<span style="color: #6c71c4;">)</span> inc-level<span style="color: #cb4b16;">)</span>
    <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setf</span> <span style="color: #6c71c4;">(</span>package-former-level pf<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>format <span style="color: #2aa198;">" (Level.suc %s)"</span>
           <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #35a69c;">(</span>s-blank? <span style="color: #6c71c4;">(</span>package-former-level pf<span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span>
               <span style="color: #2aa198;">"Level.zero"</span> <span style="color: #35a69c;">(</span>package-former-level pf<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">2. Replace all occurences of &#8220;package-former-name followed by variation&#8221;</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">with &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">carrier</span><span style="color: #96A7A9; font-style: italic;">&#8217;, if any.</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Default value of &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">new-name</span><span style="color: #96A7A9; font-style: italic;">&#8217; &amp; &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">carrier</span><span style="color: #96A7A9; font-style: italic;">&#8217; are &#10218;PackageFormer'sName&#10219;-&#10218;name-suffix&#10219;.</span>
  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">unless</span> new-name
    <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> new-name <span style="color: #6c71c4;">(</span>concat <span style="color: #b58900;">(</span>package-former-name pf<span style="color: #b58900;">)</span> <span style="color: #2aa198;">"-"</span> name-suffix<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">unless</span> carrier  <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> carrier new-name<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setf</span> fields
          <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">--map</span> <span style="color: #6c71c4;">(</span>s-replace pfv carrier it<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>package-former-elements pf<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">3. Replace PackageFormer's name with provided instantiation name.</span>
  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setf</span> <span style="color: #cb4b16;">(</span>package-former-name pf<span style="color: #cb4b16;">)</span> new-name<span style="color: #859900;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">4. Insert new fields and process the altered existing fields.</span>
  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setf</span> <span style="color: #cb4b16;">(</span>package-former-elements pf<span style="color: #cb4b16;">)</span>
        <span style="color: #cb4b16;">(</span>-concat
             prefix-fields
               <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Perform any processing on the fields.</span>
               <span style="color: #6c71c4;">(</span>funcall alter-fields <span style="color: #b58900;">(</span>-filter keep-fields fields<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>
             suffix-fields
           <span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">5. Set the new waist</span>
  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setf</span> <span style="color: #cb4b16;">(</span>package-former-waist pf<span style="color: #cb4b16;">)</span> waist<span style="color: #859900;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">6. Stringify!</span>
  <span style="color: #859900;">(</span>show-package-former pf <span style="color: #d33682; font-weight: bold; font-style: italic;">:waist-strings</span> waist-strings
                          <span style="color: #d33682; font-weight: bold; font-style: italic;">:omit-level</span>    omit-level-decl
                       <span style="color: #859900;">)</span>

 <span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>
</pre>
</div>

<p>
Let's instantiate our test example from earlier to produce a two-argument typeclass:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span>instantiate test   <span style="color: #93a1a1;">; </span><span style="color: #96A7A9; font-style: italic;">:new-name "SemigroupT"</span>
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:name-suffix</span> <span style="color: #2aa198;">"On"</span>
                    <span style="color: #93a1a1;">; </span><span style="color: #96A7A9; font-style: italic;">:type "record"</span>
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:carrier</span> <span style="color: #2aa198;">"Carrier"</span>
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:docstring</span> <span style="color: #2aa198;">"Look ma: The Carrier and the op are exposed!"</span>
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:waist-strings</span> <span style="color: #d33682;">(</span>list <span style="color: #2aa198;">"field"</span><span style="color: #d33682;">)</span>
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:waist</span> <span style="color: #d33682;">(</span>1+ 1<span style="color: #d33682;">)</span> <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">We're lifting upwards the visible _&#10814;_</span>
                                  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Whereas &#8220;Carrier&#8221; is not visible, but</span>
                                  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">an implicit necessity.</span>
                    <span style="color: #268bd2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">Look ma: The Carrier and the op are exposed! </span><span style="color: #93a1a1;">-}</span>
<span style="color: #859900; font-weight: bold;">record</span><span style="color: #b58900; font-style: italic;"> Semigroup-On (Carrier</span> : <span style="color: #859900; font-weight: bold;">Set</span>) (<span style="color: #b58900; font-style: italic;">_&#10814;_</span> :<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span>) : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
  <span style="color: #859900; font-weight: bold;">field</span>
   <span style="color: #b58900; font-style: italic;"> Id</span>  :<span style="color: #b58900; font-style: italic;"> Carrier</span>
    <span style="color: #b58900; font-style: italic;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
</pre>
</div>

<p>
What about a bundled up record declaration? Simple, we leave the waist with default value zero.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span>instantiate test   <span style="color: #d33682; font-weight: bold; font-style: italic;">:name-suffix</span> <span style="color: #2aa198;">"semantics"</span>
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:type</span> <span style="color: #2aa198;">"record"</span>
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:carrier</span> <span style="color: #2aa198;">"Carrier"</span>
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:waist-strings</span> <span style="color: #d33682;">(</span>list <span style="color: #2aa198;">"field"</span><span style="color: #d33682;">)</span>
                    <span style="color: #268bd2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">This was generated from the PackageFormer Semigroup . </span><span style="color: #93a1a1;">-}</span>
<span style="color: #859900; font-weight: bold;">record</span> <span style="color: #b58900; font-style: italic;">Semigroup-semantics</span> : <span style="color: #859900; font-weight: bold;">Set</span><span style="color: #b58900; font-style: italic;"> (Level</span>.<span style="color: #0000cd;">suc</span><span style="color: #b58900; font-style: italic;"> Level</span>.<span style="color: #0000cd;">zero</span>) <span style="color: #859900; font-weight: bold;">where</span>
  <span style="color: #859900; font-weight: bold;">field</span>
   <span style="color: #b58900; font-style: italic;"> Carrier</span> : <span style="color: #859900; font-weight: bold;">Set</span>
    <span style="color: #b58900; font-style: italic;">_&#10814;_</span> :<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span>
   <span style="color: #b58900; font-style: italic;"> Id</span>  :<span style="color: #b58900; font-style: italic;"> Carrier</span>
    <span style="color: #b58900; font-style: italic;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)
</pre>
</div>

<p>
Records provide a semantics, what if we want the syntax?
Since <code>data</code> declarations consist of constructors, whose target type necessarily
begins with the name of the <code>data</code>-type being defined, let's only keep those <a href="#orga516fc5">fields</a> and drop the rest.
</p>

<p>
First, a helper function.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">field-target</span> <span style="color: #d33682;">(</span>field<span style="color: #d33682;">)</span>
  <span style="color: #35a69c;">"Given a declaration &#8220;name : type0 &#8594; &#8943; &#8594; typeN&#8221;, yield &#8220;typeN&#8221;. "</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">ignore-errors</span> <span style="color: #859900;">(</span>car <span style="color: #cb4b16;">(</span>-take-last 1 <span style="color: #6c71c4;">(</span>s-split <span style="color: #2aa198;">"&#8594;"</span> field<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Ignore errors since field may be nil.</span>
<span style="color: #268bd2;">)</span>
</pre>
</div>

<p>
Let's test it out:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">-let</span> <span style="color: #d33682;">[</span>pf-name <span style="color: #2aa198;">"Semigroup-syntax"</span><span style="color: #d33682;">]</span>

  <span style="color: #d33682;">(</span>list <span style="color: #859900;">(</span>s-contains? pf-name <span style="color: #cb4b16;">(</span>field-target <span style="color: #2aa198;">"Id    :  Semigroup-syntax"</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
        <span style="color: #859900;">(</span>s-contains? pf-name <span style="color: #cb4b16;">(</span>field-target <span style="color: #2aa198;">"_&#10814;_   :  Semigroup-syntax &#8594; Semigroup-syntax &#8594; Semigroup-syntax"</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
        <span style="color: #859900;">(</span>s-contains? pf-name <span style="color: #cb4b16;">(</span>field-target <span style="color: #2aa198;">"assoc :  &#8704; {x y z} &#8594; (x &#10814; y) &#10814; z &#8801; x &#10814; (y &#10814; z)"</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
        <span style="color: #859900;">(</span>s-contains? pf-name <span style="color: #cb4b16;">(</span>field-target <span style="color: #2aa198;">"Semigroup-syntax : Set"</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">t</td>
<td class="org-left">t</td>
<td class="org-left">nil</td>
<td class="org-left">t</td>
</tr>
</tbody>
</table>

<p>
As the last test case shows, the name position of a declaration could have
a data-type name &#x2013;which is not allowed in Agda since constructors share the
same namespace as types, yet this property is not ensured in our generation;
so let's sanitise for it.
</p>

<p>
Now a real use case.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">-let</span> <span style="color: #d33682;">[</span>pf-name <span style="color: #2aa198;">"Semigroup-syntax"</span><span style="color: #d33682;">]</span>

  <span style="color: #d33682;">(</span>instantiate test  <span style="color: #d33682; font-weight: bold; font-style: italic;">:name-suffix</span> <span style="color: #2aa198;">"syntax"</span>
                     <span style="color: #d33682; font-weight: bold; font-style: italic;">:type</span> <span style="color: #2aa198;">"data"</span>
                     <span style="color: #d33682; font-weight: bold; font-style: italic;">:new-name</span> pf-name
                     <span style="color: #d33682; font-weight: bold; font-style: italic;">:inc-level</span> nil   <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Necessary, since true by default.</span>
                     <span style="color: #d33682; font-weight: bold; font-style: italic;">:keep-fields</span> <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #cb4b16;">(</span>f<span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>s-contains? pf-name <span style="color: #6c71c4;">(</span>field-target <span style="color: #b58900;">(</span>cadr <span style="color: #35a69c;">(</span>s-split <span style="color: #2aa198;">":"</span> f<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
                     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">:alter-fields (lambda (fs) (--map (format "Nice-%s" it) fs))</span>
                    <span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">This was generated from the PackageFormer Semigroup . </span><span style="color: #93a1a1;">-}</span>
<span style="color: #859900; font-weight: bold;">data</span> <span style="color: #b58900; font-style: italic;">Semigroup-syntax</span> : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
    <span style="color: #b58900; font-style: italic;">_&#10814;_</span> : <span style="color: #b58900; font-style: italic;">Semigroup-syntax</span> &#8594; <span style="color: #b58900; font-style: italic;">Semigroup-syntax</span> &#8594; <span style="color: #b58900; font-style: italic;">Semigroup-syntax</span>
   <span style="color: #b58900; font-style: italic;"> Id</span>  : <span style="color: #b58900; font-style: italic;">Semigroup-syntax</span>
</pre>
</div>

<p>
Yeehaw! We've got three variations and possibly much more from a single fancy well-toggled
function 🤠 We can emulate generative modules this way too! 😻
</p>

<p>
Let's package these particular toggle configurations into their own functions.
</p>

<p>
The instantations are straight-forward:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">instantiate-as-data</span> <span style="color: #d33682;">(</span>decls <span style="color: #b58900; font-style: italic;">&amp;key</span> new-name <span style="color: #859900;">(</span>carrier <span style="color: #2aa198;">"Carrier"</span><span style="color: #859900;">)</span> docstring <span style="color: #859900;">(</span>alter-fields #'identity<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>waist 0<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

  <span style="color: #35a69c;">"Given a PackageFormer declaration, instantiate it into a concrete Agda record.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">decls</span><span style="color: #35a69c;">&#8217; is immediately provided to &#8216;</span><span style="color: #6c71c4; font-weight: bold;">get-children</span><span style="color: #35a69c;">&#8217;, so it may be a string,</span>
<span style="color: #35a69c;">      a list, or a value of type &#8216;</span><span style="color: #6c71c4; font-weight: bold;">package-former</span><span style="color: #35a69c;">&#8217;.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">new-name</span><span style="color: #35a69c;">&#8217; is the name of the resulting instance.</span>
<span style="color: #35a69c;">     Default is &#8220;&#10218;PackageFormer'sName&#10219;-record-g*&#8221; for a random sequence of digits &#8216;*&#8217;.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">carrier</span><span style="color: #35a69c;">&#8217;: What is the carrier of this new instance? Default is &#8220;Carrier&#8221;.</span>

<span style="color: #35a69c;">   - TODO: Document remaining arguments.</span>
<span style="color: #35a69c;">  "</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #859900;">(</span><span style="color: #cb4b16;">(</span>pf <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>package-former-p decls<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>copy-package-former decls<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>parse-package-former <span style="color: #35a69c;">(</span>cadr <span style="color: #6c71c4;">(</span>get-children <span style="color: #2aa198;">"PackageFormer"</span> decls<span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
         <span style="color: #cb4b16;">(</span>pf-name <span style="color: #6c71c4;">(</span>package-former-name pf<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

    <span style="color: #859900;">(</span>instantiate pf  <span style="color: #d33682; font-weight: bold; font-style: italic;">:new-name</span> new-name
                       <span style="color: #d33682; font-weight: bold; font-style: italic;">:name-suffix</span> <span style="color: #2aa198;">"syntax"</span>
                       <span style="color: #d33682; font-weight: bold; font-style: italic;">:type</span> <span style="color: #2aa198;">"data"</span>
                       <span style="color: #d33682; font-weight: bold; font-style: italic;">:inc-level</span> nil
                       <span style="color: #d33682; font-weight: bold; font-style: italic;">:keep-fields</span> <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #6c71c4;">(</span>f<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>s-contains? pf-name <span style="color: #b58900;">(</span>field-target <span style="color: #35a69c;">(</span>cadr <span style="color: #6c71c4;">(</span>s-split <span style="color: #2aa198;">":"</span> f<span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
                       <span style="color: #d33682; font-weight: bold; font-style: italic;">:docstring</span> docstring
                       <span style="color: #d33682; font-weight: bold; font-style: italic;">:alter-fields</span> alter-fields
                       <span style="color: #d33682; font-weight: bold; font-style: italic;">:waist</span> waist
                      <span style="color: #859900;">)</span>
  <span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">instantiate-as-unbundled</span> <span style="color: #d33682;">(</span>depth decls <span style="color: #b58900; font-style: italic;">&amp;key</span> new-name name-suffix <span style="color: #859900;">(</span>carrier <span style="color: #2aa198;">"Carrier"</span><span style="color: #859900;">)</span> docstring <span style="color: #859900;">(</span>alter-fields #'identity<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>waist 0<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

  <span style="color: #35a69c;">"Given a PackageFormer declaration, instantiate it into a concrete Agda &#8220;record&#8221;</span>
<span style="color: #35a69c;">  where the first &#8216;</span><span style="color: #6c71c4; font-weight: bold;">depth</span><span style="color: #35a69c;">&#8217; constituents of the PackageFormer are now parameters.</span>

<span style="color: #35a69c;">  In the case &#8216;</span><span style="color: #6c71c4; font-weight: bold;">depth</span><span style="color: #35a69c;">&#8217; is 1 we obtain the &#8216;</span><span style="color: #6c71c4; font-weight: bold;">typeclass</span><span style="color: #35a69c;">&#8217; persepctive and the case</span>
<span style="color: #35a69c;">  it is 0, we obtain a fully bundled perspective.</span>

<span style="color: #35a69c;">  The extra &#8216;</span><span style="color: #6c71c4; font-weight: bold;">wasit</span><span style="color: #35a69c;">&#8217; is for the &#8216;</span><span style="color: #6c71c4; font-weight: bold;">unbundled</span><span style="color: #35a69c;">&#8217; variational clause.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">decls</span><span style="color: #35a69c;">&#8217; is immediately provided to &#8216;</span><span style="color: #6c71c4; font-weight: bold;">get-children</span><span style="color: #35a69c;">&#8217;, so it may be a string,</span>
<span style="color: #35a69c;">      a list, or a value of type &#8216;</span><span style="color: #6c71c4; font-weight: bold;">package-former</span><span style="color: #35a69c;">&#8217;.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">new-name</span><span style="color: #35a69c;">&#8217; is the name of the resulting instance.</span>
<span style="color: #35a69c;">     Default is &#8220;&#10218;PackageFormer'sName&#10219;-record-g*&#8221; for a random sequence of digits &#8216;*&#8217;.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">carrier</span><span style="color: #35a69c;">&#8217;: What is the carrier of this new instance? Default is &#8220;Carrier&#8221;.</span>

<span style="color: #35a69c;">  "</span>
  <span style="color: #d33682;">(</span>instantiate decls <span style="color: #d33682; font-weight: bold; font-style: italic;">:new-name</span> new-name
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:name-suffix</span> name-suffix
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:type</span> <span style="color: #2aa198;">"record"</span>
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:carrier</span> carrier
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:docstring</span> docstring
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:waist-strings</span> <span style="color: #859900;">(</span>list <span style="color: #2aa198;">"field"</span><span style="color: #859900;">)</span>
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:waist</span> <span style="color: #859900;">(</span>+ depth waist<span style="color: #859900;">)</span>
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:alter-fields</span> alter-fields
                    <span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>
</pre>
</div>

<p>
That's a lot of mumbo jumbo, let's have a sanity check.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span>s-join <span style="color: #2aa198;">"\n\n"</span> <span style="color: #d33682;">(</span>list
 <span style="color: #859900;">(</span>instantiate-as-unbundled 1 test <span style="color: #d33682; font-weight: bold; font-style: italic;">:name-suffix</span> <span style="color: #2aa198;">"On"</span><span style="color: #859900;">)</span> <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">typeclass</span>
 <span style="color: #859900;">(</span>instantiate-as-unbundled 0 test <span style="color: #d33682; font-weight: bold; font-style: italic;">:name-suffix</span> <span style="color: #2aa198;">"semantics"</span><span style="color: #859900;">)</span> <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">record</span>
 <span style="color: #859900;">(</span>instantiate-as-data test<span style="color: #859900;">)</span>
<span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">This was generated from the PackageFormer Semigroup . </span><span style="color: #93a1a1;">-}</span>
<span style="color: #859900; font-weight: bold;">record</span><span style="color: #b58900; font-style: italic;"> Semigroup-On (Carrier</span> : <span style="color: #859900; font-weight: bold;">Set</span>) : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
  <span style="color: #859900; font-weight: bold;">field</span>
    <span style="color: #b58900; font-style: italic;">_&#10814;_</span> :<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span>
   <span style="color: #b58900; font-style: italic;"> Id</span>  :<span style="color: #b58900; font-style: italic;"> Carrier</span>
    <span style="color: #b58900; font-style: italic;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)

<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">This was generated from the PackageFormer Semigroup . </span><span style="color: #93a1a1;">-}</span>
<span style="color: #859900; font-weight: bold;">record</span> <span style="color: #b58900; font-style: italic;">Semigroup-semantics</span> : <span style="color: #859900; font-weight: bold;">Set</span><span style="color: #b58900; font-style: italic;"> (Level</span>.<span style="color: #0000cd;">suc</span><span style="color: #b58900; font-style: italic;"> Level</span>.<span style="color: #0000cd;">zero</span>) <span style="color: #859900; font-weight: bold;">where</span>
  <span style="color: #859900; font-weight: bold;">field</span>
   <span style="color: #b58900; font-style: italic;"> Carrier</span> : <span style="color: #859900; font-weight: bold;">Set</span>
    <span style="color: #b58900; font-style: italic;">_&#10814;_</span> :<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span>
   <span style="color: #b58900; font-style: italic;"> Id</span>  :<span style="color: #b58900; font-style: italic;"> Carrier</span>
    <span style="color: #b58900; font-style: italic;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)

<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">This was generated from the PackageFormer Semigroup . </span><span style="color: #93a1a1;">-}</span>
<span style="color: #859900; font-weight: bold;">data</span> <span style="color: #b58900; font-style: italic;">Semigroup-syntax</span> : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
    <span style="color: #b58900; font-style: italic;">_&#10814;_</span> : <span style="color: #b58900; font-style: italic;">Semigroup-syntax</span> &#8594; <span style="color: #b58900; font-style: italic;">Semigroup-syntax</span> &#8594; <span style="color: #b58900; font-style: italic;">Semigroup-syntax</span>
   <span style="color: #b58900; font-style: italic;"> Id</span>  : <span style="color: #b58900; font-style: italic;">Semigroup-syntax</span>
</pre>
</div>

<p>
Notice that the results contained generated names since no names were provided.
</p>

<p>
Woah, look at that: This' reminiscent of that <a href="#orgb1b97aa">200% increase</a> from earlier ;-)
<b>Moreover</b>, with <code>unbundled</code> we may expose any or all constituents of a package
at will.
</p>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Unit Tests </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">ert-deftest</span> <span style="color: #b58900;">inst</span> <span style="color: #d33682;">()</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Parameterised record</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal <span style="color: #cb4b16;">(</span>instantiate test <span style="color: #d33682; font-weight: bold; font-style: italic;">:carrier</span> <span style="color: #2aa198;">"Carrier"</span> <span style="color: #d33682; font-weight: bold; font-style: italic;">:docstring</span> <span style="color: #2aa198;">""</span> <span style="color: #d33682; font-weight: bold; font-style: italic;">:waist-strings</span> <span style="color: #6c71c4;">(</span>list <span style="color: #2aa198;">"field"</span><span style="color: #6c71c4;">)</span> <span style="color: #d33682; font-weight: bold; font-style: italic;">:waist</span> 2<span style="color: #cb4b16;">)</span>
                 <span style="color: #2aa198;">"{-  -}</span>
<span style="color: #2aa198;">record Semigroup- (Carrier : Set) (_&#10814;_ : Carrier &#8594; Carrier &#8594; Carrier) : Set where</span>
<span style="color: #2aa198;">  field</span>
<span style="color: #2aa198;">    Id  : Carrier</span>
<span style="color: #2aa198;">    assoc : &#8704; {x y z} &#8594; (x &#10814; y) &#10814; z &#8801; x &#10814; (y &#10814; z)"</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal  <span style="color: #cb4b16;">(</span>instantiate-as-unbundled 1 test <span style="color: #d33682; font-weight: bold; font-style: italic;">:name-suffix</span> <span style="color: #2aa198;">"On"</span><span style="color: #cb4b16;">)</span>
                  <span style="color: #2aa198;">"{- This was generated from the PackageFormer Semigroup . -}</span>
<span style="color: #2aa198;">record Semigroup-On (Carrier : Set) : Set where</span>
<span style="color: #2aa198;">  field</span>
<span style="color: #2aa198;">    _&#10814;_ : Carrier &#8594; Carrier &#8594; Carrier</span>
<span style="color: #2aa198;">    Id  : Carrier</span>
<span style="color: #2aa198;">    assoc : &#8704; {x y z} &#8594; (x &#10814; y) &#10814; z &#8801; x &#10814; (y &#10814; z)"</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">ADT, data declaration</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal  <span style="color: #cb4b16;">(</span>instantiate test <span style="color: #d33682; font-weight: bold; font-style: italic;">:type</span> <span style="color: #2aa198;">"data"</span> <span style="color: #d33682; font-weight: bold; font-style: italic;">:new-name</span> <span style="color: #2aa198;">"&#119982;"</span> <span style="color: #d33682; font-weight: bold; font-style: italic;">:docstring</span> <span style="color: #2aa198;">""</span> <span style="color: #d33682; font-weight: bold; font-style: italic;">:inc-level</span> nil
                               <span style="color: #d33682; font-weight: bold; font-style: italic;">:keep-fields</span> <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #b58900;">(</span>f<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>s-contains? <span style="color: #2aa198;">"&#119982;"</span> <span style="color: #35a69c;">(</span>field-target <span style="color: #6c71c4;">(</span>cadr <span style="color: #859900;">(</span>s-split <span style="color: #2aa198;">":"</span> f<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
                  <span style="color: #2aa198;">"{-  -}</span>
<span style="color: #2aa198;">data &#119982; : Set where</span>
<span style="color: #2aa198;">    _&#10814;_ : &#119982; &#8594; &#119982; &#8594; &#119982;</span>
<span style="color: #2aa198;">    Id  : &#119982;"</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

   <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">should</span> <span style="color: #859900;">(</span>equal <span style="color: #cb4b16;">(</span>instantiate-as-data test<span style="color: #cb4b16;">)</span>
                  <span style="color: #2aa198;">"{- This was generated from the PackageFormer Semigroup . -}</span>
<span style="color: #2aa198;">data Semigroup-syntax : Set where</span>
<span style="color: #2aa198;">    _&#10814;_ : Semigroup-syntax &#8594; Semigroup-syntax &#8594; Semigroup-syntax</span>
<span style="color: #2aa198;">    Id  : Semigroup-syntax"</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>

</pre>
</div>
</details>
</div>

<div id="outline-container-org6ab9e88" class="outline-3">
<h3 id="org6ab9e88"><span class="section-number-3">6.1</span> Module instantions</h3>
<div class="outline-text-3" id="text-6-1">
<p>
We can emit module declarations as follows; which may be useful for ADT instantions
of PackageFormers that contain derived operations.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span>instantiate test   <span style="color: #d33682; font-weight: bold; font-style: italic;">:new-name</span> <span style="color: #2aa198;">"Semantics&#8321;"</span>
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:type</span> <span style="color: #2aa198;">"module"</span>
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:carrier</span> <span style="color: #2aa198;">"Carrier"</span>
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:omit-level-decl</span> t
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:waist</span> 4
                    <span style="color: #268bd2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">This was generated from the PackageFormer Semigroup . </span><span style="color: #93a1a1;">-}</span>
<span style="color: #859900; font-weight: bold;">module</span> <span style="color: #a020f0;">Semantics</span>&#8321;<span style="color: #b58900; font-style: italic;"> (Carrier</span> : <span style="color: #859900; font-weight: bold;">Set</span>) (<span style="color: #b58900; font-style: italic;">_&#10814;_</span> :<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span> &#8594;<span style="color: #b58900; font-style: italic;"> Carrier</span>)<span style="color: #b58900; font-style: italic;"> (Id</span> :<span style="color: #b58900; font-style: italic;"> Carrier</span>) (<span style="color: #b58900; font-style: italic;">assoc</span> : &#8704; {<span style="color: #0000cd;">x</span> <span style="color: #0000cd;">y</span> <span style="color: #0000cd;">z</span>} &#8594; (<span style="color: #0000cd;">x</span> &#10814; <span style="color: #0000cd;">y</span>) &#10814; <span style="color: #0000cd;">z</span> &#8801; <span style="color: #0000cd;">x</span> &#10814; (<span style="color: #0000cd;">y</span> &#10814; <span style="color: #0000cd;">z</span>)) <span style="color: #859900; font-weight: bold;">where</span>
</pre>
</div>

<p>
For now, a common scenario is forming modules that re-export a type under a new superficial disguise;
e.g., in the setting where we want to have multiple references to a structure, as in when defining homomorphisms.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">instantiate-as-opening</span> <span style="color: #d33682;">(</span>decls inst<span style="color: #d33682;">)</span>

  <span style="color: #35a69c;">"Given a PackageFormer declaration, instantiate it into a concrete Agda record.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">decls</span><span style="color: #35a69c;">&#8217; is immediately provided to &#8216;</span><span style="color: #6c71c4; font-weight: bold;">get-children</span><span style="color: #35a69c;">&#8217;, so it may be a string,</span>
<span style="color: #35a69c;">      a list, or a value of type &#8216;</span><span style="color: #6c71c4; font-weight: bold;">package-former</span><span style="color: #35a69c;">&#8217;.</span>

<span style="color: #35a69c;">   - &#8216;</span><span style="color: #6c71c4; font-weight: bold;">inst</span><span style="color: #35a69c;">&#8217; is an instance declaration value whose &#8216;</span><span style="color: #6c71c4; font-weight: bold;">openings</span><span style="color: #35a69c;">&#8217; componenet is non-nil.</span>
<span style="color: #35a69c;">  "</span>

  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #859900;">(</span><span style="color: #cb4b16;">(</span>openings <span style="color: #6c71c4;">(</span>instance-declaration-openings inst<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
         <span style="color: #cb4b16;">(</span>new-name <span style="color: #6c71c4;">(</span>instance-declaration-name inst<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
         <span style="color: #cb4b16;">(</span>kind <span style="color: #6c71c4;">(</span>car openings<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
         <span style="color: #cb4b16;">(</span>renames <span style="color: #6c71c4;">(</span>cadr openings<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
         <span style="color: #cb4b16;">(</span>otherwise <span style="color: #6c71c4;">(</span>caddr openings<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

        <span style="color: #859900;">(</span>s-replace <span style="color: #2aa198;">"\t"</span> <span style="color: #2aa198;">"    "</span> <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">replace rabs with spaces</span>
        <span style="color: #cb4b16;">(</span>instantiate decls    <span style="color: #d33682; font-weight: bold; font-style: italic;">:new-name</span> new-name
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:type</span> <span style="color: #2aa198;">"module"</span>
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:docstring</span> <span style="color: #6c71c4;">(</span>instance-declaration-docstring inst<span style="color: #6c71c4;">)</span>
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:omit-level-decl</span> t
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:waist</span> 1
                    <span style="color: #d33682; font-weight: bold; font-style: italic;">:alter-fields</span> <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #b58900;">(</span>fs<span style="color: #b58900;">)</span>
                     <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #35a69c;">(</span>fsnew<span style="color: #35a69c;">)</span>


                       <span style="color: #35a69c;">(</span><span style="color: #859900; font-weight: bold;">loop</span> for <span style="color: #6c71c4;">(</span>old . new<span style="color: #6c71c4;">)</span> in renames
                             do <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">push</span> <span style="color: #859900;">(</span>format <span style="color: #2aa198;">"%s to %s"</span> old new<span style="color: #859900;">)</span> fsnew<span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span>

                       <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">TODO: MA: To consider default &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">otherwise</span><span style="color: #96A7A9; font-style: italic;">&#8217; via opening &#955; x &#8594; x ++ "&#8242;"</span>
                       <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">(read-from-string "(lambda (x) xt)")</span>
                       <span style="color: #93a1a1;">;;</span>

                       <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">HACK: Terrible.</span>
                       <span style="color: #35a69c;">(</span><span style="color: #859900; font-weight: bold;">setq</span> fs <span style="color: #6c71c4;">(</span>cons <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">map-name</span> <span style="color: #2aa198;">"Carrier"</span> <span style="color: #268bd2;">(</span>car fs<span style="color: #268bd2;">)</span><span style="color: #859900;">)</span> <span style="color: #859900;">(</span>cdr fs<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span>

                       <span style="color: #35a69c;">(</span><span style="color: #859900; font-weight: bold;">loop</span> for f in fs
                             do <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">unless</span> <span style="color: #859900;">(</span>assoc <span style="color: #268bd2;">(</span>get-name f<span style="color: #268bd2;">)</span> renames<span style="color: #859900;">)</span>
                                  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">push</span> <span style="color: #268bd2;">(</span>format <span style="color: #2aa198;">"%s to %s"</span> <span style="color: #d33682;">(</span>get-name f<span style="color: #d33682;">)</span>
                                                <span style="color: #d33682;">(</span>rename-mixfix otherwise <span style="color: #859900;">(</span>get-name f<span style="color: #859900;">)</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
                                        fsnew<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span>

                       <span style="color: #35a69c;">(</span><span style="color: #859900; font-weight: bold;">thread-last</span>
                        <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Resulting elements must be a list, so we make a singleton list.</span>
                        <span style="color: #6c71c4;">(</span>format <span style="color: #2aa198;">"\t\t( %s\n\t\t\t)"</span> <span style="color: #859900;">(</span>s-join <span style="color: #2aa198;">"\n\t\t\t; "</span> <span style="color: #268bd2;">(</span>reverse fsnew<span style="color: #268bd2;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
                        list

                        <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Stick on the renaming, which in turn requires an opening clause;</span>
                        <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">which in turn requires a module parameter.</span>
                        <span style="color: #6c71c4;">(</span>cons <span style="color: #2aa198;">"\t renaming"</span><span style="color: #6c71c4;">)</span>
                        <span style="color: #6c71c4;">(</span>cons <span style="color: #859900;">(</span>format <span style="color: #2aa198;">"open %s &#8475; public"</span> kind<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
                        <span style="color: #6c71c4;">(</span>cons <span style="color: #859900;">(</span>format <span style="color: #2aa198;">"&#8475; : %s"</span> kind<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
                       <span style="color: #35a69c;">)</span>

    <span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #0000cd;">instantiate-as-opening</span>
</pre>
</div>

<p>
Let's test it out.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">-let</span> <span style="color: #d33682;">[</span>inst <span style="color: #859900;">(</span>load-instance-declaration <span style="color: #2aa198;">"Monoid&#8242; = MonoidPF opening Monoid (Carrier to &#119982;; _&#10814;_ to _&#8853;_; &#955; x &#8594; x ++ \"&#8242;\")"</span><span style="color: #859900;">)</span><span style="color: #d33682;">]</span>
  <span style="color: #d33682;">(</span>instantiate-as-opening test inst<span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">Monoid&#8242; = MonoidPF opening Monoid (Carrier to &#119982;; _&#10814;_ to _&#8853;_; &#955; x &#8594; x ++ "&#8242;") </span><span style="color: #93a1a1;">-}</span>
<span style="color: #859900; font-weight: bold;">module</span> <span style="color: #a020f0;">Monoid</span>&#8242; (&#8475; :<span style="color: #b58900; font-style: italic;"> Monoid</span>) <span style="color: #859900; font-weight: bold;">where</span>
    <span style="color: #859900; font-weight: bold;">open</span><span style="color: #b58900; font-style: italic;"> Monoid</span> &#8475; <span style="color: #859900; font-weight: bold;">public</span>
         <span style="color: #859900; font-weight: bold;">renaming</span>
            (<span style="color: #b58900; font-style: italic;"> Carrier</span> <span style="color: #0000cd;">to</span> &#119982;
            ; <span style="color: #b58900; font-style: italic;">_&#10814;_</span> <span style="color: #0000cd;">to</span> _&#8853;_
            ;<span style="color: #b58900; font-style: italic;"> Id</span> <span style="color: #0000cd;">to</span><span style="color: #b58900; font-style: italic;"> Id</span>&#8242;
            ; <span style="color: #b58900; font-style: italic;">assoc</span> <span style="color: #0000cd;">to</span> <span style="color: #b58900; font-style: italic;">assoc</span>&#8242;
            )
</pre>
</div>

<p>
This utility shines when we use it wholesale; as follows.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #d33682;">(</span><span style="color: #859900;">(</span>inst&#8321; <span style="color: #cb4b16;">(</span>load-instance-declaration <span style="color: #2aa198;">"Monoid&#8321; = MonoidPF opening Monoid (&#955; x &#8594; x ++ \"&#8321;\")"</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
      <span style="color: #859900;">(</span>inst&#8322; <span style="color: #cb4b16;">(</span>load-instance-declaration <span style="color: #2aa198;">"Monoid&#8322; = MonoidPF opening Monoid (&#955; x &#8594; x ++ \"&#8322;\")"</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
  <span style="color: #d33682;">(</span>s-join <span style="color: #2aa198;">"\n\n"</span> <span style="color: #859900;">(</span>list <span style="color: #cb4b16;">(</span>instantiate-as-opening test inst&#8321;<span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>instantiate-as-opening test inst&#8322;<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda"><span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">Monoid&#8321; = MonoidPF opening Monoid (&#955; x &#8594; x ++ "&#8321;") </span><span style="color: #93a1a1;">-}</span>
<span style="color: #859900; font-weight: bold;">module</span> <span style="color: #a020f0;">Monoid</span>&#8321; (&#8475; :<span style="color: #b58900; font-style: italic;"> Monoid</span>) <span style="color: #859900; font-weight: bold;">where</span>
    <span style="color: #859900; font-weight: bold;">open</span><span style="color: #b58900; font-style: italic;"> Monoid</span> &#8475; <span style="color: #859900; font-weight: bold;">public</span>
         <span style="color: #859900; font-weight: bold;">renaming</span>
            (<span style="color: #b58900; font-style: italic;"> Carrier</span> <span style="color: #0000cd;">to</span><span style="color: #b58900; font-style: italic;"> Carrier</span>&#8321;
            ; <span style="color: #b58900; font-style: italic;">_&#10814;_</span> <span style="color: #0000cd;">to</span> _&#10814;&#8321;_
            ;<span style="color: #b58900; font-style: italic;"> Id</span> <span style="color: #0000cd;">to</span><span style="color: #b58900; font-style: italic;"> Id</span>&#8321;
            ; <span style="color: #b58900; font-style: italic;">assoc</span> <span style="color: #0000cd;">to</span> <span style="color: #b58900; font-style: italic;">assoc</span>&#8321;
            )

<span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">Monoid&#8322; = MonoidPF opening Monoid (&#955; x &#8594; x ++ "&#8322;") </span><span style="color: #93a1a1;">-}</span>
<span style="color: #859900; font-weight: bold;">module</span> <span style="color: #a020f0;">Monoid</span>&#8322; (&#8475; :<span style="color: #b58900; font-style: italic;"> Monoid</span>) <span style="color: #859900; font-weight: bold;">where</span>
    <span style="color: #859900; font-weight: bold;">open</span><span style="color: #b58900; font-style: italic;"> Monoid</span> &#8475; <span style="color: #859900; font-weight: bold;">public</span>
         <span style="color: #859900; font-weight: bold;">renaming</span>
            (<span style="color: #b58900; font-style: italic;"> Carrier</span> <span style="color: #0000cd;">to</span><span style="color: #b58900; font-style: italic;"> Carrier</span>&#8322;
            ; <span style="color: #b58900; font-style: italic;">_&#10814;_</span> <span style="color: #0000cd;">to</span> _&#10814;&#8322;_
            ;<span style="color: #b58900; font-style: italic;"> Id</span> <span style="color: #0000cd;">to</span><span style="color: #b58900; font-style: italic;"> Id</span>&#8322;
            ; <span style="color: #b58900; font-style: italic;">assoc</span> <span style="color: #0000cd;">to</span> <span style="color: #b58900; font-style: italic;">assoc</span>&#8322;
            )
</pre>
</div>

<p>
We have written this kind of boilerplate so often that we welcome the
sweet relief provided by the editor tactic being developed herein.
</p>
</div>
</div>

<div id="outline-container-orge2ac64b" class="outline-3">
<h3 id="orge2ac64b"><span class="section-number-3">6.2</span> Instantiate all items in <code>instantiations-remaining</code></h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Function combinators; e.g., -partial/-cut, -const, -compose, -orfn &amp; -andfn for generalised &#8707;/&#8704;.</span>
<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">use-package</span> <span style="color: #6c71c4; font-weight: bold;">dash-functional</span><span style="color: #268bd2;">)</span> <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">https://github.com/magnars/dash.el</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">reify-instances</span> <span style="color: #d33682;">()</span>
 <span style="color: #35a69c;">"Instantiate all items in &#8216;</span><span style="color: #6c71c4; font-weight: bold;">instantiations-remaining</span><span style="color: #35a69c;">&#8217;."</span>

 <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">interactive</span><span style="color: #d33682;">)</span>

 <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #859900;">(</span>result name pf-type pf pfs variation reify perform coherent-cutting<span style="color: #859900;">)</span>

   <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">dolist</span> <span style="color: #cb4b16;">(</span>inst instantiations-remaining<span style="color: #cb4b16;">)</span>

     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Get pieces of the instance declaration.</span>
     <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> name <span style="color: #6c71c4;">(</span>instance-declaration-name inst<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
     <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> variation <span style="color: #6c71c4;">(</span>instance-declaration-variation inst<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
     <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> pf-type <span style="color: #6c71c4;">(</span>instance-declaration-package-former inst<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>

     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Get the package-former that is being instantiated.</span>
     <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> pfs <span style="color: #6c71c4;">(</span>car <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">--filter</span> <span style="color: #35a69c;">(</span>equal pf-type <span style="color: #6c71c4;">(</span>package-former-name it<span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span> package-formers<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>

     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Perform the instantiation.</span>

     <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> perform <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Recall that :x is sugar for 'x, which is then just an argument.</span>
           <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">cond</span> <span style="color: #b58900;">(</span><span style="color: #35a69c;">(</span>not pfs<span style="color: #35a69c;">)</span> <span style="color: #35a69c;">(</span>-const <span style="color: #6c71c4;">(</span>format <span style="color: #2aa198;">"\n%s = {! No PackageFormer &#8216;</span><span style="color: #6c71c4; font-weight: bold;">%s</span><span style="color: #2aa198;">&#8217; declared. !}"</span> name pf-type<span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span>
                 <span style="color: #b58900;">(</span>t <span style="color: #35a69c;">(</span><span style="color: #859900; font-weight: bold;">pcase</span> <span style="color: #6c71c4;">(</span>instance-declaration-variation inst<span style="color: #6c71c4;">)</span>
                      <span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"typeclass"</span> <span style="color: #859900;">(</span>-partial 'instantiate-as-unbundled 1<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
                      <span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"record"</span>    <span style="color: #859900;">(</span>-partial 'instantiate-as-unbundled 0<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
                      <span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"data"</span>      'instantiate-as-data<span style="color: #6c71c4;">)</span>
                      <span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"opening"</span>   <span style="color: #859900;">(</span>-const <span style="color: #268bd2;">(</span>instantiate-as-opening pfs inst<span style="color: #268bd2;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
                      <span style="color: #6c71c4;">(</span>v  <span style="color: #859900;">(</span>-const <span style="color: #268bd2;">(</span>format <span style="color: #2aa198;">"\n%s = {! Variation &#8216;</span><span style="color: #6c71c4; font-weight: bold;">%s</span><span style="color: #2aa198;">&#8217; not yet supported !}"</span> name v<span style="color: #268bd2;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>

     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Exposes clause should not be used with typeclass since it is a special case of record.</span>
     <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> exposes-hoisting <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #b58900;">(</span>fs<span style="color: #b58900;">)</span>
                         <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #35a69c;">(</span><span style="color: #6c71c4;">(</span>fsnew fs<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>es <span style="color: #859900;">(</span>instance-declaration-exposes inst<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>l <span style="color: #859900;">(</span>length es<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span>
                           <span style="color: #35a69c;">(</span><span style="color: #859900; font-weight: bold;">loop</span> for e in <span style="color: #6c71c4;">(</span>reverse es<span style="color: #6c71c4;">)</span>
                              do <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">push</span> <span style="color: #859900;">(</span>car <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">--filter</span> <span style="color: #d33682;">(</span>equal e <span style="color: #859900;">(</span>get-name it<span style="color: #859900;">)</span><span style="color: #d33682;">)</span> fsnew<span style="color: #268bd2;">)</span><span style="color: #859900;">)</span> fsnew<span style="color: #6c71c4;">)</span>
                           <span style="color: #35a69c;">)</span>
                         <span style="color: #35a69c;">(</span><span style="color: #859900; font-weight: bold;">setf</span> <span style="color: #6c71c4;">(</span>nthcdr l fsnew<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">--remove</span> <span style="color: #859900;">(</span>-contains? es <span style="color: #268bd2;">(</span>get-name it<span style="color: #268bd2;">)</span><span style="color: #859900;">)</span> <span style="color: #859900;">(</span>nthcdr l fsnew<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span>
                         fsnew
                         <span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>

     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Mainfest is like renaming but stronger, the fields are actually dropped.</span>
     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">One may think &#8220;manifest = dropped &#8728; renaming&#8221;, but our drop feature is too strong</span>
     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">since it tries to drop all fields that mention a dropped item as well.</span>
     <span style="color: #93a1a1;">;;</span>
     <span style="color: #93a1a1;">;;</span>
     <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> manifest-rewriting <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #b58900;">(</span>fs<span style="color: #b58900;">)</span>
                                <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">-let</span> <span style="color: #35a69c;">[</span>fsnew <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">--remove</span> <span style="color: #859900;">(</span>-contains? <span style="color: #268bd2;">(</span>-map #'car <span style="color: #d33682;">(</span>instance-declaration-manifest inst<span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span>get-name it<span style="color: #268bd2;">)</span><span style="color: #859900;">)</span> fs<span style="color: #6c71c4;">)</span><span style="color: #35a69c;">]</span>
                                  <span style="color: #35a69c;">(</span><span style="color: #859900; font-weight: bold;">loop</span> for old-new in <span style="color: #6c71c4;">(</span>instance-declaration-manifest inst<span style="color: #6c71c4;">)</span>
                                    do <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">setq</span> fsnew <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">--map</span> <span style="color: #268bd2;">(</span>s-replace <span style="color: #d33682;">(</span>car old-new<span style="color: #d33682;">)</span> <span style="color: #d33682;">(</span>cdr old-new<span style="color: #d33682;">)</span> it<span style="color: #268bd2;">)</span> fsnew<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span>
                                  fsnew<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>

     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Remove the dropped fields and (almost) anything that mentions them; not a high priority.</span>
     <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> coherent-cutting <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #b58900;">(</span>fs<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">--remove</span> <span style="color: #35a69c;">(</span><span style="color: #859900; font-weight: bold;">or</span> <span style="color: #6c71c4;">(</span>-contains? <span style="color: #859900;">(</span>instance-declaration-hidings inst<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>get-name it<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
                                                  <span style="color: #6c71c4;">(</span>-any? <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #268bd2;">(</span>h<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span>s-contains? <span style="color: #d33682;">(</span>s-replace <span style="color: #2aa198;">"_"</span> <span style="color: #2aa198;">""</span> h<span style="color: #d33682;">)</span> it<span style="color: #268bd2;">)</span><span style="color: #859900;">)</span> <span style="color: #859900;">(</span>instance-declaration-hidings inst<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span>
                                              fs<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>

     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">(funcall `(lambda (it) ,(car (read-from-string "(concat \"a\" it)"))) "2e")</span>
     <span style="color: #93a1a1;">;;</span>
     <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> decorated-rewriting <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #b58900;">(</span>fs<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #35a69c;">(</span>instance-declaration-decorations inst<span style="color: #35a69c;">)</span>
                                  <span style="color: #35a69c;">(</span><span style="color: #859900; font-weight: bold;">-let</span> <span style="color: #6c71c4;">(</span><span style="color: #859900;">(</span>fsnew nil<span style="color: #859900;">)</span> old new <span style="color: #859900;">(</span>letin nil<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
                                      <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">loop</span> for f in <span style="color: #859900;">(</span>reverse fs<span style="color: #859900;">)</span>
                                            do <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> old <span style="color: #268bd2;">(</span>get-name f<span style="color: #268bd2;">)</span><span style="color: #859900;">)</span>
                                               <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">push</span> <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">map-name</span> <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">setq</span> new <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">rename-mixfix-it</span> <span style="color: #cb4b16;">(</span>eval <span style="color: #6c71c4;">(</span>car <span style="color: #b58900;">(</span>read-from-string <span style="color: #35a69c;">(</span>instance-declaration-decorations inst<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span> name<span style="color: #859900;">)</span><span style="color: #d33682;">)</span> f<span style="color: #268bd2;">)</span> fsnew<span style="color: #859900;">)</span>
                                               <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> letin <span style="color: #268bd2;">(</span>cons <span style="color: #d33682;">(</span>format <span style="color: #2aa198;">"let %s = %s in "</span> old new<span style="color: #d33682;">)</span> letin<span style="color: #268bd2;">)</span><span style="color: #859900;">)</span>
                                            <span style="color: #6c71c4;">)</span>
                                      <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Could ty this into renaming, but avoiding such entaglement for now.</span>
                                      <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Stick all renames &#8220;so far&#8221; in front of each declaration.</span>
                                      <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">loop</span> for f in fsnew for i from 0 do <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setf</span> <span style="color: #268bd2;">(</span>nth i fsnew<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">map-type</span> <span style="color: #d33682;">(</span>concat <span style="color: #859900;">(</span>s-join <span style="color: #2aa198;">""</span> <span style="color: #cb4b16;">(</span>-take i letin<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span> type<span style="color: #d33682;">)</span> f<span style="color: #268bd2;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
                                      fsnew
                                    <span style="color: #35a69c;">)</span>
                                  fs
                                  <span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>

     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Possibly better than the find-replace approach below.</span>
     <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> reify <span style="color: #6c71c4;">(</span>funcall perform pfs <span style="color: #d33682; font-weight: bold; font-style: italic;">:new-name</span> name <span style="color: #d33682; font-weight: bold; font-style: italic;">:docstring</span> <span style="color: #b58900;">(</span>instance-declaration-docstring inst<span style="color: #b58900;">)</span>
                          <span style="color: #d33682; font-weight: bold; font-style: italic;">:waist</span> <span style="color: #b58900;">(</span>instance-declaration-waist inst<span style="color: #b58900;">)</span>
                          <span style="color: #d33682; font-weight: bold; font-style: italic;">:alter-fields</span> <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #35a69c;">(</span>fs<span style="color: #35a69c;">)</span>
                                                         <span style="color: #35a69c;">(</span>funcall decorated-rewriting

                                                         <span style="color: #6c71c4;">(</span>funcall exposes-hoisting <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">for exposes variational clause</span>

                                                         <span style="color: #859900;">(</span>funcall manifest-rewriting <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">for manifest variational clause</span>

                                                         <span style="color: #268bd2;">(</span>funcall coherent-cutting <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">for dropping variational clause</span>

                                                         <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">renaming</span>
                                                         <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">if-let</span> <span style="color: #859900;">(</span><span style="color: #cb4b16;">(</span>rns <span style="color: #6c71c4;">(</span>instance-declaration-renames inst<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>fsnew fs<span style="color: #cb4b16;">)</span> <span style="color: #cb4b16;">(</span>changes 0<span style="color: #cb4b16;">)</span> <span style="color: #859900;">)</span>
                                                          <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">For each &#8220;old to new&#8221;, replace &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">old</span><span style="color: #96A7A9; font-style: italic;">&#8217; in every /subsequent/ field with &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">new</span><span style="color: #96A7A9; font-style: italic;">&#8217; via a let-clause.</span>
                                                          <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">progn</span> <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">loop</span> for f in fs for i from 0
                                                                       do <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">when-let*</span> <span style="color: #b58900;">(</span><span style="color: #35a69c;">(</span>old <span style="color: #6c71c4;">(</span>get-name f<span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span> <span style="color: #35a69c;">(</span>new <span style="color: #6c71c4;">(</span>cdr <span style="color: #859900;">(</span>assoc old rns<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span>
                                                                            <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> fsnew <span style="color: #35a69c;">(</span><span style="color: #859900; font-weight: bold;">--map</span> <span style="color: #6c71c4;">(</span>s-replace old new it<span style="color: #6c71c4;">)</span> fsnew<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span>
                                                                            <span style="color: #93a1a1;">; </span><span style="color: #96A7A9; font-style: italic;">(push (format "private %s = %s" old new) (cdr (nthcdr (+ i changes) fsnew)))</span>
                                                                            <span style="color: #93a1a1;">; </span><span style="color: #96A7A9; font-style: italic;">(push "field" (cdr (nthcdr (+ i changes 1) fsnew)))</span>
                                                                            <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">setf</span> <span style="color: #35a69c;">(</span>nthcdr <span style="color: #6c71c4;">(</span>+ i 1 changes<span style="color: #6c71c4;">)</span> fsnew<span style="color: #35a69c;">)</span>
                                                                                  <span style="color: #35a69c;">(</span><span style="color: #859900; font-weight: bold;">--map</span> <span style="color: #6c71c4;">(</span>s-replace <span style="color: #2aa198;">": "</span> <span style="color: #859900;">(</span>format <span style="color: #2aa198;">": let %s = %s in "</span> old new<span style="color: #859900;">)</span> it<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>nthcdr <span style="color: #859900;">(</span>+ i 1 changes<span style="color: #859900;">)</span> fsnew<span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span>
                                                                            <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">incf</span> changes<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
                                                                 fsnew<span style="color: #859900;">)</span>
                                                         fs<span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span> <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">otherwise leave fields alone.</span>

     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Naive Perform renames.</span>
     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">(--map (setq reify (s-replace (car it) (cdr it) reify))</span>
     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">(instance-declaration-renames inst))</span>

     <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Add to list of results. The empty string yields a new line between each generated instantiation.</span>
     <span style="color: #cb4b16;">(</span><span style="color: #859900; font-weight: bold;">setq</span> result <span style="color: #6c71c4;">(</span>-cons* reify <span style="color: #2aa198;">""</span> result<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
<span style="color: #859900;">)</span>
   <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Output results as a string.</span>
     <span style="color: #859900;">(</span>s-join <span style="color: #2aa198;">"\n"</span> result<span style="color: #859900;">)</span>
<span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>

<p>
→ Naive replacement does not work since Agda supports mixfix identifers; e.g.,
  If we rename <code>_⨾_ to _⊕_</code> then it is not as easy to propogate this renaming into,
  say, <code>assoc : ∀ {x y z} → (x ⨾ y) ⨾ z ≡ x ⨾ (y ⨾ z)</code>. However, we cannot ask the
  user to rename <code>⨾</code> since it is a different identifer than <code>_⨾_</code>.
</p>

<p>
→ I also tried adding new local aliases, as in <code>private _⨾_ = _⊕_</code>, however this does not
propogate well to ADT declarations.
</p>

<p>
→ The solution was to bind the renames even more locally via let-in clauses.
</p>

<p>
As always, let's ensure this works as intended.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">progn</span>
  <span style="color: #d33682;">(</span>find-file <span style="color: #2aa198;">"Testing.agda"</span><span style="color: #d33682;">)</span>

  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">setq</span> package-formers nil<span style="color: #d33682;">)</span> <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">setq</span> instantiations-remaining nil<span style="color: #d33682;">)</span> <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">setq</span> 700-comments nil<span style="color: #d33682;">)</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">setq</span> porting-list nil<span style="color: #d33682;">)</span>

  <span style="color: #d33682;">(</span>parse-700-comments<span style="color: #d33682;">)</span>

  <span style="color: #d33682;">(</span>switch-to-buffer <span style="color: #2aa198;">"PackageFormer.org"</span><span style="color: #d33682;">)</span>

  <span style="color: #d33682;">(</span>reify-instances<span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>

</pre>
</div>

<div class="org-src-container">
<pre class="src src-results-agda">#&lt;<span style="color: #0000cd;">buffer</span> <span style="color: #b58900; font-style: italic;">PackageFormer</span>.<span style="color: #0000cd;">org</span>&gt;
</pre>
</div>

<p>
Super cool stuff <code>(งಠ_ಠ)ง</code>
</p>

<p>
Note that the renaming clause must have its old forms appear in the same order that they appear in the original declaration.
This could be avoided by obtaining the names of the continents, then intersecting that with the renames list, along the first component.
</p>

<p>
NOTE: Level polymorphism with generalised variables does not work for data declaration.
</p>
</div>
</div>
</div>

<div id="outline-container-org829e1b0" class="outline-2">
<h2 id="org829e1b0"><span class="section-number-2">7</span> Advising our Beloved <code>C-c C-l</code></h2>
<div class="outline-text-2" id="text-7">
<p>
Let's give the current buffer access to the location of the generated file.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">insert-generated-import</span> <span style="color: #d33682;">(</span>name-of-generated-file<span style="color: #d33682;">)</span>
  <span style="color: #35a69c;">"In the current file, find the top-most module declaration</span>
<span style="color: #35a69c;">   then insert an import of the generated file.</span>
<span style="color: #35a69c;">  "</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">interactive</span><span style="color: #d33682;">)</span>

  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">save-excursion</span>
    <span style="color: #859900;">(</span>beginning-of-buffer<span style="color: #859900;">)</span>
    <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">condition-case</span> the-err
      <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">attemptClause:</span>
      <span style="color: #cb4b16;">(</span>re-search-forward <span style="color: #6c71c4;">(</span>concat <span style="color: #2aa198;">"open import "</span> name-of-generated-file<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
       <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">recoveryBody:</span>
      <span style="color: #cb4b16;">(</span><span style="color: #b58900; font-weight: bold;">error</span> <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">(message-box (format "%s" the-err))</span>
         <span style="color: #6c71c4;">(</span>re-search-forward <span style="color: #2aa198;">"</span><span style="color: #268bd2; font-weight: bold;">\\</span><span style="color: #268bd2; font-weight: bold;">(</span><span style="color: #2aa198;">module.*</span><span style="color: #268bd2; font-weight: bold;">\\</span><span style="color: #268bd2; font-weight: bold;">)</span><span style="color: #2aa198;">"</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>replace-match <span style="color: #b58900;">(</span>concat <span style="color: #2aa198;">"\\1\nopen import "</span> name-of-generated-file<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>
        <span style="color: #cb4b16;">)</span>
    <span style="color: #859900;">)</span>
  <span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>
</pre>
</div>

<p>
The aim is to process test enclosed in <code>{-700 ⋯ -}</code> comments,
produce legitimate Agda from that, and ensure the generated Agda is accessible to the
current buffer automatically.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">reify-package-formers</span> <span style="color: #d33682;">(</span>orig-fun <span style="color: #b58900; font-style: italic;">&amp;rest</span> args<span style="color: #d33682;">)</span>
  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">interactive</span><span style="color: #d33682;">)</span>

  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #859900;">(</span>generated-file-name
        <span style="color: #cb4b16;">(</span>parent-imports <span style="color: #6c71c4;">(</span>extract-imports<span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
       <span style="color: #859900;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Sometimes we may want the full name due to files being in a nested</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">directory hierarchy: (file-name-sans-extension buffer-file-name)</span>
  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> generated-file-name <span style="color: #cb4b16;">(</span>concat<span style="color: #6c71c4;">(</span>file-name-sans-extension <span style="color: #b58900;">(</span>buffer-name<span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span>
                  <span style="color: #2aa198;">"_Generated"</span><span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">This&#8217; inefficent.</span>
  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> package-formers nil<span style="color: #859900;">)</span>
  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> instantiations-remaining nil<span style="color: #859900;">)</span>
  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> 700-comments nil<span style="color: #859900;">)</span>
  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">setq</span> porting-list nil<span style="color: #859900;">)</span>
  <span style="color: #859900;">(</span>parse-700-comments<span style="color: #859900;">)</span>

  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">with-temp-buffer</span>
    <span style="color: #cb4b16;">(</span>beginning-of-buffer<span style="color: #cb4b16;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Copy/paste imports from parent file.</span>
    <span style="color: #cb4b16;">(</span>insert <span style="color: #6c71c4;">(</span>s-join <span style="color: #2aa198;">"\n"</span> `<span style="color: #b58900;">(</span>
             <span style="color: #2aa198;">"{- This file is generated ;; do not alter. -}\n"</span>
             ,parent-imports
             <span style="color: #2aa198;">"open import Level as Level"</span>
             ,<span style="color: #35a69c;">(</span>format <span style="color: #2aa198;">"module %s where "</span> generated-file-name<span style="color: #35a69c;">)</span>
             , <span style="color: #35a69c;">(</span>s-join <span style="color: #2aa198;">"\n"</span> porting-list<span style="color: #35a69c;">)</span>
             ,<span style="color: #35a69c;">(</span>reify-instances<span style="color: #35a69c;">)</span><span style="color: #b58900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>

    <span style="color: #cb4b16;">(</span>write-region <span style="color: #6c71c4;">(</span>beginning-of-buffer<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>end-of-buffer<span style="color: #6c71c4;">)</span>
                  <span style="color: #6c71c4;">(</span>concat generated-file-name <span style="color: #2aa198;">".agda"</span><span style="color: #6c71c4;">)</span><span style="color: #cb4b16;">)</span>
    <span style="color: #859900;">)</span>

  <span style="color: #859900;">(</span>insert-generated-import generated-file-name<span style="color: #859900;">)</span>
  <span style="color: #d33682;">)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Need to revert buffer to discard old colours.</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">(save-buffer) (revert-buffer t t t)</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">call agda2-load</span>
  <span style="color: #d33682;">(</span>apply orig-fun args<span style="color: #d33682;">)</span>

   <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Colour 700 keywords</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">(loop for kw in '("PackageFormer" "Variation" "hiding" "renaming" "unbundling" "exposing" "renaming" "with")</span>
  <span style="color: #93a1a1;">;;  </span><span style="color: #96A7A9; font-style: italic;">do (highlight-phrase kw 'hi-green))</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Replace with a hook.</span>

  <span style="color: #d33682;">(</span>highlight-phrase <span style="color: #2aa198;">"700"</span> 'error<span style="color: #d33682;">)</span>

  <span style="color: #d33682;">(</span>message <span style="color: #2aa198;">"700 &#8759; All the best coding! (&#8226;&#768;&#7447;&#8226;&#769;)&#1608;"</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>

<span style="color: #268bd2;">(</span>advice-add 'agda2-load <span style="color: #d33682; font-weight: bold; font-style: italic;">:around</span> #'reify-package-formers<span style="color: #268bd2;">)</span>
</pre>
</div>

<p>
Personal note:
Using <code>(write-file "Generated.agda")</code> means we make a file
then the temporary buffer <i>visits</i> the Agda file, which loads the
Agda process therein, which is undesirable since it could leave
Agda working on the buffer even after it has been killed!
</p>
<ul class="org-ul">
<li>This would necessiate calling <code>(agda2-restart)</code> afterwards.</li>
<li>Instead we write the whole region, without visiting the resuting file.</li>
</ul>
</div>
</div>

<div id="outline-container-org0e1f84d" class="outline-2">
<h2 id="org0e1f84d"><span class="section-number-2">8</span> Menu matter</h2>
<div class="outline-text-2" id="text-8">
<p>
Let's quickly add a menu bar that allows users to enable or disable using PackageFormer's;
along with a brief help menu.
</p>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> The global map </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #268bd2;">700-menu-bar</span> <span style="color: #d33682;">(</span>make-sparse-keymap <span style="color: #2aa198;">"700 PackageFormers"</span><span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>

<span style="color: #268bd2;">(</span>define-key global-map <span style="color: #d33682;">[</span>menu-bar 700menu<span style="color: #d33682;">]</span> <span style="color: #d33682;">(</span>cons <span style="color: #2aa198;">"700PackageFormers"</span> 700-menu-bar<span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Enabling the feature </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span>define-key 700-menu-bar <span style="color: #d33682;">[</span>enable-package-formers<span style="color: #d33682;">]</span>
  '<span style="color: #d33682;">(</span>menu-item <span style="color: #2aa198;">"Enable PackageFormer Generation"</span> enable-package-formers<span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>

<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">enable-package-formers</span> <span style="color: #d33682;">()</span>
 <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">interactive</span><span style="color: #d33682;">)</span>
 <span style="color: #d33682;">(</span>advice-add 'agda2-load <span style="color: #d33682; font-weight: bold; font-style: italic;">:around</span> #'reify-package-formers<span style="color: #d33682;">)</span>
 <span style="color: #d33682;">(</span>message-box <span style="color: #2aa198;">"C-c C-l now reifies &#8220;700-comments&#8221; into legitimate Agda."</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Disabling the feature </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span>define-key 700-menu-bar <span style="color: #d33682;">[</span>disable-package-formers<span style="color: #d33682;">]</span>
  '<span style="color: #d33682;">(</span>menu-item <span style="color: #2aa198;">"Disable PackageFormer Generation"</span> disable-package-formers<span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>

<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">disable-package-formers</span> <span style="color: #d33682;">()</span>
 <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">interactive</span><span style="color: #d33682;">)</span>
 <span style="color: #d33682;">(</span>advice-remove 'agda2-load #'reify-package-formers<span style="color: #d33682;">)</span>
 <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">setq</span> global-mode-string <span style="color: #859900;">(</span>remove <span style="color: #2aa198;">"700 (&#8226;&#768;&#7447;&#8226;&#769;)&#1608; "</span> global-mode-string<span style="color: #859900;">)</span><span style="color: #d33682;">)</span>
  <span style="color: #d33682;">(</span>message-box <span style="color: #2aa198;">"C-c C-l now behaves as it always has."</span><span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>
</pre>
</div>
</details>

<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> About menu </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span>define-key 700-menu-bar <span style="color: #d33682;">[</span>package-formers-about<span style="color: #d33682;">]</span>
  '<span style="color: #d33682;">(</span>menu-item <span style="color: #2aa198;">"About PackageFormers"</span> package-formers-about<span style="color: #d33682;">)</span><span style="color: #268bd2;">)</span>

<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">package-formers-about</span> <span style="color: #d33682;">()</span>
 <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">interactive</span><span style="color: #d33682;">)</span>
 <span style="color: #d33682;">(</span>switch-to-buffer <span style="color: #2aa198;">"*PackageFormer-About*"</span><span style="color: #d33682;">)</span> <span style="color: #d33682;">(</span>insert
  <span style="color: #2aa198;">" This is an editor extension prototyping &#8220;the next 700 module systems&#8221; proposed research.</span>

<span style="color: #2aa198;">    An informal documentation, with examples, page can be found at</span>
<span style="color: #2aa198;">    https://alhassy.github.io/next-700-module-systems-proposal/PackageFormer.html</span>

<span style="color: #2aa198;">    The technical matter can be found at https://alhassy.github.io/next-700-module-systems-proposal/</span>

<span style="color: #2aa198;">    If you experience anything &#8220;going wrong&#8221; or have any ideas for improvement,</span>
<span style="color: #2aa198;">    please contact Musa Al-hassy at alhassy@gmail.com; thank-you &#9829;&#8255;&#9829;</span>
<span style="color: #2aa198;">  "</span>
 <span style="color: #d33682;">)</span>
<span style="color: #268bd2;">)</span>

</pre>
</div>
</details>

<p>
Let's pack these together into a minor mode.
</p>
<details class="code-details"> <summary> <strong> <font face="Courier" size="3" color="green"> Minor mode </font> </strong> </summary>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define-minor-mode</span> <span style="color: #b58900;">700-mode</span>
    <span style="color: #35a69c;">"This is an editor extension prototyping &#8220;the next 700 module systems&#8221; proposed research.</span>

<span style="color: #35a69c;">    An informal documentation, with examples, page can be found at</span>
<span style="color: #35a69c;">    https://alhassy.github.io/next-700-module-systems-proposal/PackageFormer.html</span>

<span style="color: #35a69c;">    The technical matter can be found at https://alhassy.github.io/next-700-module-systems-proposal/</span>

<span style="color: #35a69c;">    If you experience anything &#8220;going wrong&#8221; or have any ideas for improvement,</span>
<span style="color: #35a69c;">    please contact Musa Al-hassy at alhassy@gmail.com; thank-you &#9829;&#8255;&#9829;</span>
<span style="color: #35a69c;">  "</span>
  <span style="color: #d33682; font-weight: bold; font-style: italic;">:lighter</span> <span style="color: #2aa198;">" 700 (&#8226;&#768;&#7447;&#8226;&#769;)&#1608;)"</span> <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Icon to display indicating the mode is enabled.</span>
  <span style="color: #d33682; font-weight: bold; font-style: italic;">:require</span> 'foo

  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Toggle the menu bar</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">(define-key global-map [menu-bar 700menu] t)(not 700-mode))</span>
  <span style="color: #d33682;">(</span>define-key global-map <span style="color: #859900;">[</span>menu-bar 700menu<span style="color: #859900;">]</span> <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">and</span> 700-mode <span style="color: #cb4b16;">(</span>cons <span style="color: #2aa198;">"700PackageFormers"</span> 700-menu-bar<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

  <span style="color: #d33682;">(</span><span style="color: #859900; font-weight: bold;">letf</span> <span style="color: #859900;">(</span><span style="color: #cb4b16;">(</span> <span style="color: #6c71c4;">(</span>symbol-function 'message-box<span style="color: #6c71c4;">)</span> #'message<span style="color: #cb4b16;">)</span><span style="color: #859900;">)</span>
  <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">if</span> 700-mode
      <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Initilisation</span>
      <span style="color: #cb4b16;">(</span>enable-package-formers<span style="color: #cb4b16;">)</span>

      <span style="color: #93a1a1;">;; </span><span style="color: #96A7A9; font-style: italic;">Closing</span>
      <span style="color: #cb4b16;">(</span>disable-package-formers<span style="color: #cb4b16;">)</span>
  <span style="color: #859900;">)</span><span style="color: #d33682;">)</span>

<span style="color: #268bd2;">)</span>
</pre>
</div>
</details>
</div>
</div>

<div id="outline-container-org567a78a" class="outline-2">
<h2 id="org567a78a"><span class="section-number-2">9</span> <span class="done Future">Future</span> Work</h2>
<div class="outline-text-2" id="text-9">
<p>
Well, that was a lot of Lisp I had to learn <code>(งಠ_ಠ)ง</code>
</p>

<p>
Hopefully the resulting prototype will be useful to others;
drop me a line if you're interested in this effort or have
any feedback or pointers!
</p>

<div class="org-center">
<p>
★ ★ ★
</p>
</div>

<p>
Below are some desirable features to work on.
</p>

<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> MA: WK: hiding ↦ dropping</li>

<li class="off"><code>[&#xa0;]</code> Use buffer-substring-delimited-whole-buffer to parse <i>multiple</i>
<a href="#org7d7e11a">700-comments</a>!</li>

<li class="off"><code>[&#xa0;]</code> Add a level component to an instance structure; reduce it if Carrier is a parameter and otherwise leave it alone.
Instead, let the level of a PackageFormer denote the level of the typeclass instantiation, then with this in mind
we increase the level component of an instance structure only for those variations that keep the carrier as a field.
When we move to multi-sorted, as in Graphs, this issue will need to be revisited.</li>

<li class="off"><code>[&#xa0;]</code> Currently can only perform simple variational clauses; need to support complex clauses.</li>

<li class="off"><code>[&#xa0;]</code> Currently variational clauses apply as follows <code>PF v clause</code>, it would be useful to have them also apply
as <code>I clause</code> where <code>I = PF v</code> has already been declared. This would requuire we keep a list of instances and their parent PF;
our current list is consumed and thrown away.</li>

<li class="off"><code>[&#xa0;]</code> Need to implement a <b>front-end</b> system to extend variational clauses.</li>

<li class="off"><code>[&#xa0;]</code> The <code>elements</code> of a PackageFormer should be  an alist, <code>'(name . type)</code>.</li>

<li class="off"><code>[&#xa0;]</code> Refactor load-instantions function to make use of an <code>alter</code> field rather than overloading alter-<a href="#orga516fc5">fields</a> in reify-instances.</li>

<li class="off"><code>[&#xa0;]</code> Refactor <code>instantiate</code> to make use of an <code>instance</code> structure, rather than 13 arguments.</li>

<li class="off"><code>[&#xa0;]</code> Why does ‘buffer-substring-delimited-whole-buffer’ return a list of strings? Why not join its result to simply return a list?</li>

<li class="off"><code>[&#xa0;]</code> Generated.agda needs to inherit all open/import declarations from parent.</li>

<li class="off"><code>[&#xa0;]</code> Give an example PackageFormer with some definitions or derived constructs, then hoist-up your waist so that the non-defined items are <code>module</code> <a href="#org11fbf28">parameters</a>.</li>

<li class="off"><code>[&#xa0;]</code> <code>B = cs ⟨+ A ⟨+ cs′</code> where each cs is a single name-type declaration and the operation is left-associative, and A is an existing packageformer. This gives us a nice way to build a hierarchy. Note that since only A has a name, we may form a forgetful coercion B⇒A automatically.
E.g., <code>Monoid = Type ⟨+ Pointed ⟨+ (Magma renaming (_⊕_ to _⨾_)) ⟨+ LeftUnital ⟨+ RightUnital ⟨+ assoc : ∀ {x y z} → (x ⨾ y) ⨾ z ≡ x ⨾ (y ⨾ z)</code> gives, automatically, <code>Monoid⇒Type, Monoid⇒Pointed, Monoid⇒Magma, Monoid⇒LeftUnital, Magma⇒RightUnital</code> (•̀ᴗ•́)و MA: To begin with, ignore the rename and work up the sequence one ⟨+ at a time.</li>

<li class="off"><code>[&#xa0;]</code> PF's should account for equations. For simplicity they become components of a record &amp; module, but derived operations on datatypes.</li>

<li class="off"><code>[&#xa0;]</code> Demonstrate how generative modules can be emulated.</li>

<li class="off"><code>[&#xa0;]</code> For now, PackageFormer's have no other <a href="#org11fbf28">parameters</a> besides the variation symbol.</li>

<li class="off"><code>[&#xa0;]</code> The global variables package-formers &amp; instance-declaration should be <i>buffer</i> specific?</li>

<li class="off"><code>[&#xa0;]</code> Assign to a local var, check equality against global <a href="#org7d7e11a">700-comments</a>,
if identical, no more processing since everything already generated.</li>

<li class="off"><code>[&#xa0;]</code> Make use of docstring so that when a user enters a key sequence or selects from a menu, we can show them a listing of all ‘major’ components of a program: An org-mode file is displayed with an enumeration of the items, each being a link to the source, and only their docstring is shown. This is a nice ‘overview’ of the program source.</li>

<li class="off"><code>[&#xa0;]</code> Currently it looks like we are a minor mode, but this is not true. We only have a menu and the icon (•̀ᴗ•́)و is displayed when our feature is supported.</li>

<li class="off"><code>[&#xa0;]</code> Generate all instances of a PackageFormer schema.</li>

<li class="off"><code>[&#xa0;]</code> <p>
Allow package formers to have explicit <code>Variation</code> <a href="#org11fbf28">parameters</a>; but
how do we then deal with nested invocations? What are the uses of
having differing invocations?
</p>

<p>
For example,
</p>
<div class="org-src-container">
<pre class="src src-agda"><span style="color: #b58900; font-style: italic;">PackageFormer LawfullyPointed</span> (<span style="color: #0000cd;">v</span> :<span style="color: #b58900; font-style: italic;"> Variation</span>) : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
   <span style="color: #0000cd;">point</span> :<span style="color: #b58900; font-style: italic;"> LawfullyPointed</span> <span style="color: #0000cd;">v</span>
   <span style="color: #0000cd;">law</span>   :<span style="color: #b58900; font-style: italic;"> LawfullyPointed FOL</span> <span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">Concrete variation </span><span style="color: #93a1a1;">-}</span>

</pre>
</div>
<p>
Would elaborate to something like:
</p>
<div class="org-src-container">
<pre class="src src-agda">       <span style="color: #859900; font-weight: bold;">data</span><span style="color: #b58900; font-style: italic;"> LP-Term (Vars</span> : <span style="color: #859900; font-weight: bold;">Set</span>) : <span style="color: #859900; font-weight: bold;">Set</span> <span style="color: #859900; font-weight: bold;">where</span>
            <span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">Abstract fields from constituents of packageformer </span><span style="color: #93a1a1;">-}</span>
           <span style="color: #b58900; font-style: italic;"> Point</span>    :<span style="color: #b58900; font-style: italic;"> LP-Term</span>
            <span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">Fragment of first order logic term formation </span><span style="color: #93a1a1;">-}</span>
            _&#8242;       :<span style="color: #b58900; font-style: italic;"> Vars</span> &#8594;<span style="color: #b58900; font-style: italic;"> LP-Term</span> <span style="color: #93a1a1;">{- </span><span style="color: #96A7A9; font-style: italic;">Injection of vars as terms </span><span style="color: #93a1a1;">-}</span>
            _&#8776;_      :<span style="color: #b58900; font-style: italic;"> LP-Term</span> &#8594;<span style="color: #b58900; font-style: italic;"> LP-Term</span> &#8594;<span style="color: #b58900; font-style: italic;"> LP-Term</span>
            &#8704;&#8242; &#8707;&#8242;    :<span style="color: #b58900; font-style: italic;"> (Vars</span> &#8594;<span style="color: #b58900; font-style: italic;"> LP-Term</span>) &#8594;<span style="color: #b58900; font-style: italic;"> LP-Term</span>

       <span style="color: #859900; font-weight: bold;">record</span><span style="color: #b58900; font-style: italic;"> LP</span> :<span style="color: #b58900; font-style: italic;"> Set</span>&#8321; <span style="color: #859900; font-weight: bold;">where</span>
         <span style="color: #859900; font-weight: bold;">constructor</span> _,_,_
         <span style="color: #859900; font-weight: bold;">field</span>
           <span style="color: #b58900; font-style: italic;"> Carrier</span> : <span style="color: #859900; font-weight: bold;">Set</span>
            <span style="color: #0000cd;">point</span>   :<span style="color: #b58900; font-style: italic;"> Carrier</span>
            <span style="color: #0000cd;">law</span>     :<span style="color: #b58900; font-style: italic;"> LP-Term Carrier</span>
</pre>
</div>

<p>
With the following example uses.
</p>
<div class="org-src-container">
<pre class="src src-agda">     <span style="color: #b58900; font-style: italic;"> Contractable</span> :<span style="color: #b58900; font-style: italic;"> (A</span> : <span style="color: #859900; font-weight: bold;">Set</span>) (<span style="color: #0000cd;">a</span> :<span style="color: #b58900; font-style: italic;"> A</span>) &#8594;<span style="color: #b58900; font-style: italic;"> LP</span>
     <span style="color: #b58900; font-style: italic;"> Contractable A</span> <span style="color: #0000cd;">a</span> <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #b58900; font-style: italic;"> A</span> , <span style="color: #0000cd;">a</span> , &#8704;&#8242; (<span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #0000cd;">x</span> &#8594; <span style="color: #0000cd;">x</span> &#8776; <span style="color: #0000cd;">a</span> &#8242;)

     <span style="color: #b58900; font-style: italic;"> Indistinguishable</span> :<span style="color: #b58900; font-style: italic;"> (A</span> : <span style="color: #859900; font-weight: bold;">Set</span>)  &#8594; <span style="color: #b58900; font-style: italic;"> LP</span> <span style="color: #859900; font-weight: bold;">hiding</span> <span style="color: #0000cd;">point</span>
     <span style="color: #b58900; font-style: italic;"> Indistinguishable A</span> <span style="color: #0000cd;">a</span> <span style="color: #859900; font-weight: bold;">=</span> <span style="color: #b58900; font-style: italic;"> A</span> , &#8704;&#8242; (<span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #0000cd;">x</span> &#8594; &#8704;&#8242; (<span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #0000cd;">y</span> &#8594; <span style="color: #0000cd;">x</span> &#8776; <span style="color: #0000cd;">y</span>))
</pre>
</div>
<p>
Where <code>PF hiding c</code> is the largest sub-PackageFormer of <code>PF</code> with constituent <code>c</code>
removed &#x2014;in particular, constituents that depend on <code>c</code> would also be dropped.
</p></li>
</ul>
</div>
</div>
</div>
</body>
</html>
